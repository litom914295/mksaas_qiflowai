# 🚀 部署检查清单

本文档提供生产环境和 Staging 环境部署前的完整检查清单。

---

## 📋 部署前检查（Pre-Deployment）

### ✅ 代码质量检查

- [ ] 所有测试通过（`npm run test`）
- [ ] TypeScript 类型检查无错误（`npm run type-check`）
- [ ] Lint 检查通过（`npm run lint`）
- [ ] 代码格式化完成（`npm run format`）
- [ ] 构建成功（`npm run build`）
- [ ] 没有 console.log/debugger 语句（生产环境）
- [ ] 敏感信息已移除（API密钥、密码等）

### ✅ 环境配置检查

- [ ] `.env.production` 文件已正确配置
- [ ] 所有必需的环境变量已设置
- [ ] 数据库连接字符串正确
- [ ] API 密钥已更换为生产环境密钥
- [ ] OAuth 回调 URL 已更新
- [ ] Webhook URL 已更新
- [ ] CDN URL 已配置
- [ ] CORS 域名白名单已更新

### ✅ 数据库检查

- [ ] 数据库迁移脚本已测试
- [ ] 生产数据库已创建
- [ ] 数据库备份已启用
- [ ] 数据库连接池已配置
- [ ] 索引已创建
- [ ] 外键约束已检查
- [ ] 数据库权限已正确设置

### ✅ 安全检查

- [ ] 所有密钥使用强随机值
- [ ] HTTPS 已启用
- [ ] 安全头已配置（CSP, HSTS等）
- [ ] Rate Limiting 已启用
- [ ] CSRF 保护已启用
- [ ] XSS 防护已启用
- [ ] SQL 注入防护已检查
- [ ] 文件上传限制已设置
- [ ] 敏感数据已加密
- [ ] 安全审计日志已启用

### ✅ 性能优化检查

- [ ] 图片已优化（WebP, 压缩）
- [ ] 代码已压缩（minify）
- [ ] 代码已分割（code splitting）
- [ ] 懒加载已实现
- [ ] 缓存策略已配置
- [ ] CDN 已配置
- [ ] Gzip 压缩已启用
- [ ] 数据库查询已优化
- [ ] N+1 查询问题已解决
- [ ] Redis 缓存已启用

### ✅ 监控配置检查

- [ ] Sentry 错误监控已配置
- [ ] 日志收集已启用
- [ ] 性能监控已启用
- [ ] 正常运行时间监控已设置
- [ ] 告警规则已配置
- [ ] 日志保留策略已设置

### ✅ 备份检查

- [ ] 数据库自动备份已启用
- [ ] 备份存储位置已确认
- [ ] 备份恢复流程已测试
- [ ] 备份保留策略已配置
- [ ] 文件存储备份已配置

---

## 🔄 部署流程（Deployment Process）

### Staging 环境部署

#### 1. 准备阶段
```bash
# 切换到部署分支
git checkout staging

# 拉取最新代码
git pull origin staging

# 安装依赖
npm ci
```

#### 2. 构建阶段
```bash
# 设置环境变量
cp .env.staging .env

# 构建项目
npm run build

# 验证构建产物
ls -la .next/
```

#### 3. 数据库迁移
```bash
# 备份数据库
npm run backup:db

# 执行迁移
npm run db:migrate

# 验证迁移
npm run db:verify
```

#### 4. 部署
```bash
# 使用 Vercel CLI (推荐)
vercel --prod --env-file .env.staging

# 或使用 Docker
docker build -t qiflow-staging .
docker push registry.example.com/qiflow-staging
```

#### 5. 验证
```bash
# 健康检查
curl https://staging.yourdomain.com/api/health

# 验证关键功能
npm run test:e2e -- --env=staging
```

### Production 环境部署

#### 1. 准备阶段
```bash
# 创建发布标签
git tag -a v1.0.0 -m "Release version 1.0.0"
git push origin v1.0.0

# 切换到生产分支
git checkout main
```

#### 2. 预部署检查
```bash
# 运行完整检查清单
npm run pre-deploy:check

# 确认所有测试通过
npm run test:all

# 性能基准测试
npm run test:performance
```

#### 3. 数据库迁移（带回滚计划）
```bash
# 备份生产数据库
npm run backup:db:production

# 在 Staging 上测试迁移
npm run db:migrate:staging

# 生产环境迁移
npm run db:migrate:production

# 验证数据完整性
npm run db:validate
```

#### 4. 灰度发布（推荐）
```bash
# 部署到 10% 流量
vercel --prod --target 10%

# 监控 10 分钟，检查错误率
# 如果正常，逐步增加流量

# 部署到 50% 流量
vercel --prod --target 50%

# 部署到 100% 流量
vercel --prod --target 100%
```

#### 5. 部署后验证
```bash
# 冒烟测试
npm run test:smoke -- --env=production

# 验证关键路径
npm run test:critical-path

# 检查错误监控
# 访问 Sentry 查看是否有新错误
```

---

## 🔍 部署后检查（Post-Deployment）

### ✅ 功能验证

- [ ] 用户注册/登录正常
- [ ] 支付功能正常
- [ ] AI 功能正常
- [ ] 文件上传正常
- [ ] 邮件发送正常
- [ ] 推荐系统正常
- [ ] 签到功能正常
- [ ] 管理后台正常

### ✅ 性能检查

- [ ] 首页加载时间 < 2秒
- [ ] API 响应时间 < 500ms
- [ ] 数据库查询时间 < 100ms
- [ ] CDN 命中率 > 80%
- [ ] 内存使用率 < 70%
- [ ] CPU 使用率 < 60%

### ✅ 监控检查

- [ ] Sentry 正在接收事件
- [ ] 日志正常输出
- [ ] 性能指标正常上报
- [ ] 告警规则生效
- [ ] 备份任务正常运行

### ✅ 安全检查

- [ ] HTTPS 证书有效
- [ ] 安全头正确设置
- [ ] Rate Limiting 工作正常
- [ ] 敏感端点受保护
- [ ] CORS 配置正确

---

## 🚨 回滚计划（Rollback Plan）

### 快速回滚步骤

#### Vercel 部署回滚
```bash
# 方法 1: 通过 Dashboard
# 访问 Vercel Dashboard → Deployments → 选择上一个部署 → Promote to Production

# 方法 2: 通过 CLI
vercel rollback
```

#### 数据库回滚
```bash
# 恢复最近的备份
npm run restore:db -- --backup-file=backup_2025-01-01.sql.gz

# 或者执行回滚迁移
npm run db:rollback
```

#### Docker 部署回滚
```bash
# 回滚到上一个版本
kubectl rollout undo deployment/qiflow

# 验证回滚
kubectl rollout status deployment/qiflow
```

### 回滚决策标准

立即回滚的情况：
- 错误率 > 5%
- 关键功能不可用
- 数据丢失风险
- 安全漏洞发现
- 性能严重下降 (> 50%)

---

## 📊 性能基准（Performance Benchmarks）

### 目标指标

| 指标 | 目标值 | 警告值 | 紧急值 |
|------|--------|--------|--------|
| 首页加载时间 | < 2s | > 3s | > 5s |
| API 响应时间 | < 500ms | > 1s | > 2s |
| 数据库查询 | < 100ms | > 300ms | > 500ms |
| 错误率 | < 0.1% | > 1% | > 5% |
| 可用性 | > 99.9% | < 99.5% | < 99% |
| CPU 使用率 | < 60% | > 80% | > 90% |
| 内存使用率 | < 70% | > 85% | > 95% |

---

## 📞 紧急联系人

### 部署相关联系人

- **技术负责人**: [姓名] - [电话] - [邮箱]
- **运维负责人**: [姓名] - [电话] - [邮箱]
- **产品负责人**: [姓名] - [电话] - [邮箱]
- **On-Call工程师**: [姓名] - [电话] - [邮箱]

### 服务提供商支持

- **云服务商**: [联系方式]
- **CDN提供商**: [联系方式]
- **数据库服务**: [联系方式]
- **监控服务**: [联系方式]

---

## 📝 部署记录模板

```markdown
# 部署记录 - YYYY-MM-DD

## 部署信息
- **版本**: v1.0.0
- **环境**: Production
- **部署人**: [姓名]
- **部署时间**: 2025-01-01 10:00:00
- **Git Commit**: abc1234

## 变更内容
- 新功能 A
- Bug 修复 B
- 性能优化 C

## 部署步骤
1. 备份数据库 - 完成
2. 代码部署 - 完成
3. 数据库迁移 - 完成
4. 功能验证 - 完成

## 部署结果
- **状态**: ✅ 成功
- **影响用户数**: 0
- **停机时间**: 0秒
- **错误数**: 0

## 监控数据
- 部署后错误率: 0.05%
- 平均响应时间: 234ms
- CPU 使用率: 45%
- 内存使用率: 58%

## 备注
无异常
```

---

**最后更新**: 2025-01-01  
**维护者**: DevOps Team
