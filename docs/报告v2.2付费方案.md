# 专业八字风水分析报告 v2.2 付费方案

> 基于现有积分扣费体系的融合方案 | 2025-01-14

---

## 一、现有付费体系分析

### 1.1 当前积分定价（已实施）

根据 `src/lib/qiflow/credit-degradation.ts` 的现有配置：

```typescript
export const CREDIT_COSTS = {
  bazi: {
    full: 10,      // 完整八字分析
    medium: 5,     // 中级八字分析
    lite: 2,       // 基础八字分析
  },
  xuankong: {
    full: 20,      // 完整玄空风水分析
    medium: 10,    // 中级风水分析
    lite: 5,       // 基础风水分析
  },
  aiChat: {
    deep: 30,      // 深度AI分析
    normal: 5,     // 普通AI对话
    simple: 1,     // 简单AI查询
  },
  pdfExport: 5,    // PDF导出
}
```

### 1.2 当前API扣费逻辑（已实施）

**示例：** `src/app/api/qiflow/complete-unified/route.ts`

```typescript
// 完整分析API（八字 + 风水）扣除 30 积分
const REQUIRED_CREDITS = 30;

// 1. 检查积分余额
const balanceResult = await getCreditBalanceAction();
if (balanceResult.data.credits < REQUIRED_CREDITS) {
  return { error: '积分不足', required: 30, available: credits };
}

// 2. 扣除积分
await consumeCreditsAction({
  amount: REQUIRED_CREDITS,
  description: `完整分析（八字+风水） - ${personal.name}`
});
```

### 1.3 降级策略（已实施）

| 积分余额 | 降级等级 | 可用功能 |
|---------|---------|---------|
| >= 100  | **Full** | 完整功能（十神、图表、导出、深度解读） |
| 50-99   | **Medium** | 中级功能（基础分析 + 图表，无导出） |
| 10-49   | **Lite** | 基础功能（仅基本八字/风水信息） |
| < 10    | **Minimum** | 最小功能（查看历史记录） |

---

## 二、报告 v2.2 付费方案设计

### 2.1 核心原则

1. **与现有体系无缝融合**：复用 `CREDIT_COSTS` 和 `consumeCreditsAction`
2. **分层定价，精准计费**：根据报告内容复杂度动态计算积分
3. **渐进式付费体验**：免费预览 → 付费查看完整 → 付费导出
4. **避免重复扣费**：缓存机制 + 报告ID关联用户

### 2.2 报告功能分级与定价

#### 方案A：固定积分模式（推荐）

| 功能 | 积分消耗 | 说明 |
|-----|---------|------|
| **生成完整报告 HTML** | **15 积分** | 包含所有分析结果（八字+风水+整合建议） |
| **导出 PDF** | **5 积分** | 在已生成报告基础上导出 |
| **发送邮件** | **3 积分** | 将报告发送到指定邮箱 |
| **AI 深度解读** | **30 积分** | 基于报告内容的个性化AI咨询（可选） |

**总计费示例**：
- 基础流程（生成报告）：**15 积分**
- 完整流程（生成 + 导出 + 邮件）：**23 积分**
- 旗舰流程（生成 + 导出 + 邮件 + AI 解读）：**53 积分**

#### 方案B：动态计费模式（按内容计费，更精细）

```typescript
// 新增：报告计费配置
export const REPORT_V22_COSTS = {
  base: 10,                          // 基础报告框架
  modules: {
    baziAnalysis: 5,                 // 八字分析模块
    fengshuiAnalysis: 10,            // 风水分析模块
    integratedAdvice: 5,             // 整合建议模块
    charts: 3,                        // 图表可视化
    deepInterpretation: 10,          // 深度解读
  },
  export: {
    html: 0,                          // HTML预览（免费）
    pdf: 5,                           // PDF导出
  },
  delivery: {
    email: 3,                         // 邮件发送
    storage: 0,                       // 云端存储（7天免费）
  },
} as const;

// 计费逻辑示例
function calculateReportCost(options: ReportOptions): number {
  let total = REPORT_V22_COSTS.base;
  
  if (options.includeBazi) total += REPORT_V22_COSTS.modules.baziAnalysis;
  if (options.includeFengshui) total += REPORT_V22_COSTS.modules.fengshuiAnalysis;
  if (options.includeAdvice) total += REPORT_V22_COSTS.modules.integratedAdvice;
  if (options.includeCharts) total += REPORT_V22_COSTS.modules.charts;
  if (options.deepInterpretation) total += REPORT_V22_COSTS.modules.deepInterpretation;
  
  if (options.exportPdf) total += REPORT_V22_COSTS.export.pdf;
  if (options.sendEmail) total += REPORT_V22_COSTS.delivery.email;
  
  return total;
}
```

**优势**：更灵活，用户可按需选择模块  
**劣势**：复杂度高，用户决策成本增加

---

## 三、推荐实施方案（方案A + 优化）

### 3.1 定价表（最终版）

| 操作 | 积分 | 备注 |
|-----|------|------|
| 🆓 **预览报告（仅首屏）** | **0** | 展示报告前30%内容，吸引付费 |
| ✅ **生成完整报告 v2.2** | **15** | 包含八字+风水+整合建议，在线查看 |
| 📄 **导出 PDF** | **5** | 需已生成报告 |
| 📧 **发送邮件** | **3** | 需已生成报告 |
| 🤖 **AI 深度咨询** | **30** | 独立功能，可选 |

### 3.2 与现有体系对比

| 功能 | 现有费用 | 报告 v2.2 费用 | 差异说明 |
|-----|---------|---------------|---------|
| 八字分析（完整） | 10 积分 | 包含在15积分内 | 新报告价格更优惠 |
| 风水分析（完整） | 20 积分 | 包含在15积分内 | 新报告价格更优惠 |
| 八字+风水组合 | 30 积分 | **15 积分** | **节省 50%** |
| PDF导出 | 5 积分 | 5 积分 | 保持不变 |
| AI深度分析 | 30 积分 | 30 积分 | 保持不变 |

**定价策略**：报告 v2.2 作为"套餐优惠"，单独生成报告比分别调用API更划算，引导用户使用新报告功能。

### 3.3 代码实现示例

#### 3.3.1 新增报告积分配置

```typescript
// src/lib/qiflow/credit-degradation.ts

export const CREDIT_COSTS = {
  // ... 现有配置 ...
  
  // 新增：报告 v2.2
  reportV22: {
    generate: 15,        // 生成完整报告（套餐价，包含八字+风水+建议）
    preview: 0,          // 预览（免费）
    exportPdf: 5,        // 导出PDF
    sendEmail: 3,        // 发送邮件
  },
} as const;
```

#### 3.3.2 API 扣费实现

```typescript
// src/app/api/reports/v2-2/generate/route.ts

import { consumeCreditsAction } from '@/actions/consume-credits';
import { getCreditBalanceAction } from '@/actions/get-credit-balance';
import { CREDIT_COSTS } from '@/lib/qiflow/credit-degradation';
import { auth } from '@/lib/auth';

export async function POST(req: NextRequest) {
  // 1. 验证登录
  const session = await auth.api.getSession({ headers: req.headers });
  if (!session?.user) {
    return NextResponse.json({ error: '请先登录' }, { status: 401 });
  }

  // 2. 解析请求参数
  const body = await req.json();
  const { preview = false, exportPdf = false } = body;

  // 3. 计算所需积分
  let requiredCredits = 0;
  if (!preview) {
    requiredCredits += CREDIT_COSTS.reportV22.generate; // 15 积分
  }
  if (exportPdf) {
    requiredCredits += CREDIT_COSTS.reportV22.exportPdf; // +5 积分
  }

  // 4. 检查积分余额（预览模式跳过）
  if (requiredCredits > 0) {
    const balance = await getCreditBalanceAction();
    
    if (!balance?.data?.success || balance.data.credits < requiredCredits) {
      return NextResponse.json({
        error: '积分不足',
        required: requiredCredits,
        available: balance?.data?.credits || 0,
        needsCredits: true,
      }, { status: 402 });
    }

    // 5. 扣除积分
    const consumeResult = await consumeCreditsAction({
      amount: requiredCredits,
      description: `生成专业报告 v2.2 - ${session.user.name}`,
    });

    if (!consumeResult?.data?.success) {
      return NextResponse.json(
        { error: '积分扣除失败', details: consumeResult?.data?.error },
        { status: 500 }
      );
    }
  }

  // 6. 生成报告（复用现有八字+风水引擎）
  // ... 报告生成逻辑 ...

  return NextResponse.json({
    success: true,
    reportId: 'xxx',
    reportUrl: '/report/xxx',
    creditsUsed: requiredCredits,
    remainingCredits: (balance?.data?.credits || 0) - requiredCredits,
  });
}
```

#### 3.3.3 前端积分提示

```tsx
// src/components/home/HeroWithForm.tsx

import { useCreditBalance } from '@/hooks/use-credits';
import { CREDIT_COSTS } from '@/lib/qiflow/credit-degradation';

export function HeroWithForm() {
  const { data: credits } = useCreditBalance();
  const REQUIRED = CREDIT_COSTS.reportV22.generate; // 15

  const canAfford = (credits ?? 0) >= REQUIRED;

  return (
    <div>
      {/* 积分提示 */}
      <div className="mb-3 text-center text-sm">
        <span className="text-muted-foreground">当前积分: </span>
        <span className={`font-bold ${canAfford ? 'text-primary' : 'text-destructive'}`}>
          {credits ?? 0}
        </span>
        <span className="text-muted-foreground"> / 需要 {REQUIRED}</span>
      </div>

      {/* 生成按钮 */}
      <Button
        onClick={handleGenerate}
        disabled={!canAfford}
        className="w-full"
      >
        {!canAfford && <Lock className="w-4 h-4 mr-2" />}
        生成专业报告（{REQUIRED} 积分）
      </Button>

      {!canAfford && (
        <p className="mt-2 text-xs text-destructive text-center">
          积分不足，
          <Link href="/settings/credits" className="underline">去充值</Link>
        </p>
      )}
    </div>
  );
}
```

---

## 四、防止重复扣费机制

### 4.1 报告缓存策略

```typescript
// src/lib/report-cache.ts

interface ReportCache {
  reportId: string;
  userId: string;
  inputHash: string;      // 输入参数的hash
  reportHtml: string;
  creditsCharged: number;
  expiresAt: Date;        // 7天后过期
  createdAt: Date;
}

export async function getCachedReport(
  userId: string,
  inputHash: string
): Promise<ReportCache | null> {
  // 1. 从Redis/DB查询缓存
  const cached = await redis.get(`report:${userId}:${inputHash}`);
  
  if (cached && new Date(cached.expiresAt) > new Date()) {
    return cached; // 返回缓存，不重复扣费
  }
  
  return null;
}

export async function cacheReport(data: ReportCache): Promise<void> {
  await redis.setex(
    `report:${data.userId}:${data.inputHash}`,
    7 * 24 * 3600, // 7天
    JSON.stringify(data)
  );
}
```

### 4.2 API 中的缓存检查

```typescript
// 在扣费前检查缓存
const inputHash = createHash('sha256')
  .update(JSON.stringify(body))
  .digest('hex');

const cachedReport = await getCachedReport(session.user.id, inputHash);

if (cachedReport) {
  // 直接返回缓存结果，不扣费
  return NextResponse.json({
    success: true,
    reportId: cachedReport.reportId,
    reportHtml: cachedReport.reportHtml,
    fromCache: true,
    creditsUsed: 0, // 未扣费
  });
}

// 否则继续扣费 + 生成 + 缓存
```

---

## 五、用户体验优化

### 5.1 分步付费流程

```
步骤1: 免费预览报告 (0积分)
   ↓
[查看前30%内容，激发兴趣]
   ↓
步骤2: 解锁完整报告 (15积分)
   ↓
[在线查看完整HTML]
   ↓
步骤3: 导出PDF (5积分) [可选]
   ↓
步骤4: 发送邮件 (3积分) [可选]
```

### 5.2 前端提示文案

```tsx
// 生成报告按钮下方提示
<p className="text-xs text-center text-muted-foreground">
  💡 无需注册 · 3分钟生成 · 首次体验<span className="line-through">免费</span> 15积分
</p>

// 或者更清晰的分层提示
<div className="text-xs text-muted-foreground space-y-1">
  <p>🆓 免费预览（查看部分内容）</p>
  <p>✅ 完整报告 15 积分</p>
  <p>📄 PDF导出 +5 积分</p>
  <p>📧 邮件发送 +3 积分</p>
</div>
```

### 5.3 积分不足时的引导

```tsx
if (!canAfford) {
  return (
    <Card className="p-4 bg-muted/50">
      <h3 className="font-semibold">积分不足</h3>
      <p className="text-sm text-muted-foreground mt-2">
        您当前有 {credits} 积分，生成报告需要 {REQUIRED} 积分
      </p>
      
      <div className="mt-4 flex gap-2">
        <Button variant="default" asChild>
          <Link href="/settings/credits">立即充值</Link>
        </Button>
        <Button variant="outline" onClick={() => setPreviewMode(true)}>
          免费预览
        </Button>
      </div>
    </Card>
  );
}
```

---

## 六、数据库Schema建议

```sql
-- 报告生成记录表
CREATE TABLE generated_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  
  -- 报告元信息
  report_version VARCHAR(10) NOT NULL DEFAULT 'v2.2',
  report_type VARCHAR(20) NOT NULL, -- 'bazi', 'fengshui', 'combined'
  input_hash VARCHAR(64) NOT NULL,  -- 输入参数hash，用于去重
  
  -- 费用信息
  credits_charged INTEGER NOT NULL DEFAULT 0,
  
  -- 存储信息
  html_content TEXT,                -- HTML报告内容
  pdf_url TEXT,                     -- PDF下载链接（如有）
  storage_path TEXT,                -- 文件存储路径
  
  -- 时间戳
  generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,             -- 7天后过期（非专业版）
  last_viewed_at TIMESTAMP,
  view_count INTEGER DEFAULT 0,
  
  -- 索引
  UNIQUE(user_id, input_hash),      -- 防止重复生成
  INDEX idx_user_generated (user_id, generated_at DESC),
  INDEX idx_expires (expires_at)
);
```

---

## 七、实施清单

### 高优先级（立即实施）

- [ ] **更新 `credit-degradation.ts`**：添加 `reportV22` 配置
- [ ] **创建 API 路由**：`/api/reports/v2-2/generate`
- [ ] **实现扣费逻辑**：检查积分 → 扣费 → 生成报告
- [ ] **前端积分显示**：在表单下方显示当前积分和所需积分
- [ ] **修复文案错别字**：将"免货"改为"免费"

### 中优先级（1周内）

- [ ] **实现报告缓存**：防止重复扣费
- [ ] **添加预览模式**：免费查看报告前30%
- [ ] **PDF导出功能**：在已生成报告基础上导出
- [ ] **数据库表创建**：`generated_reports` 表

### 低优先级（后续迭代）

- [ ] **邮件发送功能**
- [ ] **报告历史记录页面**
- [ ] **AI深度解读（30积分）**
- [ ] **订阅用户免费特权**

---

## 八、关键决策点

### ✅ 最终建议

1. **定价**：生成报告 **15 积分**（比单独调用八字10+风水20更优惠）
2. **扣费时机**：点击"生成报告"按钮时立即扣费，生成后缓存7天
3. **防重复扣费**：基于 `inputHash` 的缓存机制
4. **文案优化**：去掉"免费"误导，改为"15积分生成"
5. **用户引导**：提供"免费预览"模式，降低付费门槛

### ❌ 不建议

- ❌ 动态计费（复杂度高，用户体验差）
- ❌ 完全免费（与现有积分体系冲突）
- ❌ 高于30积分定价（失去相对于API的优势）

---

## 九、对照现有文档的补充说明

参考 `docs/付费逻辑和命名规范建议.md` 中的建议：

| 原建议 | 本方案采纳情况 | 说明 |
|--------|--------------|------|
| 生成专业报告 5积分 | ❌ **改为15积分** | 考虑到包含八字+风水双重分析，5积分过低 |
| 导出HTML 3积分 | ✅ **HTML免费，PDF收费5积分** | HTML作为在线查看免费，导出PDF收费 |
| 发送邮件 3积分 | ✅ **采纳** | 保持3积分不变 |
| 每日免费次数限制 | ⏸️ **暂缓** | 当前优先实现积分体系，后续可添加免费额度 |

---

## 十、总结

**报告 v2.2 定价方案（最终版）**：

| 操作 | 积分 | 说明 |
|-----|------|------|
| 生成完整报告 | **15** | 含八字+风水+整合建议 |
| 导出PDF | **5** | 需已生成报告 |
| 发送邮件 | **3** | 需已生成报告 |
| **总计（全流程）** | **23** | 比分开调用API节省25% |

**核心优势**：
1. ✅ 无缝融合现有积分体系
2. ✅ 套餐价格更优惠，引导用户使用报告功能
3. ✅ 防重复扣费机制完善
4. ✅ 渐进式付费体验（预览→完整→导出）

**下一步行动**：
1. 更新 `CREDIT_COSTS` 配置
2. 创建报告生成API并实现扣费
3. 前端添加积分显示和提示
4. 修复"免货"错别字为"免费"
