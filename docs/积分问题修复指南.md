# 个人后台积分问题修复指南

## 问题描述

个人后台不显示积分,不能签到,提示数据库没有连接。

## 问题诊断步骤

### 1. 检查数据库连接

运行数据库连接测试脚本:

```bash
# 使用 tsx 运行测试脚本
npx tsx scripts/test-credits-db.ts

# 或使用 ts-node
ts-node scripts/test-credits-db.ts
```

该脚本会检查:
- ✅ 数据库连接是否正常
- ✅ 用户表是否有数据
- ✅ 积分表是否有数据
- ✅ 积分交易表是否有数据
- ✅ 用户和积分的关联是否正确

### 2. 检查环境变量

确认 `.env` 或 `.env.local` 文件中包含正确的数据库连接字符串:

```env
DATABASE_URL=postgresql://postgres:password@host:port/database
SESSION_DATABASE_URL=postgresql://postgres:password@host:port/database
DIRECT_DATABASE_URL=postgresql://postgres:password@host:port/database
```

### 3. 检查数据库迁移

确保所有数据库迁移已执行:

```bash
npm run db:push
# 或
npm run db:migrate
```

## 常见问题及解决方案

### 问题 1: 数据库连接失败

**症状**: 控制台显示 "Failed to get user balance" 或类似错误

**解决方案**:
1. 检查数据库服务是否运行
2. 验证数据库连接字符串是否正确
3. 检查网络连接(特别是使用 Supabase 等云数据库时)
4. 尝试使用不同的连接模式(Transaction Pooler vs Session Pooler)

```bash
# 测试数据库连接
npm run test:db
```

### 问题 2: 积分表为空

**症状**: 数据库连接正常,但用户没有积分记录

**解决方案**:
运行积分初始化脚本:

```bash
npx tsx scripts/init-user-credits.ts
```

这会为所有现有用户创建初始积分记录(默认 100 积分)。

### 问题 3: 签到功能不工作

**症状**: 点击签到按钮没有反应或报错

**可能原因**:
1. API 路由未正确配置
2. 用户未登录
3. 数据库连接问题

**解决方案**:
1. 检查浏览器控制台是否有错误
2. 检查 `/api/credits/daily-signin` 路由是否可访问
3. 查看服务器日志获取详细错误信息

```bash
# 启动开发服务器并查看日志
npm run dev
```

### 问题 4: 前端不显示积分

**症状**: 个人后台积分显示为 0 或不显示

**解决方案**:

1. **检查用户是否登录**:
```typescript
// 在浏览器控制台检查
console.log(document.cookie);
```

2. **检查 API 响应**:
在浏览器开发者工具 Network 标签中查看积分相关的 API 请求。

3. **检查组件状态**:
积分显示组件 `StatsGrid` 依赖 `stats.credits` 属性,确保该属性被正确传递。

4. **清除缓存并刷新**:
```bash
# 清除 Next.js 缓存
rm -rf .next
npm run dev
```

## 修复内容说明

### 1. 修复签到功能 (`perform-signin.ts`)

将原来的模拟数据替换为真实的 API 调用:
- ✅ 调用 `/api/credits/daily-signin` 接口
- ✅ 正确处理已签到状态
- ✅ 刷新相关页面缓存
- ✅ 返回正确的签到数据

### 2. 增强积分管理器 (`manager.ts`)

添加详细的日志记录:
- ✅ 记录每次积分查询
- ✅ 记录数据库连接状态
- ✅ 记录错误详情和堆栈
- ✅ 验证 userId 非空

### 3. 添加诊断工具

创建了两个实用脚本:
- `test-credits-db.ts`: 测试数据库连接和积分数据
- `init-user-credits.ts`: 为用户初始化积分记录

## 使用流程

### 首次设置

1. 运行诊断脚本:
```bash
npx tsx scripts/test-credits-db.ts
```

2. 如果积分表为空,运行初始化脚本:
```bash
npx tsx scripts/init-user-credits.ts
```

3. 重启开发服务器:
```bash
npm run dev
```

4. 登录并访问个人后台,检查积分是否正常显示

### 日常维护

定期检查:
- 数据库连接状态
- 积分表数据完整性
- 签到功能是否正常
- 积分交易记录是否准确

## 监控和日志

### 服务器端日志

积分管理器现在会输出详细日志:
```
[积分管理] 获取用户积分余额, userId: xxx
[积分管理] 数据库连接成功
[积分管理] 用户积分余额: 100
```

### 客户端日志

浏览器控制台会显示签到相关的状态和错误。

## 相关文件

- `src/app/actions/daily-signin/perform-signin.ts` - 签到逻辑
- `src/app/api/credits/daily-signin/route.ts` - 签到 API
- `src/lib/credits/manager.ts` - 积分管理器
- `src/components/dashboard/personal/stats-grid.tsx` - 积分显示组件
- `src/components/dashboard/personal/activity-section.tsx` - 签到组件
- `scripts/test-credits-db.ts` - 数据库测试脚本
- `scripts/init-user-credits.ts` - 积分初始化脚本

## 技术支持

如果问题仍未解决,请提供以下信息:

1. 运行 `test-credits-db.ts` 的完整输出
2. 浏览器控制台的错误信息
3. 服务器日志中的相关错误
4. 数据库连接配置(隐藏密码)

## 预防措施

为避免类似问题,建议:

1. **用户注册时自动创建积分记录**:
在用户注册流程中添加积分初始化逻辑

2. **添加健康检查端点**:
创建 `/api/health` 端点检查数据库连接状态

3. **监控积分数据完整性**:
定期运行脚本检查用户积分数据

4. **完善错误提示**:
在前端显示更友好的错误信息,而不是静默失败

## 更新日志

- 2025-10-19: 初始版本
  - 修复签到功能数据库集成
  - 增强积分管理器日志
  - 添加诊断和初始化脚本
