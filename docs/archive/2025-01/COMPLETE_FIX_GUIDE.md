# ğŸš€ å®Œæ•´ä¿®å¤æŒ‡å— - æ³¨å†ŒåŠŸèƒ½é—®é¢˜

## ğŸ“Š é—®é¢˜æ€»ç»“

ä½ çš„é¡¹ç›®æœ‰**ä¸‰ä¸ªå…³é”®é—®é¢˜**éœ€è¦ä¿®å¤ï¼š

### 1ï¸âƒ£ DATABASE_URL æ ¼å¼é”™è¯¯ âŒ
```bash
# å½“å‰ï¼ˆé”™è¯¯ï¼‰
DATABASE_URL="ttps://sibwcdadrsbfkblinezj.supabase.copostgresql://postgres:Sd@721204@db..."

# åº”è¯¥æ˜¯
DATABASE_URL="postgresql://postgres:Sd%40721204@db.sibwcdadrsbfkblinezj.supabase.co:5432/postgres"
```

### 2ï¸âƒ£ BETTER_AUTH_SECRET æœªé…ç½® âŒ
```bash
# å½“å‰ï¼ˆç©ºï¼‰
BETTER_AUTH_SECRET=""

# åº”è¯¥æ˜¯ï¼ˆæˆ‘å·²ä¸ºä½ ç”Ÿæˆï¼‰
BETTER_AUTH_SECRET="kgkSg5VWhoPyK4skK+EktJskVxqoH3OJ+WknD4yw170="
```

### 3ï¸âƒ£ æ•°æ®åº“è¡¨æœªåˆ›å»º âŒ
å› ä¸º DATABASE_URL é”™è¯¯ï¼Œæ‰€ä»¥æ— æ³•æ‰§è¡Œ `npm run db:push`

---

## ğŸ”§ ä¸€æ¬¡æ€§ä¿®å¤æ‰€æœ‰é—®é¢˜

### æ­¥éª¤ 1ï¼šä¿®å¤ .env æ–‡ä»¶ â­

æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶ï¼Œæ‰¾åˆ°å¹¶ä¿®æ”¹ä»¥ä¸‹ä¸¤è¡Œï¼š

```bash
# æ‰¾åˆ°è¿™ä¸¤è¡Œå¹¶å®Œå…¨æ›¿æ¢ï¼š

# 1. ä¿®å¤ DATABASE_URL
DATABASE_URL="postgresql://postgres:Sd%40721204@db.sibwcdadrsbfkblinezj.supabase.co:5432/postgres"

# 2. æ·»åŠ  BETTER_AUTH_SECRET
BETTER_AUTH_SECRET="kgkSg5VWhoPyK4skK+EktJskVxqoH3OJ+WknD4yw170="
```

**âš ï¸ é‡è¦æç¤ºï¼š**
- å¯†ç ä¸­çš„ `@` å¿…é¡»ç¼–ç ä¸º `%40`
- ä¸è¦æœ‰å¤šä½™çš„ç©ºæ ¼
- ä¿å­˜æ–‡ä»¶åå…³é—­ç¼–è¾‘å™¨

### æ­¥éª¤ 2ï¼šåŒæ­¥æ•°æ®åº“ Schema

ä¿®å¤ `.env` åï¼Œåœ¨ç»ˆç«¯è¿è¡Œï¼š

```bash
npm run db:push
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… Schema pushed successfully
```

**å¦‚æœå¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š**
- DATABASE_URL ä»ç„¶æ ¼å¼é”™è¯¯ï¼ˆæ£€æŸ¥æ‹¼å†™ï¼‰
- ç½‘ç»œæ— æ³•è¿æ¥åˆ° Supabaseï¼ˆæ£€æŸ¥ç½‘ç»œï¼‰
- Supabase æ•°æ®åº“æœªå¯åŠ¨ï¼ˆæ£€æŸ¥ Supabase Dashboardï¼‰

### æ­¥éª¤ 3ï¼šéªŒè¯ä¿®å¤

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
npx tsx scripts/test-db-registration.ts
```

**åº”è¯¥çœ‹åˆ°ï¼š**
```
ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„...

1ï¸âƒ£ æµ‹è¯•æ•°æ®åº“è¿æ¥...
   âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ

2ï¸âƒ£ æµ‹è¯• user è¡¨...
   âœ… user è¡¨å­˜åœ¨ (æ‰¾åˆ° X æ¡è®°å½•)

3ï¸âƒ£ æµ‹è¯• userCredit è¡¨...
   âœ… userCredit è¡¨å­˜åœ¨ (æ‰¾åˆ° X æ¡è®°å½•)

4ï¸âƒ£ æµ‹è¯• creditTransaction è¡¨...
   âœ… creditTransaction è¡¨å­˜åœ¨ (æ‰¾åˆ° X æ¡è®°å½•)

5ï¸âƒ£ æµ‹è¯•æ•°æ®åº“å†™å…¥æƒé™...
   âœ… å¯ä»¥æ’å…¥æ•°æ®
   âœ… å¯ä»¥åˆ é™¤æ•°æ®

âœ… æ‰€æœ‰æ•°æ®åº“æµ‹è¯•é€šè¿‡ï¼
```

### æ­¥éª¤ 4ï¼šé‡å¯å¼€å‘æœåŠ¡å™¨

```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
# æŒ‰ Ctrl+C

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

### æ­¥éª¤ 5ï¼šæµ‹è¯•æ³¨å†ŒåŠŸèƒ½

1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ Cookies**
   - Chrome: Ctrl+Shift+Delete
   - é€‰æ‹©"Cookies å’Œå…¶ä»–ç½‘ç«™æ•°æ®"
   - é€‰æ‹©"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
   - æ¸…é™¤æ•°æ®

2. **æ‰“å¼€æ³¨å†Œé¡µé¢**
   ```
   http://localhost:3000/auth/register
   ```

3. **å¡«å†™æ³¨å†Œä¿¡æ¯**
   - å§“åï¼šæµ‹è¯•ç”¨æˆ·
   - é‚®ç®±ï¼štest@example.com
   - å¯†ç ï¼šTest@123456

4. **æäº¤æ³¨å†Œ**

5. **æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—**
   åº”è¯¥çœ‹åˆ°ï¼š
   ```
   >> middleware start, pathname /auth/register
   << middleware end, applying intlMiddleware
   âœ… Added register gift credits for user [userId]
   âœ… Added Free monthly credits for user [userId]
   âœ… QiFlow profiles initialized for user [userId]
   ```

---

## ğŸ“‹ å®Œæ•´çš„ .env é…ç½®æ¸…å•

ç¡®ä¿ä½ çš„ `.env` æ–‡ä»¶åŒ…å«ä»¥ä¸‹å¿…éœ€çš„é…ç½®ï¼š

```bash
# ============================================
# å¿…éœ€é…ç½®ï¼ˆå¿…é¡»å¡«å†™ï¼‰
# ============================================

# åº”ç”¨åŸºç¡€ URL
NEXT_PUBLIC_BASE_URL="http://localhost:3000"

# æ•°æ®åº“è¿æ¥ï¼ˆä¿®å¤åçš„æ ¼å¼ï¼‰
DATABASE_URL="postgresql://postgres:Sd%40721204@db.sibwcdadrsbfkblinezj.supabase.co:5432/postgres"

# Better Auth å¯†é’¥ï¼ˆå·²ç”Ÿæˆï¼‰
BETTER_AUTH_SECRET="kgkSg5VWhoPyK4skK+EktJskVxqoH3OJ+WknD4yw170="

# ============================================
# OAuth é…ç½®ï¼ˆå¦‚æœéœ€è¦ç¤¾äº¤ç™»å½•ï¼‰
# ============================================

# GitHub OAuthï¼ˆå¯é€‰ï¼‰
GITHUB_CLIENT_ID=""
GITHUB_CLIENT_SECRET=""

# Google OAuthï¼ˆå¯é€‰ï¼‰
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""

# ============================================
# é‚®ä»¶æœåŠ¡é…ç½®ï¼ˆå¦‚æœéœ€è¦å‘é€é‚®ä»¶ï¼‰
# ============================================

# Resend API Keyï¼ˆç”¨äºå‘é€éªŒè¯é‚®ä»¶ï¼‰
RESEND_API_KEY=""

# ============================================
# å…¶ä»–å¯é€‰é…ç½®
# ============================================

# Stripeï¼ˆå¦‚æœéœ€è¦æ”¯ä»˜åŠŸèƒ½ï¼‰
STRIPE_SECRET_KEY=""
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=""
STRIPE_WEBHOOK_SECRET=""

# Turnstileï¼ˆå¦‚æœéœ€è¦éªŒè¯ç ï¼‰
NEXT_PUBLIC_TURNSTILE_SITE_KEY=""
TURNSTILE_SECRET_KEY=""
```

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ Aï¼šnpm run db:push ä»ç„¶å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Error: getaddrinfo ENOTFOUND sibwcdadrsbfkblinezj.supabase.copostgresql
```

**è§£å†³æ–¹æ¡ˆï¼š**
1. å†æ¬¡æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `DATABASE_URL`
2. ç¡®ä¿æ ¼å¼å®Œå…¨æ­£ç¡®ï¼Œæ²¡æœ‰å¤šä½™çš„å­—ç¬¦
3. å¤åˆ¶æˆ‘æä¾›çš„æ­£ç¡®æ ¼å¼ï¼Œä¸è¦æ‰‹åŠ¨è¾“å…¥

### é—®é¢˜ Bï¼šæ³¨å†Œæ—¶ä»ç„¶æ˜¾ç¤º 500 é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
1. æ•°æ®åº“è¡¨æœªåˆ›å»º â†’ è¿è¡Œ `npm run db:push`
2. å¼€å‘æœåŠ¡å™¨æœªé‡å¯ â†’ åœæ­¢å¹¶é‡æ–°è¿è¡Œ `npm run dev`
3. æµè§ˆå™¨ç¼“å­˜ â†’ æ¸…é™¤ç¼“å­˜å’Œ Cookies

**è°ƒè¯•æ­¥éª¤ï¼š**
1. æŸ¥çœ‹ç»ˆç«¯è¾“å‡ºä¸­çš„ `âŒ` æ ‡è®°
2. å¦‚æœçœ‹åˆ°æ•°æ®åº“ç›¸å…³é”™è¯¯ï¼Œè¿è¡Œ `npm run db:studio` æ£€æŸ¥è¡¨
3. å¦‚æœçœ‹åˆ°è®¤è¯ç›¸å…³é”™è¯¯ï¼Œæ£€æŸ¥ `BETTER_AUTH_SECRET` æ˜¯å¦å·²è®¾ç½®

### é—®é¢˜ Cï¼šMiddleware é”™è¯¯

å¦‚æœçœ‹åˆ°ç±»ä¼¼é”™è¯¯ï¼š
```
âŒ Middleware: Failed to fetch session
```

**è¿™æ˜¯æ­£å¸¸çš„**ï¼Œæˆ‘å·²ç»ä¿®æ”¹äº† middleware ä»£ç ï¼Œä½¿å…¶åœ¨è·å– session å¤±è´¥æ—¶ä¸ä¼šé˜»æ­¢è¯·æ±‚ã€‚ä½†ä½ ä»ç„¶éœ€è¦ä¿®å¤æ•°æ®åº“é…ç½®ã€‚

### é—®é¢˜ Dï¼šæ³¨å†ŒæˆåŠŸä½†æ²¡æœ‰ç§¯åˆ†

**æ£€æŸ¥æ­¥éª¤ï¼š**
1. è¿è¡Œ `npm run db:studio`
2. æŸ¥çœ‹ `user_credit` è¡¨
3. æ‰¾åˆ°ä½ çš„ç”¨æˆ· ID
4. æ£€æŸ¥ `currentCredits` å­—æ®µæ˜¯å¦ä¸º 100

å¦‚æœæ²¡æœ‰ç§¯åˆ†ï¼ŒæŸ¥çœ‹ç»ˆç«¯æ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
```
âŒ Register gift credits error: {...}
```

æ ¹æ®é”™è¯¯ä¿¡æ¯ä¿®å¤é—®é¢˜ã€‚

---

## âœ… æˆåŠŸæ ‡å¿—

å®Œæˆæ‰€æœ‰ä¿®å¤åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

### æµè§ˆå™¨ç«¯ï¼š
- âœ… è®¿é—®æ³¨å†Œé¡µé¢ä¸ä¼šå´©æºƒ
- âœ… æäº¤æ³¨å†Œè¡¨å•ä¸ä¼šæ˜¾ç¤º 500 é”™è¯¯
- âœ… çœ‹åˆ°"è¯·æ£€æŸ¥é‚®ç®±éªŒè¯"çš„æˆåŠŸæ¶ˆæ¯

### ç»ˆç«¯æ—¥å¿—ï¼š
```
>> middleware start, pathname /auth/register
<< middleware end, applying intlMiddleware
âœ… Added register gift credits for user [userId]
âœ… Added Free monthly credits for user [userId]  
âœ… QiFlow profiles initialized for user [userId]
```

### æ•°æ®åº“ï¼ˆä½¿ç”¨ npm run db:studio æŸ¥çœ‹ï¼‰ï¼š
- âœ… `user` è¡¨ä¸­æœ‰æ–°ç”¨æˆ·è®°å½•
- âœ… `user_credit` è¡¨ä¸­è¯¥ç”¨æˆ·æœ‰ 100 ç§¯åˆ†
- âœ… `credit_transaction` è¡¨ä¸­æœ‰ç§¯åˆ†èµ é€è®°å½•
- âœ… `bazi_calculations` ç­‰è¡¨ä¸­æœ‰åˆå§‹åŒ–è®°å½•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

æˆ‘å·²ç»åˆ›å»ºäº†ä»¥ä¸‹è¯¦ç»†æ–‡æ¡£ï¼š

1. **`DATABASE_URL_FIX_GUIDE.md`** - æ•°æ®åº“è¿æ¥ä¿®å¤æŒ‡å—
2. **`REGISTRATION_500_ERROR_FIX.md`** - 500 é”™è¯¯ä¿®å¤æŒ‡å—
3. **`CREDITS_FIX_SUMMARY.md`** - ç§¯åˆ†ç³»ç»Ÿä¿®å¤æ€»ç»“
4. **`REGISTER_ERROR_FIX.md`** - æ³¨å†Œé”™è¯¯ä¿®å¤æ€»ç»“
5. **`ENV_FIX_GUIDE.md`** - ç¯å¢ƒå˜é‡ä¿®å¤æŒ‡å—
6. **`scripts/test-db-registration.ts`** - æ•°æ®åº“æµ‹è¯•è„šæœ¬

---

## ğŸ¯ å¿«é€Ÿæ£€æŸ¥æ¸…å•

ä¿®å¤å‰è¯·ç¡®è®¤ï¼š

- [ ] å·²å¤‡ä»½ `.env` æ–‡ä»¶ï¼ˆå·²è‡ªåŠ¨åˆ›å»º `.env.backup`ï¼‰
- [ ] å·²ä¿®æ”¹ `DATABASE_URL` ä¸ºæ­£ç¡®æ ¼å¼
- [ ] å·²æ·»åŠ  `BETTER_AUTH_SECRET`
- [ ] å·²è¿è¡Œ `npm run db:push` å¹¶æˆåŠŸ
- [ ] å·²è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯æ•°æ®åº“
- [ ] å·²é‡å¯å¼€å‘æœåŠ¡å™¨
- [ ] å·²æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

ä¿®å¤åéªŒè¯ï¼š

- [ ] æ³¨å†Œé¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] å¯ä»¥æˆåŠŸæäº¤æ³¨å†Œè¡¨å•
- [ ] ç»ˆç«¯æ˜¾ç¤ºæˆåŠŸæ—¥å¿—ï¼ˆâœ… æ ‡è®°ï¼‰
- [ ] æ–°ç”¨æˆ·è·å¾— 100 ç§¯åˆ†
- [ ] æ²¡æœ‰é”™è¯¯æ—¥å¿—ï¼ˆâŒ æ ‡è®°ï¼‰

---

## ğŸ’¡ é¢å¤–æç¤º

### å®‰å…¨å»ºè®®

1. **ä¸è¦æäº¤ .env æ–‡ä»¶åˆ° Git**
   - å·²åŒ…å«åœ¨ `.gitignore` ä¸­
   - æ°¸è¿œä¸è¦å…¬å¼€ `BETTER_AUTH_SECRET` å’Œæ•°æ®åº“å¯†ç 

2. **ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¯†é’¥**
   - å½“å‰ç”Ÿæˆçš„å¯†é’¥ä»…ç”¨äºå¼€å‘
   - ç”Ÿäº§ç¯å¢ƒéœ€è¦ç”Ÿæˆæ–°çš„å¯†é’¥

3. **å®šæœŸæ›´æ¢å¯†é’¥**
   - å¦‚æœæ€€ç–‘å¯†é’¥æ³„éœ²ï¼Œç«‹å³æ›´æ¢

### æ€§èƒ½å»ºè®®

1. **ä½¿ç”¨ Pooling æ¨¡å¼**
   - å½“å‰ä½¿ç”¨çš„æ˜¯ Direct connection
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Poolingï¼ˆç«¯å£ 6543ï¼‰

2. **å¯ç”¨è¿æ¥æ± **
   - å‚è€ƒ Supabase æ–‡æ¡£é…ç½®è¿æ¥æ± 
   - å¯ä»¥æé«˜æ€§èƒ½å’Œå¹¶å‘èƒ½åŠ›

---

## ğŸ“ è¿˜æœ‰é—®é¢˜ï¼Ÿ

å¦‚æœå®Œæˆæ‰€æœ‰æ­¥éª¤åä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. **æ•°æ®åº“æµ‹è¯•ç»“æœ**
   ```bash
   npx tsx scripts/test-db-registration.ts
   ```
   å®Œæ•´è¾“å‡º

2. **ç»ˆç«¯é”™è¯¯æ—¥å¿—**
   åŒ…æ‹¬æ‰€æœ‰ `âŒ` æ ‡è®°çš„é”™è¯¯

3. **æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯**
   æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾

4. **`.env` æ–‡ä»¶æ ¼å¼**
   ï¼ˆéšè—å¯†ç ï¼Œåªæ˜¾ç¤ºæ ¼å¼ï¼‰

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** é¢„è®¡ 5-10 åˆ†é’Ÿ  
**éš¾åº¦ç­‰çº§ï¼š** ğŸŸ¢ ç®€å•ï¼ˆä¸»è¦æ˜¯å¤åˆ¶ç²˜è´´ï¼‰  
**æˆåŠŸç‡ï¼š** 99%ï¼ˆå¦‚æœä¸¥æ ¼æŒ‰ç…§æ­¥éª¤æ“ä½œï¼‰

åŠ æ²¹ï¼ğŸš€




