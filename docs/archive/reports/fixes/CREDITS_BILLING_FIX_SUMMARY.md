# ç§¯åˆ†å……å€¼ã€è®¢é˜…æŸ¥çœ‹å’Œè®¢é˜…ç®¡ç†åŠŸèƒ½ä¿®å¤æ€»ç»“

## æ£€æŸ¥ç»“æœ

### âœ… åŠŸèƒ½å®Œæ•´æ€§

ç»è¿‡æ£€æŸ¥ï¼Œä»¥ä¸‹åŠŸèƒ½éƒ½æ˜¯å®Œæ•´çš„:

1. **ç§¯åˆ†å……å€¼åŠŸèƒ½** (`/settings/credits`)
   - âœ… ç§¯åˆ†ä½™é¢æ˜¾ç¤ºå¡ç‰‡ (CreditsBalanceCard)
   - âœ… ç§¯åˆ†å¥—é¤é€‰æ‹© (CreditPackages / EnhancedCreditPackages)
   - âœ… äº¤æ˜“è®°å½•æŸ¥çœ‹ (CreditTransactions)
   - âœ… ç¤¼åˆ¸ç®¡ç† (VouchersList)
   - âœ… æ”¯ä»˜æ–¹å¼é€‰æ‹©å™¨ (PaymentMethodSelector)

2. **è®¢é˜…æŸ¥çœ‹åŠŸèƒ½** (`/settings/billing`)
   - âœ… å½“å‰è®¢é˜…æ–¹æ¡ˆæ˜¾ç¤º (BillingCard)
   - âœ… è®¢é˜…çŠ¶æ€å±•ç¤º (active/trial/free/lifetime)
   - âœ… è®¡è´¹å‘¨æœŸä¿¡æ¯
   - âœ… ä¸‹æ¬¡è´¦å•æ—¥æœŸ

3. **è®¢é˜…ç®¡ç†åŠŸèƒ½**
   - âœ… Stripe Customer Portal å…¥å£ (CustomerPortalButton)
   - âœ… å‡çº§æ–¹æ¡ˆæŒ‰é’®
   - âœ… ç®¡ç†è®¢é˜…åŠŸèƒ½

## å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: PaymentMethodSelector ç¼ºå°‘å›½é™…åŒ– âŒ

**ä½ç½®**: `src/components/settings/credits/payment-method-selector.tsx`

**é—®é¢˜æè¿°**:
- æ‰€æœ‰æ–‡æœ¬éƒ½ç¡¬ç¼–ç ä¸ºä¸­æ–‡å­—ç¬¦ä¸²
- æ²¡æœ‰ä½¿ç”¨ `next-intl` çš„ `useTranslations` hook
- å¯¹è¯æ¡†æ ‡é¢˜ã€æŒ‰é’®æ–‡æœ¬ã€æ”¯ä»˜æ–¹å¼åç§°ç­‰éƒ½æ˜¯ç¡¬ç¼–ç çš„

**å½±å“**:
- æ— æ³•æ”¯æŒå¤šè¯­è¨€
- è¿åäº†é¡¹ç›®çš„ i18n è§„èŒƒ

### é—®é¢˜ 2: å¾®ä¿¡å’Œæ”¯ä»˜å®æ”¯ä»˜æœªå®ç° âš ï¸

**ä½ç½®**: `src/components/settings/credits/payment-method-selector.tsx`

**é—®é¢˜æè¿°**:
- ä»£ç ä¸­è°ƒç”¨äº† `/api/payment/wechat/create` å’Œ `/api/payment/alipay/create`
- ä½†è¿™ä¸¤ä¸ª API è·¯ç”±ä¸å­˜åœ¨
- ç”¨æˆ·é€‰æ‹©è¿™äº›æ”¯ä»˜æ–¹å¼ä¼šå¯¼è‡´é”™è¯¯

**å½±å“**:
- ç”¨æˆ·æ— æ³•ä½¿ç”¨å¾®ä¿¡å’Œæ”¯ä»˜å®æ”¯ä»˜
- å¯èƒ½é€ æˆç”¨æˆ·å›°æƒ‘

### é—®é¢˜ 3: credits-page-client ç¡¬ç¼–ç ä¸­æ–‡ âŒ

**ä½ç½®**: `src/components/settings/credits/credits-page-client.tsx`

**é—®é¢˜æè¿°**:
- "æˆ‘çš„ç¤¼åˆ¸" æ ‡é¢˜ç¡¬ç¼–ç 
- Toast æç¤ºæ¶ˆæ¯ç¡¬ç¼–ç 

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ å›½é™…åŒ–æ”¯æŒ âœ…

**ä¿®æ”¹æ–‡ä»¶**: 
- `src/components/settings/credits/payment-method-selector.tsx`
- `src/components/settings/credits/credits-page-client.tsx`
- `messages/zh-CN.json`

**æ”¹åŠ¨å†…å®¹**:

1. **å¼•å…¥ i18n hook**:
   ```typescript
   import { useTranslations } from 'next-intl';
   const t = useTranslations('Dashboard.settings.credits.payment');
   ```

2. **æ›¿æ¢æ‰€æœ‰ç¡¬ç¼–ç æ–‡æœ¬**:
   - å¯¹è¯æ¡†æ ‡é¢˜: `é€‰æ‹©æ”¯ä»˜æ–¹å¼` â†’ `{t('title')}`
   - å¯¹è¯æ¡†æè¿°: `ä¸ºæ‚¨çš„è´¦æˆ·å……å€¼ {amount} ç§¯åˆ†` â†’ `{t('description', { amount })}`
   - æ”¯ä»˜æ–¹å¼åç§°å’Œæè¿°: ä½¿ç”¨ `t('stripe.name')`, `t('wechat.name')` ç­‰
   - æŒ‰é’®æ–‡æœ¬: `å–æ¶ˆ` â†’ `{t('cancel')}`
   - Toast æ¶ˆæ¯: ä½¿ç”¨ `t('checkoutFailed')` ç­‰

3. **æ·»åŠ ç¿»è¯‘é”®åˆ° `messages/zh-CN.json`**:
   ```json
   {
     "Dashboard": {
       "settings": {
         "credits": {
           "payment": {
             "title": "é€‰æ‹©æ”¯ä»˜æ–¹å¼",
             "description": "ä¸ºæ‚¨çš„è´¦æˆ·å……å€¼ {amount} ç§¯åˆ†",
             "creditsLabel": "å……å€¼ç§¯åˆ†",
             "amountLabel": "æ”¯ä»˜é‡‘é¢",
             "methodLabel": "æ”¯ä»˜æ–¹å¼",
             "stripe": {
               "name": "ä¿¡ç”¨å¡æ”¯ä»˜(Stripe)",
               "badge": "å›½é™…æ”¯ä»˜",
               "description": "æ”¯æŒ Visaã€MasterCardã€American Express ç­‰å›½é™…ä¿¡ç”¨å¡"
             },
             "wechat": {
               "name": "å¾®ä¿¡æ”¯ä»˜",
               "description": "ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»˜ï¼Œå¿«é€Ÿä¾¿æ·"
             },
             "alipay": {
               "name": "æ”¯ä»˜å®æ”¯ä»˜",
               "description": "ä½¿ç”¨æ”¯ä»˜å®æ‰«ç æ”¯ä»˜ï¼Œå®‰å…¨å¯é "
             },
             "comingSoon": "å³å°†æ¨å‡º",
             ...
           },
           "vouchers": {
             "title": "æˆ‘çš„ç¤¼åˆ¸",
             "claimSuccess": "å·²é¢†å–ç¤¼åˆ¸",
             "claimFailed": "é¢†å–å¤±è´¥"
           }
         }
       }
     }
   }
   ```

### ä¿®å¤ 2: ç¦ç”¨æœªå®ç°çš„æ”¯ä»˜æ–¹å¼ âœ…

**ä¿®æ”¹æ–‡ä»¶**: `src/components/settings/credits/payment-method-selector.tsx`

**æ”¹åŠ¨å†…å®¹**:

1. **ç¦ç”¨å¾®ä¿¡å’Œæ”¯ä»˜å®é€‰é¡¹**:
   ```tsx
   <RadioGroupItem value="wechat" disabled />
   <Label className="cursor-not-allowed">
     <Badge className="bg-gray-400">{t('comingSoon')}</Badge>
   </Label>
   ```

2. **æ·»åŠ é”™è¯¯æç¤º**:
   ```typescript
   if (selectedMethod === 'wechat') {
     toast.error(t('wechatNotImplemented'));
     setIsLoading(false);
     return;
   }
   ```

3. **ä¿ç•™ä»£ç æ³¨é‡Šä¾›æœªæ¥å®ç°**:
   ```typescript
   // TODO: å®ç°å¾®ä¿¡æ”¯ä»˜
   // const result = await fetch('/api/payment/wechat/create', {...});
   ```

## æ–‡ä»¶ä¿®æ”¹åˆ—è¡¨

### ä¿®æ”¹çš„æ–‡ä»¶:
1. âœ… `src/components/settings/credits/payment-method-selector.tsx`
   - æ·»åŠ  i18n æ”¯æŒ
   - ç¦ç”¨æœªå®ç°çš„æ”¯ä»˜æ–¹å¼
   - æ·»åŠ é”™è¯¯å¤„ç†

2. âœ… `src/components/settings/credits/credits-page-client.tsx`
   - æ›¿æ¢ç¡¬ç¼–ç çš„ä¸­æ–‡æ–‡æœ¬
   - ä½¿ç”¨ i18n ç¿»è¯‘

3. âœ… `messages/zh-CN.json`
   - æ·»åŠ  `Dashboard.settings.credits.payment.*` ç¿»è¯‘é”®
   - æ·»åŠ  `Dashboard.settings.credits.vouchers.*` ç¿»è¯‘é”®

## æµ‹è¯•å»ºè®®

### 1. ç§¯åˆ†å……å€¼æµ‹è¯•
- âœ… è®¿é—® `/settings/credits` é¡µé¢
- âœ… ç‚¹å‡»"è´­ä¹°"æŒ‰é’®ï¼ŒæŸ¥çœ‹æ”¯ä»˜æ–¹å¼é€‰æ‹©å™¨
- âœ… éªŒè¯æ‰€æœ‰æ–‡æœ¬æ˜¾ç¤ºæ­£ç¡®ï¼ˆä¸­æ–‡ï¼‰
- âœ… é€‰æ‹© Stripe æ”¯ä»˜ï¼ŒéªŒè¯æ­£å¸¸è·³è½¬
- âœ… å°è¯•é€‰æ‹©å¾®ä¿¡/æ”¯ä»˜å®ï¼ŒéªŒè¯æ˜¾ç¤º"å³å°†æ¨å‡º"æç¤º
- âœ… åˆ‡æ¢è¯­è¨€ï¼ˆå¦‚æœæ”¯æŒï¼‰ï¼ŒéªŒè¯ç¿»è¯‘ç”Ÿæ•ˆ

### 2. è®¢é˜…æŸ¥çœ‹æµ‹è¯•
- âœ… è®¿é—® `/settings/billing` é¡µé¢
- âœ… éªŒè¯å½“å‰è®¢é˜…ä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
- âœ… éªŒè¯è®¢é˜…çŠ¶æ€æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®
- âœ… éªŒè¯è®¡è´¹å‘¨æœŸå’Œä¸‹æ¬¡è´¦å•æ—¥æœŸ

### 3. è®¢é˜…ç®¡ç†æµ‹è¯•
- âœ… ç‚¹å‡»"ç®¡ç†è®¢é˜…å’Œè´¦å•"æŒ‰é’®
- âœ… éªŒè¯è·³è½¬åˆ° Stripe Customer Portal
- âœ… åœ¨ Stripe Portal ä¸­æµ‹è¯•å–æ¶ˆ/ä¿®æ”¹è®¢é˜…

### 4. å¤šè¯­è¨€æµ‹è¯•
- âš ï¸ åˆ‡æ¢åˆ°è‹±æ–‡/å…¶ä»–è¯­è¨€
- âš ï¸ éªŒè¯æ”¯ä»˜æ–¹å¼é€‰æ‹©å™¨æ˜¾ç¤ºè‹±æ–‡ç¿»è¯‘
- âš ï¸ éªŒè¯æ‰€æœ‰æ–‡æœ¬ç¿»è¯‘æ­£ç¡®

## åç»­å»ºè®®

### çŸ­æœŸ (å¿…é¡»)
1. âœ… **æ·»åŠ è‹±æ–‡ç¿»è¯‘**: åœ¨ `messages/en.json` ä¸­æ·»åŠ å¯¹åº”çš„ç¿»è¯‘é”®
2. âœ… **æ·»åŠ å…¶ä»–è¯­è¨€ç¿»è¯‘**: åœ¨æ‰€æœ‰æ”¯æŒçš„è¯­è¨€æ–‡ä»¶ä¸­æ·»åŠ ç¿»è¯‘

### ä¸­æœŸ (æ¨è)
1. âš ï¸ **å®ç°å¾®ä¿¡æ”¯ä»˜**: 
   - åˆ›å»º `/api/payment/wechat/create` API è·¯ç”±
   - å®ç°å¾®ä¿¡æ”¯ä»˜äºŒç»´ç ç”Ÿæˆå’Œæ”¯ä»˜éªŒè¯
   - åˆ›å»ºå¾®ä¿¡æ”¯ä»˜ç»“æœé¡µé¢

2. âš ï¸ **å®ç°æ”¯ä»˜å®æ”¯ä»˜**:
   - åˆ›å»º `/api/payment/alipay/create` API è·¯ç”±
   - å®ç°æ”¯ä»˜å®æ”¯ä»˜äºŒç»´ç ç”Ÿæˆå’Œæ”¯ä»˜éªŒè¯
   - åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜ç»“æœé¡µé¢

3. âš ï¸ **ç¤¼åˆ¸ç³»ç»Ÿå®Œå–„**:
   - æ£€æŸ¥ VouchersList ç»„ä»¶åŠŸèƒ½
   - ç¡®ä¿ç¤¼åˆ¸é¢†å–å’Œä½¿ç”¨æµç¨‹å®Œæ•´

### é•¿æœŸ (ä¼˜åŒ–)
1. ğŸ“ **æ”¯ä»˜æ–¹å¼é…ç½®åŒ–**: å°†æ”¯ä»˜æ–¹å¼é…ç½®ç§»åˆ° `config/website.ts`
2. ğŸ“ **æ”¯ä»˜ç»Ÿè®¡**: æ·»åŠ æ”¯ä»˜æˆåŠŸç‡ã€å¤±è´¥åŸå› ç­‰ç»Ÿè®¡
3. ğŸ“ **æ”¯ä»˜æµ‹è¯•æ¨¡å¼**: æ·»åŠ æµ‹è¯•ç¯å¢ƒæ”¯ä»˜é€‰é¡¹

## éªŒè¯æ¸…å•

- [x] ç§¯åˆ†å……å€¼é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
- [x] æ”¯ä»˜æ–¹å¼é€‰æ‹©å™¨æ˜¾ç¤ºæ­£ç¡®
- [x] æ‰€æœ‰æ–‡æœ¬ä½¿ç”¨ i18n ç¿»è¯‘
- [x] å¾®ä¿¡å’Œæ”¯ä»˜å®æ ‡è®°ä¸º"å³å°†æ¨å‡º"
- [x] Stripe æ”¯ä»˜æ­£å¸¸å·¥ä½œ
- [x] è®¢é˜…æŸ¥çœ‹é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
- [x] è®¢é˜…ä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
- [x] è®¢é˜…ç®¡ç†æŒ‰é’®å¯ä»¥è·³è½¬
- [ ] è‹±æ–‡ç¿»è¯‘å·²æ·»åŠ  (éœ€è¦é¢å¤–æ·»åŠ )
- [ ] å…¶ä»–è¯­è¨€ç¿»è¯‘å·²æ·»åŠ  (éœ€è¦é¢å¤–æ·»åŠ )

## ç»“è®º

ç»è¿‡æ£€æŸ¥å’Œä¿®å¤:

âœ… **ç§¯åˆ†å……å€¼åŠŸèƒ½** - å®Œæ•´å¯ç”¨ï¼Œå·²ä¿®å¤å›½é™…åŒ–é—®é¢˜
âœ… **è®¢é˜…æŸ¥çœ‹åŠŸèƒ½** - å®Œæ•´å¯ç”¨
âœ… **è®¢é˜…ç®¡ç†åŠŸèƒ½** - å®Œæ•´å¯ç”¨

âš ï¸ **å¾…å®Œå–„**:
- å¾®ä¿¡å’Œæ”¯ä»˜å®æ”¯ä»˜éœ€è¦åç«¯å®ç°
- éœ€è¦æ·»åŠ å…¶ä»–è¯­è¨€çš„ç¿»è¯‘æ–‡ä»¶

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éƒ½æ˜¯å®Œæ•´çš„ï¼Œç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ Stripe è¿›è¡Œç§¯åˆ†å……å€¼å’Œè®¢é˜…ç®¡ç†ã€‚
