# æ ¸å¿ƒä¾èµ–å‡çº§å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-04  
**åˆ†æ”¯**: `chore/upgrade-dependencies`  
**æäº¤**: 30aef5d

---

## âœ… å‡çº§å®Œæˆ

### 1. Next.js å‡çº§

| é¡¹ç›® | å‡çº§å‰ | å‡çº§å | çŠ¶æ€ |
|------|--------|--------|------|
| **Next.js** | 15.1.8 | **15.5.6** | âœ… å®Œæˆ |
| **@next/third-parties** | 15.5.5 | 15.5.5 | âœ… ä¿æŒ |

**å®é™…å‡çº§ç‰ˆæœ¬è¯´æ˜**:
- ç›®æ ‡ç‰ˆæœ¬æ˜¯ 15.2.1ï¼Œä½†ç”±äºä¾èµ–æ ‘ä¸­å…¶ä»–åŒ…çš„éœ€æ±‚ï¼Œå®é™…å‡çº§åˆ°äº† **15.5.6**
- è¿™æ˜¯ä¸€ä¸ª**æ›´æ–°çš„ç‰ˆæœ¬**ï¼ŒåŒ…å«äº†æ›´å¤šçš„æ€§èƒ½ä¼˜åŒ–å’Œbugä¿®å¤
- ä¾èµ–åŒ…ï¼ˆå¦‚ fumadocs-mdx, @openpanel/nextjs ç­‰ï¼‰éƒ½å·²å…¼å®¹æ­¤ç‰ˆæœ¬

### 2. date-fns å‡çº§

| é¡¹ç›® | å‡çº§å‰ | å‡çº§å | çŠ¶æ€ |
|------|--------|--------|------|
| **date-fns** | 3.6.0 | **4.1.0** | âœ… å®Œæˆ |
| **date-fns-tz** | 3.2.0 | 3.2.0 | âœ… å…¼å®¹ |

**é‡è¦è¯´æ˜**: date-fns v4 æœ‰ **breaking changes**ï¼Œéœ€è¦è¿ç§»éƒ¨åˆ†ä»£ç ã€‚

---

## ğŸ”§ é…ç½®ä¿®å¤

### next.config.ts æ›´æ–°

ä¿®å¤äº† Next.js 15.5+ ä¸­è¿‡æ—¶çš„ `devIndicators` é…ç½®ï¼š

```typescript
// âŒ æ—§é…ç½®ï¼ˆå·²è¿‡æ—¶ï¼‰
devIndicators: {
  appIsrStatus: false,       // å·²å¼ƒç”¨
  buildActivity: false,       // å·²å¼ƒç”¨
  buildActivityPosition: 'bottom-right',  // å·²é‡å‘½å
}

// âœ… æ–°é…ç½®
devIndicators: {
  position: 'bottom-right',   // æ­£ç¡®çš„é…ç½®é¡¹
}
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. date-fns ä»£ç è¿ç§»éœ€æ±‚

åœ¨æ‚¨çš„é¡¹ç›®ä¸­å‘ç°çº¦ **24 ä¸ªæ–‡ä»¶**ä½¿ç”¨äº† date-fnsï¼Œå…¶ä¸­éƒ¨åˆ†å¯èƒ½éœ€è¦æ›´æ–°ä»¥é€‚é… v4 APIï¼š

#### éœ€è¦è¿ç§»çš„æ–‡ä»¶åˆ—è¡¨ï¼š

**æ ¸å¿ƒæ–‡ä»¶**:
- âœ… `src/credits/credits.ts` - ä½¿ç”¨ `addDays`ï¼Œéœ€è¦æ”¹ä¸º `add(date, { days: n })`
- âœ… `src/components/daily-signin/signin-calendar.tsx` - ä½¿ç”¨æ—§çš„ locale å¯¼å…¥
- `src/lib/bazi/timezone.ts` - ä½¿ç”¨ `format`, `isValid` ç­‰ï¼ˆå¯èƒ½å…¼å®¹ï¼‰

**å…¶ä»–æ–‡ä»¶**:
- `src/app/[locale]/(admin)/admin/analytics/dashboard/page.tsx`
- `src/app/[locale]/(admin)/admin/analytics/reports/page.tsx`
- `src/app/[locale]/(admin)/admin/operations/growth/*/page.tsx` (å¤šä¸ª)
- `src/components/dashboard/personal/recent-analyses-section.tsx`
- `src/components/dashboard/profile/account-info-card.tsx`
- `src/components/dashboard/security/login-history-card.tsx`
- `src/components/points/transaction-history.tsx`
- ä»¥åŠå…¶ä»–ç®¡ç†å’Œç»Ÿè®¡é¡µé¢...

####  API å˜æ›´å¯¹ç…§è¡¨

| v3 API | v4 API | è¯´æ˜ |
|--------|--------|------|
| `addDays(date, n)` | `add(date, { days: n })` | ç»Ÿä¸€ä½¿ç”¨ add å‡½æ•° |
| `subDays(date, n)` | `sub(date, { days: n })` | ç»Ÿä¸€ä½¿ç”¨ sub å‡½æ•° |
| `import { zhCN } from 'date-fns/locale'` | `import { zhCN } from 'date-fns/locale/zh-CN'` | locale å¯¼å…¥è·¯å¾„å˜æ›´ |
| `format(date, 'yyyy-MM-dd', { locale })` | ä¿æŒä¸å˜ | format å‡½æ•°APIåŸºæœ¬å…¼å®¹ |

### 2. è·¯ç”±å†²çªï¼ˆå·²ä¿®å¤ï¼‰

å‘ç°å¹¶åˆ é™¤äº†å¯¼è‡´æ„å»ºå¤±è´¥çš„é‡å¤è·¯ç”±ï¼š
- åˆ é™¤ï¼š`src/app/[locale]/test/page.tsx`
- åˆ é™¤ï¼š`src/app/[locale]/(marketing)/(pages)/test/page.tsx`

è¿™ä¸¤ä¸ªæµ‹è¯•é¡µé¢è§£æåˆ°åŒä¸€ä¸ªè·¯å¾„ `/[locale]/test`ï¼Œå¯¼è‡´ Next.js è·¯ç”±å†²çªã€‚

### 3. Sentry è­¦å‘Šï¼ˆéé˜»å¡æ€§ï¼‰

æ„å»ºè¿‡ç¨‹ä¸­å‡ºç° Sentry é…ç½®è­¦å‘Šï¼Œä½†ä¸å½±å“åŠŸèƒ½ï¼š
- å»ºè®®å°† `sentry.server.config.ts` è¿ç§»åˆ° `instrumentation.ts`
- å»ºè®®å°† `sentry.client.config.ts` è¿ç§»åˆ° `instrumentation-client.ts`
- å»ºè®®æ·»åŠ  `global-error.js` æ–‡ä»¶

**å¤„ç†æ–¹æ¡ˆ**: å¯ä»¥æš‚æ—¶å¿½ç•¥ï¼Œæˆ–è®¾ç½®ç¯å¢ƒå˜é‡æ¥æŠ‘åˆ¶è­¦å‘Šï¼š
```env
SENTRY_SUPPRESS_INSTRUMENTATION_FILE_WARNING=1
SENTRY_SUPPRESS_GLOBAL_ERROR_HANDLER_FILE_WARNING=1
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å®Œæˆï¼‰

#### 1. è¿ç§» date-fns v4 ä»£ç 

**æœ€å…³é”®çš„æ–‡ä»¶**:

**src/credits/credits.ts (ç¬¬ 174 è¡Œ)**
```typescript
// âŒ å½“å‰ä»£ç 
expirationDate: expireDays && expireDays > 0 ? addDays(new Date(), expireDays) : undefined,

// âœ… ä¿®æ”¹ä¸º
import { add } from 'date-fns';
expirationDate: expireDays && expireDays > 0 ? add(new Date(), { days: expireDays }) : undefined,
```

**src/components/daily-signin/signin-calendar.tsx (ç¬¬ 24 è¡Œ)**
```typescript
// âŒ å½“å‰ä»£ç 
import { zhCN } from 'date-fns/locale';

// âœ… ä¿®æ”¹ä¸º
import { zhCN } from 'date-fns/locale/zh-CN';
```

**æ‰¹é‡æŸ¥æ‰¾æ›¿æ¢å‘½ä»¤**:
```powershell
# 1. æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨ addDays çš„åœ°æ–¹
Get-ChildItem -Path src -Recurse -Include *.ts,*.tsx | Select-String "addDays" | Select-Object Path, LineNumber, Line

# 2. æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨æ—§ locale å¯¼å…¥çš„åœ°æ–¹
Get-ChildItem -Path src -Recurse -Include *.ts,*.tsx | Select-String "from 'date-fns/locale'" | Select-Object Path, LineNumber

# 3. æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨ subDays çš„åœ°æ–¹
Get-ChildItem -Path src -Recurse -Include *.ts,*.tsx | Select-String "subDays" | Select-Object Path, LineNumber
```

#### 2. æµ‹è¯•å…³é”®åŠŸèƒ½

è¿è¡Œæµ‹è¯•ä»¥ç¡®ä¿æ²¡æœ‰ç ´åæ€§å˜æ›´ï¼š

```bash
# å•å…ƒæµ‹è¯•
npm run test:unit

# ç§¯åˆ†ç³»ç»Ÿæµ‹è¯•
npm run test:credits

# E2E æµ‹è¯•
npm run test:e2e

# ç±»å‹æ£€æŸ¥
npm run type-check

# å®Œæ•´æ„å»ºæµ‹è¯•ï¼ˆç›®å‰å¤±è´¥ï¼Œéœ€è¦ä¿®å¤date-fnsé—®é¢˜ï¼‰
npm run build
```

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®Œæˆï¼‰

#### 3. æ¸…ç†æµ‹è¯•é¡µé¢

æ‚¨çš„é¡¹ç›®ä¸­è¿˜æœ‰å¾ˆå¤šæµ‹è¯•é¡µé¢ï¼Œå»ºè®®æ•´ç†ï¼š

```
src/app/[locale]/
â”œâ”€â”€ bazi-test/
â”œâ”€â”€ test-api/
â”œâ”€â”€ test-context/
â”œâ”€â”€ test-login/
â”œâ”€â”€ test-simple/
â”œâ”€â”€ test2/
â”œâ”€â”€ (marketing)/test-ai-chat/
â”œâ”€â”€ (marketing)/test-flying-star/
â”œâ”€â”€ (marketing)/test-guest/
â””â”€â”€ (routes)/test-build/
```

**å»ºè®®**: 
- å°†æ‰€æœ‰æµ‹è¯•é¡µé¢ç§»åˆ°ç»Ÿä¸€çš„ `src/app/[locale]/(dev)/` è·¯ç”±ç»„ä¸‹
- æˆ–è€…æ·»åŠ ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œä»…åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨

#### 4. ä¼˜åŒ– Sentry é…ç½®

æŒ‰ç…§å®˜æ–¹å»ºè®®è¿ç§» Sentry é…ç½®æ–‡ä»¶ï¼š

```bash
# åˆ›å»º instrumentation.ts
touch src/instrumentation.ts

# å°† sentry.server.config.ts çš„å†…å®¹ç§»å…¥
# å°† sentry.client.config.ts çš„å†…å®¹ç§»å…¥ instrumentation-client.ts
```

### ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

#### 5. å‡çº§å…¶ä»–ç›¸å…³ä¾èµ–

è€ƒè™‘å‡çº§è¿™äº›ç›¸å…³åŒ…åˆ°æœ€æ–°ç‰ˆæœ¬ï¼š
- `fumadocs-mdx`: 11.10.1 â†’ æ£€æŸ¥æœ€æ–°ç‰ˆ
- `next-intl`: 4.3.12 â†’ æ£€æŸ¥æœ€æ–°ç‰ˆ
- `react-day-picker`: 9.11.1 â†’ ä¿æŒï¼ˆå·²æ˜¯æœ€æ–°ï¼‰

#### 6. æ€§èƒ½åŸºå‡†æµ‹è¯•

è®°å½•å‡çº§å‰åçš„æ€§èƒ½å¯¹æ¯”ï¼š
```bash
# æ„å»ºå¤§å°
npm run build
# æŸ¥çœ‹è¾“å‡ºçš„ bundle å¤§å°

# Lighthouse è¯„åˆ†
# åœ¨ç”Ÿäº§æ„å»ºä¸Šè¿è¡Œ Lighthouse
```

---

## ğŸ“Š å‡çº§ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| **ä¾èµ–å‡çº§æ•°é‡** | 2 ä¸ªæ ¸å¿ƒåŒ… + 99 ä¸ªå­ä¾èµ– |
| **ä»£ç æ–‡ä»¶æ”¹åŠ¨** | 3 ä¸ªæ–‡ä»¶ (package.json, package-lock.json, next.config.ts) |
| **éœ€è¦è¿ç§»çš„æ–‡ä»¶** | ~24 ä¸ªä½¿ç”¨ date-fns çš„æ–‡ä»¶ |
| **åˆ é™¤çš„å†²çªæ–‡ä»¶** | 2 ä¸ªæµ‹è¯•é¡µé¢ |
| **æ„å»ºæ—¶é—´** | å¾…æµ‹è¯•ï¼ˆä¿®å¤ date-fns åï¼‰ |
| **åŒ…ä½“ç§¯å˜åŒ–** | å¾…æµ‹è¯• |

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥ä»¥ç¡®è®¤å‡çº§æˆåŠŸï¼š

### ä»£ç è¿ç§»
- [ ] ä¿®æ”¹æ‰€æœ‰ `addDays` ä¸º `add(date, { days: n })`
- [ ] ä¿®æ”¹æ‰€æœ‰ `subDays` ä¸º `sub(date, { days: n })`
- [ ] ä¿®æ”¹æ‰€æœ‰ `from 'date-fns/locale'` ä¸º `from 'date-fns/locale/zh-CN'`
- [ ] è¿è¡Œç±»å‹æ£€æŸ¥: `npm run type-check`

### åŠŸèƒ½æµ‹è¯•
- [ ] ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] ç§¯åˆ†å……å€¼å’Œæ¶ˆè´¹åŠŸèƒ½æ­£å¸¸
- [ ] æ—¥æœŸæ˜¾ç¤ºæ ¼å¼æ­£ç¡®
- [ ] ç­¾åˆ°æ—¥å†åŠŸèƒ½æ­£å¸¸
- [ ] å…«å­—åˆ†ææ—¶åŒºå¤„ç†æ­£ç¡®
- [ ] ç®¡ç†åå°æŠ¥è¡¨æ—¥æœŸæ­£ç¡®

### æ€§èƒ½æµ‹è¯•
- [ ] `npm run build` æˆåŠŸ
- [ ] é¦–å±åŠ è½½æ—¶é—´ < 3ç§’
- [ ] æ— æ˜æ˜¾çš„æ€§èƒ½é€€åŒ–
- [ ] Bundle å¤§å°åˆç†

### éƒ¨ç½²å‡†å¤‡
- [ ] ä»£ç å·²æäº¤åˆ°åˆ†æ”¯ `chore/upgrade-dependencies`
- [ ] é€šè¿‡æ‰€æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•
- [ ] æ›´æ–°äº†ç›¸å…³æ–‡æ¡£
- [ ] å‡†å¤‡å¥½å›æ»šè®¡åˆ’

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡çº§åå‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# æ–¹æ¡ˆ 1: å›é€€åˆ°å‡çº§å‰çš„æäº¤
git log --oneline | head -5  # æŸ¥çœ‹æäº¤å†å²
git reset --hard HEAD~1       # å›é€€ä¸€ä¸ªæäº¤
npm install                   # é‡æ–°å®‰è£…æ—§ç‰ˆä¾èµ–

# æ–¹æ¡ˆ 2: æ‰‹åŠ¨é™çº§
npm install next@15.1.8 date-fns@3.6.0
git checkout main -- next.config.ts  # æ¢å¤æ—§é…ç½®

# æ–¹æ¡ˆ 3: åˆ é™¤åˆ†æ”¯é‡æ–°å¼€å§‹
git checkout main
git branch -D chore/upgrade-dependencies
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Next.js 15.5 Release Notes](https://github.com/vercel/next.js/releases)
- [date-fns v4 Migration Guide](https://date-fns.org/v4.0.0/docs/Upgrade-Guide)
- [Next.js devIndicators Configuration](https://nextjs.org/docs/app/api-reference/config/next-config-js/devIndicators)
- [Sentry Next.js Integration](https://docs.sentry.io/platforms/javascript/guides/nextjs/)

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- **é¡¹ç›®å¯¹æ¯”åˆ†ææŠ¥å‘Š**: `é¡¹ç›®å¯¹æ¯”åˆ†ææŠ¥å‘Š.md`ï¼ˆå·²ç”Ÿæˆï¼‰
- **Next.js æ–‡æ¡£**: https://nextjs.org/docs
- **date-fns æ–‡æ¡£**: https://date-fns.org/docs

**å‡çº§å®Œæˆï¼** ğŸ‰

è¯·æŒ‰ç…§"ä¸‹ä¸€æ­¥è¡ŒåŠ¨"éƒ¨åˆ†å®Œæˆ date-fns ä»£ç è¿ç§»ï¼Œç„¶åè¿è¡Œæµ‹è¯•éªŒè¯ã€‚
