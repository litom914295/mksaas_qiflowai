# ç„ç©ºé£æ°´åŠŸèƒ½å…¥å£è¯´æ˜

> ç„ç©ºé£æ˜Ÿé£æ°´åˆ†æç³»ç»Ÿçš„é¡µé¢å…¥å£å’Œæµç¨‹è¯´æ˜

## ğŸ¯ ä¸»è¦å…¥å£

### 1. è·¯ç”±è·¯å¾„
```
/analysis/xuankong
```

**å®Œæ•´è·¯å¾„ç¤ºä¾‹**:
- ä¸­æ–‡: `https://yourdomain.com/zh-CN/analysis/xuankong`
- è‹±æ–‡: `https://yourdomain.com/en/analysis/xuankong`
- ç¹ä½“ä¸­æ–‡: `https://yourdomain.com/zh-TW/analysis/xuankong`

### 2. è·¯ç”±å®šä¹‰
åœ¨ `src/routes.ts` ä¸­å®šä¹‰ï¼š
```typescript
QiflowXuankong = '/analysis/xuankong'
```

### 3. é¡µé¢ç»„ä»¶ä½ç½®
```
src/app/[locale]/(marketing)/analysis/xuankong/page.tsx
  â†“ å¼•ç”¨
src/components/qiflow/xuankong/xuankong-analysis-page.tsx
```

---

## ğŸ“ ç”¨æˆ·è¾“å…¥æµç¨‹

### é˜¶æ®µ 1: åŸºæœ¬ä¿¡æ¯è¾“å…¥
**è¡¨å•ç»„ä»¶**: `src/components/qiflow/forms/xuankong-input-form.tsx`

#### è¾“å…¥å­—æ®µ

**1. å»ºç­‘åŸºæœ¬ä¿¡æ¯** (å¯é€‰)
- ğŸ¢ **å»ºç­‘åç§°**: `buildingName`
  - ä¾‹å¦‚ï¼šé˜³å…‰èŠ±å›­
  - ç±»å‹ï¼šå­—ç¬¦ä¸²
  - å¯é€‰é¡¹

- ğŸ“ **åœ°å€**: `address`
  - ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒº
  - ç±»å‹ï¼šå­—ç¬¦ä¸²
  - å¯é€‰é¡¹

**2. æ–¹ä½ä¿¡æ¯** (å¿…å¡« â­)
- ğŸ§­ **åå±±æ–¹ä½**: `mountainDirection`
  - å»ºç­‘èƒŒé çš„æ–¹å‘
  - é‡‡ç”¨äºŒåå››å±±æ–¹ä½ç³»ç»Ÿ
  - ç±»å‹ï¼šè§’åº¦ (0-359Â°)
  - å¯é€‰å€¼ï¼š
    ```
    å£¬(337.5Â°), å­(352.5Â°), ç™¸(7.5Â°), ä¸‘(22.5Â°),
    è‰®(37.5Â°), å¯…(52.5Â°), ç”²(67.5Â°), å¯(82.5Â°),
    ä¹™(97.5Â°), è¾°(112.5Â°), å·½(127.5Â°), å·³(142.5Â°),
    ä¸™(157.5Â°), åˆ(172.5Â°), ä¸(187.5Â°), æœª(202.5Â°),
    å¤(217.5Â°), ç”³(232.5Â°), åºš(247.5Â°), é…‰(262.5Â°),
    è¾›(277.5Â°), æˆŒ(292.5Â°), ä¹¾(307.5Â°), äº¥(322.5Â°)
    ```

- ğŸ§­ **å‘å±±æ–¹ä½**: `facingDirection`
  - å»ºç­‘é¢å‘çš„æ–¹å‘
  - è‡ªåŠ¨è®¡ç®—ï¼ˆåå±± + 180Â°ï¼‰
  - ç±»å‹ï¼šè§’åº¦ (0-359Â°)

**3. æ—¶é—´ä¿¡æ¯** (å¿…å¡« â­)
- ğŸ“… **å»ºç­‘è½æˆå¹´ä»½**: `completionYear`
  - ä¾‹å¦‚ï¼š2020
  - èŒƒå›´ï¼š1900 - å½“å‰å¹´ä»½
  - ç±»å‹ï¼šæ•°å­—
  - ç”¨äºè®¡ç®—å»ºç­‘å…ƒè¿

- ğŸ“… **å»ºç­‘è½æˆæœˆä»½**: `completionMonth`
  - èŒƒå›´ï¼š1-12
  - ç±»å‹ï¼šæ•°å­—

- ğŸ¢ **æ¥¼å±‚æ•°**: `floorCount`
  - å¯é€‰é¡¹
  - ç±»å‹ï¼šæ•°å­—

- ğŸ“… **å½“å‰å¹´ä»½**: `currentYear`
  - é»˜è®¤ï¼šå½“å‰å¹´ä»½
  - ç”¨äºæµå¹´åˆ†æ

### è¡¨å•éªŒè¯è§„åˆ™
```typescript
// å¹´ä»½éªŒè¯
completionYear: 1900 <= value <= currentYear

// æœˆä»½éªŒè¯
completionMonth: 1 <= value <= 12

// åå±±æ–¹ä½
mountainDirection: 0 <= value <= 359

// å‘å±±æ–¹ä½ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
facingDirection = (mountainDirection + 180) % 360
```

---

## ğŸ”„ åˆ†æå¤„ç†æµç¨‹

### æµç¨‹å›¾
```
ç”¨æˆ·è¾“å…¥è¡¨å•
    â†“
éªŒè¯è¡¨å•æ•°æ®
    â†“
è°ƒç”¨åˆ†æå¼•æ“
    â†“
ç”Ÿæˆé£æ˜Ÿç›˜
    â†“
æ˜¾ç¤ºåˆ†æç»“æœ
```

### è¯¦ç»†æ­¥éª¤

#### 1. è¡¨å•æäº¤
**å‡½æ•°**: `handleFormSubmit`
**ä½ç½®**: `xuankong-analysis-page.tsx`

```typescript
const handleFormSubmit = async (data: XuankongFormData) => {
  // 1. è®¾ç½®åˆ†æçŠ¶æ€
  setIsAnalyzing(true);
  setAnalysisData(data);

  // 2. åˆ›å»ºè§‚æµ‹æ—¥æœŸ
  const observedAt = new Date(
    data.completionYear,
    data.completionMonth - 1,
    1
  );

  // 3. è°ƒç”¨åˆ†æå¼•æ“
  const result = await runComprehensiveAnalysis({
    observedAt,                    // è§‚æµ‹æ—¶é—´
    facing: {                      // æœå‘ä¿¡æ¯
      degrees: data.facingDirection
    },
    location: {                    // ä½ç½®ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
      lat: 0, 
      lon: 0
    },
    includeLiunian: true,          // åŒ…å«æµå¹´åˆ†æ
    includePersonalization: false, // ä¸ªæ€§åŒ–åˆ†æ
    includeTiguaAnalysis: true,    // æ›¿å¦åˆ†æ
    includeLingzheng: true,        // é›¶æ­£åˆ†æ
    includeChengmenjue: true,      // åŸé—¨è¯€
    includeTimeSelection: false,   // æ‹©æ—¶åˆ†æ
    targetYear: data.currentYear,  // ç›®æ ‡å¹´ä»½
    config: {
      applyTiGua: true,            // åº”ç”¨æ›¿å¦
      applyFanGua: false,          // åº”ç”¨åå¦
    },
  });

  // 4. æ˜¾ç¤ºç»“æœ
  setAnalysisResult(result);
  setShowAnalysis(true);
};
```

#### 2. åˆ†æå¼•æ“
**æ–‡ä»¶**: `src/lib/qiflow/xuankong/comprehensive-engine.ts`

åˆ†æå¼•æ“ä¼šè®¡ç®—ï¼š
- ğŸŒŸ é£æ˜Ÿç›˜ï¼ˆä¹å®«æ ¼ï¼‰
- ğŸ“Š å„æ–¹ä½å‰å‡¶
- ğŸ  æˆ¿é—´å¸ƒå±€å»ºè®®
- ğŸ“… æµå¹´è¿åŠ¿
- ğŸ”„ æ›¿å¦åˆ†æ
- âš–ï¸ é›¶æ­£åˆ†æ
- ğŸšª åŸé—¨è¯€åº”ç”¨

---

## ğŸ“Š åˆ†æç»“æœå±•ç¤º

### ç»“æœç»„ä»¶
**ä¸»ç»„ä»¶**: `ComprehensiveAnalysisPanel`
**ä½ç½®**: `src/components/qiflow/xuankong/comprehensive-analysis-panel.tsx`

### æ˜¾ç¤ºå†…å®¹åŒ…æ‹¬

#### 1. åŸºç¡€åˆ†æè§†å›¾
**ç»„ä»¶**: `BasicAnalysisView`
- ä¹å®«é£æ˜Ÿå›¾
- åŸºç¡€å‰å‡¶åˆ¤æ–­
- æ–¹ä½è¯„åˆ†

#### 2. æ›¿å¦åˆ†æè§†å›¾
**ç»„ä»¶**: `TiguaAnalysisView`
- æ›¿å¦æ˜Ÿç›˜
- æ›¿å¦å‰å‡¶
- æ›¿å¦è¯´æ˜

#### 3. é›¶æ­£åˆ†æè§†å›¾
**ç»„ä»¶**: `LingzhengAnalysisView`
- é›¶æ­£ç¥ä½ç½®
- é›¶æ­£è¯„ä¼°
- è°ƒæ•´å»ºè®®

#### 4. åŸé—¨è¯€åˆ†æè§†å›¾
**ç»„ä»¶**: `ChengmenjueAnalysisView`
- åŸé—¨ä½ç½®
- åŸé—¨å‰å‡¶
- åº”ç”¨å»ºè®®

#### 5. æµå¹´åˆ†æè§†å›¾
**ç»„ä»¶**: `LiunianAnalysisView`
- å½“å‰æµå¹´é£æ˜Ÿ
- æµå¹´å‰å‡¶
- æµå¹´æ³¨æ„äº‹é¡¹

#### 6. ä¸ªæ€§åŒ–åˆ†æè§†å›¾
**ç»„ä»¶**: `PersonalizedAnalysisView`
- æ ¹æ®ç”¨æˆ·ä¿¡æ¯å®šåˆ¶
- ä¸ªäººè¿åŠ¿åˆ†æ
- ä¸“å±å»ºè®®

#### 7. æ™ºèƒ½æ¨èè§†å›¾
**ç»„ä»¶**: `SmartRecommendationsView`
- AI æ™ºèƒ½åˆ†æ
- ä¼˜åŒ–å»ºè®®
- æ”¹å–„æ–¹æ¡ˆ

---

## ğŸ› ï¸ ç›¸å…³ API æ¥å£

### 1. ç„ç©ºåˆ†æ API
**è·¯å¾„**: `/api/qiflow/xuankong`
**æ–‡ä»¶**: `src/app/api/qiflow/xuankong/route.ts`

**è¯·æ±‚æ–¹æ³•**: POST
**è¯·æ±‚å‚æ•°**:
```typescript
{
  observedAt: Date,           // è§‚æµ‹æ—¶é—´
  facing: {
    degrees: number          // æœå‘è§’åº¦
  },
  location?: {
    lat: number,             // çº¬åº¦
    lon: number              // ç»åº¦
  },
  includeLiunian?: boolean,  // åŒ…å«æµå¹´
  includePersonalization?: boolean,
  includeTiguaAnalysis?: boolean,
  includeLingzheng?: boolean,
  includeChengmenjue?: boolean,
  targetYear?: number
}
```

**å“åº”æ•°æ®**:
```typescript
{
  flyingStarChart: {},       // é£æ˜Ÿç›˜
  basicAnalysis: {},         // åŸºç¡€åˆ†æ
  tiguaAnalysis: {},         // æ›¿å¦åˆ†æ
  lingzhengAnalysis: {},     // é›¶æ­£åˆ†æ
  chengmenjueAnalysis: {},   // åŸé—¨è¯€åˆ†æ
  liunianAnalysis: {},       // æµå¹´åˆ†æ
  recommendations: []        // å»ºè®®åˆ—è¡¨
}
```

---

## ğŸ§® æ ¸å¿ƒç®—æ³•

### é£æ˜Ÿè®¡ç®—
**æ–‡ä»¶**: `src/lib/qiflow/xuankong/flying-star.ts`

è®¡ç®—é€»è¾‘ï¼š
1. æ ¹æ®å»ºç­‘è½æˆå¹´ä»½ç¡®å®šå…ƒè¿
2. æ ¹æ®åå‘ç¡®å®šå±±å‘
3. è®¡ç®—ä¹å®«é£æ˜Ÿæ’åˆ—
4. åº”ç”¨æ›¿å¦è§„åˆ™ï¼ˆå¦‚éœ€è¦ï¼‰
5. è®¡ç®—æµå¹´é£æ˜Ÿ

### å…ƒè¿åˆ’åˆ†
```
ä¸€è¿: 1864-1883 (20å¹´)
äºŒè¿: 1884-1903
ä¸‰è¿: 1904-1923
å››è¿: 1924-1943
äº”è¿: 1944-1963
å…­è¿: 1964-1983
ä¸ƒè¿: 1984-2003
å…«è¿: 2004-2023
ä¹è¿: 2024-2043
```

---

## ğŸ’° ç§¯åˆ†æ¶ˆè´¹

### åˆ†ææ¶ˆè´¹ç§¯åˆ†
**å®šä¹‰ä½ç½®**: `src/lib/credits/manager.ts`

```typescript
xuankong: 20 ç§¯åˆ†
```

### é™çº§ç­–ç•¥
å½“ç”¨æˆ·ç§¯åˆ†ä¸è¶³æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é™çº§åˆ†æï¼š
- åŸºç¡€åˆ†æï¼š10 ç§¯åˆ†
- ç®€åŒ–åˆ†æï¼š5 ç§¯åˆ†

---

## ğŸ“± å“åº”å¼æ”¯æŒ

### æ¡Œé¢ç«¯ (Desktop)
- å®Œæ•´çš„ä¹å®«æ ¼å±•ç¤º
- è¯¦ç»†çš„åˆ†æé¢æ¿
- ä¸°å¯Œçš„äº¤äº’åŠŸèƒ½

### å¹³æ¿ç«¯ (Tablet)
- è‡ªé€‚åº”å¸ƒå±€
- ç®€åŒ–éƒ¨åˆ†å±•ç¤º
- ä¿ç•™æ ¸å¿ƒåŠŸèƒ½

### ç§»åŠ¨ç«¯ (Mobile)
- å‚ç›´æ»šåŠ¨å¸ƒå±€
- æŠ˜å å¼é¢æ¿
- è§¦æ‘¸ä¼˜åŒ–

---

## ğŸ”— ç›¸å…³é“¾æ¥

### é¡µé¢è·¯å¾„
- ç„ç©ºåˆ†æé¡µé¢: `/analysis/xuankong`
- é¦–é¡µ: `/`
- ä»·æ ¼é¡µé¢: `/pricing`

### å¯¼èˆªå…¥å£
1. **é¦–é¡µç‰¹æ€§å¡ç‰‡**
   - ç»„ä»¶: `FeatureCardLink`
   - ä½ç½®: é¦–é¡µä¸­éƒ¨

2. **å¯¼èˆªèœå•**
   - åœ¨ä¸»å¯¼èˆªæ "åˆ†æå·¥å…·"ä¸‹æ‹‰èœå•ä¸­

3. **å·¥å…·é¡µé¢**
   - åˆ†æå·¥å…·åˆ—è¡¨ä¸­

### æ–‡æ¡£èµ„æº
- API æ–‡æ¡£: `src/lib/qiflow/xuankong/API_DOCUMENTATION.md`
- åŠŸèƒ½æ–‡æ¡£: `src/lib/qiflow/fengshui/README.md`
- ç»Ÿä¸€å¼•æ“æ–‡æ¡£: `src/lib/qiflow/unified/README.md`

---

## ğŸ§ª æµ‹è¯•

### E2E æµ‹è¯•
**æ–‡ä»¶**: `src/components/qiflow/xuankong/__tests__/e2e.test.tsx`

### é›†æˆæµ‹è¯•
**æ–‡ä»¶**: `src/components/qiflow/xuankong/__tests__/integration.test.tsx`

### API æµ‹è¯•
**æ–‡ä»¶**: `src/app/api/qiflow/xuankong/__tests__/route.test.ts`

---

## ğŸ“ ç¤ºä¾‹æ•°æ®

### ç¤ºä¾‹è¾“å…¥
```json
{
  "buildingName": "é˜³å…‰èŠ±å›­",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº",
  "mountainDirection": 337.5,
  "facingDirection": 157.5,
  "completionYear": 2020,
  "completionMonth": 6,
  "floorCount": 30,
  "currentYear": 2025
}
```

### ç¤ºä¾‹è§£é‡Š
- å»ºç­‘åç§°: é˜³å…‰èŠ±å›­
- åå±±: å£¬ï¼ˆåŒ—åè¥¿ï¼‰
- å‘å±±: ä¸™ï¼ˆå—åä¸œï¼‰
- è½æˆ: 2020å¹´6æœˆï¼ˆå…«è¿ï¼‰
- åˆ†æå¹´ä»½: 2025å¹´ï¼ˆä¹è¿æµå¹´ï¼‰

---

## ğŸ“ ç”¨æˆ·æŒ‡å—

### å¦‚ä½•æµ‹é‡åå‘ï¼Ÿ
1. ä½¿ç”¨æŒ‡å—é’ˆæˆ–æ‰‹æœºç½—ç›˜
2. ç«™åœ¨å»ºç­‘ä¸­å¿ƒç‚¹
3. é¢å‘å»ºç­‘ä¸»è¦å…¥å£
4. è®°å½•ç½—ç›˜è¯»æ•°
5. ç¡®å®šåå±±å’Œå‘å±±

### æœ€ä½³å®è·µ
1. âœ… å‡†ç¡®æµ‹é‡åå‘ï¼ˆè¯¯å·® Â±5Â°ï¼‰
2. âœ… ç¡®è®¤å»ºç­‘è½æˆæ—¶é—´
3. âœ… äº†è§£å»ºç­‘å¸ƒå±€
4. âœ… è®°å½•ç‰¹æ®Šä½ç½®ï¼ˆå¦‚å¨æˆ¿ã€å§å®¤ï¼‰
5. âœ… å®šæœŸæ›´æ–°æµå¹´åˆ†æ

---

## ğŸš€ æœªæ¥è§„åˆ’

### è®¡åˆ’åŠŸèƒ½
- [ ] GPS è‡ªåŠ¨å®šä½
- [ ] 3D å»ºç­‘å¯è§†åŒ–
- [ ] AR æ–¹ä½æ ‡æ³¨
- [ ] å†å²åˆ†æè®°å½•
- [ ] å¤šæˆ¿å±‹å¯¹æ¯”
- [ ] PDF æŠ¥å‘Šå¯¼å‡º
- [ ] ä¸“å®¶åœ¨çº¿å’¨è¯¢

---

æœ€åæ›´æ–°: 2025-01-12  
ç»´æŠ¤è€…: å¼€å‘å›¢é˜Ÿ
