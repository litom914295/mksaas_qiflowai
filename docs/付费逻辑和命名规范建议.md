# ä»˜è´¹é€»è¾‘æ¢³ç†å’Œæ–‡ä»¶å‘½åè§„èŒƒå»ºè®®

## ä¸€ã€ä»˜è´¹é€»è¾‘æ¢³ç†ä¸ä¼˜åŒ–å»ºè®®

### 1.1 å½“å‰ç§¯åˆ†å’Œè®¢é˜…ç³»ç»Ÿæ¦‚å†µ

æ ¹æ®ç°æœ‰ä»£ç åˆ†æï¼Œç³»ç»Ÿå·²ç»å®ç°äº†åŸºç¡€çš„ç§¯åˆ†å’Œè®¢é˜…ç®¡ç†ï¼š

#### ç°æœ‰åŠŸèƒ½æ¨¡å—
- âœ… **ç§¯åˆ†ä½™é¢æŸ¥è¯¢** (`useCreditBalance`)
- âœ… **ç§¯åˆ†æ¶ˆè´¹** (`useConsumeCredits`)
- âœ… **ç§¯åˆ†ç»Ÿè®¡** (`useCreditStats`)
- âœ… **ç§¯åˆ†äº¤æ˜“å†å²** (`useCreditTransactions`)
- âœ… **è®¢é˜…çŠ¶æ€æ£€æµ‹** (é€šè¿‡ `session?.user?.id` åˆ¤æ–­ä¸“ä¸šç‰ˆ)

### 1.2 å»ºè®®çš„ä»˜è´¹é€»è¾‘è®¾è®¡

#### 1.2.1 åŠŸèƒ½åˆ†çº§å®šä»·

| åŠŸèƒ½ | å…è´¹ç‰ˆ | ç§¯åˆ†ç”¨æˆ· | è®¢é˜…ä¸“ä¸šç‰ˆ |
|-----|-------|---------|-----------|
| åŸºç¡€å…«å­—åˆ†æ | âœ… æ¯æ—¥3æ¬¡ | âœ… æŒ‰æ¬¡æ¶ˆè´¹ | âœ… æ— é™æ¬¡ |
| é£æ°´åˆ†æ | âŒ | âœ… æŒ‰æ¬¡æ¶ˆè´¹ | âœ… æ— é™æ¬¡ |
| æ•´åˆå»ºè®® | âŒ | âœ… æŒ‰æ¬¡æ¶ˆè´¹ | âœ… æ— é™æ¬¡ |
| ç”Ÿæˆä¸“ä¸šæŠ¥å‘Š | âŒ | âœ… 5ç§¯åˆ†/æ¬¡ | âœ… æ— é™æ¬¡ |
| å¯¼å‡ºHTMLæŠ¥å‘Š | âŒ | âœ… 3ç§¯åˆ†/æ¬¡ | âœ… æ— é™æ¬¡ |
| å‘é€é‚®ä»¶æŠ¥å‘Š | âŒ | âœ… 3ç§¯åˆ†/æ¬¡ | âœ… æ— é™æ¬¡ |
| AIèŠå¤©å’¨è¯¢ | âœ… æ¯æ—¥10æ¡ | âœ… 1ç§¯åˆ†/10æ¡ | âœ… æ— é™æ¡ |
| æŠ¥å‘Šå†å²è®°å½• | âŒ | âœ… ä¿å­˜30å¤© | âœ… æ°¸ä¹…ä¿å­˜ |

#### 1.2.2 ç§¯åˆ†å®šä»·å»ºè®®

```typescript
// å»ºè®®åœ¨ constants/pricing.ts ä¸­å®šä¹‰
export const CREDIT_COSTS = {
  // åˆ†æç›¸å…³
  BASIC_BAZI_ANALYSIS: 0,      // åŸºç¡€å…«å­—åˆ†æï¼ˆå…è´¹ï¼‰
  FENGSHUI_ANALYSIS: 3,        // é£æ°´åˆ†æ
  INTEGRATED_ADVICE: 2,        // æ•´åˆå»ºè®®ï¼ˆåœ¨å·²æœ‰åˆ†æåŸºç¡€ä¸Šï¼‰
  
  // æŠ¥å‘Šç›¸å…³
  GENERATE_REPORT: 5,          // ç”Ÿæˆä¸“ä¸šæŠ¥å‘Šv2.2
  EXPORT_HTML: 3,              // å¯¼å‡ºHTML
  EXPORT_PDF: 5,               // å¯¼å‡ºPDFï¼ˆæœªæ¥åŠŸèƒ½ï¼‰
  SEND_EMAIL: 3,               // å‘é€é‚®ä»¶
  
  // AIæœåŠ¡
  AI_CHAT_BUNDLE: 1,           // AIèŠå¤©å¥—é¤ï¼ˆ10æ¡æ¶ˆæ¯ï¼‰
  DEEP_ANALYSIS: 10,           // æ·±åº¦AIåˆ†æ
} as const;

export const DAILY_FREE_LIMITS = {
  BASIC_ANALYSIS: 3,           // æ¯æ—¥å…è´¹åŸºç¡€åˆ†ææ¬¡æ•°
  AI_CHAT_MESSAGES: 10,        // æ¯æ—¥å…è´¹AIæ¶ˆæ¯æ•°
} as const;
```

#### 1.2.3 è®¢é˜…å¥—é¤å»ºè®®

```typescript
// å»ºè®®åœ¨ constants/subscriptions.ts ä¸­å®šä¹‰
export const SUBSCRIPTION_PLANS = {
  FREE: {
    name: 'å…è´¹ç‰ˆ',
    price: 0,
    interval: 'forever',
    features: {
      baziAnalysis: { limit: 3, period: 'daily' },
      aiChat: { limit: 10, period: 'daily' },
      reportHistory: { limit: 0 },
      exportReports: false,
      emailReports: false,
    }
  },
  
  BASIC: {
    name: 'åŸºç¡€ç‰ˆ',
    price: 99,               // å…ƒ/æœˆ
    interval: 'monthly',
    features: {
      baziAnalysis: { limit: 50, period: 'monthly' },
      fengshuiAnalysis: { limit: 20, period: 'monthly' },
      aiChat: { limit: 500, period: 'monthly' },
      reportHistory: { limit: 100 },
      exportReports: true,
      emailReports: true,
      prioritySupport: false,
    }
  },
  
  PRO: {
    name: 'ä¸“ä¸šç‰ˆ',
    price: 299,              // å…ƒ/æœˆ
    interval: 'monthly',
    features: {
      baziAnalysis: { limit: -1 },    // æ— é™åˆ¶
      fengshuiAnalysis: { limit: -1 }, // æ— é™åˆ¶
      aiChat: { limit: -1 },           // æ— é™åˆ¶
      reportHistory: { limit: -1 },    // æ°¸ä¹…ä¿å­˜
      exportReports: true,
      emailReports: true,
      prioritySupport: true,
      apiAccess: true,                 // APIæ¥å£è®¿é—®
      customBranding: true,            // è‡ªå®šä¹‰å“ç‰Œæ°´å°
    }
  },
  
  LIFETIME: {
    name: 'ç»ˆèº«ç‰ˆ',
    price: 1999,             // å…ƒä¸€æ¬¡æ€§
    interval: 'lifetime',
    features: {
      // ä¸PROç‰ˆç›¸åŒï¼Œä½†ç»ˆèº«æœ‰æ•ˆ
      ...SUBSCRIPTION_PLANS.PRO.features,
      lifetimeUpdates: true,
    }
  }
} as const;
```

### 1.3 å®æ–½ä»£ç å»ºè®®

#### 1.3.1 åœ¨æŠ¥å‘Šç”ŸæˆAPIä¸­æ·»åŠ ç§¯åˆ†æ£€æŸ¥

```typescript
// src/app/api/reports/v2.2/generate/route.ts
import { CREDIT_COSTS } from '@/constants/pricing';
import { consumeCreditsAction } from '@/actions/consume-credits';
import { getCreditBalanceAction } from '@/actions/get-credit-balance';

export async function POST(request: Request) {
  const session = await getSession();
  const user = session?.user;
  
  if (!user) {
    return NextResponse.json(
      { error: 'è¯·å…ˆç™»å½•' },
      { status: 401 }
    );
  }
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸“ä¸šç‰ˆè®¢é˜…ç”¨æˆ·
  const isPro = await checkPremiumSubscription(user.id);
  
  if (!isPro) {
    // éä¸“ä¸šç‰ˆç”¨æˆ·éœ€è¦æ¶ˆè€—ç§¯åˆ†
    const balance = await getCreditBalanceAction();
    
    if (!balance?.data?.success || balance.data.credits < CREDIT_COSTS.GENERATE_REPORT) {
      return NextResponse.json(
        { 
          error: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·å……å€¼æˆ–å‡çº§ä¸“ä¸šç‰ˆ',
          requiredCredits: CREDIT_COSTS.GENERATE_REPORT,
          currentCredits: balance?.data?.credits || 0
        },
        { status: 402 }
      );
    }
    
    // æ¶ˆè€—ç§¯åˆ†
    const consumeResult = await consumeCreditsAction({
      amount: CREDIT_COSTS.GENERATE_REPORT,
      description: 'ç”Ÿæˆä¸“ä¸šæŠ¥å‘Š v2.2'
    });
    
    if (!consumeResult?.data?.success) {
      return NextResponse.json(
        { error: 'ç§¯åˆ†æ‰£é™¤å¤±è´¥' },
        { status: 500 }
      );
    }
  }
  
  // ç»§ç»­ç”ŸæˆæŠ¥å‘Šçš„é€»è¾‘...
  // ...
}
```

#### 1.3.2 åœ¨å‰ç«¯æ·»åŠ ç§¯åˆ†ä½™é¢æ˜¾ç¤ºå’Œæç¤º

```typescript
// src/components/home/HeroWithForm.tsx
import { useCreditBalance } from '@/hooks/use-credits';
import { authClient } from '@/lib/auth-client';

export function HeroWithForm() {
  const { data: session } = authClient.useSession();
  const { data: creditsAvailable = 0 } = useCreditBalance();
  
  const handleGenerateReport = async (e: React.MouseEvent) => {
    // ... éªŒè¯é€»è¾‘ ...
    
    // æ£€æŸ¥ç”¨æˆ·æƒé™
    const isPro = !!session?.user?.id; // ç®€åŒ–æ£€æŸ¥ï¼Œå®é™…åº”è¯¥æ£€æŸ¥è®¢é˜…çŠ¶æ€
    
    if (!isPro && creditsAvailable < 5) {
      toast.error(
        'ç§¯åˆ†ä¸è¶³ï¼ˆéœ€è¦5ç§¯åˆ†ï¼‰ï¼Œè¯·å……å€¼æˆ–å‡çº§ä¸“ä¸šç‰ˆ',
        {
          action: {
            label: 'å»å……å€¼',
            onClick: () => router.push('/settings/credits')
          }
        }
      );
      return;
    }
    
    // ç»§ç»­ç”ŸæˆæŠ¥å‘Š...
  };
  
  return (
    <div>
      {/* åœ¨æŒ‰é’®ä¸Šæ–¹æ˜¾ç¤ºç§¯åˆ†ä½™é¢ */}
      {!isPro && (
        <div className="mb-3 text-center text-sm text-muted-foreground">
          <span>å½“å‰ç§¯åˆ†: </span>
          <span className="font-semibold text-primary">{creditsAvailable}</span>
          <span> | ç”ŸæˆæŠ¥å‘Šéœ€è¦ 5 ç§¯åˆ†</span>
        </div>
      )}
      
      {/* æŒ‰é’® */}
      {/* ... */}
    </div>
  );
}
```

#### 1.3.3 æ·»åŠ æ¯æ—¥å…è´¹æ¬¡æ•°é™åˆ¶

```typescript
// src/lib/rate-limit/daily-limits.ts
import { redis } from '@/lib/redis'; // å‡è®¾ä½¿ç”¨Redis

export async function checkDailyLimit(
  userId: string,
  action: string,
  limit: number
): Promise<{ allowed: boolean; remaining: number }> {
  const key = `daily-limit:${userId}:${action}:${new Date().toISOString().split('T')[0]}`;
  
  const current = await redis.incr(key);
  
  if (current === 1) {
    // ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºä»Šå¤©ç»“æŸ
    const tomorrow = new Date();
    tomorrow.setHours(24, 0, 0, 0);
    const secondsUntilTomorrow = Math.floor((tomorrow.getTime() - Date.now()) / 1000);
    await redis.expire(key, secondsUntilTomorrow);
  }
  
  return {
    allowed: current <= limit,
    remaining: Math.max(0, limit - current)
  };
}

// ä½¿ç”¨ç¤ºä¾‹
export async function POST(request: Request) {
  const session = await getSession();
  const user = session?.user;
  
  if (!user) {
    return NextResponse.json({ error: 'è¯·å…ˆç™»å½•' }, { status: 401 });
  }
  
  const isPro = await checkPremiumSubscription(user.id);
  
  if (!isPro) {
    // æ£€æŸ¥æ¯æ—¥å…è´¹æ¬¡æ•°
    const { allowed, remaining } = await checkDailyLimit(
      user.id,
      'basic-analysis',
      DAILY_FREE_LIMITS.BASIC_ANALYSIS
    );
    
    if (!allowed) {
      return NextResponse.json({
        error: 'ä»Šæ—¥å…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·æ˜å¤©å†è¯•æˆ–å‡çº§ä¸“ä¸šç‰ˆ',
        dailyLimit: DAILY_FREE_LIMITS.BASIC_ANALYSIS,
        remaining: 0
      }, { status: 429 });
    }
  }
  
  // ç»§ç»­å¤„ç†...
}
```

### 1.4 æ•°æ®åº“Schemaå»ºè®®

```sql
-- è®¢é˜…è¡¨
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  plan_type VARCHAR(20) NOT NULL, -- 'FREE', 'BASIC', 'PRO', 'LIFETIME'
  status VARCHAR(20) NOT NULL, -- 'active', 'cancelled', 'expired'
  start_date TIMESTAMP NOT NULL,
  end_date TIMESTAMP, -- NULL for lifetime
  auto_renew BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨ï¼ˆå·²å­˜åœ¨ï¼Œä½†å»ºè®®å¢å¼ºï¼‰
CREATE TABLE credit_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  amount INTEGER NOT NULL, -- æ­£æ•°è¡¨ç¤ºå……å€¼ï¼Œè´Ÿæ•°è¡¨ç¤ºæ¶ˆè´¹
  balance_after INTEGER NOT NULL,
  type VARCHAR(20) NOT NULL, -- 'purchase', 'consume', 'refund', 'bonus'
  description TEXT,
  metadata JSONB, -- å­˜å‚¨é¢å¤–ä¿¡æ¯ï¼Œå¦‚æŠ¥å‘ŠIDã€åˆ†æç±»å‹ç­‰
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æŠ¥å‘Šç”Ÿæˆè®°å½•è¡¨ï¼ˆå»ºè®®æ–°å¢ï¼‰
CREATE TABLE generated_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  report_type VARCHAR(20) NOT NULL, -- 'bazi', 'fengshui', 'combined'
  report_version VARCHAR(10) NOT NULL, -- 'v2.2', 'v2.3', etc.
  input_data JSONB NOT NULL, -- å­˜å‚¨ç”ŸæˆæŠ¥å‘Šçš„è¾“å…¥æ•°æ®
  report_url TEXT, -- æŠ¥å‘Šçš„è®¿é—®URL
  storage_path TEXT, -- æŠ¥å‘Šæ–‡ä»¶çš„å­˜å‚¨è·¯å¾„
  cost_credits INTEGER, -- æ¶ˆè€—çš„ç§¯åˆ†æ•°ï¼ˆ0è¡¨ç¤ºå…è´¹ï¼‰
  generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP, -- å¯¹äºéä¸“ä¸šç‰ˆç”¨æˆ·ï¼ŒæŠ¥å‘Šå¯èƒ½æœ‰è¿‡æœŸæ—¶é—´
  view_count INTEGER DEFAULT 0,
  last_viewed_at TIMESTAMP
);

-- æ¯æ—¥ä½¿ç”¨é™åˆ¶è¿½è¸ªè¡¨ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸ä½¿ç”¨Redisï¼‰
CREATE TABLE daily_usage_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  action_type VARCHAR(50) NOT NULL, -- 'basic-analysis', 'ai-chat', etc.
  usage_date DATE NOT NULL,
  count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, action_type, usage_date)
);
```

---

## äºŒã€æ–‡ä»¶å‘½åè§„èŒƒå»ºè®®

### 2.1 ç‰ˆæœ¬å·å‘½åè§„èŒƒé—®é¢˜

å½“å‰ä»£ç ä¸­ä½¿ç”¨äº†å¤šç§ç‰ˆæœ¬å·å‘½åæ–¹å¼ï¼š
- âŒ `v2.2` (å¸¦ç‚¹å·)
- âŒ `V2.2` (å¤§å†™V+ç‚¹å·)
- âŒ `v2_2` (ä¸‹åˆ’çº¿)

### 2.2 æ¨èçš„å‘½åè§„èŒƒ

#### 2.2.1 æ–‡ä»¶å’Œç›®å½•å‘½å

**æ¨èæ ¼å¼ï¼šå°å†™ + è¿å­—ç¬¦**

```
âœ… å¥½çš„å‘½åï¼š
- src/lib/report/v2-2/html.ts
- src/lib/report/v2-2/generator.ts
- src/app/api/reports/v2-2/generate/route.ts
- docs/report-templates/v2-2/professional-report.md

âŒ é¿å…çš„å‘½åï¼š
- src/lib/report/v2.2/html.ts        (ç‚¹å·åœ¨æŸäº›ç³»ç»Ÿä¸­ä¼šå¼•èµ·é—®é¢˜)
- src/lib/report/V2.2/html.ts        (å¤§å°å†™ä¸ä¸€è‡´)
- src/lib/report/v2_2/html.ts        (ä¸‹åˆ’çº¿ä¸å¦‚è¿å­—ç¬¦ç›´è§‚)
- src/lib/report/version-2.2/html.ts (è¿‡äºå†—é•¿)
```

#### 2.2.2 TypeScriptç±»å‹å’Œæ¥å£å‘½å

**æ¨èæ ¼å¼ï¼šPascalCase + Våç¼€**

```typescript
âœ… å¥½çš„å‘½åï¼š
type ReportDataV22 = {
  version: '2.2';
  // ...
};

interface ReportConfigV22 {
  template: string;
  // ...
}

class ReportGeneratorV22 {
  // ...
}

âŒ é¿å…çš„å‘½åï¼š
type ReportDataV2_2 = { ... };      // ä¸‹åˆ’çº¿ä¸ç¬¦åˆTSçº¦å®š
type ReportData_v2_2 = { ... };     // æ··åˆå¤§å°å†™ä¸è§„èŒƒ
interface ReportConfigV2Dot2 { ... }; // ç”¨è¯å•°å—¦
```

#### 2.2.3 å¸¸é‡å‘½å

**æ¨èæ ¼å¼ï¼šUPPER_SNAKE_CASE**

```typescript
âœ… å¥½çš„å‘½åï¼š
const REPORT_VERSION_V2_2 = '2.2';
const API_ENDPOINT_V2_2 = '/api/reports/v2-2';
const DEFAULT_TEMPLATE_V2_2 = 'professional';

âŒ é¿å…çš„å‘½åï¼š
const REPORT_VERSION_V2dot2 = '2.2';  // æ··åˆä½¿ç”¨æ–‡å­—
const reportVersionV22 = '2.2';       // camelCaseä¸ç¬¦åˆå¸¸é‡çº¦å®š
```

#### 2.2.4 å‡½æ•°å’Œå˜é‡å‘½å

**æ¨èæ ¼å¼ï¼šcamelCase + Våç¼€**

```typescript
âœ… å¥½çš„å‘½åï¼š
function generateReportV22(data: ReportDataV22): string {
  // ...
}

const renderReportHtmlV22 = (config: ReportConfigV22) => {
  // ...
};

const reportInstanceV22 = new ReportGeneratorV22();

âŒ é¿å…çš„å‘½åï¼š
function generate_report_v2_2(data) { ... }  // snake_caseä¸ç¬¦åˆJS/TSçº¦å®š
const renderReportHTML_v2_2 = () => { ... }; // æ··åˆå‘½åé£æ ¼
```

#### 2.2.5 APIè·¯ç”±å‘½å

**æ¨èæ ¼å¼ï¼šå°å†™ + è¿å­—ç¬¦**

```
âœ… å¥½çš„å‘½åï¼š
/api/reports/v2-2/generate
/api/reports/v2-2/export
/api/reports/v2-2/preview/:id

âŒ é¿å…çš„å‘½åï¼š
/api/reports/v2.2/generate        (ç‚¹å·å¯èƒ½è¢«è¯¯è®¤ä¸ºæ–‡ä»¶æ‰©å±•å)
/api/reports/V2-2/generate        (å¤§å†™ä¸ä¸€è‡´)
/api/reports/version-2-2/generate (å†—é•¿)
```

### 2.3 é‡æ„å»ºè®®

#### 2.3.1 éœ€è¦é‡æ„çš„æ–‡ä»¶

```bash
# å½“å‰ç»“æ„ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰
src/lib/report/v2_2/
src/app/api/reports/v2.2/
docs/æŠ¥å‘Šæ¨¡ç‰ˆ/v2.2/

# æ¨èç»“æ„
src/lib/report/v2-2/
src/app/api/reports/v2-2/
docs/report-templates/v2-2/
```

#### 2.3.2 ä»£ç å†…éƒ¨å¼•ç”¨æ›´æ–°

```typescript
// ä¿®æ”¹å‰
import { generateFullReport_v2_2 } from '@/lib/report/v2_2/generator';

// ä¿®æ”¹å
import { generateFullReportV22 } from '@/lib/report/v2-2/generator';
```

#### 2.3.3 æ¸è¿›å¼é‡æ„æ­¥éª¤

1. **åˆ›å»ºåˆ«åå’Œé‡æ–°å¯¼å‡º**ï¼ˆä¸å½±å“ç°æœ‰ä»£ç ï¼‰
```typescript
// src/lib/report/v2-2/index.ts
export * from '../v2_2'; // å‘åå…¼å®¹
export { generateFullReportV22 } from './generator';
```

2. **æ›´æ–°æ–°ä»£ç ä½¿ç”¨æ–°å‘½å**
```typescript
// æ–°æ–‡ä»¶ç»Ÿä¸€ä½¿ç”¨ v2-2 æ ¼å¼
import { generateFullReportV22 } from '@/lib/report/v2-2';
```

3. **é€æ­¥è¿ç§»æ—§ä»£ç **
```typescript
// æ ‡è®°æ—§å¯¼å…¥ä¸ºåºŸå¼ƒ
/** @deprecated Use generateFullReportV22 from '@/lib/report/v2-2' instead */
export { generateFullReport_v2_2 };
```

4. **æœ€ç»ˆç§»é™¤æ—§ä»£ç **ï¼ˆåœ¨æ‰€æœ‰å¼•ç”¨æ›´æ–°åï¼‰

### 2.4 ç»Ÿä¸€çš„ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**å»ºè®®åˆ›å»ºç‰ˆæœ¬å¸¸é‡æ–‡ä»¶**

```typescript
// src/constants/versions.ts
export const REPORT_VERSIONS = {
  V2_2: '2.2',
  V2_3: '2.3',
  CURRENT: '2.2',
} as const;

export type ReportVersion = typeof REPORT_VERSIONS[keyof typeof REPORT_VERSIONS];

// ä½¿ç”¨ç¤ºä¾‹
import { REPORT_VERSIONS } from '@/constants/versions';

if (reportVersion === REPORT_VERSIONS.V2_2) {
  // ä½¿ç”¨v2.2ç”Ÿæˆå™¨
}
```

---

## ä¸‰ã€å®æ–½ä¼˜å…ˆçº§å»ºè®®

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… åœ¨é¦–é¡µæ·»åŠ "ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®ï¼ˆå·²å®Œæˆï¼‰
2. ğŸ”´ åœ¨æŠ¥å‘Šç”ŸæˆAPIä¸­æ·»åŠ ç§¯åˆ†æ£€æŸ¥å’Œæ‰£é™¤é€»è¾‘
3. ğŸ”´ åœ¨å‰ç«¯æ·»åŠ ç§¯åˆ†ä½™é¢æ˜¾ç¤ºå’Œä¸è¶³æç¤º
4. ğŸ”´ å®šä¹‰å’Œå®æ–½ç§¯åˆ†å®šä»·å¸¸é‡

### ä¸­ä¼˜å…ˆçº§ï¼ˆ1-2å‘¨å†…ï¼‰
1. ğŸŸ¡ å®æ–½æ¯æ—¥å…è´¹æ¬¡æ•°é™åˆ¶
2. ğŸŸ¡ å®Œå–„è®¢é˜…å¥—é¤ç³»ç»Ÿ
3. ğŸŸ¡ æ·»åŠ æŠ¥å‘Šå†å²è®°å½•åŠŸèƒ½
4. ğŸŸ¡ æ–‡ä»¶å‘½åè§„èŒƒé‡æ„ï¼ˆåˆ›å»ºåˆ«åè¿‡æ¸¡ï¼‰

### ä½ä¼˜å…ˆçº§ï¼ˆåç»­è¿­ä»£ï¼‰
1. ğŸŸ¢ PDFå¯¼å‡ºåŠŸèƒ½
2. ğŸŸ¢ é‚®ä»¶å‘é€åŠŸèƒ½
3. ğŸŸ¢ APIæ¥å£è®¿é—®
4. ğŸŸ¢ è‡ªå®šä¹‰å“ç‰Œæ°´å°

---

## å››ã€æµ‹è¯•å»ºè®®

### 4.1 ç§¯åˆ†ç³»ç»Ÿæµ‹è¯•ç”¨ä¾‹

```typescript
describe('Credit System', () => {
  it('should deduct credits when generating report', async () => {
    const user = await createTestUser({ credits: 10 });
    await generateReport(user.id);
    const balance = await getCreditBalance(user.id);
    expect(balance).toBe(5); // 10 - 5 = 5
  });
  
  it('should reject when insufficient credits', async () => {
    const user = await createTestUser({ credits: 3 });
    await expect(generateReport(user.id)).rejects.toThrow('ç§¯åˆ†ä¸è¶³');
  });
  
  it('should not deduct credits for premium users', async () => {
    const user = await createTestUser({ credits: 10, isPremium: true });
    await generateReport(user.id);
    const balance = await getCreditBalance(user.id);
    expect(balance).toBe(10); // æœªæ‰£é™¤
  });
});
```

### 4.2 æ¯æ—¥é™åˆ¶æµ‹è¯•ç”¨ä¾‹

```typescript
describe('Daily Limits', () => {
  it('should allow up to 3 free analyses per day', async () => {
    const user = await createTestUser();
    
    for (let i = 0; i < 3; i++) {
      const result = await runBasicAnalysis(user.id);
      expect(result.success).toBe(true);
    }
    
    await expect(runBasicAnalysis(user.id)).rejects.toThrow('ä»Šæ—¥å…è´¹æ¬¡æ•°å·²ç”¨å®Œ');
  });
  
  it('should reset daily limit at midnight', async () => {
    // ä½¿ç”¨æ—¶é—´æ¨¡æ‹Ÿåº“è¿›è¡Œæµ‹è¯•
  });
});
```

---

## äº”ã€æ€»ç»“

1. **ä»˜è´¹é€»è¾‘**ï¼šå»ºè®®é‡‡ç”¨ç§¯åˆ† + è®¢é˜…æ··åˆæ¨¡å¼ï¼Œæ—¢ç»™å…è´¹ç”¨æˆ·ä½“éªŒæœºä¼šï¼Œä¹Ÿä¸ºä»˜è´¹ç”¨æˆ·æä¾›æ˜ç¡®ä»·å€¼
2. **å‘½åè§„èŒƒ**ï¼šç»Ÿä¸€ä½¿ç”¨å°å†™è¿å­—ç¬¦ï¼ˆ`v2-2`ï¼‰ç”¨äºæ–‡ä»¶/ç›®å½•ï¼ŒPascalCaseï¼ˆ`V22`ï¼‰ç”¨äºä»£ç æ ‡è¯†ç¬¦
3. **å®æ–½ç­–ç•¥**ï¼šä¼˜å…ˆå®Œå–„ç§¯åˆ†æ‰£é™¤é€»è¾‘ï¼Œç„¶åé€æ­¥é‡æ„æ–‡ä»¶å‘½åï¼Œé¿å…ä¸€æ¬¡æ€§æ”¹åŠ¨è¿‡å¤§

ä»¥ä¸Šå»ºè®®å¯æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚å’ŒæŠ€æœ¯æ ˆè¿›è¡Œè°ƒæ•´ã€‚
