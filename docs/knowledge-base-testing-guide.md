# 知识库功能测试指南

## 更新内容 (v5.1.1)

### 1. 管理后台导航集成 ✅
- **位置**：`/admin/knowledge` 和 `/admin/ai-cost`
- **文件**：`src/components/admin/layout/admin-sidebar.tsx`
- **新增菜单项**：
  - 知识库管理（Database图标）
  - AI成本监控（LineChart图标）
- **分类**：系统设置部分

### 2. 文件格式支持扩展 ✅
- **新增格式**：`.pdf`, `.docx`, `.doc`
- **原有格式**：`.txt`, `.md`, `.json`
- **依赖包**：
  - `pdf-parse`: ^1.1.1
  - `mammoth`: ^1.6.0
- **修改文件**：
  - API: `src/app/api/admin/knowledge/upload/route.ts`
  - 前端: `src/components/admin/knowledge-base-manager.tsx`

## 测试准备

### 环境检查
```bash
# 1. 确认依赖已安装
npm list pdf-parse mammoth

# 2. 确认环境变量
# .env.local 中需要：
OPENAI_API_KEY=sk-xxx...
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...

# 3. 启动开发服务器
npm run dev
```

### 测试文件
已准备三个测试文件（位于 `test-data/` 目录）：

| 文件 | 格式 | 大小 | 内容 | 分类建议 |
|------|------|------|------|---------|
| `bazi-basics.txt` | TXT | ~1.5KB | 八字命理基础知识 | bazi |
| `fengshui-basics.md` | Markdown | ~3KB | 风水基础知识 | fengshui |
| `qiflow-faq.json` | JSON | ~6KB | 常见问题FAQ | general |

**需自备测试文件**（可选）：
- PDF文件：任意文本型PDF（建议3-10页）
- DOCX文件：任意Word 2007+文档
- DOC文件：任意Word 97-2003文档

## 测试清单

### 测试 1：导航访问测试
- [ ] 启动开发服务器
- [ ] 访问 `http://localhost:3000/zh/admin/dashboard`
- [ ] 检查左侧导航栏"系统设置"部分
- [ ] 确认显示"知识库管理"菜单项
- [ ] 确认显示"AI成本监控"菜单项
- [ ] 点击"知识库管理"，跳转到 `/admin/knowledge`
- [ ] 点击"AI成本监控"，跳转到 `/admin/ai-cost`
- [ ] 确认页面正常加载，无错误

**预期结果**：
- ✅ 导航菜单正确显示
- ✅ 页面跳转正常
- ✅ 无控制台错误

### 测试 2：文件上传测试 - TXT格式
**步骤**：
1. 访问 `/admin/knowledge` 页面
2. 点击"选择文件"
3. 选择 `test-data/bazi-basics.txt`
4. 选择分类："八字命理"
5. 点击"开始上传"
6. 等待处理完成

**检查点**：
- [ ] 文件选择成功
- [ ] 上传按钮可点击
- [ ] 显示上传中状态
- [ ] Toast提示"上传成功！"
- [ ] 1秒后自动刷新列表
- [ ] 文档列表中出现新文档
- [ ] 状态："等待中" → "处理中" → "已完成"
- [ ] 显示正确的文件名、大小、分类

**预期结果**：
- ✅ 上传流程顺利
- ✅ 文档状态最终为"已完成"
- ✅ chunk_count > 0（预计1-2个块）

### 测试 3：文件上传测试 - Markdown格式
**步骤**：
1. 选择 `test-data/fengshui-basics.md`
2. 分类："风水玄学"
3. 上传

**检查点**：
- [ ] Markdown文件识别正确
- [ ] 表格、列表等格式被保留
- [ ] chunk_count合理（预计2-4个块）

### 测试 4：文件上传测试 - JSON格式
**步骤**：
1. 选择 `test-data/qiflow-faq.json`
2. 分类："通用知识"
3. 上传

**检查点**：
- [ ] JSON自动格式化
- [ ] 结构化数据被正确处理
- [ ] chunk_count较大（预计6-10个块）

### 测试 5：文件上传测试 - PDF格式
**前提**：准备一个文本型PDF文件

**步骤**：
1. 选择PDF文件
2. 分类：自定义"测试PDF"
3. 上传

**检查点**：
- [ ] PDF文件识别成功
- [ ] 文本提取正确（无乱码）
- [ ] 处理时间可能较长（视文件大小）
- [ ] 最终状态为"已完成"

**可能问题**：
- ❌ 扫描版PDF会提取失败（预期行为）
- ❌ 加密PDF无法读取（预期行为）

### 测试 6：文件上传测试 - DOCX格式
**前提**：准备一个Word文档

**步骤**：
1. 选择DOCX文件
2. 分类：自定义"测试DOCX"
3. 上传

**检查点**：
- [ ] DOCX文件识别成功
- [ ] 段落文本提取正确
- [ ] 图片、页眉页脚被忽略（预期行为）
- [ ] 表格转为文本行

### 测试 7：批量上传测试
**步骤**：
1. 同时选择多个文件（如上述3个测试文件）
2. 分类："通用知识"
3. 上传

**检查点**：
- [ ] 多文件同时上传
- [ ] 每个文件独立处理
- [ ] 所有文件都显示在列表中
- [ ] Toast显示正确的文件数量

### 测试 8：文件格式验证测试
**步骤**：
1. 尝试上传不支持的格式（如 `.zip`, `.exe`, `.png`）
2. 观察行为

**预期结果**：
- ✅ 文件选择器只显示支持的格式
- ✅ 或上传后跳过不支持的文件（服务器日志会显示警告）

### 测试 9：删除文档测试
**步骤**：
1. 找到一个已完成的文档
2. 点击"删除"按钮
3. 确认删除

**检查点**：
- [ ] 显示确认对话框
- [ ] 点击确认后文档消失
- [ ] Toast提示"删除成功"
- [ ] 数据库中相关记录被清除

### 测试 10：向量检索测试
**前提**：已上传测试文件

**步骤**：
1. 打开开发者工具控制台
2. 运行以下代码测试向量检索：

```javascript
// 测试RAG检索
fetch('/api/ai/rag/search', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: '什么是八字',
    category: 'bazi',
    topK: 3
  })
}).then(r => r.json()).then(console.log);
```

**检查点**：
- [ ] 返回相关文本块
- [ ] 相似度分数合理（0.6-1.0）
- [ ] 内容与查询相关

### 测试 11：错误处理测试
**测试场景**：

#### 11.1 空文件上传
- [ ] 不选择任何文件
- [ ] 点击上传
- [ ] 预期：Toast提示"请选择文件"

#### 11.2 自定义分类但未输入名称
- [ ] 选择文件
- [ ] 分类选"自定义"
- [ ] 不输入分类名
- [ ] 点击上传
- [ ] 预期：Toast提示"请输入分类"

#### 11.3 超大文件
- [ ] 上传超过10MB的文件
- [ ] 预期：可能超时或内存不足

#### 11.4 损坏的文件
- [ ] 上传损坏的PDF或DOCX
- [ ] 预期：状态变为"错误"，显示错误信息

### 测试 12：性能测试
**测试内容**：
- [ ] 上传10个小文件（每个<1MB）
- [ ] 记录总处理时间
- [ ] 检查内存使用情况
- [ ] 确认没有内存泄漏

**预期性能**：
- 单个文件处理时间：< 5秒
- 批量10个文件：< 30秒
- 向量检索响应：< 1秒

## 测试结果记录

### 环境信息
- Node.js版本：______
- npm版本：______
- 浏览器：______
- 日期：______

### 测试摘要
| 测试项 | 结果 | 备注 |
|--------|------|------|
| 1. 导航访问 | ☐ 通过 ☐ 失败 |  |
| 2. TXT上传 | ☐ 通过 ☐ 失败 |  |
| 3. Markdown上传 | ☐ 通过 ☐ 失败 |  |
| 4. JSON上传 | ☐ 通过 ☐ 失败 |  |
| 5. PDF上传 | ☐ 通过 ☐ 失败 |  |
| 6. DOCX上传 | ☐ 通过 ☐ 失败 |  |
| 7. 批量上传 | ☐ 通过 ☐ 失败 |  |
| 8. 格式验证 | ☐ 通过 ☐ 失败 |  |
| 9. 删除文档 | ☐ 通过 ☐ 失败 |  |
| 10. 向量检索 | ☐ 通过 ☐ 失败 |  |
| 11. 错误处理 | ☐ 通过 ☐ 失败 |  |
| 12. 性能测试 | ☐ 通过 ☐ 失败 |  |

### 发现的问题
1. 
2. 
3. 

### 改进建议
1. 
2. 
3. 

## 常见问题排查

### 上传一直"处理中"
**可能原因**：
1. OPENAI_API_KEY未配置或无效
2. 网络问题导致API调用超时
3. Supabase连接问题

**排查步骤**：
```bash
# 检查环境变量
echo $OPENAI_API_KEY

# 查看服务器日志
npm run dev 2>&1 | grep -i error

# 检查数据库连接
# 访问 Supabase控制台查看 knowledge_documents 表
```

### 文件上传后找不到
**可能原因**：
1. 文件格式不支持被跳过
2. 上传过程中出错但没有显示
3. 数据库写入失败

**排查步骤**：
1. 检查浏览器控制台错误
2. 查看Network面板API响应
3. 检查Supabase数据库表记录

### PDF/DOCX提取乱码
**可能原因**：
1. 文件编码问题
2. 特殊格式的文档
3. 加密或受保护的文档

**解决方案**：
- 尝试用其他工具打开并重新保存
- 使用不同版本的文档格式
- 检查文档是否加密

## 下一步工作

### 优化方向
- [ ] 添加文件大小校验（前端+后端）
- [ ] 显示处理进度百分比
- [ ] 支持断点续传
- [ ] 添加文件预览功能
- [ ] 优化大文件分块策略

### 功能扩展
- [ ] PPT/PPTX格式支持
- [ ] HTML网页导入
- [ ] 扫描版PDF OCR支持
- [ ] 图片描述生成
- [ ] 自动摘要生成

### 监控与维护
- [ ] 添加上传失败告警
- [ ] 定期清理过期文档
- [ ] 向量索引优化
- [ ] 成本监控集成

---

**测试完成后，请将结果反馈至开发团队！**
