# 八字综合组件使用指南

## 📍 完整流程概览

你的项目已经拥有完整的八字分析系统，用户从首页输入信息后即可看到专业分析结果。

```
首页表单 (HeroWithForm)
    ↓ 填写出生信息
    ↓ 点击"立即分析"
报告页面 (/zh-CN/report)
    ↓ 自动调用 API
    ↓ 展示完整八字分析
专业分析结果 (BaziProfessionalResult)
```

---

## 🎯 核心组件清单

### 1. **首页表单组件**
**文件位置**: `src/components/home/HeroWithForm.tsx`
**路由地址**: `/zh-CN` （首页）

**功能特性**:
- ✅ 姓名、性别输入
- ✅ 出生日期选择（年/月/日分开）
- ✅ 阴历/阳历切换
- ✅ 精确时间选择 + 快捷时段按钮
- ✅ 出生城市输入（真太阳时校正）
- ✅ 可选的房屋风水信息（朝向、房间数、落成年月）
- ✅ 数据自动保存到 sessionStorage 和 localStorage

**提交后操作**:
```typescript
// 保存表单数据
sessionStorage.setItem('analysisFormData', JSON.stringify(reportData));

// 跳转到报告页面
router.push('/zh-CN/report');
```

---

### 2. **报告展示页面**
**文件位置**: `src/app/[locale]/(routes)/report/page.tsx`
**路由地址**: `/zh-CN/report`

**功能特性**:
- ✅ 自动读取 sessionStorage 中的表单数据
- ✅ 基本信息展示卡片
- ✅ Tabs 切换：八字分析 / 风水分析
- ✅ AI 聊天上下文自动同步
- ✅ 数据同步状态提示
- ✅ 返回按钮和手动同步按钮

**数据加载优先级**:
1. `sessionStorage.analysisFormData` (最新提交)
2. URL 参数 `data`
3. `localStorage.formHistory` (历史记录)

---

### 3. **八字完整分析组件**
**文件位置**: `src/components/qiflow/analysis/bazi-complete-analysis.tsx`

**功能特性**:
- ✅ 自动调用 API: `/api/qiflow/bazi-unified`
- ✅ Loading 状态处理
- ✅ 错误处理
- ✅ 数据适配器转换（API → 专业版格式）
- ✅ 分析完成回调 `onAnalysisComplete`

**API 调用代码**:
```typescript
const response = await fetch('/api/qiflow/bazi-unified', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    name: personal.name,
    birthDate: personal.birthDate,
    birthTime: personal.birthTime,
    gender: personal.gender,
    birthCity: personal.birthCity || '',
    calendarType: personal.calendarType || 'solar',
  }),
});
```

---

### 4. **专业八字分析结果组件**
**文件位置**: `src/components/qiflow/analysis/bazi-professional-result.tsx`

**包含的完整分析内容**:

#### 📊 八字命盘
- 年柱、月柱、日柱、时柱
- 天干地支显示
- 纳音五行（可选）

#### 🛡️ 五行力量分析
- 日主强度评分
- 五行占比（木火土金水）
- 进度条可视化
- 最强/最弱标识

#### ⭐ 命格格局
- 格局名称和描述
- 格局纯度评分
- 辅助格局列表

#### 🎯 用神忌神
- 用神（主要喜神）
- 喜神（次要喜神）
- 忌神（避免五行）
- 开运建议

#### 🔮 神煞分析
- 吉神列表（带强度和描述）
- 凶神列表（带规避建议）

#### 📅 大运流年时间轴
- 可视化时间线组件
- 当前年龄标识
- 每个大运的质量评级
- 详细描述和建议

#### 📝 详细解读（Tabs）
1. **综合解读**: 整体概况、优势、改善建议
2. **性格特质**: 性格分析详情（折叠式）
3. **事业发展**: 适合行业、发展方向、运势分析
4. **财运分析**: 财运总评、理财建议、时机分析
5. **感情人际**: 感情运、家庭运、人际关系
6. **健康建议**: 需注意事项和建议

---

## 🔌 API 路由

### `/api/qiflow/bazi-unified`
**文件位置**: `src/app/api/qiflow/bazi-unified/route.ts`

**请求参数**:
```typescript
{
  name: string;          // 姓名
  birthDate: string;     // 格式: YYYY-MM-DD
  birthTime: string;     // 格式: HH:MM
  gender: 'male' | 'female';
  birthCity?: string;    // 可选
  calendarType: 'solar' | 'lunar';  // 默认 solar
}
```

**积分消耗**:
- 已登录用户: 10 积分
- 未登录用户: 免费试用（基础功能）

**返回数据结构**:
```typescript
{
  success: true,
  data: {
    bazi: { year, month, day, hour },
    wuxing: { wood, fire, earth, metal, water, analysis },
    personality: { summary, strengths, weaknesses },
    career: { suitable, direction, timing },
    wealth: { overall, advice, timing },
    health: { concerns, advice },
    relationships: { love, family, friends },
    creditsUsed: number,
    isFreeTrial: boolean,
    analysisDate: string,
    inputData: { ... }
  }
}
```

**⚠️ 注意**: 当前返回的是模拟数据，需要集成真实的八字分析引擎。

---

## 🔧 支持组件

### 1. AI 聊天上下文组件
**文件**: `src/components/qiflow/ai-chat-with-context.tsx`
- 悬浮在页面右下角
- 自动获取用户输入和分析结果
- 智能问答功能

### 2. 历史快速填充
**文件**: `src/components/qiflow/history-quick-fill.tsx`
- 显示最近 5 条分析记录
- 一键快速填充表单
- 支持删除单条记录

### 3. 城市定位选择器
**文件**: `src/components/qiflow/city-location-picker.tsx`
- 手动输入城市
- 热门城市快捷选择
- 地理定位功能（待实现）

### 4. 房屋平面图上传
**文件**: `src/components/qiflow/house-layout-upload.tsx`
- 点击上传 / 拖拽上传
- 实时预览
- 文件类型和大小验证

---

## 🚀 使用流程

### 第一步：用户访问首页
```
URL: http://localhost:3000/zh-CN
```

首页会展示 `HeroWithForm` 组件，用户可以：
1. 填写姓名、性别
2. 选择出生日期（年/月/日）
3. 选择阴历或阳历
4. 输入或选择出生时间
5. 可选：填写出生城市
6. 可选：展开风水信息（房屋朝向、房间数等）

### 第二步：提交表单
点击 "立即生成专属分析报告" 按钮后：
1. 数据验证（必填项检查）
2. 保存到 sessionStorage: `analysisFormData`
3. 保存到 localStorage: `formHistory` (历史记录)
4. 跳转到 `/zh-CN/report`

### 第三步：查看分析结果
Report 页面会：
1. 自动读取 sessionStorage 中的数据
2. 显示基本信息卡片
3. 显示八字分析 Tab
4. `BaziCompleteAnalysis` 组件自动调用 API
5. API 返回数据后，通过适配器转换为专业格式
6. `BaziProfessionalResult` 展示完整的分析结果

### 第四步：互动功能
- 使用 AI 聊天询问详细问题
- 点击「手动同步」按钮刷新 AI 上下文
- 如果有风水信息，可切换到「风水布局分析」Tab
- 分享或下载报告（功能待实现）

---

## 📊 数据流转图

```
┌─────────────────┐
│   首页表单      │
│  HeroWithForm   │
└────────┬────────┘
         │ 提交
         ↓
┌────────────────────────┐
│  sessionStorage        │
│  + localStorage        │
└────────┬───────────────┘
         │ 读取
         ↓
┌─────────────────┐
│   Report 页面   │
│  /zh-CN/report  │
└────────┬────────┘
         │
         ↓
┌──────────────────────┐
│ BaziCompleteAnalysis │
└────────┬─────────────┘
         │ API 调用
         ↓
┌───────────────────────────┐
│  /api/qiflow/bazi-unified │
└────────┬──────────────────┘
         │ 返回数据
         ↓
┌─────────────────────┐
│    数据适配器       │
│  (API → 专业格式)   │
└────────┬────────────┘
         │
         ↓
┌──────────────────────────┐
│ BaziProfessionalResult   │
│ (完整八字分析展示)       │
└──────────────────────────┘
```

---

## ✅ 功能完整性检查

| 功能模块 | 状态 | 文件位置 |
|---------|------|----------|
| 首页表单 | ✅ 完整 | `src/components/home/HeroWithForm.tsx` |
| 报告页面 | ✅ 完整 | `src/app/[locale]/(routes)/report/page.tsx` |
| 八字分析组件 | ✅ 完整 | `src/components/qiflow/analysis/bazi-complete-analysis.tsx` |
| 专业结果展示 | ✅ 完整 | `src/components/qiflow/analysis/bazi-professional-result.tsx` |
| API 路由 | ⚠️ 模拟数据 | `src/app/api/qiflow/bazi-unified/route.ts` |
| AI 聊天 | ✅ 完整 | `src/components/qiflow/ai-chat-with-context.tsx` |
| 历史记录 | ✅ 完整 | `src/components/qiflow/history-quick-fill.tsx` |
| 城市选择器 | ✅ 完整 | `src/components/qiflow/city-location-picker.tsx` |

---

## 🔥 立即测试

### 1. 启动开发服务器
```bash
npm run dev
# 或
yarn dev
```

### 2. 访问首页
```
http://localhost:3000/zh-CN
```

### 3. 填写测试数据
- **姓名**: 测试用户
- **性别**: 女
- **出生日期**: 1995年3月15日
- **出生时间**: 08:00 （或点击"上午"快捷按钮）
- **历法**: 阳历
- **出生城市**: 北京（可选）

### 4. 点击提交
点击 "立即生成专属分析报告" 按钮

### 5. 查看结果
自动跳转到 `/zh-CN/report`，展示完整的八字分析结果

---

## 📝 后续优化建议

### 高优先级
1. ✅ **集成真实八字引擎** - 替换 API 中的模拟数据
2. **完善大运流年数据** - 确保时间线组件有完整数据
3. **添加报告下载功能** - PDF 导出
4. **添加报告分享功能** - 生成分享链接

### 中优先级
5. **优化适配器** - 确保 API 数据完全匹配专业格式
6. **添加更多神煞** - 扩展神煞分析内容
7. **性能优化** - 大数据量时的渲染优化
8. **移动端适配** - 响应式设计优化

### 低优先级
9. **多语言支持** - 英文、繁体中文
10. **主题切换** - 暗色模式
11. **动画效果** - 增强用户体验
12. **打印样式** - 优化打印布局

---

## ❓ 常见问题

### Q1: 为什么看不到分析结果？
**A**: 检查以下几点：
1. 确保填写了所有必填项（姓名、性别、日期、时间）
2. 检查浏览器控制台是否有错误
3. 确认 API 路由 `/api/qiflow/bazi-unified` 正常运行

### Q2: 数据没有保存？
**A**: 数据会自动保存到：
- `sessionStorage.analysisFormData` (当次会话)
- `localStorage.formHistory` (历史记录，最多5条)

### Q3: AI 聊天没有上下文？
**A**: 点击报告页面右上角的「手动同步」按钮，将数据同步到 AI 聊天。

### Q4: 积分不足怎么办？
**A**: 
- 未登录用户可以免费试用基础功能
- 已登录用户需要至少 10 积分
- 前往 `/settings/credits` 充值积分

---

## 📞 技术支持

如有问题或建议，请联系开发团队。

**文档版本**: v2.0  
**最后更新**: 2025-01-19  
**作者**: AI Assistant
