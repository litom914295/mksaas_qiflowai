# v2.1 A/B测试上线前检查清单

在启动v2.1 A/B测试前，请逐项确认以下内容。

---

## ✅ 一、代码与测试（强制）

### 1.1 核心功能完成度
- [ ] ✅ generateDecisionWindows() 完善（月令+五行互动）
- [ ] ✅ generateWaterActions()/generateMountainActions() 集成物品库
- [ ] ✅ generateActionPlan() 分级行动清单
- [ ] ✅ generateFengshuiChecklist() 风水Checklist
- [ ] ✅ generateFullReport_v2_2() 完整流程

### 1.2 单元测试覆盖
- [ ] ✅ fengshui-checklist.test.ts（513行，13个测试用例）
- [ ] ✅ generate-decision-windows.test.ts（482行，17个测试用例）
- [ ] ✅ generate-action-plan.test.ts（已有，17个测试用例）
- [ ] ✅ 测试覆盖率 ≥80%

### 1.3 集成测试
- [ ] ✅ report-v2.1-integration.test.ts（656行，20+个测试用例）
- [ ] ✅ 5个完整案例验证通过
- [ ] ✅ JSON格式验证通过
- [ ] ✅ 性能测试通过（生成时间<5秒）

### 1.4 代码审查
- [ ] 代码已通过Code Review
- [ ] 无明显性能问题（如N+1查询）
- [ ] 错误处理完善（try-catch、兜底逻辑）
- [ ] 类型定义完整（TypeScript strict mode通过）

---

## ✅ 二、A/B测试工具（强制）

### 2.1 AB工具库
- [ ] ✅ src/lib/ab/ab-utils.ts 已创建
- [ ] ✅ getABVariant() 函数正常工作
- [ ] ✅ trackABEvent() 埋点函数正常工作
- [ ] ✅ hashUserId() 哈希算法测试通过（相同userId分配一致）

### 2.2 报告生成入口修改
- [ ] 报告生成API已集成AB逻辑（根据variant选择v2.0/v2.1）
- [ ] Cookie读写正常（ab_v21 cookie生命周期7天）
- [ ] 环境变量AB_V21_ENABLED控制生效

### 2.3 埋点验证
- [ ] report_generated 事件正常上报
- [ ] report_viewed 事件正常上报
- [ ] pay_success 事件正常上报
- [ ] satisfaction_submitted 事件正常上报
- [ ] 事件包含variant字段

---

## ✅ 三、环境与配置（强制）

### 3.1 环境变量
- [ ] ✅ .env.ab-test.example 已创建
- [ ] .env.production 已配置AB_V21_ENABLED=true
- [ ] 生产环境已重启应用（使环境变量生效）
- [ ] 调试变量AB_V21_FORCE_VARIANT已注释（生产环境禁止使用）

### 3.2 数据库/缓存
- [ ] 数据库表结构支持v2.1（如需新增字段）
- [ ] 缓存策略调整（v2.0和v2.1报告分开缓存）
- [ ] 数据迁移脚本已执行（如有）

### 3.3 监控与告警
- [ ] 报告生成耗时监控已配置（阈值5秒）
- [ ] JSON解析失败率监控已配置（阈值1%）
- [ ] 5xx错误率监控已配置（阈值+0.5pp）
- [ ] 告警通知渠道已配置（钉钉/企业微信/邮件）

---

## ✅ 四、灰度与回滚（强制）

### 4.1 灰度发布准备
- [ ] 灰度流量比例已配置（建议10%，2小时观测）
- [ ] 灰度阶段护栏指标已明确（错误率/超时/JSON失败率）
- [ ] 灰度期间日志级别已调整（debug模式）

### 4.2 回滚预案
- [ ] 回滚操作已演练（AB_V21_ENABLED=false）
- [ ] 回滚时间 ≤5分钟（环境变量修改+重启）
- [ ] 回滚决策人已指定（项目负责人）
- [ ] 紧急联系方式已确认

### 4.3 回滚触发条件
- [ ] JSON解析失败率 >1%
- [ ] 报告生成超时率 >5%
- [ ] 5xx错误率增长 >0.5pp
- [ ] 用户投诉显著增加（>5条/小时）

---

## ✅ 五、文档与沟通（推荐）

### 5.1 技术文档
- [ ] ✅ v2.1_AB测试部署计划.md 已创建
- [ ] ✅ AB测试日报模板.md 已创建
- [ ] ✅ v2.1上线前检查清单.md（本文件）
- [ ] API文档已更新（如有变动）

### 5.2 团队沟通
- [ ] 实验目标已同步给团队（转化率≥10%、ARPU≥¥150、满意度≥90%）
- [ ] 实验周期已明确（7天+灰度2小时）
- [ ] 每日日报时间已确认（每日10:00）
- [ ] 决策会议时间已确认（Day 7，10:00）

### 5.3 用户沟通
- [ ] 用户通知（可选）：是否需要提前告知用户"报告升级"
- [ ] 客服培训：客服团队已了解v2.1新功能
- [ ] FAQ准备：常见问题解答已准备

---

## ✅ 六、数据与报表（推荐）

### 6.1 数据准备
- [ ] 历史基线数据已确认（v2.0的CR/ARPU/满意度）
- [ ] 数据统计口径已明确（unique userId per day）
- [ ] 样本量估算已完成（预估每天XX用户暴露）

### 6.2 报表工具
- [ ] 日报生成脚本已准备（手动或自动）
- [ ] 数据看板已配置（如有BI系统）
- [ ] 趋势图绘制工具已准备

---

## ✅ 七、风险评估（推荐）

### 7.1 技术风险
- [ ] v2.1生成耗时可能增加（已在测试中验证<5秒）
- [ ] JSON格式变更可能导致前端解析失败（已验证兼容性）
- [ ] 物品库数据不完整（已验证469项物品）

### 7.2 业务风险
- [ ] 用户不理解v2.1新功能（已准备FAQ）
- [ ] 行动建议过于激进导致用户反感（已验证用户反馈）
- [ ] 决策窗口不准确导致投诉（已设置置信度65-95）

### 7.3 缓解措施
- [ ] 灰度阶段严格监控护栏指标
- [ ] 用户投诉快速响应机制（<2小时）
- [ ] 技术支持值班表已排定

---

## ✅ 八、上线操作（执行时填写）

### 8.1 Day 0 上午（灰度）
- [ ] 10:00 修改环境变量AB_V21_ENABLED=true
- [ ] 10:05 重启应用服务
- [ ] 10:10 验证灰度流量10%（查看日志/监控）
- [ ] 10:10-12:10 观测2小时护栏指标
- [ ] 12:10 灰度阶段决策（通过/回滚）

### 8.2 Day 0 下午（正式AB）
- [ ] 14:00 提升流量至50%/50%
- [ ] 14:05 验证分流比例正确
- [ ] 14:10 首次埋点数据确认
- [ ] 16:00 Day 0日报生成（部分数据）

### 8.3 Day 1-7（日常监控）
- [ ] 每日10:00 生成日报
- [ ] 每日11:00 团队复盘会（15分钟）
- [ ] 异常情况随时沟通

### 8.4 Day 7（决策）
- [ ] 10:00 决策会议（是否全量上线）
- [ ] 11:00 执行决策（全量上线或回滚）
- [ ] 12:00 发布公告（内部/外部）

---

## ✅ 九、成功标准（参考）

### 9.1 主要指标达标
- [ ] 转化率 ≥10%（Treatment vs Control）
- [ ] ARPU ≥¥150（Treatment vs Control）
- [ ] 满意度 ≥90%（Treatment vs Control）

### 9.2 护栏指标正常
- [ ] 退款率 ≤3%
- [ ] JSON解析失败率 ≤1%
- [ ] 生成超时率 ≤5%
- [ ] 5xx错误率 ≤0.5pp增长

### 9.3 用户反馈良好
- [ ] "我知道该干什么"同意度 ≥90%
- [ ] 用户投诉量无显著增加
- [ ] NPS ≥70

---

## 📝 签字确认

| 角色 | 姓名 | 确认时间 | 签名 |
|------|------|---------|------|
| 项目负责人 | ______ | _______ | ____ |
| 技术负责人 | ______ | _______ | ____ |
| 测试负责人 | ______ | _______ | ____ |
| 数据分析 | ______ | _______ | ____ |

---

**检查清单版本**：v1.0  
**最后更新**：2025-01-14  
**维护人**：[姓名]
