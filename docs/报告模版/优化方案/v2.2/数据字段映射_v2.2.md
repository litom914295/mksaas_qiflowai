# 📐 字段定义草案 v2.2（八字→策略/行动映射｜飞星→Checklist映射）

> 目的：确保前后端对齐；同时提供 TypeScript 接口与 JSON Schema 方向（示例）。

---

## 一、八字 → 策略/行动 映射（Bazi → StrategyMapping）

- 输入来源：`analyzePattern` 结果 + Luck Pillars + YongShen（若有）
- 输出目标：职业匹配、时机窗口、分级行动、风险与归因、主题叙事

### TypeScript 接口

```ts
export type FiveElement = '木' | '火' | '土' | '金' | '水';
export type TenGod = '比肩' | '劫财' | '食神' | '伤官' | '偏财' | '正财' | '偏官' | '正官' | '偏印' | '正印';

export interface TimeWindow {
  from: string; // ISO，如 '2027-02-04'
  to: string;   // ISO，如 '2027-04-20'
  confidence: number; // 0-100
  note?: string;
}

export interface ActionItem {
  id: string;
  title: string;
  reason: string;        // 为什么做（命理/用神/调候等依据）
  expectedImpact: string; // 预期结果（可量化更好）
  expectedTimeframe: string; // 见效时间，如 '1-2周'
  relatedElements?: FiveElement[];
  relatedGods?: TenGod[];
  checklist?: string[];   // 子步骤
}

export interface StrategyMapping {
  lifeTheme: {
    title: string;
    summary: string;
    stages: Array<{
      ageRange: string;
      likelyEvents: string[];
      meaning: string;
      lesson: string;
      skills: string[];
      evidence?: string[];
    }>;
  };
  careerMatch: Array<{ career: string; score: number; rationale: string }>;
  decisionWindows: Array<{ topic: string; window: TimeWindow; rationale: string }>;
  actions: {
    essential: ActionItem[];
    recommended: ActionItem[];
    optional: ActionItem[];
  };
  riskWarnings: string[];
  attribution: {
    timeFactor: number;       // 时间/大运/流年
    endowmentFactor: number;  // 先天禀赋/五行
    environmentFactor: number;// 环境/风水
    strategyFactor: number;   // 方法/策略
    notes?: string[];
  };
}
```

---

## 二、飞星 → Checklist 映射（FlyingStars → FengshuiChecklist）

- 输入来源：`analyzeLingzheng`、`generateLingzhengRecommendations`、零正审计
- 输出目标：水/山位可执行任务、风险级别、运转变更建议

### TypeScript 接口

```ts
export type Severity = 'high' | 'medium' | 'low';
export type PalaceIndex = 1|2|3|4|5|6|7|8|9; // 例：九宫索引

export interface EnvironmentalTask {
  id: string;
  palace: PalaceIndex;
  bagua: string;   // 如 '乾' '坎' '艮' ...
  task: string;    // 动作：摆放/清理/移动/增亮等
  rationale: string; // 命理/飞星/零正依据
  severity: Severity;
  expectedImpact?: string;
  dueBy?: string;     // 截止时间或窗口
  recurrence?: 'weekly' | 'monthly' | 'quarterly';
}

export interface FengshuiChecklist {
  waterPlacement: {
    favorablePalaces: PalaceIndex[];
    unfavorablePalaces: PalaceIndex[];
    actions: EnvironmentalTask[];
  };
  mountainPlacement: {
    favorablePalaces: PalaceIndex[];
    unfavorablePalaces: PalaceIndex[];
    actions: EnvironmentalTask[];
  };
  environmentChecklist: EnvironmentalTask[];
  timeChangeAdvice: {
    transitionAdvice: string[];
    riskLevel: 'high' | 'medium' | 'low';
    riskDescription: string;
  };
  zeroPositiveAudit: {
    isReversed: boolean;
    issues: string[];
    severity: 'critical' | 'major' | 'minor' | 'none';
  };
}
```

---

## 三、数据落点（模板占位变量 ←→ 字段）

- {{life_theme_title}} ← StrategyMapping.lifeTheme.title
- {{life_theme_summary}} ← StrategyMapping.lifeTheme.summary
- {{stage_1_*}} ← StrategyMapping.lifeTheme.stages[0]
- {{useful_god_primary}} ← analyzePattern.usefulGod.primary[0]
- {{decision_windows}} → 展开为表格：StrategyMapping.decisionWindows
- {{fs_task_*}} ← FengshuiChecklist.environmentChecklist[n]
- {{water_favorable_palaces}} ← FengshuiChecklist.waterPlacement.favorablePalaces
- {{mountain_favorable_palaces}} ← FengshuiChecklist.mountainPlacement.favorablePalaces
- {{zero_positive_*}} ← FengshuiChecklist.zeroPositiveAudit

（完整映射见模板尾部“占位变量字典”）
