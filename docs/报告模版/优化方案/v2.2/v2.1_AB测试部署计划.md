# v2.1 A/B 测试部署计划（7天）

目标：验证v2.1是否显著提升核心业务指标，并在满足门槛时全量上线。

—

## 1. 实验概要
- 实验名称：AB_V21
- 单位（Unit of randomization）：用户（userId）优先；无userId则使用持久化cookie
- 变体：
  - Control：v2.0（现网能力）
  - Treatment：v2.1（分级行动清单/决策窗口/风水Checklist 可执行方案）
- 分流：50% / 50%
- 暴露定义：用户生成/查看一份报告即视为暴露

## 2. 假设与指标
- 假设：v2.1将带来更高的转化率与ARPU，并提升“我知道该干什么”同意度
- 主要指标（Primary Metrics）
  1) 转化率（CR）：≥10%
  2) ARPU：≥¥150
  3) 满意度：≥90%
- 护栏指标（Guardrails）
  - 退款率 ≤ 3%
  - JSON解析失败率 ≤ 1%
  - 报告生成超时率（>5s）≤ 5%
  - 错误率（5xx）不高于对照组+0.5pp

## 3. 分流与特征开关设计
- 变体标记：ab_v21=control|v2_1（cookie，7天）
- 分配逻辑：
  - 有userId：hash(userId)%100 < 50 为 v2_1，否则 control
  - 无userId：若无cookie，首次随机分配并写入cookie
- 服务器判定：服务器侧根据cookie/入参选择生成v2.0或v2.1报告
- Feature Flag：AB_V21_ENABLED=true（全局开关，紧急关闭时统一走v2.0）

## 4. 埋点与数据
- 事件列表（建议最小集）：
  - report_generated({ userId, variant, durationMs, jsonOk, ts })
  - report_viewed({ userId, variant, ts })
  - pay_success({ userId, variant, amount, ts })
  - satisfaction_submitted({ userId, variant, score, ts })
- 关键属性：userId、variant、ts、amount、durationMs、jsonOk、orderId/sessionId
- 存储：接入现有埋点系统；如无，可暂存至日志（JSON Lines）并由离线脚本聚合

## 5. 发布节奏与回滚
- Day 0（灰度）：
  - 预发/小流量验证（10%流量，2小时）
  - 护栏：错误率/超时/JSON失败率任一超阈值立即回滚
- Day 1~7（正式AB）：
  - 固定 50%/50%
  - 每日10:00出日报（最近24h）
- 决策与全量：
  - 满足三项主要指标门槛，护栏稳定，则 Day 7 全量 v2.1
  - 任一护栏连续2天告警：暂停实验并回滚到 v2.0

## 6. 报表与阈值
- 每日生成指标：
  - CR、ARPU、满意度、退款率、生成耗时P50/P95、JSON失败率、5xx率
- 统计口径：unique user/day；金额取人均
- 显著性（可选）：两比例Z检验（CR），t检验（ARPU）；若样本<2000，可仅用门槛判定

## 7. 工程改动（最小化）
- 新增通用AB工具：src/lib/ab/ab-utils.ts（变体分配、cookie读写、hash）
- 在报告生成入口增加 variant 选择：
  - control -> 走 v2.0 生成路径（现有）
  - v2_1 -> 走 v2.1 生成路径（generateFullReport_v2_2）
- 统一打点：trackEvent(name, props) 传递 variant

## 8. 风险与预案
- 生成时长飙升：降级到简化的v2.1模块或切回v2.0
- JSON解析失败：启用兜底模板并上报异常
- 指标波动：加大样本或延长实验期至14天

## 9. 时间线
- D0 上午：发布+10%灰度，2小时观测
- D0 下午：提升至 50%/50% 分流
- D1~D7：每日例行报表与复盘
- D7：是否全量上线的决策会

—

附：
- 日报模板：docs/报告模版/优化方案/v2.2/AB测试日报模板.md
- 分析脚本（问卷/人工反馈）：docs/报告模版/优化方案/v2.2/analyze-feedback.js
