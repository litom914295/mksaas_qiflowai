# 子任务14.3：希望之光时间线实施说明

> **完成日期**: 2025年1月
> **预计工时**: 3天
> **实际工时**: 1天（提前完成）

---

## 一、功能概述

`generateHopeTimeline()` 函数生成用户的**希望之光时间线**，分为短期/中期/长期三个阶段，并提供3个"为什么会好"的命理依据。

### 核心话术

> **"还有XX年（或XX个月），您的局面就会明显好转。"**

### 设计目标

- **给用户盼头**：明确改善时间点，避免"遥遥无期"
- **量化改善**：具体数字（如"收入提升20-30%"），而非抽象描述
- **可信度**：3个命理依据，增强用户信任
- **行动导向**：即使大运不利，也强调"策略+环境"可改善

---

## 二、算法逻辑

### 2.1 整体流程

```
输入：luckPillars + currentAge + patternAnalysis
  ↓
1. 分析当前大运状态（有利/不利）
2. 查找下一个有利大运（转折点）
  ↓
3. 生成短期希望（6-12月）
4. 生成中期希望（1-3年，含转折点）
5. 生成长期希望（3-10年）
  ↓
6. 生成3个"为什么会好"的理由
  ↓
输出：HopeTimeline
```

---

### 2.2 短期希望（6-12月）

#### 场景1: 当前大运有利

```typescript
changes: [
  "2025年春夏季：人际关系改善，贵人出现概率65%",
  "2025年下半年：工作/项目进展顺利，收入提升10-15%"
]
```

#### 场景2: 当前大运不利

```typescript
changes: [
  "2025年下半年：小的积极信号出现，如贵人提点、新机会浮现",
  "2026年上半年：状态调整后，精力/效率提升10%左右"
]
```

#### 场景3: 格局弱（可控部分补救）

```typescript
changes: [
  "调整风水和行动策略后，6个月内状态可改善5-10%"
]
```

**关键特征**：
- 改善幅度小（5-20%），但给予即时反馈
- 时间具体（春夏季/下半年）
- 结合可控因素（风水/策略）

---

### 2.3 中期希望（1-3年）

#### 场景1: 有明确转折点（1-3年内）

```typescript
midTerm: {
  timeframe: "1-3年",
  turningPoint: "2027年春季（大运切换，约30岁）",
  changes: [
    "2027年春夏季：**运势转折点**，职业升迁/创业机会出现",
    "2027-2029年：收入提升20-30%，事业进入上升通道"
  ]
}

// 如果转折点≤2年，强调时间感
if (yearsUntilTurning <= 2) {
  changes.push("**还有2年，您的局面就会明显好转。**");
}
```

#### 场景2: 当前已在好运中（无转折点）

```typescript
midTerm: {
  timeframe: "1-3年",
  turningPoint: undefined,
  changes: [
    "2026-2028年：当前好运持续，事业稳步上升",
    "2027年：收入提升20-35%，社会地位提高"
  ]
}
```

#### 场景3: 无明显转折点（依靠策略）

```typescript
midTerm: {
  timeframe: "1-3年",
  turningPoint: undefined,
  changes: [
    "2026-2028年：虽无明显天时，但通过策略优化，可改善15-25%",
    "2027年：积累期，为未来爆发做准备"
  ]
}
```

**改善幅度根据格局强度调整**：
- 格局强：30-50%
- 格局中：20-30%
- 格局弱：15-25%

---

### 2.4 长期希望（3-10年）

#### 场景1: 有多个有利大运（高峰期）

```typescript
longTerm: {
  timeframe: "3-10年",
  changes: [
    "2030-2035年：**人生高峰期**，连续好运，事业达到顶峰",
    "2032年左右：财富积累突破，有机会实现财务自由或行业地位"
  ]
}
```

#### 场景2: 有一个有利大运

```typescript
longTerm: {
  timeframe: "3-10年",
  changes: [
    "2031年左右：事业高峰期，收入45-60%以上",
    "2033-2036年：进入稳定期，享受前期积累的成果"
  ]
}
```

#### 场景3: 无明显有利大运（积累型）

```typescript
longTerm: {
  timeframe: "3-10年",
  changes: [
    "2032年左右：积累到一定程度，质变引发量变，迎来突破",
    "2033-2035年：进入成熟期，事业达到相对稳定的高度"
  ]
}
```

**特殊格局加成**：
- 从格：`"长期看利用大环境，有机会成为行业领导者"`
- 格局强：`"长期成就可期，有机会成为所在领域的佼佼者"`

---

### 2.5 "为什么会好"的3个理由

#### 理由1: 大运角度

| 场景 | 话术示例 |
|------|----------|
| **即将转好（≤3年）** | "**大运即将切换**：还有2年（30岁时），用神得力，天时转向有利，是命理学上的自然周期。" |
| **远期转好（>3年）** | "**大运周期规律**：40岁后进入新大运，用神得力，是命理上的转折点。" |
| **当前有利** | "**当前大运有利**：您正处于用神得力的大运期，天时支持，只要策略得当，就会持续改善。" |
| **当前不利无转折** | "**时间是您的盟友**：即使当前大运不利，但随着时间推移，总会迎来有利期。历史规律如此。" |

#### 理由2: 格局角度

| 场景 | 话术示例 |
|------|----------|
| **格局强+纯** | "**格局先天优势**：您的格局清纯有力，属于人群15%的优质格局，一旦天时到来，爆发力强。" |
| **从格** | "**从格特殊优势**：您是从格，属于顺势型格局，历史上许多从格者都是中晚年大器晚成。" |
| **格局弱** | "**后天可塑性强**：格局虽弱，但可塑空间大，通过策略优化和环境调整，改善空间大，反而更灵活。" |
| **格局中等** | "**格局均衡有潜力**：您的格局属中等水平，这意味着后天努力和机遇把握同等重要，有很大上升空间。" |

#### 理由3: 积累角度

| 年龄段 | 话术示例 |
|--------|----------|
| **< 35岁** | "**年轻是最大资本**：您还年轻，当前的积累和磨练，都会在未来3-5年转化为经验优势，届时爆发力更强。" |
| **35-50岁** | "**中年经验优势**：您已积累了丰富的经验和资源，一旦天时转好，这些积累将迅速转化为成果，进入收获期。" |
| **≥50岁** | "**成熟智慧优势**：您的人生阅历和智慧是年轻人无法比拟的，这些优势会帮助您在未来的机会中更稳健地把握。" |

---

## 三、测试用例

### 3.1 案例1: 大运即将转好型（28岁，还有2年）

**输入**:
```typescript
{
  luckPillars: [
    { startAge: 20, element: '金' }, // 忌神
    { startAge: 30, element: '木' }  // 用神得力
  ],
  currentAge: 28,
  patternAnalysis: {
    patternStrength: 'medium',
    usefulGod: { element: '木' }
  }
}
```

**输出**:
```json
{
  "shortTerm": {
    "timeframe": "6-12个月",
    "changes": [
      "2025年下半年：小的积极信号出现，如贵人提点、新机会浮现",
      "2026年上半年：状态调整后，精力/效率提升10%左右"
    ]
  },
  "midTerm": {
    "timeframe": "1-3年",
    "turningPoint": "2027年春季（大运切换，约30岁）",
    "changes": [
      "2027年春夏季：**运势转折点**，职业升迁/创业机会出现",
      "2027-2029年：收入提升20-30%，事业进入上升通道",
      "**还有2年，您的局面就会明显好转。**"
    ]
  },
  "longTerm": {
    "timeframe": "3-10年",
    "changes": [...]
  },
  "whyYouWillImprove": [
    "**大运即将切换**：还有2年（30岁时），用神得力，天时转向有利，是命理学上的自然周期。",
    "**格局均衡有潜力**：您的格局属中等水平，这意味着后天努力和机遇把握同等重要，有很大上升空间。",
    "**年轻是最大资本**：您还年轻，当前的积累和磨练，都会在未来3-5年转化为经验优势，届时爆发力更强。"
  ]
}
```

**用户反馈预期**: "有盼头了，还有2年就好了！"

---

### 3.2 案例2: 大运当前有利型（25岁）

**输入**:
```typescript
{
  luckPillars: [
    { startAge: 20, element: '木' },  // 用神得力
    { startAge: 30, element: '金' }
  ],
  currentAge: 25,
  patternAnalysis: {
    patternStrength: 'strong',
    patternPurity: 'pure',
    usefulGod: { element: '木' }
  }
}
```

**输出**:
```json
{
  "midTerm": {
    "turningPoint": undefined, // 无转折点
    "changes": [
      "2026-2028年：当前好运持续，事业稳步上升",
      "2027年：收入提升20-35%，社会地位提高"
    ]
  },
  "whyYouWillImprove": [
    "**当前大运有利**：您正处于用神得力的大运期，天时支持，只要策略得当，就会持续改善。",
    "**格局先天优势**：您的格局清纯有力，属于人群15%的优质格局，一旦天时到来，爆发力强。",
    "**年轻是最大资本**：您还年轻，当前的积累和磨练，都会在未来3-5年转化为经验优势，届时爆发力更强。"
  ]
}
```

**用户反馈预期**: "原来我正在好运中，要抓紧机会！"

---

### 3.3 案例3: 无明显转折型（25岁）

**输入**:
```typescript
{
  luckPillars: [
    { startAge: 20, element: '金' },
    { startAge: 30, element: '火' }
    // 无用神得力的大运
  ],
  currentAge: 25,
  patternAnalysis: {
    patternStrength: 'weak',
    usefulGod: { element: '木' }
  }
}
```

**输出**:
```json
{
  "shortTerm": {
    "changes": [
      "2025年下半年：小的积极信号出现，如贵人提点、新机会浮现",
      "2026年上半年：状态调整后，精力/效率提升10%左右",
      "调整风水和行动策略后，6个月内状态可改善5-10%"
    ]
  },
  "midTerm": {
    "turningPoint": undefined,
    "changes": [
      "2026-2028年：虽无明显天时，但通过策略优化，可改善15-25%",
      "2027年：积累期，为未来爆发做准备"
    ]
  },
  "whyYouWillImprove": [
    "**时间是您的盟友**：即使当前大运不利，但随着时间推移，总会迎来有利期。历史规律如此。",
    "**后天可塑性强**：格局虽弱，但可塑空间大，通过策略优化和环境调整，改善空间大，反而更灵活。",
    "**年轻是最大资本**：您还年轻，当前的积累和磨练，都会在未来3-5年转化为经验优势，届时爆发力更强。"
  ]
}
```

**用户反馈预期**: "即使大运不利，也有办法改善！"

---

## 四、核心特性

### 4.1 时间感增强

- **短期**：具体到季度（春夏季/下半年）
- **中期**：具体到年份+季节（2027年春季）
- **长期**：跨度年份（2030-2035年）

### 4.2 量化改善

| 改善类型 | 量化示例 |
|----------|----------|
| 收入 | "收入提升20-30%" |
| 精力 | "精力/效率提升10%" |
| 人际 | "贵人出现概率65%" |
| 财富 | "财富积累突破，有机会实现财务自由" |

### 4.3 转折点标记

```
格式：YYYY年春季（大运切换，约XX岁）
示例："2027年春季（大运切换，约30岁）"
```

### 4.4 可信度增强

- 3个理由涵盖：大运（天时）+ 格局（禀赋）+ 积累（人和）
- 命理依据明确（用神得力/格局清纯/大运周期）
- 历史类比（"历史上许多从格者都是中晚年大器晚成"）

---

## 五、文件清单

### 5.1 核心文件

| 文件路径 | 说明 | 状态 |
|----------|------|------|
| `src/lib/report/report-generator-v2.2.ts` | generateHopeTimeline() 主函数（504-834行） | ✅ 已完成 |
| `src/types/report-v2.2.ts` | HopeTimeline 类型定义（164-181行） | ✅ 已完成 |

### 5.2 辅助函数

| 函数名 | 行数 | 说明 |
|--------|------|------|
| `generateShortTermHope()` | 589-622 | 生成短期希望（6-12月） |
| `generateMidTermHope()` | 628-687 | 生成中期希望（1-3年） |
| `generateLongTermHope()` | 693-748 | 生成长期希望（3-10年） |
| `generateWhyYouWillImprove()` | 754-834 | 生成3个"为什么会好"的理由 |

### 5.3 测试文件

| 文件路径 | 说明 | 状态 |
|----------|------|------|
| `src/lib/report/__tests__/generate-hope-timeline.test.ts` | 5个真实案例+边界条件单元测试 | ✅ 已完成 |

---

## 六、集成说明

### 6.1 在报告生成器中调用

```typescript
// 在 generateFullReport_v2_2() 中
const hopeTimeline = generateHopeTimeline(
  luckPillars,
  currentAge,
  patternAnalysis
);

// 返回值包含在 ReportOutput_v2_2 中
return {
  meta,
  summary,
  baziAnalysis,
  strategyMapping,
  fengshuiChecklist,
  hopeTimeline,  // ← 希望之光时间线
  sixDomains,
  comparison,
  charts,
  appendix
};
```

### 6.2 在前端展示

建议在报告第8章"温柔视角：重建信心"中展示希望之光：

```typescript
<section className="hope-timeline-section">
  <h2>希望之光：您的改善时间线</h2>
  
  {/* 短期 */}
  <div className="short-term">
    <h3>{hopeTimeline.shortTerm.timeframe}</h3>
    <ul>
      {hopeTimeline.shortTerm.changes.map(change => (
        <li key={change}>{change}</li>
      ))}
    </ul>
  </div>
  
  {/* 中期（含转折点） */}
  <div className="mid-term">
    <h3>{hopeTimeline.midTerm.timeframe}</h3>
    {hopeTimeline.midTerm.turningPoint && (
      <p className="turning-point">
        <strong>转折点：</strong>{hopeTimeline.midTerm.turningPoint}
      </p>
    )}
    <ul>
      {hopeTimeline.midTerm.changes.map(change => (
        <li key={change}>{change}</li>
      ))}
    </ul>
  </div>
  
  {/* 长期 */}
  <div className="long-term">
    <h3>{hopeTimeline.longTerm.timeframe}</h3>
    <ul>
      {hopeTimeline.longTerm.changes.map(change => (
        <li key={change}>{change}</li>
      ))}
    </ul>
  </div>
  
  {/* 为什么会好 */}
  <div className="why-you-will-improve">
    <h3>为什么会好？</h3>
    <ol>
      {hopeTimeline.whyYouWillImprove.map(reason => (
        <li key={reason}>{reason}</li>
      ))}
    </ol>
  </div>
</section>
```

---

## 七、后续优化方向

### 7.1 流年细化

- 当前只看大运（10年），未来可细化到流年（1年）
- 短期希望可以精确到月份（如"2025年3月"）

### 7.2 更个性化的改善预测

- 根据用户画像（职业、困境类型）调整改善方向
- 如：程序员→"技术突破"、销售→"业绩提升"

### 7.3 动态可信度评分

- 为每个预测添加可信度分数（如"转折点可信度85%"）
- 基于格局强度、大运力度、历史数据

---

## 八、验收标准

- [x] 函数实现完成（generateHopeTimeline + 4个辅助函数）
- [x] 5个真实案例测试设计完成
- [x] 转折点时间格式标准化
- [x] 改善幅度根据格局强度动态调整
- [x] 3个"为什么会好"的理由涵盖大运/格局/积累三个角度
- [ ] 实际用户反馈收集（需上线后）

---

## 九、总结

希望之光时间线算法已完成实现，核心特性：

1. **时间感强**：明确改善时间点（如"还有2年就会好"），避免遥遥无期
2. **量化改善**：具体数字（收入提升20-30%），非抽象描述
3. **可信度高**：3个命理依据（大运/格局/积累），增强用户信任
4. **行动导向**：即使大运不利，也强调"策略+环境"可改善
5. **情感共鸣**：话术温柔（如"年轻是最大资本"），给予情感支持

**预期效果**：
- 用户反馈"有盼头了"：≥90%
- 用户反馈"知道什么时候会好"：≥85%
- 用户反馈"对未来有信心"：≥85%

**下一步**：子任务14.4 - AI Prompt增强（bazi_explainer.md）
