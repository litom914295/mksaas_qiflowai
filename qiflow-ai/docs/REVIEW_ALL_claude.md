# QiFlow v5.0 跨文档一致性评审报告

**评审角色**：产品审稿人 + 合规官 + UX总监  
**评审范围**：PRD_v5.0.md + TECH_GUIDE_v5.0.md + TASK_PLAN_v5.0.md + UI_DESIGN_v5.0.md  
**评审日期**：2024-12-27  
**结论**：需修订（Revise）

---

## 一、核心发现

整体完成度为75%，四份文档在产品价值定义、技术实现方案和UI设计上基本对齐，但在**合规策略、权限控制、计费一致性和用户体验细节**上存在关键缺失和冲突。

### 主要问题分布
- **合规与安全**：算命服务免责声明缺失、内容审核策略不明、未成年人保护机制缺失
- **计费一致性**：AI深度解读积分定义冲突（PRD 30分 vs TECH 未定义）
- **权限控制**：免费用户权限边界模糊、积分不足降级策略缺失
- **用户体验**：错误提示、loading状态、空状态设计缺失

---

## 二、指标/收费/权限的落地与验收分析

### 2.1 北极星指标落地情况

| 指标 | PRD定义 | TECH实现 | TASK验收 | UI体现 | 一致性 |
|------|---------|----------|----------|---------|---------|
| WAPU | M1:500, M2:2000 | OpenPanel埋点 | 未定义验收 | 未体现 | ⚠️ 部分缺失 |
| 激活率 | 7天内生成报告>40% | 埋点qf.bazi.run | 未定义基线 | 引导设计不足 | ⚠️ 需加强 |
| 付费转化 | Free to Paid>5% | Stripe集成完整 | Sprint 5验收 | UnlockButton | ✅ 基本一致 |
| 留存率 | D30>35% | 未见留存埋点 | 业务指标有定义 | 未体现复访引导 | ❌ 实现缺失 |

**问题1**：WAPU埋点未在TECH中明确定义，需补充周活跃付费用户统计逻辑  
**问题2**：激活率和留存率的具体埋点事件未在各文档中统一

### 2.2 收费模式一致性检查

| 功能 | PRD积分定义 | TECH积分配置 | UI积分展示 | 冲突点 |
|------|-------------|---------------|------------|---------|
| 八字分析 | 10积分 | bazi: 10 ✅ | 未显示消耗 | UI需补充 |
| AI深度解读 | 30积分 | 未定义 ❌ | credits={30} | TECH缺失 |
| 风水分析 | 20积分 | xuankong: 20 ✅ | 未显示消耗 | UI需补充 |
| AI对话 | 未明确 | aiChat: 5 | CreditCounter | PRD需明确 |
| PDF导出 | 5积分 | pdfExport: 5 ✅ | 未体现 | UI需补充 |

**关键冲突**：PRD定义"AI深度解读30积分"但TECH只有"aiChat:5"，需区分两种AI服务

### 2.3 权限控制验证

| 用户类型 | PRD权限定义 | TECH权限检查 | UI权限提示 | 问题 |
|----------|-------------|---------------|------------|------|
| 未登录 | 未明确 | throw Error('请先登录') | 未设计 | 需补充引导页 |
| 免费用户 | 每月5次基础分析 | checkUserCredits | 未显示余额 | UI需加强 |
| Pro用户 | 无限次分析 | subscription检查 | 未区分展示 | 需差异化UI |
| 积分不足 | 未定义降级 | throw Error | UnlockButton | 需优雅降级 |

**关键缺失**：积分不足时的降级策略（只读预览、引导充值、试用体验）

---

## 三、UI体现约束与提示分析

### 3.1 合规提示在UI中的体现

| 合规要求 | PRD定义 | UI设计 | 缺失内容 |
|----------|---------|---------|----------|
| 免责声明 | 未定义 ❌ | 未设计 ❌ | 需在所有分析结果页底部添加 |
| 年龄确认 | 未定义 ❌ | 未设计 ❌ | 注册流程需增加18+确认 |
| 隐私提示 | GDPR/CCPA ✅ | 未体现 ❌ | 首次使用需隐私弹窗 |
| 敏感内容警告 | 未定义 ❌ | 未设计 ❌ | AI对话需拒答提示 |

### 3.2 错误与状态提示

| 场景 | TECH错误处理 | UI状态设计 | 改进建议 |
|------|---------------|-------------|----------|
| 网络错误 | PROVIDER_ERROR | 未设计 | 需添加重试机制和友好提示 |
| 积分不足 | INSUFFICIENT_CREDITS | UnlockButton | 需显示具体差额和充值引导 |
| 罗盘权限被拒 | 降级到手动输入 | CalibrationButton | 需清晰的权限引导说明 |
| AI超时 | TOO_MANY_REQUESTS | ThinkingAnimation | 需超时提示和降级方案 |
| 空状态 | 未定义 | 未设计 | 各页面需空状态引导设计 |

---

## 四、合规/隐私/内容安全闭环分析

### 4.1 合规闭环检查

| 合规项 | PRD | TECH | TASK | UI | 闭环状态 |
|--------|-----|------|------|-----|----------|
| GDPR数据导出 | ✅ 定义 | ✅ 流程 | ❌ 无任务 | ❌ 无入口 | 🔴 断链 |
| CCPA数据删除 | ✅ 定义 | ✅ 流程 | ❌ 无任务 | ❌ 无入口 | 🔴 断链 |
| 支付PCI合规 | ✅ Stripe | ✅ 不存储 | ✅ Sprint 5 | ✅ 安全 | 🟢 闭环 |
| 算命服务免责 | ❌ 缺失 | ❌ 缺失 | ❌ 缺失 | ❌ 缺失 | 🔴 全缺 |
| 内容审核机制 | ❌ 缺失 | ❌ 缺失 | ❌ 缺失 | ❌ 缺失 | 🔴 全缺 |

### 4.2 隐私保护实施

**关键缺失**：
1. 用户数据收集告知（位置、生日等敏感信息）
2. Cookie同意管理
3. 第三方数据共享说明（AI服务商）
4. 儿童隐私保护（未成年人识别）

### 4.3 内容安全策略

**完全缺失的内容安全机制**：
- 拒答清单（死亡、疾病、赌博等敏感话题）
- AI生成内容审核流程
- 用户举报机制
- 违规内容处理流程

---

## 五、i18n与a11y一致性分析

### 5.1 国际化实施情况

| 语言支持 | PRD定义 | TECH实现 | UI设计 | 问题 |
|----------|---------|----------|---------|------|
| 简体中文 | ✅ 主要 | ✅ messages/zh.json | ✅ 默认 | 一致 |
| 繁体中文 | ✅ 计划 | ✅ 结构准备 | ⚠️ 未细化 | 术语转换需注意 |
| English | ✅ 计划 | ✅ 结构准备 | ⚠️ 未设计 | 文化适配需考虑 |
| 日本語 | ✅ 未来 | ❌ 未实现 | ❌ 未考虑 | 暂不影响 |

**关键问题**：
1. 农历/公历转换逻辑未在英文版考虑
2. 时辰概念的西方用户理解问题
3. 天干地支的翻译策略不明确

### 5.2 无障碍设计验证

| a11y要求 | PRD标准 | UI实现 | 验收标准 | 状态 |
|----------|---------|---------|----------|------|
| WCAG 2.1 AA | ✅ 明确 | ✅ 有示例 | ❌ 无验收 | ⚠️ 需完善 |
| 键盘导航 | ✅ 要求 | ✅ tabIndex | ❌ 未测试 | ⚠️ 需验证 |
| 屏幕阅读 | ✅ 要求 | ✅ aria-label | ❌ 未测试 | ⚠️ 需验证 |
| 色彩对比 | ❌ 未定义 | ⚠️ 可能不足 | ❌ 无标准 | 🔴 需检查 |
| 触控目标 | ❌ 未定义 | ✅ ≥44px | ❌ 无验收 | ⚠️ 需规范 |

---

## 六、Quick Wins（一周内可完成）

1. **补充免责声明文案**（1天）
   - PRD新增7.4节免责声明
   - UI在所有分析结果页添加固定提示
   - TECH实现免责确认机制

2. **统一AI服务计费**（2天）
   - 区分AI对话(5积分)和AI深度解读(30积分)
   - TECH补充deepInterpretation配置
   - UI区分两种服务的入口和提示

3. **完善积分不足提示**（2天）
   - UI设计积分不足弹窗
   - 显示差额和充值选项
   - 提供试用/预览选项

4. **增加数据导出入口**（2天）
   - 在设置页添加"我的数据"模块
   - 实现GDPR/CCPA合规功能
   - TASK补充相关任务

5. **优化错误提示文案**（1天）
   - 统一错误码和用户提示映射
   - UI设计统一的错误展示组件
   - 支持重试和降级操作

---

## 七、关键补丁建议

### PRD补丁
```markdown
## 7.4 内容安全与免责声明（新增）

### 7.4.1 服务免责声明
- 所有命理分析仅供娱乐参考，不构成人生决策建议
- 用户需确认已满18周岁
- 在每个分析结果页面底部显示："结果仅供参考，请理性对待"

### 7.4.2 内容审核机制
- AI拒答清单：死亡预测、疾病诊断、赌博建议、政治内容
- 敏感时期（清明、中元节）调整服务内容
- 用户生成内容需通过敏感词过滤

### 7.4.3 未成年人保护
- 注册时需进行年龄验证
- 18岁以下用户限制使用
- 家长监护机制预留

## 3.4.3 AI服务计费明细（新增）
- AI对话（快速问答）：5积分/次
- AI深度解读（详细报告）：30积分/次
- 区分使用场景和模型成本
```

### TECH补丁
```typescript
// src/config/qiflow-pricing.ts 补充
export const qiflowPricing = {
  credits: {
    bazi: 10,
    xuankong: 20,
    aiChat: 5,           // 快速对话
    aiDeepAnalysis: 30,  // 深度解读（新增）
    pdfExport: 5
  }
}

// src/middleware/disclaimer.ts 新增
export async function requireDisclaimer(userId: string) {
  const accepted = await checkDisclaimerAcceptance(userId);
  if (!accepted) {
    return {
      required: true,
      message: "请先阅读并接受服务免责声明"
    };
  }
}

// src/lib/content-filter.ts 新增
export const sensitiveTopics = [
  '死亡', '自杀', '疾病', '赌博', 
  '股票代码', '彩票号码'
];

export function shouldRejectQuery(query: string): boolean {
  return sensitiveTopics.some(topic => 
    query.includes(topic)
  );
}
```

### TASK补丁
```markdown
## Sprint 1 新增任务
- [ ] 实现免责声明确认流程
- [ ] 配置内容审核规则

## Sprint 2 新增任务  
- [ ] 开发数据导出功能（GDPR合规）
- [ ] 实现用户数据删除功能（CCPA合规）

## Sprint 5 新增验收标准
- [ ] 所有错误提示用户友好
- [ ] 积分不足有明确引导
- [ ] 免责声明100%展示率

## Sprint 7 新增任务
- [ ] 无障碍测试（WCAG 2.1 AA）
- [ ] 色彩对比度检查
- [ ] 键盘导航测试
```

---

## 八、总结与建议

### 立即行动（3天内）
1. 所有团队对齐免责声明和内容安全策略
2. 产品明确AI两种服务的区分和计费
3. UI补充所有缺失的状态和提示设计

### 短期改进（1周内）
1. 完成所有Quick Wins项目
2. 建立合规checklist并逐项验证
3. 统一所有文档中的指标定义和埋点

### 长期优化（1月内）
1. 建立完整的内容审核机制
2. 完善无障碍设计并通过第三方认证
3. 优化国际化方案，特别是文化适配

**最终建议**：当前方案在产品和技术层面已较完整，但合规和用户体验细节需要立即补充。建议先完成免责声明、计费统一和基础错误处理，确保MVP可安全上线。