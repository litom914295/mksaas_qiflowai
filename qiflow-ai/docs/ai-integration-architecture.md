# AI对话系统集成文档

## 概述

QiFlow AI对话系统采用"算法优先"原则，确保所有八字风水分析都基于专业算法引擎的计算结果，再由AI进行解读和增强。

## 核心架构

### 1. 智能检测系统 (`analysis-detection.ts`)

负责识别用户消息是否为分析请求：

- **关键词匹配**：识别八字、风水相关术语
- **模式识别**：检测日期、性别、房屋信息等
- **意图分析**：判断用户是否需要分析服务
- **置信度计算**：综合多个因素计算检测置信度

**检测阈值**：

- 置信度 ≥ 30% 触发分析流程
- 置信度 < 30% 转入普通对话

### 2. 算法优先服务 (`algorithm-first-service.ts`)

核心分析引擎，严格遵循算法优先原则：

#### 处理流程：

1. **输入验证**：标准化和验证用户输入
2. **算法计算**：调用八字/风水算法引擎
3. **AI解读**：基于算法结果生成专业解释
4. **结构化输出**：返回完整的分析报告

#### AI大师Prompt设计：

```typescript
【核心原则】
1. 算法优先：所有分析基于算法引擎的计算结果
2. 专业严谨：使用标准术语，解释清晰准确
3. 可验证性：提供详细的推理过程
4. 实用导向：给出具体可行的建议
5. 文化尊重：尊重传统文化，避免迷信色彩
```

#### 响应结构（八字分析）：

1. **输入确认**：确认出生时间、性别、地点
2. **四柱结果**：展示年月日时四柱天干地支
3. **关键结论**：日主强弱、格局、用神分析
4. **详细解读**：五行、性格、事业、婚姻、健康
5. **建议与注意**：颜色、方位、职业、时机
6. **复核提示**：提醒可验证计算准确性

### 3. API路由 (`/api/chat/route.ts`)

请求处理中心，协调各个服务：

#### 处理逻辑：

```javascript
if (检测到分析请求 && 置信度 >= 0.3) {
  // 调用算法优先服务
  调用 algorithmFirstService.processAnalysisRequest()
  返回结构化分析结果
} else {
  // 处理普通对话
  调用 orchestrator.handleUserMessage()
  返回对话响应
}
```

#### 错误处理：

- **输入不完整**：返回友好提示，引导用户提供完整信息
- **算法失败**：提供降级方案，显示基本计算结果
- **AI服务不可用**：返回算法结果，不含AI解释

## 响应格式

### 分析请求响应：

```json
{
  "success": true,
  "data": {
    "sessionId": "session_xxx",
    "reply": "AI大师的专业解读文本",
    "analysisResult": {
      "type": "bazi",
      "success": true,
      "data": {
        /* 算法计算结果 */
      }
    },
    "aiEnhancement": {
      "explanation": "详细解释",
      "insights": ["洞察1", "洞察2"],
      "recommendations": ["建议1", "建议2"],
      "followUpQuestions": ["后续问题1", "后续问题2"],
      "confidence": 0.85
    },
    "rawData": {
      /* 原始算法数据 */
    },
    "redirectTo": {
      /* 可选的页面跳转信息 */
    }
  }
}
```

### 普通对话响应：

```json
{
  "success": true,
  "data": {
    "sessionId": "session_xxx",
    "reply": "AI助手的回复",
    "messages": [
      /* 对话历史 */
    ],
    "state": {
      /* 对话状态 */
    }
  }
}
```

## 质量保障

### 1. 置信度评估

系统对每个分析都进行置信度评估：

- **高置信度 (> 0.8)**：完整的输入信息，成功的算法计算，详细的AI解读
- **中置信度 (0.5-0.8)**：部分信息缺失，但核心计算成功
- **低置信度 (< 0.5)**：信息不足或计算异常

### 2. 降级策略

当部分服务不可用时的处理：

- **AI服务故障**：返回纯算法结果
- **算法引擎故障**：返回错误提示和输入指导
- **完全故障**：返回友好的错误消息

### 3. 日志监控

完整的日志记录：

```javascript
[ChatAPI] 智能分析请求检测结果
[ChatAPI] 调用算法优先服务开始
[算法优先服务] 开始处理分析请求
[算法优先服务] 算法计算成功
[算法优先服务] AI补充解释生成成功
[ChatAPI] 分析请求处理完成
```

## 测试验证

### 运行集成测试：

```bash
node scripts/test-ai-integration.js
```

### 测试覆盖：

- 完整的八字分析请求
- 简单的分析请求
- 风水分析请求
- 综合分析请求
- 普通对话（不触发分析）
- 错误处理

## 性能优化

### 1. 缓存策略

- 缓存算法计算结果（相同输入）
- 缓存AI解读模板

### 2. 并发处理

- 算法计算和AI调用可并行
- 多个分析请求排队处理

### 3. 超时控制

- 算法计算：10秒超时
- AI生成：15秒超时
- 总体请求：30秒超时

## 最佳实践

### 1. 用户输入引导

始终提供清晰的输入示例：

```
正确：1990年3月15日下午3点，男性，出生在北京
错误：帮我算命
```

### 2. 结果展示

- 先展示算法计算的客观结果
- 再提供AI的专业解读
- 最后给出实用建议

### 3. 交互优化

- 识别不完整输入，主动询问缺失信息
- 提供相关的后续问题
- 支持渐进式信息收集

## 故障排查

### 常见问题：

1. **分析请求未被识别**
   - 检查置信度阈值设置
   - 查看关键词匹配日志
   - 验证检测逻辑

2. **算法计算失败**
   - 检查输入参数格式
   - 验证算法服务可用性
   - 查看错误日志

3. **AI解读质量低**
   - 检查Prompt模板
   - 验证算法结果格式
   - 调整温度参数

## 未来改进

1. **智能对话管理**：支持多轮对话收集信息
2. **个性化解读**：基于用户偏好调整解读风格
3. **实时反馈**：流式输出分析结果
4. **多模态输入**：支持图片、语音输入
