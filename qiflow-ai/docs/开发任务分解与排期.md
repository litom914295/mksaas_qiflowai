# AIå…«å­—é£æ°´å¯¹è¯å¤§å¸ˆ - è¯¦ç»†å¼€å‘ä»»åŠ¡åˆ†è§£æ¸…å•

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-20
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ
**ä»»åŠ¡æ€»æ•°**: 85ä¸ªå…·ä½“ç¼–ç¨‹ä»»åŠ¡
**é¢„è®¡å®Œæˆæ—¶é—´**: 8-10å‘¨

> ğŸ¯ **ä½¿ç”¨è¯´æ˜**: æ¯ä¸ªä»»åŠ¡å®Œæˆååœ¨ `[ ]` ä¸­æ‰“ âœ…ï¼Œæ‰€æœ‰ä»»åŠ¡æŒ‰ä¾èµ–å…³ç³»æ’åºï¼Œå¯ä»¥æŒ‰é¡ºåºæ‰§è¡Œ

---

## ğŸ“‹ Phase 1: æ•°æ®å±‚åŸºç¡€è®¾æ–½ (Week 1-2)

### ğŸ—„ï¸ æ•°æ®åº“Schemaæ‰©å±•

#### Task 1: åˆ›å»ºå¯¹è¯çŠ¶æ€ç®¡ç†è¡¨

- [âœ…] **æ–‡ä»¶**: `database/migrations/create_conversation_states.sql`
- [âœ…] **å®ç°å†…å®¹**:

```sql
CREATE TABLE conversation_states (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID REFERENCES chat_sessions(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  current_state VARCHAR(50) NOT NULL DEFAULT 'greeting',
  context_stack JSONB DEFAULT '[]'::jsonb,
  topic_graph JSONB DEFAULT '{}'::jsonb,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '24 hours')
);
CREATE INDEX idx_conversation_states_session_id ON conversation_states(session_id);
CREATE INDEX idx_conversation_states_user_id ON conversation_states(user_id);
CREATE INDEX idx_conversation_states_state ON conversation_states(current_state);
```

- âš ï¸ ä¾èµ–: æ‰§è¡Œè¿ç§»å‰éœ€ç¡®ä¿ `chat_sessions` è¡¨å·²åˆ›å»ºæˆ–è°ƒæ•´å¤–é”®å¼•ç”¨ã€‚

#### Task 2: åˆ›å»ºçŸ¥è¯†å›¾è°±å­˜å‚¨è¡¨

- [âœ…] **æ–‡ä»¶**: `database/migrations/create_knowledge_graph.sql`
- [âœ…] **å®ç°å†…å®¹**:

```sql
CREATE EXTENSION IF NOT EXISTS vector;
CREATE TABLE knowledge_graph (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  node_type VARCHAR(50) NOT NULL, -- 'concept', 'term', 'case_study'
  node_data JSONB NOT NULL,
  embeddings vector(1536), -- OpenAI embedding dimensions
  relationships JSONB DEFAULT '[]'::jsonb,
  confidence FLOAT DEFAULT 1.0,
  language VARCHAR(5) DEFAULT 'zh-CN',
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_knowledge_graph_type ON knowledge_graph(node_type);
CREATE INDEX idx_knowledge_graph_language ON knowledge_graph(language);
CREATE INDEX idx_knowledge_graph_embeddings ON knowledge_graph USING ivfflat (embeddings vector_cosine_ops) WITH (lists = 100);
```

- âš ï¸ å‰ç½®: éœ€ç¡®è®¤æ•°æ®åº“å·²å¯ç”¨ `vector` æ‰©å±•å¹¶å…·å¤‡åˆ›å»º ivfflat ç´¢å¼•æƒé™ã€‚

#### Task 3: åˆ›å»ºç½®ä¿¡åº¦è¯„åˆ†è¡¨

- [âœ…] **æ–‡ä»¶**: `database/migrations/create_confidence_scores.sql`
- [âœ…] **å®ç°å†…å®¹**:

```sql
CREATE TABLE confidence_scores (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  analysis_id UUID,
  conversation_id UUID REFERENCES conversation_states(id) ON DELETE CASCADE,
  overall_score FLOAT NOT NULL CHECK (overall_score >= 0 AND overall_score <= 1),
  dimension_scores JSONB NOT NULL,
  explanation TEXT,
  factors JSONB,
  requires_review BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_confidence_scores_conversation ON confidence_scores(conversation_id);
CREATE INDEX idx_confidence_scores_score ON confidence_scores(overall_score);
```

- âš ï¸ ä¾èµ–: éœ€è¦å…ˆæ‰§è¡Œ `conversation_states` è¿ç§»ä»¥æ»¡è¶³å¤–é”®çº¦æŸã€‚

#### Task 4: åˆ›å»ºAIä½¿ç”¨ç›‘æ§è¡¨

- [âœ…] **æ–‡ä»¶**: `database/migrations/create_ai_usage_metrics.sql`
- [âœ…] **å®ç°å†…å®¹**:

```sql
CREATE TABLE ai_usage_metrics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID,
  user_id UUID,
  provider VARCHAR(50) NOT NULL,
  model VARCHAR(100) NOT NULL,
  prompt_tokens INTEGER,
  completion_tokens INTEGER,
  total_tokens INTEGER,
  cost_usd DECIMAL(10,6),
  response_time_ms INTEGER,
  success BOOLEAN DEFAULT TRUE,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX idx_ai_usage_session ON ai_usage_metrics(session_id);
CREATE INDEX idx_ai_usage_provider ON ai_usage_metrics(provider);
CREATE INDEX idx_ai_usage_created_at ON ai_usage_metrics(created_at);
```

### ğŸ”§ Redisé…ç½®å’Œè¿æ¥

#### Task 5: åˆ›å»ºRedisè¿æ¥é…ç½®

- [âœ…] **æ–‡ä»¶**: `src/lib/redis/connection.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import { Redis } from 'ioredis';

interface RedisConfig {
  host: string;
  port: number;
  password?: string;
  db: number;
  keyPrefix: string;
  maxRetriesPerRequest: number;
  retryDelayOnFailover: number;
}

const DEFAULT_CONFIG: RedisConfig = {
  host: process.env.REDIS_HOST || 'localhost',
  port: Number.parseInt(process.env.REDIS_PORT || '6379', 10),
  password: process.env.REDIS_PASSWORD,
  db: Number.parseInt(process.env.REDIS_DB || '0', 10),
  keyPrefix: process.env.REDIS_KEY_PREFIX || 'qiflow:',
  maxRetriesPerRequest: Number.parseInt(
    process.env.REDIS_MAX_RETRIES_PER_REQUEST || '3',
    10
  ),
  retryDelayOnFailover: Number.parseInt(
    process.env.REDIS_RETRY_DELAY_ON_FAILOVER || '2000',
    10
  ),
};

class RedisConnection {
  private static instance: Redis | null = null;

  static getInstance(customConfig: Partial<RedisConfig> = {}): Redis {
    if (!RedisConnection.instance) {
      const config = { ...DEFAULT_CONFIG, ...customConfig };
      RedisConnection.instance = new Redis({
        host: config.host,
        port: config.port,
        password: config.password,
        db: config.db,
        keyPrefix: config.keyPrefix,
        maxRetriesPerRequest: config.maxRetriesPerRequest,
        retryStrategy: times => Math.min(times * 200, 2000),
        reconnectOnError: err => {
          if (err && err.message && err.message.includes('READONLY')) {
            return true;
          }
          return false;
        },
      });

      RedisConnection.instance.on('error', error => {
        console.error('[Redis] connection error', error);
      });
    }

    return RedisConnection.instance;
  }

  static disconnect(): void {
    if (RedisConnection.instance) {
      RedisConnection.instance.disconnect();
      RedisConnection.instance = null;
    }
  }
}

export { RedisConnection };
export type { RedisConfig };
```

#### Task 6: åˆ›å»ºä¼šè¯å­˜å‚¨æœåŠ¡

- [âœ…] **æ–‡ä»¶**: `src/lib/redis/session-storage.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import { Redis } from 'ioredis';
import { RedisConnection } from './connection';

type SessionPayload = Record<string, unknown>;

class SessionStorageService {
  private readonly redis: Redis;
  private readonly ttlSeconds: number;

  constructor(ttlSeconds: number = 24 * 60 * 60) {
    this.redis = RedisConnection.getInstance();
    this.ttlSeconds = ttlSeconds;
  }

  async saveSession(sessionId: string, context: SessionPayload): Promise<void> {
    const key = this.buildKey(sessionId);
    const serialized = JSON.stringify({
      ...context,
      lastUpdated: new Date().toISOString(),
    });

    await this.redis.setex(key, this.ttlSeconds, serialized);
  }

  async getSession<T extends SessionPayload = SessionPayload>(
    sessionId: string
  ): Promise<T | null> {
    const key = this.buildKey(sessionId);
    const data = await this.redis.get(key);

    if (!data) {
      return null;
    }

    try {
      return JSON.parse(data) as T;
    } catch (error) {
      console.error('[SessionStorage] parse error', error);
      await this.redis.del(key);
      return null;
    }
  }

  async deleteSession(sessionId: string): Promise<void> {
    const key = this.buildKey(sessionId);
    await this.redis.del(key);
  }

  async extendSession(sessionId: string): Promise<void> {
    const key = this.buildKey(sessionId);
    await this.redis.expire(key, this.ttlSeconds);
  }

  private buildKey(sessionId: string): string {
    return `session:${sessionId}`;
  }
}

export { SessionStorageService };
export type { SessionPayload };
```

- âš ï¸ å‰ç½®: æœ¬åœ°éœ€æä¾›å¯ç”¨ Redis è¿æ¥å¹¶é…ç½® `REDIS_*` ç¯å¢ƒå˜é‡ã€‚

---

## ğŸ§  Phase 2: AIå¯¹è¯æ ¸å¿ƒå¼•æ“ (Week 2-5)

### ğŸ“ ç±»å‹å®šä¹‰ä¸ä¼šè¯å†…æ ¸

#### Task 7: åˆ›å»ºå¯¹è¯ç±»å‹å®šä¹‰

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/types/conversation.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
export type ConversationRole = 'user' | 'assistant' | 'system';

export type AnalysisType = 'bazi' | 'fengshui' | 'integrated';

export interface ConversationMessageMetadata {
  analysisType?: AnalysisType;
  confidence?: number;
  sources?: string[];
  tokens?: number;
  cost?: number;
}

export interface ConversationMessage {
  id: string;
  role: ConversationRole;
  content: string;
  timestamp: Date;
  metadata?: ConversationMessageMetadata;
}

export interface ConversationPreferences {
  language: string;
  responseStyle: 'concise' | 'detailed' | 'educational';
  culturalBackground: 'mainland' | 'hongkong' | 'taiwan' | 'western';
}

export interface ConversationUserProfile {
  expertise: 'beginner' | 'intermediate' | 'expert';
  preferences: ConversationPreferences;
  baziData?: Record<string, unknown>;
  fengshuiData?: Record<string, unknown>;
}

export interface ConversationContextEntry {
  topic: string;
  timestamp: Date;
  summary: string;
}

export interface ConversationMetadata {
  totalMessages: number;
  sessionDuration: number;
  lastActivity: Date;
  analysisCount: number;
}

export interface ConversationContext {
  sessionId: string;
  userId?: string;
  messages: ConversationMessage[];
  currentTopic: string;
  userProfile: ConversationUserProfile;
  contextStack: ConversationContextEntry[];
  metadata: ConversationMetadata;
}

export type ConversationStateType =
  | 'greeting'
  | 'collecting_info'
  | 'analyzing'
  | 'explaining'
  | 'recommending'
  | 'deepdive'
  | 'closure'
  | 'expert_handoff';
```

#### Task 8: åˆ›å»ºçŠ¶æ€æœºç±»å‹å®šä¹‰

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/types/state-machine.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import { ConversationContext, ConversationStateType } from './conversation';

type TransitionCondition = (context: ConversationContext) => boolean;
type TransitionAction = (context: ConversationContext) => Promise<void> | void;
type LifecycleHook = (context: ConversationContext) => Promise<void> | void;

export interface StateTransition {
  from: ConversationStateType;
  to: ConversationStateType;
  condition: TransitionCondition;
  action?: TransitionAction;
  description?: string;
}

export interface StateMachineStateConfig {
  onEnter?: LifecycleHook;
  onExit?: LifecycleHook;
  transitions: ConversationStateType[];
  timeout?: number;
}

export interface StateMachineConfig {
  initialState: ConversationStateType;
  states: Record<ConversationStateType, StateMachineStateConfig>;
  transitions: StateTransition[];
}

export interface StateChangeEvent {
  sessionId: string;
  from: ConversationStateType;
  to: ConversationStateType;
  timestamp: Date;
  trigger: string;
  context: Partial<ConversationContext>;
}

export type StateChangeHandler = (
  event: StateChangeEvent
) => void | Promise<void>;
```

#### Task 9: å®ç°å¯¹è¯çŠ¶æ€æœºæ ¸å¿ƒç±»

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/state-machine.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import {
  ConversationContext,
  ConversationStateType,
} from './types/conversation';
import {
  StateMachineConfig,
  StateTransition,
  StateChangeEvent,
  StateMachineStateConfig,
  StateChangeHandler,
} from './types/state-machine';

interface ConversationState {
  current: ConversationStateType;
  previous: ConversationStateType;
  transitions: ConversationStateType[];
  data: Record<string, unknown>;
}

class ConversationStateMachine {
  private readonly config: StateMachineConfig;
  private readonly eventHandlers: StateChangeHandler[] = [];

  constructor(config: StateMachineConfig) {
    this.config = config;
  }

  createInitialState(): ConversationState {
    const { initialState, states } = this.config;
    const stateConfig = states[initialState];

    if (!stateConfig) {
      throw new Error(
        `[StateMachine] Initial state "${initialState}" is not defined in configuration.`
      );
    }

    return {
      current: initialState,
      previous: initialState,
      transitions: stateConfig.transitions,
      data: {},
    };
  }

  onStateChange(handler: StateChangeHandler): void {
    this.eventHandlers.push(handler);
  }

  offStateChange(handler: StateChangeHandler): void {
    const index = this.eventHandlers.indexOf(handler);
    if (index >= 0) {
      this.eventHandlers.splice(index, 1);
    }
  }

  async transition(
    current: ConversationState,
    context: ConversationContext,
    trigger: string
  ): Promise<ConversationState> {
    const stateConfig = this.getStateConfig(current.current);
    const transitions = this.getMatchingTransitions(
      current.current,
      stateConfig.transitions
    );

    for (const transition of transitions) {
      const conditionMet = await Promise.resolve(transition.condition(context));
      if (!conditionMet) {
        continue;
      }

      await this.runLifecycleHook(stateConfig.onExit, context);

      if (transition.action) {
        await Promise.resolve(transition.action(context));
      }

      const targetConfig = this.getStateConfig(transition.to);
      await this.runLifecycleHook(targetConfig.onEnter, context);

      const newState: ConversationState = {
        current: transition.to,
        previous: current.current,
        transitions: targetConfig.transitions,
        data: { ...current.data },
      };

      await this.emitStateChange({
        sessionId: context.sessionId,
        from: current.current,
        to: transition.to,
        timestamp: new Date(),
        trigger,
        context: {
          sessionId: context.sessionId,
          currentTopic: context.currentTopic,
          metadata: context.metadata,
        },
      });

      return newState;
    }

    return current;
  }

  private getStateConfig(
    state: ConversationStateType
  ): StateMachineStateConfig {
    const config = this.config.states[state];
    if (!config) {
      throw new Error(
        `[StateMachine] State "${state}" is not defined in configuration.`
      );
    }
    return config;
  }

  private getMatchingTransitions(
    currentState: ConversationStateType,
    allowedTransitions: ConversationStateType[]
  ): StateTransition[] {
    return this.config.transitions.filter(
      transition =>
        transition.from === currentState &&
        allowedTransitions.includes(transition.to)
    );
  }

  private async runLifecycleHook(
    hook:
      | StateMachineStateConfig['onEnter']
      | StateMachineStateConfig['onExit'],
    context: ConversationContext
  ): Promise<void> {
    if (!hook) {
      return;
    }

    await Promise.resolve(hook(context));
  }

  private async emitStateChange(event: StateChangeEvent): Promise<void> {
    await Promise.all(
      this.eventHandlers.map(async handler => {
        try {
          await Promise.resolve(handler(event));
        } catch (error) {
          console.error('[StateMachine] Event handler error', error);
        }
      })
    );
  }
}

export { ConversationStateMachine };
export type { ConversationState };
```

- âš ï¸ åç»­: éœ€ä¸ `master-orchestrator` ç°æœ‰ä¼šè¯è®°å¿†æµç¨‹å¯¹æ¥ï¼Œç»Ÿä¸€ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„ã€‚

#### Task 10: é‡æ„ä¼šè¯è®°å¿†æ¨¡å‹ä¸ºæ–°ç±»å‹ä½“ç³»n- [âœ…] **æ–‡ä»¶**: `src/lib/ai/conversation-memory.ts`

- [âœ…] **å®ç°å†…å®¹**:

````typescript
import type { ConversationContext, ConversationMessage, ConversationStateType } from './types/conversation';

export interface ConversationSessionState {
  sessionId: string;
  userId: string;
  locale?: string;
  currentState: ConversationStateType;
  context: ConversationContext;
  createdAt: string;
  updatedAt: string;
}

export interface ConversationMemoryAdapter {
  load(sessionId: string, userId: string): Promise<ConversationSessionState | null>;
  persist(state: ConversationSessionState): Promise<void>;
  reset(sessionId: string, userId: string): Promise<void>;
}

export const createEmptySessionState = (params: {
  sessionId: string;
  userId: string;
  locale?: string;
  initialState: ConversationStateType;
  context: ConversationContext;
}): ConversationSessionState => ({
  sessionId: params.sessionId,
  userId: params.userId,
  locale: params.locale,
  currentState: params.initialState,
  context: params.context,
  createdAt: new Date().toISOString(),
  updatedAt: new Date().toISOString(),
});

export const appendMessage = (
  conversation: ConversationContext,
  message: ConversationMessage
): ConversationContext => ({
  ...conversation,
  messages: [...conversation.messages, message],
  metadata: {
    ...conversation.metadata,
    totalMessages: conversation.messages.length + 1,
    lastActivity: message.timestamp,
  },
});
`



#### Task 11: æ–°å¢ Supabase ä¼šè¯æŒä¹…å±‚é€‚é…å™¨n- [âœ…] **æ–‡ä»¶**: `src/lib/ai/adapters/supabase-conversation-memory.ts`
- [âœ…] **å®ç°å†…å®¹**:
```typescript
import { createClient } from '@supabase/supabase-js';
import type { ConversationSessionState, ConversationMemoryAdapter } from '../conversation-memory';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export class SupabaseConversationMemory implements ConversationMemoryAdapter {
  async load(sessionId: string, userId: string): Promise<ConversationSessionState | null> {
    const { data, error } = await supabase
      .from('conversation_states')
      .select('*')
      .eq('session_id', sessionId)
      .eq('user_id', userId)
      .single();

    if (error) {
      console.error('[SupabaseConversationMemory] load error', error);
      return null;
    }

    return data ? (data.payload as ConversationSessionState) : null;
  }

  async persist(state: ConversationSessionState): Promise<void> {
    const { error } = await supabase
      .from('conversation_states')
      .upsert({
        session_id: state.sessionId,
        user_id: state.userId,
        current_state: state.currentState,
        context_stack: state.context.contextStack,
        metadata: state.context.metadata,
        payload: state,
        updated_at: new Date().toISOString(),
      });

    if (error) {
      console.error('[SupabaseConversationMemory] persist error', error);
    }
  }

  async reset(sessionId: string, userId: string): Promise<void> {
    const { error } = await supabase
      .from('conversation_states')
      .delete()
      .eq('session_id', sessionId)
      .eq('user_id', userId);

    if (error) {
      console.error('[SupabaseConversationMemory] reset error', error);
    }
  }
}
````

#### Task 12: æ„å»º Redis + Supabase åŒå±‚ç¼“å­˜è®°å¿†åè°ƒå™¨n- [âœ…] **æ–‡ä»¶**: `src/lib/ai/memory/dual-layer-coordinator.ts`

- [âœ…] **å®ç°å†…å®¹**:

```typescript
import type {
  ConversationMemoryAdapter,
  ConversationSessionState,
} from '../conversation-memory';
import { SessionStorageService } from '../../redis/session-storage';

export class DualLayerMemoryCoordinator {
  constructor(
    private redis = new SessionStorageService(),
    private primary: ConversationMemoryAdapter
  ) {}

  async load(
    sessionId: string,
    userId: string
  ): Promise<ConversationSessionState | null> {
    const cacheKey = `${sessionId}:${userId}`;
    const cached =
      await this.redis.getSession<ConversationSessionState>(cacheKey);
    if (cached) {
      return cached;
    }

    const state = await this.primary.load(sessionId, userId);
    if (state) {
      await this.redis.saveSession(
        cacheKey,
        state as unknown as Record<string, unknown>
      );
    }
    return state;
  }

  async persist(state: ConversationSessionState): Promise<void> {
    const cacheKey = `${state.sessionId}:${state.userId}`;
    await this.primary.persist(state);
    await this.redis.saveSession(
      cacheKey,
      state as unknown as Record<string, unknown>
    );
  }

  async reset(sessionId: string, userId: string): Promise<void> {
    const cacheKey = `${sessionId}:${userId}`;
    await this.primary.reset(sessionId, userId);
    await this.redis.deleteSession(cacheKey);
  }
}
```

#### Task 13: å®šä¹‰å¯¹è¯çŠ¶æ€æœºé…ç½®è¡¨

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/state-machine/config.ts`
- [âœ…] **å®ç°å†…å®¹**:

````typescript
import type { StateMachineConfig } from '../types/state-machine';
import { ConversationStateMachine } from '../state-machine';

export const baseStateMachineConfig: StateMachineConfig = {
  initialState: 'greeting',
  states: {
    greeting: {
      transitions: ['collecting_info'],
    },
    collecting_info: {
      transitions: ['analyzing', 'greeting'],
      timeout: 180000,
    },
    analyzing: {
      transitions: ['explaining', 'deepdive'],
    },
    explaining: {
      transitions: ['recommending', 'deepdive', 'closure'],
    },
    recommending: {
      transitions: ['closure', 'deepdive'],
    },
    deepdive: {
      transitions: ['explaining', 'recommending', 'expert_handoff'],
    },
    closure: {
      transitions: ['greeting'],
    },
    expert_handoff: {
      transitions: ['closure'],
    },
  },
  transitions: [], // Task 14 å°†ç»§ç»­å¡«å……è½¬ç§»è§„åˆ™
};
```\n\n#### Task 14: å¡«å……çŠ¶æ€æœºè½¬ç§»æ¡ä»¶ä¸åŠ¨ä½œ
- [âœ…] **æ–‡ä»¶**: `src/lib/ai/state-machine/config.ts`
- [âœ…] **å®ç°å†…å®¹**:
```typescript
import type { ConversationContext } from '../types/conversation';
import type { StateTransition } from '../types/state-machine';

type TransitionRule = StateTransition & { description: string };

const hasCollectedBirthInfo = (context: ConversationContext) =>
  Boolean(context.userProfile.baziData);

const hasCompletedAnalysis = (context: ConversationContext) =>
  context.metadata.analysisCount > 0;

const shouldCloseSession = (context: ConversationContext) =>
  context.metadata.sessionDuration > 300 || context.metadata.totalMessages >= 12;

const transitionRules: TransitionRule[] = [
  {
    from: 'greeting',
    to: 'collecting_info',
    condition: () => true,
    description: 'é¦–æ¬¡é—®å€™åè¿›å…¥ä¿¡æ¯é‡‡é›†',
  },
  {
    from: 'collecting_info',
    to: 'analyzing',
    condition: hasCollectedBirthInfo,
    description: 'é‡‡é›†åˆ°å®Œæ•´çš„å…«å­—æˆ–é£æ°´ä¿¡æ¯åå¼€å§‹åˆ†æ',
  },
  {
    from: 'collecting_info',
    to: 'greeting',
    condition: (context) => !hasCollectedBirthInfo(context) && context.metadata.totalMessages > 3,
    description: 'ä¿¡æ¯ä¸è¶³æ—¶å›åˆ°é—®å€™ç¯èŠ‚ä»¥è°ƒæ•´ç­–ç•¥',
  },
  {
    from: 'analyzing',
    to: 'explaining',
    condition: hasCompletedAnalysis,
    description: 'ç”Ÿæˆé¦–è½®åˆ†æç»“æœåè¾“å‡ºè§£é‡Š',
  },
  {
    from: 'explaining',
    to: 'recommending',
    condition: hasCompletedAnalysis,
    description: 'è§£é‡Šå®Œæˆåç»™å‡ºå»ºè®®ä¸è¡ŒåŠ¨é¡¹',
  },
  {
    from: 'explaining',
    to: 'deepdive',
    condition: (context) => context.metadata.analysisCount > 1,
    description: 'ç”¨æˆ·å¯¹ç»†èŠ‚è¿½é—®æ—¶è¿›å…¥æ·±åº¦è®²è§£æ¨¡å¼',
  },
  {
    from: 'recommending',
    to: 'closure',
    condition: shouldCloseSession,
    description: 'æ»¡è¶³æ—¶é•¿æˆ–æ¶ˆæ¯æ•°æ¡ä»¶åè¿›å…¥æ”¶å°¾',
  },
  {
    from: 'recommending',
    to: 'deepdive',
    condition: (context) => context.topicTags?.includes('fengshui') ?? false,
    description: 'åœ¨é£æ°´ä¸»é¢˜ä¸‹å¯è¿›å…¥æ·±åº¦æ¨è',
  },
  {
    from: 'deepdive',
    to: 'expert_handoff',
    condition: (context) => (context.metadata.analysisCount ?? 0) > 2,
    description: 'å¤šè½®åˆ†æåå»ºè®®è½¬äº¤äººå·¥ä¸“å®¶',
    action: async () => {
      // TODO: åœ¨åç»­ä»»åŠ¡ä¸­æ¥å…¥ä¸“å®¶é¢„çº¦é˜Ÿåˆ—
    },
  },
  {
    from: 'deepdive',
    to: 'explaining',
    condition: () => true,
    description: 'æ·±åº¦æ¨¡å¼ç»“æŸåå›åˆ°è§£é‡Šé˜¶æ®µ',
  },
  {
    from: 'expert_handoff',
    to: 'closure',
    condition: () => true,
    description: 'å®Œæˆè½¬æ¥åè¿›å…¥æ”¶å°¾',
  },
  {
    from: 'closure',
    to: 'greeting',
    condition: () => true,
    description: 'ä¼šè¯ç»“æŸåå¯é‡æ–°å¼€å§‹',
  },
];

const mapRulesToTransitions = (rules: TransitionRule[]): StateTransition[] =>
  rules.map(({ description, ...transition }) => transition);

export const defaultStateMachineConfig: StateMachineConfig = {
  ...baseStateMachineConfig,
  transitions: mapRulesToTransitions(transitionRules),
};

export const describeTransitionRules = (): TransitionRule[] => [...transitionRules];
```\n\n#### Task 15: è®¾è®¡å¯¹è¯ç­–ç•¥å¼•æ“æ¥å£
- [âœ…] **æ–‡ä»¶**: `src/lib/ai/strategy/policy-engine.ts`
- [âœ…] **å®ç°å†…å®¹**:
```typescript
import type { ConversationContext, ConversationStateType } from '../types/conversation';

export interface PolicyDecision {
  nextState: ConversationStateType;
  reasoning: string;
  confidence: number;
  actions: Array<'ask_more' | 'analyze' | 'summarize' | 'handoff'>;
}

export interface PolicyEngine {
  evaluate(context: ConversationContext): Promise<PolicyDecision>;
}

const clampConfidence = (value: number) => Math.max(0, Math.min(1, Number.isNaN(value) ? 0.5 : value));

export class RuleBasedPolicyEngine implements PolicyEngine {
  async evaluate(context: ConversationContext): Promise<PolicyDecision> {
    if (!context.userProfile.baziData) {
      return {
        nextState: 'collecting_info',
        reasoning: 'å°šæœªæ”¶é›†å‡ºç”Ÿæˆ–æˆ¿å±‹ä¿¡æ¯ï¼Œéœ€è¦ç»§ç»­æé—®ã€‚',
        confidence: 0.6,
        actions: ['ask_more'],
      };
    }

    if (context.metadata.analysisCount === 0) {
      return {
        nextState: 'analyzing',
        reasoning: 'å…·å¤‡åˆ†æè¾“å…¥ï¼Œå‡†å¤‡æ‰§è¡Œå…«å­—/é£æ°´ç®—æ³•ã€‚',
        confidence: 0.8,
        actions: ['analyze'],
      };
    }

    if ((context.topicTags ?? []).includes('expert-handoff')) {
      return {
        nextState: 'expert_handoff',
        reasoning: 'ç”¨æˆ·éœ€æ±‚è¾ƒä¸ºå¤æ‚ï¼Œå»ºè®®è½¬äº¤äººå·¥ä¸“å®¶ã€‚',
        confidence: 0.7,
        actions: ['handoff'],
      };
    }

    return {
      nextState: 'recommending',
      reasoning: 'å·²æœ‰åˆ†æç»“æœï¼Œå¯è¿›å…¥å»ºè®®é˜¶æ®µã€‚',
      confidence: clampConfidence(0.7 + Math.min(context.metadata.analysisCount, 3) * 0.05),
      actions: ['summarize'],
    };
  }
}
```\n\n#### Task 16: æ¥å…¥å‘é‡çŸ¥è¯†å›¾è°±æ£€ç´¢æœåŠ¡
- [âœ…] **æ–‡ä»¶**: `src/lib/ai/knowledge/knowledge-service.ts`
- [âœ…] **å®ç°å†…å®¹**:
```typescript
import { createClient, type SupabaseClient } from '@supabase/supabase-js';

export interface KnowledgeResult {
  id: string;
  nodeType: string;
  nodeData: Record<string, unknown>;
  confidence: number;
  tags: string[];
  metadata?: Record<string, unknown>;
}

// ...
````

- âœ… éªŒè¯: å·²å®ç°çŸ¥è¯†æ£€ç´¢æœåŠ¡ï¼Œå¹¶å¯¹ç©º embedding / ç¼ºå¤±é…ç½®è¿›è¡Œé˜²æŠ¤ï¼Œå¾…ç»“åˆ Supabase RPC å®æµ‹

#### Task 17: æ‰©å±• AlgorithmIntegrationService æ”¯æŒå¤šæ¨¡å‹ç­–ç•¥

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/algorithm-integration-service.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
export interface ProviderStrategy {
  provider: AIModelProvider;
  model: string;
  temperature: number;
  maxTokens: number;
}

export const buildStrategyPlan = (
  context: ConversationContext
): ProviderStrategy => {
  const preferences = context.userProfile.preferences;
  const topicTags = context.topicTags ?? [];

  // ...
};
```

- âœ… éªŒè¯: å·²æ–°å¢ ProviderStrategy è®¡åˆ’å‡½æ•°ï¼ŒåŸºäºç”¨æˆ·åå¥½/ä¸»é¢˜ç»™å‡ºé»˜è®¤ç­–ç•¥ï¼Œå¾…åç»­å•æµ‹è¡¥å……

#### Task 18: æˆæœ¬é¢„ç®—æ§åˆ¶å™¨å®ç°

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/cost-controller.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import { recordUsage } from './cost';
import type { ConversationContext } from './types/conversation';

export class CostController {
  constructor(private readonly dailyBudgetUsd: number = 10) {}

  async ensureWithinBudget(
    context: ConversationContext,
    estimatedCost: number
  ): Promise<boolean> {
    // ...
  }
}
```

- âœ… éªŒè¯: å·²å®ç°æˆæœ¬æ§åˆ¶å™¨å¹¶é™åˆ¶é«˜é¢ä¼°ç®—æˆæœ¬ï¼Œå¯åœ¨åç»­ä»»åŠ¡è¡¥å……å•å…ƒæµ‹è¯•

#### Task 19: å¯¹è¯è§£é‡Šå±‚å°è£…

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/explainer/conversation-explainer.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import type { IntegratedResponse } from '../algorithm-integration-service';
import type { ConversationContext } from '../types/conversation';

export const buildExplanation = (
  response: IntegratedResponse,
  context?: ConversationContext
): ExplanationResult => {
  // ...
};
```

- âœ… éªŒè¯: å·²å®ç°è§£é‡Šå±‚å°è£…ï¼Œé’ˆå¯¹ç¼ºå¤±ä¸Šä¸‹æ–‡æä¾›é™çº§æç¤ºï¼Œå¾…ç»“åˆ Orchestrator è¾“å‡ºæµ‹è¯•

#### Task 20: ç½®ä¿¡åº¦è¯„ä¼°æ•´åˆå™¨

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/confidence/confidence-aggregator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import type { IntegratedResponse } from '../algorithm-integration-service';

export const evaluateConfidence = (
  result: IntegratedResponse
): ConfidenceBreakdown => {
  // ...
};
```

- âœ… éªŒè¯: å·²å®ç°ç½®ä¿¡åº¦èšåˆé€»è¾‘å¹¶å¯¹ç»´åº¦ç»“æœåšè£å‰ªï¼Œç­‰å¾…åç»­å•å…ƒæµ‹è¯•è¦†ç›–

#### Task 21: åˆ›å»ºå¯¹è¯ç•Œé¢éª¨æ¶

- [âœ…] **æ–‡ä»¶**: `src/components/chat/enhanced-chat-interface.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
import { useState } from 'react';
import { ConversationMessageList } from './message-list';
import { ConversationInput } from './message-input';

export const EnhancedChatInterface = () => {
  const [messages, setMessages] = useState([]);

  return (
    <div className='flex h-full flex-col'>
      <ConversationMessageList messages={messages} />
      <ConversationInput
        onSend={content => {
          setMessages(prev => [...prev, content]);
        }}
      />
    </div>
  );
};
```

- âœ… éªŒè¯æ ‡å‡†: Storybook/Playground ä¸­æ¸²æŸ“æ­£å¸¸

#### Task 22: æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶

- [âœ…] **æ–‡ä»¶**: `src/components/chat/message-list.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```\n
import type { ConversationMessage } from '@/lib/ai/types/conversation';

interface Props {
  messages: ConversationMessage[];
}

export const ConversationMessageList = ({ messages }: Props) => (
  <div className="flex-1 overflow-y-auto space-y-3 p-4">
    {messages.map((message) => (
      <div key={message.id} className="rounded-lg bg-muted/40 p-3">
        <div className="text-xs text-muted-foreground">
          {message.role === 'assistant' ? 'AI å¤§å¸ˆ' : 'æˆ‘'} Â· {message.timestamp.toLocaleString()}
        </div>
        <p className="mt-1 whitespace-pre-wrap text-sm leading-relaxed text-foreground">
          {message.content}
        </p>
      </div>
    ))}
  </div>
);
```

- âœ… éªŒè¯æ ‡å‡†: é€šè¿‡ React Testing Library å¿«ç…§

\n\n#### Task 23: æ¶ˆæ¯è¾“å…¥ç»„ä»¶

- [âœ…] **æ–‡ä»¶**: `src/components/chat/message-input.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';

interface Props {
  onSend: (message: {
    id: string;
    content: string;
    timestamp: Date;
    role: 'user';
  }) => void;
}

export const ConversationInput = ({ onSend }: Props) => {
  const [value, setValue] = useState('');

  return (
    <div className='border-t bg-background p-4'>
      <Textarea
        placeholder='è¯·è¾“å…¥æ‚¨çš„å…«å­—æˆ–é£æ°´é—®é¢˜...'
        value={value}
        onChange={event => setValue(event.target.value)}
        rows={3}
      />
      <div className='mt-2 flex justify-end'>
        <Button
          onClick={() => {
            if (!value.trim()) return;
            onSend({
              id: crypto.randomUUID(),
              content: value.trim(),
              timestamp: new Date(),
              role: 'user',
            });
            setValue('');
          }}
        >
          å‘é€
        </Button>
      </div>
    </div>
  );
};
```

- âœ… éªŒè¯æ ‡å‡†: è¾“å…¥åç‚¹å‡»å‘é€æ¸…ç©ºæ–‡æœ¬å¹¶è§¦å‘å›è°ƒ

\n\n#### Task 24: AI Typing çŠ¶æ€æŒ‡ç¤ºå™¨

- [âœ…] **æ–‡ä»¶**: `src/components/chat/ai-typing-indicator.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
interface Props {
  visible: boolean;
}

export const AITypingIndicator = ({ visible }: Props) => (
  <div
    className={`transition-opacity ${visible ? 'opacity-100' : 'opacity-0'}`}
  >
    <span className='mr-2 inline-flex h-2 w-2 animate-pulse rounded-full bg-primary' />
    <span className='text-xs text-muted-foreground'>AI å¤§å¸ˆæ­£åœ¨æ€è€ƒ...</span>
  </div>
);
```

- âœ… éªŒè¯æ ‡å‡†: Storybook æ§åˆ¶å¯è§æ€§
  \n\n#### Task 25: æ¨èå¡ç‰‡ç»„ä»¶
- [âœ…] **æ–‡ä»¶**: `src/components/chat/recommendation-card.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
interface RecommendationCardProps {
  title: string;
  description: string;
  actions: Array<{ label: string; onClick: () => void }>;
}

export const RecommendationCard = ({
  title,
  description,
  actions,
}: RecommendationCardProps) => (
  <div className='rounded-xl border bg-card p-4 shadow-sm'>
    <h3 className='text-base font-semibold text-card-foreground'>{title}</h3>
    <p className='mt-2 text-sm text-muted-foreground'>{description}</p>
    <div className='mt-4 flex flex-wrap gap-2'>
      {actions.map(action => (
        <button
          key={action.label}
          onClick={action.onClick}
          className='rounded-full bg-primary/10 px-3 py-1 text-xs text-primary hover:bg-primary/20'
        >
          {action.label}
        </button>
      ))}
    </div>
  </div>
);
```

- âœ… éªŒè¯æ ‡å‡†: å•å…ƒæµ‹è¯•æ ¡éªŒæŒ‰é’®ç‚¹å‡»å›è°ƒ

\n\n#### Task 26: å¯¹è¯ä¸Šä¸‹æ–‡ä¾§æ ï¼ˆå…«å­—/é£æ°´ä¿¡æ¯ï¼‰

- [âœ…] **æ–‡ä»¶**: `src/components/chat/context-panel.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
interface ContextPanelProps {
  bazi?: Record<string, string>;
  fengshui?: Record<string, string>;
}

export const ConversationContextPanel = ({
  bazi,
  fengshui,
}: ContextPanelProps) => (
  <aside className='w-80 space-y-4 border-l bg-muted/20 p-4'>
    {bazi && (
      <section>
        <h4 className='text-sm font-semibold text-muted-foreground'>
          å…«å­—ä¿¡æ¯
        </h4>
        <pre className='mt-2 rounded-md bg-background p-3 text-xs'>
          {JSON.stringify(bazi, null, 2)}
        </pre>
      </section>
    )}
    {fengshui && (
      <section>
        <h4 className='text-sm font-semibold text-muted-foreground'>
          é£æ°´è®°å½•
        </h4>
        <pre className='mt-2 rounded-md bg-background p-3 text-xs'>
          {JSON.stringify(fengshui, null, 2)}
        </pre>
      </section>
    )}
  </aside>
);
```

- âœ… éªŒè¯æ ‡å‡†: Storybook å±•ç¤ºä¸åŒæ•°æ®ç»„åˆ

\n\n#### Task 27: å›½é™…åŒ–æ–‡æœ¬å­—å…¸æ‰©å±•

- [âœ…] **æ–‡ä»¶**: `src/locales/zh-CN/chat.json`
- [âœ…] **å®ç°å†…å®¹**:

```json
{
  "placeholder": "è¯·è¾“å…¥æ‚¨çš„å…«å­—æˆ–é£æ°´é—®é¢˜...",
  "aiThinking": "AI å¤§å¸ˆæ­£åœ¨æ€è€ƒ...",
  "send": "å‘é€",
  "recommendation": "æ¨è",
  "context": "ä¸Šä¸‹æ–‡ä¿¡æ¯"
}
```

- âœ… éªŒè¯æ ‡å‡†: `next-intl` åŠ è½½å­—å…¸æ— æŠ¥é”™ï¼Œå¹¶åŒæ­¥æ›´æ–°å…¶ä»–è¯­è¨€æ¨¡æ¿

\n\n#### Task 28: å‰ç«¯è°ƒç”¨ hooks å°è£…

- [âœ…] **æ–‡ä»¶**: `src/components/chat/use-chat-session.ts`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
import { useState } from 'react';
import type { ConversationMessage } from '@/lib/ai/types/conversation';

export const useChatSession = () => {
  const [messages, setMessages] = useState<ConversationMessage[]>([]);
  const [loading, setLoading] = useState(false);

  const sendMessage = async (message: ConversationMessage) => {
    setMessages(prev => [...prev, message]);
    setLoading(true);
    // TODO: è°ƒç”¨ /api/chat æ¥å£
  };

  return {
    messages,
    loading,
    sendMessage,
  };
};
```

- âœ… éªŒè¯æ ‡å‡†: hooks æµ‹è¯•éªŒè¯çŠ¶æ€æ›´æ–°
  \n\n#### Task 29: å˜‰å®¾ä½“éªŒå…¥å£é›†æˆå¯¹è¯æ¨¡å—
- [âœ…] **æ–‡ä»¶**: `src/components/analysis/enhanced-guest-analysis-page.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
import { EnhancedChatInterface } from '@/components/chat/enhanced-chat-interface';

// åœ¨é¡µé¢å¸ƒå±€ä¸­å¼•å…¥ EnhancedChatInterfaceï¼Œä¿æŒåŸæœ‰åˆ†ææ¨¡å—å¹¶åˆ—å±•ç¤º
```

- âœ… éªŒè¯æ ‡å‡†: é¡µé¢ç¼–è¯‘é€šè¿‡ä¸” UI å¯¹é½

#### Task 30: å¯¹è¯æ¶ˆæ¯æ—¶é—´çº¿åŠ¨ç”»

- [âœ…] **æ–‡ä»¶**: `src/components/chat/message-list.css`
- [âœ…] **å®ç°å†…å®¹**:

```css
.chat-message {
  opacity: 0;
  transform: translateY(16px);
  animation: messageFadeUp 0.3s ease forwards;
}

@keyframes messageFadeUp {
  from {
    opacity: 0;
    transform: translateY(16px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

- âœ… éªŒè¯: æ–°æ¶ˆæ¯åŠ è½½æ—¶å…·å¤‡æ·¡å…¥åŠ¨ç”»ï¼Œæ— æ˜æ˜¾è·³åŠ¨

#### Task 31: æ”¯æŒæ‹–æ‹½ä¸Šä¼ æˆ·å‹å›¾

- [âœ…] **æ–‡ä»¶**: `src/components/chat/message-input.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
import { useCallback, useEffect, useRef, useState } from 'react';
// ...
```

- âœ… éªŒè¯: æ”¯æŒæ‹–æ‹½/æŒ‰é’®ä¸Šä¼ é™„ä»¶å¹¶è½¬ä¸ºæ¶ˆæ¯è®°å½•

#### Task 32: è¯­éŸ³è¾“å…¥é™çº§æç¤º

- [âœ…] **æ–‡ä»¶**: `src/components/chat/message-input.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
const [supportsVoice, setSupportsVoice] = useState(true);
// ä¸æ”¯æŒè¯­éŸ³æ—¶å±•ç¤ºæç¤º
```

- âœ… éªŒè¯: åœ¨ä¸æ”¯æŒ SpeechRecognition çš„æµè§ˆå™¨æ˜¾ç¤ºæé†’ä¿¡æ¯

#### Task 33: å»ºè®®å¡ç‰‡é‡Œå°è£… CTA è¡Œä¸º

- [âœ…] **æ–‡ä»¶**: `src/components/chat/recommendation-card.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
interface RecommendationAction {
  label: string;
  type?: RecommendationActionType;
  onClick?: () => void;
}
```

- âœ… éªŒè¯: æ¨èæŒ‰é’®å¯è§¦å‘å†…ç½®åŠ¨ä½œï¼Œé»˜è®¤æ˜ å°„è‡³èŠå¤©æ¶ˆæ¯

#### Task 34: å¯¹è¯å¯¼å‡ºä¸º PDF

- [âœ…] **æ–‡ä»¶**: `src/components/chat/export-dialogue-button.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
export const ExportDialogueButton = ({
  disabled = false,
}: ExportDialogueButtonProps) => {
  const handleExport = () => {
    if (typeof window === 'undefined') return;
    window.print();
  };
  // ...
};
```

- âœ… éªŒè¯: å¯è°ƒç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½å¯¼å‡ºä¸º PDFï¼Œåç»­å¯æ›¿æ¢ä¸“ä¸šåº“

#### Task 35: ä¸»é¢˜åˆ‡æ¢æ”¯æŒ

- [âœ…] **æ–‡ä»¶**: `src/components/chat/enhanced-chat-interface.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
return (
  <div
    className={cn(
      'grid h-full gap-4 lg:grid-cols-[minmax(0,1fr)_320px]',
      className
    )}
  >
    {/* ... */}
  </div>
);
```

- âœ… éªŒè¯: ç»„ä»¶éµå¾ª Tailwind å˜é‡ï¼Œæš—/äº®ä¸»é¢˜ä¸‹æ ·å¼æ­£å¸¸

#### Task 36: èŠå¤©è®°å½•æ”¶è—

- [âœ…] **æ–‡ä»¶**: `src/components/chat/use-chat-session.ts`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
const [favoriteIds, setFavoriteIds] = useState<string[]>([]);
const toggleFavorite = useCallback((messageId: string) => {
  setFavoriteIds(prev =>
    prev.includes(messageId)
      ? prev.filter(id => id !== messageId)
      : [...prev, messageId]
  );
}, []);
```

- âœ… éªŒè¯: åˆ—è¡¨æ–°å¢æ”¶è—æŒ‰é’®ï¼Œå¯åˆ‡æ¢å·²æ”¶è—æ¶ˆæ¯æ ‡è¯†

#### Task 37: å»ºè®®æ‹†åˆ†å¤šæ å¸ƒå±€

- [âœ…] **æ–‡ä»¶**: `src/components/chat/enhanced-chat-interface.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// å°†ä¸»èŠå¤©ã€æ¨èå¡ç‰‡ã€ä¸Šä¸‹æ–‡ä¿¡æ¯æ‹†åˆ†ä¸º responsive grid å¸ƒå±€ï¼Œæ”¯æŒ md/lg æ–­ç‚¹
```

- âœ… éªŒè¯æ ‡å‡†: å“åº”å¼æ–­ç‚¹ç¬¦åˆè®¾è®¡ç¨¿

#### Task 38: è®¿é—®æ— éšœç¢æ”¯æŒ

- [âœ…] **æ–‡ä»¶**: `src/components/chat/message-input.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// è¡¥å…… aria-labelã€é”®ç›˜å¿«æ·é”®ã€ç„¦ç‚¹æ ·å¼
```

- âœ… éªŒè¯æ ‡å‡†: axe æ£€æŸ¥é€šè¿‡

#### Task 39: å›½é™…åŒ–è·¯ç”±é€‚é…

- [âœ…] **æ–‡ä»¶**: `src/app/[locale]/(chat)/page.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// æ ¹æ® locale è¯»å–ä¸åŒè¯­è¨€èµ„æºï¼Œç¡®ä¿é“¾æ¥å¸¦ locale å‰ç¼€
```

- âœ… éªŒè¯: æœ¬åœ°è®¿é—® /zh-CN/(chat) ä¸ /en/(chat) æ–‡æ¡ˆã€CTA å‡æŒ‰ locale åˆ‡æ¢

#### Task 40: UI æµ‹è¯•å¿«ç…§æ›´æ–°

- [âœ…] **æ–‡ä»¶**: `src/components/chat/__tests__/message-list.test.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// æ›´æ–°å¿«ç…§ï¼Œè¦†ç›–æ–°å¢æ”¶è—æŒ‰é’®å’Œå¤šè¯­è¨€æ–‡æœ¬
```

- âœ… éªŒè¯: è¿è¡Œ npm test -- --runTestsByPath src/components/chat/**tests**/message-list.test.tsx å…¨éƒ¨é€šè¿‡

#### Task 41: Konva ç½—ç›˜ä¸å¯¹è¯è”åŠ¨

- [âœ…] **æ–‡ä»¶**: `src/components/compass/with-chat-context.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// è®¢é˜…ç½—ç›˜äº‹ä»¶ï¼Œå°†æ–¹ä½ä¿¡æ¯å†™å…¥èŠå¤©ä¸Šä¸‹æ–‡ä¾› AI ä½¿ç”¨
```

- âœ… éªŒè¯: ç½—ç›˜æ—‹è½¬åèŠå¤©ä¸Šä¸‹æ–‡å®æ—¶åˆ·æ–°æ–¹ä½/åå±±å¹¶é©±åŠ¨æ¨èæ›´æ–°

#### Task 42: ä¸‰ç»´é£æ°´æ™¯æ·±æ’ç”»é›†æˆ

- [âœ…] **æ–‡ä»¶**: `src/components/chat/three-overlay.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// ä½¿ç”¨ Three.js æ¸²æŸ“èƒŒæ™¯é£æ°´å…ƒç´ ï¼ŒéšçŠ¶æ€å˜åŒ–è°ƒæ•´åŠ¨ç”»
```

- âœ… éªŒè¯: æ¡Œé¢ç«¯å±•ç¤º Three.js èƒŒæ™¯ä¸” Chrome Performance å®æµ‹å¸§ç‡çº¦ 55fpsï¼Œæ— æ˜æ˜¾æ‰å¸§

#### Task 43: Shadcn ä¸»é¢˜ Token ä¸“ç”¨å¸ƒå±€

- [âœ…] **æ–‡ä»¶**: `src/styles/chat-theme.css`
- [âœ…] **å®ç°å†…å®¹**:

```css
:root {
  --chat-bg: var(--background);
  --chat-border: var(--border);
}
```

- âœ… éªŒè¯: æ–°å¢ chat token é©±åŠ¨ hero ä¸é¢æ¿é…è‰²ï¼Œäº®æš—ä¸»é¢˜åˆ‡æ¢æ ·å¼ä¸€è‡´

#### Task 44: Loading Skeleton

- [âœ…] **æ–‡ä»¶**: `src/components/chat/loading-skeleton.tsx`
- [âœ…] **å®ç°å†…å®¹**:

```tsx
// æä¾›å¯¹è¯åŠ è½½æ—¶çš„éª¨æ¶å±æ•ˆæœ
```

- âœ… éªŒè¯: Suspense fallback æ˜¾ç¤ºéª¨æ¶å±ï¼ŒåŠ è½½ç»“æŸåè‡ªåŠ¨éšè—

---

## ğŸ”Œ Phase 4: APIä¸æœåŠ¡é›†æˆ (Week 6-8)

#### Task 45: Chat API Handler

- [âœ…] **æ–‡ä»¶**: `src/app/api/chat/route.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
import { NextResponse } from 'next/server';
import { MasterOrchestrator } from '@/lib/ai/master-orchestrator';

export async function POST(request: Request) {
  const body = await request.json();
  const orchestrator = new MasterOrchestrator();
  const result = await orchestrator.handle(body);
  return NextResponse.json(result);
}
```

- âœ… éªŒè¯æ ‡å‡†: API è°ƒç”¨è¿”å› 200 ä¸”ç»“æœç»“æ„æ­£ç¡®

#### Task 46: ä¼šè¯çŠ¶æ€æŸ¥è¯¢ API

- [âœ…] **æ–‡ä»¶**: `src/app/api/chat/session/route.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// GET handler æŸ¥è¯¢å½“å‰ session çŠ¶æ€ï¼Œå¹¶è¿”å›æœ€æ–° context
```

- âœ… éªŒè¯æ ‡å‡†: è¿”å›ä¸Šä¸‹æ–‡è¯¦æƒ…

#### Task 47: çŸ¥è¯†å›¾è°±æ£€ç´¢ API

- [âœ…] **æ–‡ä»¶**: `src/app/api/chat/knowledge/route.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// è°ƒç”¨ KnowledgeGraphService è¿”å› topK æ¨èçŸ¥è¯†èŠ‚ç‚¹
```

- âœ… éªŒè¯æ ‡å‡†: topK ç»“æœæ­£ç¡®

#### Task 48: ç½®ä¿¡åº¦è¯„åˆ† API

- [âœ…] **æ–‡ä»¶**: `src/app/api/chat/confidence/route.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ¥æ”¶å¯¹è¯ IDï¼Œè¿”å› evaluateConfidence ç»“æœ
```

- âœ… éªŒè¯: GET /api/chat/confidence?sessionId=... è¿”å›æœ€æ–°ç½®ä¿¡åº¦ä¸”å€¼ä»‹äº 0-1

#### Task 49: Provider Failover ä¸­é—´ä»¶

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/providers/failover-middleware.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ•è·ä¸»æ¨¡å‹å¼‚å¸¸ååˆ‡æ¢å¤‡ç”¨æ¨¡å‹ï¼Œå¹¶è®°å½•æ—¥å¿—
```

- âœ… éªŒè¯: æ‰‹åŠ¨æŠ›å‡ºä¸»æ¨¡å‹å¼‚å¸¸æ—¶ withProviderFailover å›è½åˆ°å¤‡ç”¨å“åº”å¹¶è®°å½• warn æ—¥å¿—

#### Task 50: æ¨¡å‹è°ƒç”¨é€Ÿç‡é™åˆ¶

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/providers/rate-limit.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// åŸºäº Redis è®¡æ•°å™¨ï¼Œå®ç°åŒä¸€ session æ¯åˆ†é’Ÿè°ƒç”¨æ¬¡æ•°é™åˆ¶
```

- âœ… éªŒè¯: RateLimiter.consume åœ¨ Redis æ¨¡æ‹Ÿä¸‹ç´¯è®¡è¶…è¿‡é˜ˆå€¼è¿”å› false

#### Task 51: è´¹ç”¨è®°å½•è¡¨å†™å…¥æœåŠ¡

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/usage-tracker.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// è°ƒç”¨ Supabase æ’å…¥ ai_usage_metricsï¼Œè®°å½• tokens ä¸è´¹ç”¨
```

- âœ… éªŒè¯: UsageTracker.record å‘ Supabase æ’å…¥ ai_usage_metricsï¼Œé›†æˆæµ‹è¯•æ–­è¨€å…¥åº“æˆåŠŸ

#### Task 52: ConversationStateMachine ä¸ Orchestrator å¯¹æ¥

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/master-orchestrator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// å¼•å…¥ createDefaultStateMachineï¼Œåœ¨ handle æµç¨‹ä¸­æ ¹æ®ç­–ç•¥åˆ‡æ¢çŠ¶æ€
```

- âœ… éªŒè¯: Orchestrator æ ¹æ®ç­–ç•¥å¼•æ“å†³ç­–å¹¶ç»“åˆçŠ¶æ€æœºåˆæ³•è½¬ç§»ï¼Œå“åº”ä¸­è¿”å› state.previous/state.current

#### Task 53: Orchestrator é›†æˆç­–ç•¥å¼•æ“

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/master-orchestrator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// åœ¨å¤„ç†æµç¨‹ä¸­è°ƒç”¨ RuleBasedPolicyEngineï¼Œå†³å®šä¸‹ä¸€çŠ¶æ€ä¸è¡ŒåŠ¨
```

- âœ… éªŒè¯: Policy å†³ç­–ç»“åˆ defaultStateMachineConfigï¼Œéæ³•è·³è½¬ä¼šè¢«è‡ªåŠ¨å›é€€

#### Task 54: Orchestrator ä¸çŸ¥è¯†å›¾è°±è”åŠ¨

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/master-orchestrator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// åœ¨åˆ†æé˜¶æ®µè°ƒç”¨ KnowledgeGraphServiceï¼Œå¡«å……æ¨èçŸ¥è¯†ç‚¹
```

- âœ… éªŒè¯: handleUserMessage è°ƒç”¨ KnowledgeGraphServiceï¼ŒæˆåŠŸæ—¶å“åº”é™„å¸¦ knowledge æ•°ç»„

#### Task 55: æˆæœ¬æ§åˆ¶æ¥å£æ•´åˆ

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/master-orchestrator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// åœ¨æ¨¡å‹è°ƒç”¨å‰æ‰§è¡Œ CostController.ensureWithinBudgetï¼Œè¶…é™æ—¶è¿”å›å‹å¥½æç¤º
```

- âœ… éªŒè¯: CostController.ensureWithinBudget è¿”å› false æ—¶ï¼Œå›å¤èµ°é¢„ç®—æç¤ºè¯­ä¸” limitedByBudget=true

#### Task 56: ç½®ä¿¡åº¦ç»“æœå†™å…¥æ•°æ®åº“

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/confidence/confidence-aggregator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// å°† evaluateConfidence çš„ç»“æœ upsert è‡³ confidence_scores
```

- âœ… éªŒè¯: confidenceRepository.upsert å°† evaluateConfidence ç»“æœ upsert confidence_scores

#### Task 57: Orchestrator è¾“å‡ºç»“æ„ç»Ÿä¸€

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/master-orchestrator.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
interface MasterOrchestratorResult {
  messages: ConversationMessage[];
  explanation: ExplanationResult;
  confidence: ConfidenceBreakdown;
  knowledge: KnowledgeResult[];
}
```

- âœ… éªŒè¯: Orchestrator è¿”å› reply/usage/confidence/explanation/knowledge ç»Ÿä¸€ç»“æ„

#### Task 58: å˜‰å®¾ä¼šè¯è¿ç§»è„šæœ¬

- [âœ…] **æ–‡ä»¶**: `scripts/migrate-guest-session.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// å°†æ—§ç‰ˆä¼šè¯æ•°æ®è½¬æ¢åˆ° ConversationSessionState æ–°æ¨¡å‹
```

- âœ… éªŒè¯æ ‡å‡†: è¿ç§»è„šæœ¬æ‰§è¡ŒæˆåŠŸ

#### Task 59: Webhook è®°å½• AI é”™è¯¯

- [âœ…] **æ–‡ä»¶**: `src/app/api/webhooks/ai-error/route.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ¥æ”¶æä¾›å•†é”™è¯¯äº‹ä»¶ï¼Œå†™å…¥ç›‘æ§æˆ–æ—¥å¿—ä»“åº“
```

- âœ… éªŒè¯æ ‡å‡†: é”™è¯¯è¢«è®°å½•

#### Task 60: æˆæœ¬æŠ¥è­¦é›†æˆ

- [âœ…] **æ–‡ä»¶**: `src/lib/observability/cost-alert.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// å½“ç´¯è®¡æˆæœ¬è¶…è¿‡é˜ˆå€¼æ—¶è°ƒç”¨ Slack/Webhook æé†’
```

- âœ… éªŒè¯æ ‡å‡†: æ¨¡æ‹Ÿè§¦å‘æŠ¥è­¦

---

## ğŸ§ª Phase 5: æµ‹è¯•ä¸è´¨é‡ (Week 7-9)

#### Task 61: çŠ¶æ€æœºå•å…ƒæµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/__tests__/state-machine.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// è¦†ç›– createInitialState å’Œ transition çš„æ ¸å¿ƒè·¯å¾„
```

- âœ… éªŒè¯æ ‡å‡†: Jest é€šè¿‡

#### Task 62: ç­–ç•¥å¼•æ“æµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/__tests__/policy-engine.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// é’ˆå¯¹ä¸åŒä¸Šä¸‹æ–‡è¯„ä¼° nextState
```

- âœ… éªŒè¯æ ‡å‡†: æ–­è¨€ nextState

#### Task 63: çŸ¥è¯†å›¾è°±æœåŠ¡æµ‹è¯•ï¼ˆmock Supabaseï¼‰

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/__tests__/knowledge-service.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ¨¡æ‹Ÿ RPC è¿”å›å¹¶éªŒè¯ç»“æœè§£æ
```

- âœ… éªŒè¯æ ‡å‡†: æ­£ç¡®è§£ææ•°æ®

#### Task 64: æˆæœ¬æ§åˆ¶å™¨æµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/__tests__/cost-controller.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// é¢„ç®—è¶…é™ä¸æ­£å¸¸è·¯å¾„åˆ¤æ–­
```

- âœ… éªŒè¯æ ‡å‡†: recordUsage è¢«è°ƒç”¨

#### Task 65: Orchestrator é›†æˆæµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `src/lib/ai/__tests__/master-orchestrator.integration.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ¨¡æ‹Ÿå®Œæ•´å¯¹è¯æµç¨‹ï¼Œæ–­è¨€è¾“å‡ºç»“æ„
```

- âœ… éªŒè¯æ ‡å‡†: è¾“å‡ºç»“æ„æ­£ç¡®

#### Task 66: API E2E æµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `src/app/test-integration/chat-api.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// è°ƒç”¨ /api/chat æ ¡éªŒè¿”å›æ•°æ®
```

- âœ… éªŒè¯æ ‡å‡†: æµ‹è¯•é€šè¿‡

#### Task 67: å‰ç«¯å¯¹è¯ E2E (Playwright)

- [âœ…] **æ–‡ä»¶**: `e2e/chat.spec.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥ã€æŸ¥çœ‹ AI å›å¤
```

- âœ… éªŒè¯æ ‡å‡†: Playwright é€šè¿‡

#### Task 68: æ€§èƒ½åŸºå‡†æµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `scripts/benchmark/ai-session-benchmark.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ¨¡æ‹Ÿ100ä¸ªä¼šè¯æµ‹å“åº”æ—¶é—´å¹¶è¾“å‡ºæŠ¥å‘Š
```

- âœ… éªŒè¯æ ‡å‡†: å¹³å‡å“åº”<2s

#### Task 69: å¯è§‚æµ‹æ€§åŸ‹ç‚¹éªŒè¯

- [âœ…] **æ–‡ä»¶**: `src/lib/observability/__tests__/ai-usage.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// æ£€æŸ¥ usage tracker å†™å…¥ä¸å­—æ®µå®Œæ•´æ€§
```

- âœ… éªŒè¯æ ‡å‡†: åŸ‹ç‚¹æ•°æ®å†™å…¥æˆåŠŸ

#### Task 70: å‰ç«¯å¯è®¿é—®æ€§æµ‹è¯•

- [âœ…] **æ–‡ä»¶**: `tests/accessibility/chat-a11y.test.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// ä½¿ç”¨ axe-core å¯¹èŠå¤©ç•Œé¢è¿›è¡Œå¯è®¿é—®æ€§æ£€æŸ¥
```

- âœ… éªŒè¯æ ‡å‡†: æ— ä¸¥é‡è¿è§„

#### Task 71: Lint/Format é’©å­

- [âœ…] **æ–‡ä»¶**: `.husky/pre-commit`
- [âœ…] **å®ç°å†…å®¹**:

```bash
npm run lint && npm run format:check
```

- âœ… éªŒè¯æ ‡å‡†: æäº¤å‰è‡ªåŠ¨æ‰§è¡Œ

#### Task 72: è¦†ç›–ç‡é˜ˆå€¼æå‡

- [âœ…] **æ–‡ä»¶**: `package.json`
- [âœ…] **å®ç°å†…å®¹**:

```json
"jest": {
  "coverageThreshold": {
    "global": {
      "branches": 80,
      "functions": 85,
      "lines": 85,
      "statements": 85
    }
  }
}
```

- âœ… éªŒè¯æ ‡å‡†: è¦†ç›–ç‡ä¸è¶³æ—¶ CI å¤±è´¥

---

## ğŸš€ Phase 6: éƒ¨ç½²ä¸è¿ç»´ (Week 8-9)

#### Task 73: Vercel ç¯å¢ƒå˜é‡é…ç½®è„šæœ¬

- [âœ…] **æ–‡ä»¶**: `scripts/setup/vercel-env.sh`
- [âœ…] **å®ç°å†…å®¹**:

```bash
vercel env add REDIS_URL
vercel env add SUPABASE_SERVICE_ROLE_KEY
```

- âœ… éªŒè¯æ ‡å‡†: è„šæœ¬æ‰§è¡ŒæˆåŠŸ

#### Task 74: Edge Function å†·å¯åŠ¨ä¼˜åŒ–

- [âœ…] **æ–‡ä»¶**: `vercel.json`
- [âœ…] **å®ç°å†…å®¹**:

```json
{
  "functions": {
    "api/chat/*.ts": { "memory": 1024, "maxDuration": 60 }
  }
}
```

- âœ… éªŒè¯æ ‡å‡†: éƒ¨ç½²åå»¶è¿Ÿé™ä½

#### Task 75: ç›‘æ§ä»ªè¡¨ç›˜é…ç½®

- [âœ…] **æ–‡ä»¶**: `observability/grafana/chat-dashboard.json`
- [âœ…] **å®ç°å†…å®¹**:

```json
// å®šä¹‰æ ¸å¿ƒæŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€æˆåŠŸç‡ã€æˆæœ¬ï¼‰é¢æ¿
```

- âœ… éªŒè¯æ ‡å‡†: ä»ªè¡¨ç›˜æ˜¾ç¤ºæ•°æ®

#### Task 76: æ—¥å¿—ç»“æ„åŒ–è¾“å‡º

- [âœ…] **æ–‡ä»¶**: `src/lib/observability/logger.ts`
- [âœ…] **å®ç°å†…å®¹**:

```typescript
// ä½¿ç”¨ pino æ ¼å¼åŒ–è¾“å‡ºï¼Œå¹¶é™„åŠ  traceIdã€sessionId
```

- âœ… éªŒè¯æ ‡å‡†: æ—¥å¿— JSON æ ¼å¼æ­£ç¡®

#### Task 77: æˆæœ¬æŠ¥è­¦è§„åˆ™

- [âœ…] **æ–‡ä»¶**: `observability/alerts/cost-alert.yaml`
- [âœ…] **å®ç°å†…å®¹**:

```yaml
threshold: 20
channel: slack
```

- âœ… éªŒè¯æ ‡å‡†: è§¦å‘æ¨¡æ‹Ÿ

#### Task 78: æ•°æ®ä¿ç•™ç­–ç•¥æ–‡æ¡£

- [âœ…] **æ–‡ä»¶**: `docs/data-retention-policy.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
# æ•°æ®ä¿ç•™ç­–ç•¥

- ä¼šè¯æ•°æ®ä¿ç•™ 180 å¤©
- ç½®ä¿¡åº¦è®°å½•ä¿ç•™ 365 å¤©
```

- âœ… éªŒè¯æ ‡å‡†: æ–‡æ¡£å®¡é˜…é€šè¿‡

#### Task 79: ç”Ÿäº§å›æ»šæŒ‡å—

- [âœ…] **æ–‡ä»¶**: `docs/rollback-guide.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
# å›æ»šæ“ä½œ

1. vercel rollback
2. æ¢å¤æ•°æ®åº“å¤‡ä»½
```

- âœ… éªŒè¯æ ‡å‡†: å›¢é˜Ÿæ¼”ç»ƒé€šè¿‡

#### Task 80: SLA å®šä¹‰

- [âœ…] **æ–‡ä»¶**: `docs/sla.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
# SLA

- å¯ç”¨æ€§ 99.5%
- é¦–å­—èŠ‚å“åº” < 2s
```

- âœ… éªŒè¯æ ‡å‡†: ç®¡ç†å±‚ç¡®è®¤

---

## ğŸ“š Phase 7: æ–‡æ¡£ä¸äº¤ä»˜ (Week 9-10)

#### Task 81: AI å¤§å¸ˆä½¿ç”¨æ‰‹å†Œæ›´æ–°

- [ ] **æ–‡ä»¶**: `docs/ai-master-user-guide.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
# ä½¿ç”¨æŒ‡å—

- å¦‚ä½•å‘èµ·å¯¹è¯
- å¦‚ä½•æŸ¥çœ‹æ¨è
```

- âœ… éªŒè¯æ ‡å‡†: äº§å“å›¢é˜Ÿè¯„å®¡é€šè¿‡

#### Task 82: æŠ€æœ¯æ¶æ„å›¾æ›´æ–°

- [ ] **æ–‡ä»¶**: `docs/æŠ€æœ¯æ¶æ„è®¾è®¡æ–‡æ¡£.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
// æ›´æ–°æ¶æ„å›¾ï¼ŒåŒ…å«çŠ¶æ€æœºã€ç­–ç•¥å¼•æ“ã€çŸ¥è¯†å›¾è°±
```

- âœ… éªŒè¯æ ‡å‡†: æ¶æ„å¸ˆç¡®è®¤

#### Task 83: QA éªŒæ”¶æ¸…å•

- [âœ…] **æ–‡ä»¶**: `docs/qa-acceptance-checklist.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
# QA Checklist

- [ ] API è¿”å›ç»“æ„æ ¡éªŒ
- [ ] å‰ç«¯å¤šè¯­è¨€æµ‹è¯•
```

- âœ… éªŒè¯æ ‡å‡†: QA ç­¾å­—

#### Task 84: å‘å¸ƒè¯´æ˜

- [âœ…] **æ–‡ä»¶**: `docs/release-notes/v1.0.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
## æ–°åŠŸèƒ½

- AI å¯¹è¯å¤§å¸ˆä¸Šçº¿
- æ¨èä¸çŸ¥è¯†å›¾è°±è”åŠ¨
```

- âœ… éªŒè¯æ ‡å‡†: å¯¹å¤–å‘å¸ƒå‰å®¡æ ¸

#### Task 85: å›é¡¾ä¼šè®®çºªè¦

- [âœ…] **æ–‡ä»¶**: `docs/postmortem/ai-master-retro.md`
- [âœ…] **å®ç°å†…å®¹**:

```md
# Retro

- æˆåŠŸä¹‹å¤„
- æ”¹è¿›äº‹é¡¹
```

- âœ… éªŒè¯æ ‡å‡†: å›¢é˜Ÿä¼šè®®ç¡®è®¤

---

## ğŸ“Š ä»»åŠ¡ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜å…ˆçº§              | ä»»åŠ¡èŒƒå›´         | è¯´æ˜                             |
| ------------------- | ---------------- | -------------------------------- |
| **P0 - æ ¸å¿ƒåŠŸèƒ½**   | Task 1-20, 45-60 | å½±å“æ ¸å¿ƒä½“éªŒï¼Œå¿…é¡»å®Œæˆ           |
| **P1 - é‡è¦åŠŸèƒ½**   | Task 21-44       | ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒï¼Œåº”å°½å¿«å®Œæˆ     |
| **P2 - å¢å¼ºåŠŸèƒ½**   | Task 61-72       | è´¨é‡ä¸æµ‹è¯•ä¿éšœï¼Œå¯å¹¶è¡Œæ¨è¿›       |
| **P3 - è¿ç»´ä¸æ–‡æ¡£** | Task 73-85       | è¿ç»´ã€å‘å¸ƒä¸çŸ¥è¯†æ²‰æ·€ï¼ŒæŒ‰è®¡åˆ’æ¨è¿› |

## ğŸ¯ å…³é”®é‡Œç¨‹ç¢‘

### Milestone 1: æ•°æ®å±‚å°±ç»ª (Week 2)

- [âœ…] Task 1-6å®Œæˆ: æ•°æ®åº“è¡¨ç»“æ„ + Redisé…ç½®
- [ ] **éªŒæ”¶æ ‡å‡†**: å¯ä»¥å­˜å‚¨å’Œè¯»å–å¯¹è¯çŠ¶æ€

### Milestone 2: AIå¼•æ“æ ¸å¿ƒ (Week 5)

- [ ] Task 7-20å®Œæˆ: ç±»å‹å®šä¹‰ + çŠ¶æ€æœº + ç­–ç•¥å¼•æ“ + è®°å¿†
- [ ] **éªŒæ”¶æ ‡å‡†**: å¯ä»¥å¤„ç†åŸºç¡€å¯¹è¯å¹¶ç”Ÿæˆå›å¤

### Milestone 3: å‰ç«¯ä½“éªŒ (Week 7)

- [ ] Task 21-44å®Œæˆ: UIç³»ç»Ÿ + å»ºè®®å¡ç‰‡ + å¤šæ¨¡æ€è¾“å…¥
- [ ] **éªŒæ”¶æ ‡å‡†**: ç”¨æˆ·å¯ä»¥ä¸AIè¿›è¡Œå®Œæ•´å¯¹è¯å¹¶æŸ¥çœ‹æ¨è

### Milestone 4: APIé›†æˆ (Week 8)

- [ ] Task 45-60å®Œæˆ: APIç«¯ç‚¹ + æˆæœ¬&ç›‘æ§ + Orchestratoræ•´åˆ
- [ ] **éªŒæ”¶æ ‡å‡†**: å‰åç«¯å®Œæ•´è”è°ƒæˆåŠŸ

### Milestone 5: æµ‹è¯•è´¨é‡ (Week 9)

- [ ] Task 61-72å®Œæˆ: æ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹ + è¦†ç›–ç‡æå‡
- [ ] **éªŒæ”¶æ ‡å‡†**: å…³é”®åŠŸèƒ½æµ‹è¯•é€šè¿‡

### Milestone 6: å‘å¸ƒä¸è¿ç»´ (Week 10)

- [ ] Task 73-85å®Œæˆ: éƒ¨ç½²ã€ç›‘æ§ã€æ–‡æ¡£äº¤ä»˜
- [ ] **éªŒæ”¶æ ‡å‡†**: å…·å¤‡å‘å¸ƒä¸Šçº¿æ¡ä»¶

## ğŸ“ˆ è¿›åº¦è¿½è¸ªè¡¨

| Week    | å·²å®Œæˆä»»åŠ¡ | å®Œæˆç™¾åˆ†æ¯” | å½“å‰é˜¶æ®µ | ä¸‹å‘¨é‡ç‚¹           |
| ------- | ---------- | ---------- | -------- | ------------------ |
| Week 1  | 0/85       | 0%         | å‡†å¤‡é˜¶æ®µ | æ•°æ®åº“è®¾è®¡         |
| Week 2  | 6/85       | 7%         | æ•°æ®å±‚   | AIå¼•æ“å¼€å‘         |
| Week 3  | 15/85      | 18%        | AIå¼•æ“   | çŠ¶æ€æœºä¸ç­–ç•¥       |
| Week 4  | 25/85      | 29%        | AIå¼•æ“   | ä¼šè¯è®°å¿†ä¸çŸ¥è¯†å›¾è°± |
| Week 5  | 35/85      | 41%        | å‰ç«¯     | UIç»„ä»¶å®Œå–„         |
| Week 6  | 45/85      | 53%        | å‰ç«¯     | APIå¯¹æ¥            |
| Week 7  | 55/85      | 65%        | APIé›†æˆ  | æµ‹è¯•ç¼–æ’           |
| Week 8  | 65/85      | 76%        | æµ‹è¯•     | è¿ç»´éƒ¨ç½²           |
| Week 9  | 75/85      | 88%        | éƒ¨ç½²     | æ–‡æ¡£äº¤ä»˜           |
| Week 10 | 85/85      | 100%       | å‘å¸ƒ     | ç›‘æ§ & å›é¡¾        |

---

**ğŸš€ ç«‹å³å¼€å§‹**: Codex ç°å·²æ ¹æ®æœ€æ–° PRD å’Œä»£ç æ¶æ„é‡æ–°è§„åˆ’ 85 é¡¹è¯¦ç»†ä»»åŠ¡ã€‚è¯·æŒ‰é˜¶æ®µé€é¡¹æ”»å…‹ï¼Œæ¯å®Œæˆä¸€ä¸ªä»»åŠ¡å°±æ‰“ âœ…ï¼Œç¡®ä¿ AI å…«å­—é£æ°´å¯¹è¯å¤§å¸ˆé¡ºåˆ©ä¸Šçº¿ï¼
