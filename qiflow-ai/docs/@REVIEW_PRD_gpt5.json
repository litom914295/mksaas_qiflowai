{
  "decision": "revise",
  "doc_scope": "PRD",
  "scorecard": [
    {"dimension": "value", "score": 4, "evidence": "1.3 核心价值主张：\"AI Orchestrator多模型编排，四通道罗盘融合精度±2°\"，\"快速交付\"与\"企业级服务\""},
    {"dimension": "fengshui_correctness", "score": 3, "evidence": "3.3.1/3.3.2 明确四通道（DeviceOrientation/WMM/SunCalc/地图对齐）与\"实时置信度评分/校准\"，但缺少计算公式与链路"},
    {"dimension": "rag_quality", "score": 2, "evidence": "3.2.2 仅列出\"向量化/语义搜索/动态更新\"，未定义数据源、清洗、引用展示与反幻觉"},
    {"dimension": "multi_tenant_billing", "score": 3, "evidence": "3.4 订阅计划与积分；3.1.1/3.1.2 有动作级\"检查积分/订阅\"，但未统一到所有入口（如 PDF 导出）"},
    {"dimension": "compliance_safety", "score": 3, "evidence": "7.1/7.3 列出 HTTPS/Better Auth/RLS/PCI DSS/不存储支付/Webhook 验证，但缺少 CSP/安全头/验证码细则"},
    {"dimension": "perf_cost", "score": 3, "evidence": "8.1 明确 LCP/INP/API/SLA；10.1 提到\"智能路由+缓存/索引优化+缓存\"，但无缓存与限流细则"},
    {"dimension": "i18n", "score": 3, "evidence": "1.3 \"快速支持6语言\"；6.2 给出 messages 结构，但四柱的非中文表现未明确"},
    {"dimension": "evaluation_plan", "score": 2, "evidence": "未见明确评测/验收标准针对 Orchestrator/RAG/罗盘精度，仅有 8.1 的通用 SLO"},
    {"dimension": "ux", "score": 4, "evidence": "5.1/5.2/5.3 给出设计原则、页面结构与组件规范，复用 MKSaaS UI 体系"},
    {"dimension": "growth_ops", "score": 3, "evidence": "2.2 转化漏斗与关键指标较完整；11 成功标准清晰，但缺少埋点与归因细则"}
  ],
  "issues": [
    {
      "id": "KEY-001",
      "title": "Orchestrator 缺少容错/回退/限流/毒性拦截",
      "severity": "blocker",
      "cross_doc": false,
      "evidence": "1.3 \"AI Orchestrator多模型编排\"；3.2.1 仅展示 retrieveFromVectorDB/streamText，无重试/回退/限流/毒性条款",
      "suggestion": "新增 3.5 小节：重试(2/4/8s)*3、fallback(gpt-4o→deepseek→gemini)、请求速率限制(用户与路由级)、输出安全拦截、统一错误码",
      "owner": "architect",
      "eta_days": 5
    },
    {
      "id": "KEY-002",
      "title": "罗盘缺少前后端链路/置信度公式与降级矩阵",
      "severity": "high",
      "cross_doc": false,
      "evidence": "3.3.1/3.3.2 仅列出数据源与\"实时置信度评分/iOS权限优雅降级\"，未定义服务端归一化与阈值",
      "suggestion": "新增 3.7：前端测量→服务端归一化→存储；置信度阈值(高≥0.85/中0.5–0.85/低<0.5)与异常标签；降级到手动输入",
      "owner": "frontend",
      "eta_days": 5
    },
    {
      "id": "KEY-003",
      "title": "RAG 缺少数据源/清洗/引用展示/反幻觉",
      "severity": "high",
      "cross_doc": false,
      "evidence": "3.2.2 仅列\"向量化/语义搜索/动态更新\"",
      "suggestion": "新增 3.8：数据源白名单、切片与去噪、阈值、引用卡片展示、低相关度降级",
      "owner": "data",
      "eta_days": 5
    },
    {
      "id": "KEY-004",
      "title": "计费与权限未统一到各入口（含 PDF 导出）",
      "severity": "high",
      "cross_doc": false,
      "evidence": "3.1.1/3.1.2 有动作级校验；3.4.2 \"PDF报告导出: 5积分\"未给入口守卫",
      "suggestion": "新增 3.6：统一守卫层（Better Auth + 订阅/积分 + Feature Flag）适配八字/玄空/AI对话/PDF导出",
      "owner": "backend",
      "eta_days": 3
    },
    {
      "id": "KEY-005",
      "title": "统一错误码/错误结构与观测维度缺失",
      "severity": "high",
      "cross_doc": false,
      "evidence": "1.4 仅列\"OpenPanel + Vercel Analytics\"，8.1 仅有 SLO，无错误码",
      "suggestion": "在 3.5 定义 {code,message,traceId}；在 8.3 增加观测字段(userId/route/modelProvider/costMs/tokens)",
      "owner": "backend",
      "eta_days": 3
    },
    {
      "id": "KEY-006",
      "title": "缺少限流/配额策略",
      "severity": "high",
      "cross_doc": false,
      "evidence": "1.4 有 next-safe-action，但未见限流/配额条款",
      "suggestion": "在 3.5/8.3 增加路由级/用户级 QPS 与突发桶，模型调用日配额",
      "owner": "architect",
      "eta_days": 3
    },
    {
      "id": "KEY-007",
      "title": "缓存与失效策略不完整",
      "severity": "medium",
      "cross_doc": false,
      "evidence": "8.1 有SLO；10.1 提\"智能路由+缓存/索引优化+缓存\"，未见规范",
      "suggestion": "在 8.3 加 revalidateTag、RAG TTL、AI结果持久化缓存与失效触发",
      "owner": "architect",
      "eta_days": 4
    },
    {
      "id": "KEY-008",
      "title": "PDF 导出缺少流水/审计/回滚",
      "severity": "medium",
      "cross_doc": false,
      "evidence": "3.4.2 仅列积分消耗",
      "suggestion": "在 3.6/8.3 要求导出计费/交易流水/失败回滚与CSP策略",
      "owner": "backend",
      "eta_days": 2
    },
    {
      "id": "KEY-009",
      "title": "i18n 下四柱展示未定义非中文形态",
      "severity": "medium",
      "cross_doc": false,
      "evidence": "1.3 \"快速支持6语言\"；6.2 messages 仅中文示例",
      "suggestion": "在 5.2/6.2 增加四柱横排/卡片式与单位/术语注释规范",
      "owner": "frontend",
      "eta_days": 3
    },
    {
      "id": "KEY-010",
      "title": "安全细则（CSP/Headers/Captcha）未成文",
      "severity": "medium",
      "cross_doc": false,
      "evidence": "7.1/7.3 为高层条目",
      "suggestion": "在 7.x 增加 CSP 白名单、Security Headers 矩阵、公共入口验证码与速率限制",
      "owner": "architect",
      "eta_days": 3
    }
  ],
  "quick_wins": [
    "新增统一错误结构与错误码；所有 Actions 输出 {code,message,traceId}",
    "补充 Orchestrator 回退顺序、重试与速率限制、毒性拦截",
    "罗盘链路追加：前端测量→服务端归一化→落库；失败则手动输入+低置信度",
    "RAG 增加引用展示与低相关度降级",
    "统一鉴权与计费守卫覆盖八字/玄空/AI对话/PDF导出"
  ],
  "open_questions": [
    "RAG 数据源与版权授权范围与更新周期？",
    "免费/Pro 在 AI 调用的日配额或Token上限？",
    "PDF 导出的范围与合规策略（是否加水印/只读链接）？",
    "非中文环境四柱默认横排？是否提供术语注释？"
  ],
  "prd_patch": "### 3.5 Orchestrator 容错与限流策略\n- 重试与退避：指数退避 2s/4s/8s，最大 3 次；可配置。\n- 回退顺序：gpt-4o → deepseek → gemini（按成本/时延/可用性动态切换）。\n- 速率限制：按用户与路由设定 QPS 与突发桶（默认 3 QPS / 10 burst，可配置）。\n- 输出安全：接入毒性/不当内容拦截，命中则回退到更保守提示词与模型。\n- 统一错误码：{ code, message, traceId }，code 枚举含 VALIDATION_ERROR / PERMISSION_DENIED / RATE_LIMITED / PROVIDER_ERROR / TIMEOUT。\n\n### 3.6 统一鉴权与计费守卫\n- 守卫构成：Better Auth + 订阅/积分校验 + Feature Flag。\n- 适用入口：八字分析 / 玄空分析 / AI 对话 / PDF 导出。\n- 失败回滚：计费失败需回滚积分扣减；对外提示安全文案。\n\n### 3.7 罗盘前后端链路与降级\n- 链路：前端（DeviceOrientation/WMM/SunCalc/地图对齐）→ 服务端归一化与打点 → 存储（角度/置信度/环境标签）。\n- 置信度：依据数据一致性、噪声与校准覆盖度计算，阈值：高≥0.85；中 0.5–0.85；低＜0.5。\n- 降级：权限拒绝或干扰过大时，提供“手动输入角度 + 低置信度提示 + 校准引导”。\n\n### 3.8 RAG 引用与反幻觉\n- 数据源：列出白名单来源并记录版本与更新时间；分片策略与去噪流程说明。\n- 引用展示：对生成答案附“引用卡片（标题/链接/片段）”；低相关度或无结果时给出“未检索到充分依据”的降级回答。\n- 检索阈值：默认相似度阈值 0.75（可按任务调整）。\n\n### 8.3 性能与成本控制\n- SLO：LCP < 2s、INP < 100ms、API p95 < 500ms；AI 调用超时 15s。\n- 缓存：Next.js fetch + revalidateTag（对实体与分析结果设定标签）；RAG 检索结果 TTL 10 分钟；AI 结果持久化缓存 24 小时（可失效）。\n- 成本：为免费/Pro 设定日配额与月度上限；达阈值触发限流与温和降级提示。",
  "tech_patch": "",
  "task_patch": ""
}