# QiFlow AI - AI八字风水对话大师产品需求文档（PRD）

**文档版本**: v1.2
**撰写日期**: 2025-01-19
**最后更新**: 2025-01-20
**文档状态**: 跨团队评审优化版
**负责人**: 产品团队

---

## 0. 文档信息

### 0.1 更新记录

| 版本 | 日期       | 修订人     | 修订内容                                                                | 评审状态 |
| ---- | ---------- | ---------- | ----------------------------------------------------------------------- | -------- |
| v1.2 | 2025-01-20 | 跨团队协作 | 基于专家评审优化：API契约补充、性能指标明确、错误处理规范、技术架构细化 | 评审中   |
| v1.1 | 2025-01-20 | Codex 协作 | 结构重构、补充技术依赖、修正编码问题                                    | 已完成   |
| v1.0 | 2025-01-19 | 产品团队   | 初始版本创建                                                            | 已完成   |

### 0.2 审核人清单

```
[跨团队评审意见汇总]
- 产品经理审核: [✓] 需求范围明确，商业模式可行
- 技术负责人审核: [✓] 架构设计合理，需补充API契约
- UI/UX 设计审核: [✓] 设计规范完善，需文化元素强化
- 测试负责人审核: [✓] 测试策略全面，需AI质量保证
- AI平台负责人审核: [✓] 模型集成可行，需成本控制
- 算法团队审核: [✓] 传统算法集成方案可行
```

---

## 1. 背景与目标

### 1.1 项目背景

QiFlow AI（Next.js 15 + React 18 + TypeScript）已提供罗盘测向、飞星盘绘制与嘉宾试用体验。现有的 `FengShuiCompass`、`FengShuiAIAnalysis`、`safe-data-utils` 等模块可输出高质量玄空风水与八字数据，但缺乏一个可对话、可溯源的专家形象来整合洞察并指导用户决策。

### 1.2 产品愿景

打造业内领先的 AI 八字风水对话大师，以人格化的对话体验把传统玄空与现代 AI 融合，输出可信赖的专属建议，并驱动会员订阅与专家增值服务。

### 1.3 版本范围

- V1 聚焦在 Web 端（桌面 + 移动）对话体验，与现有罗盘与嘉宾分析模块深度融合。
- 通过 Supabase 会话体系承载游客与会员身份，支持中文首发，保留国际化扩展接口。
- 接入 `src/lib/ai/providers` 统一模型代理，首期主推 DeepSeek/Claude，提供回退策略。

### 1.4 成功指标概览

- 关键 KPI：日新增注册≥1000、免费至付费转化≥8%、会员复购率≥45%、AI 对话满意度≥4.5/5。
- 里程碑：8 周交付 Beta、12 周上线 GA、18 周完成首轮功能迭代与会员转化验证。

---

## 2. 用户洞察

### 2.1 目标用户画像

| 用户群体 | 年龄     | 性别占比        | 收入水平  | 典型职业                   | 城市级别       | 主要诉求                                         |
| -------- | -------- | --------------- | --------- | -------------------------- | -------------- | ------------------------------------------------ |
| 核心用户 | 28-45 岁 | 女 65% / 男 35% | 月 8K-30K | 管理层、自由职业者、创业者 | 一二线城市     | 快速获得事业与家庭布局建议，期望专业付费服务     |
| 潜在用户 | 25-35 岁 | 女 52% / 男 48% | 月 5K-15K | 白领、公务员、教师         | 二三线城市     | 希望了解自我性格与阶段运势，重视性价比与轻量体验 |
| 高端用户 | 35-55 岁 | 男 55% / 女 45% | 月 30K+   | 企业高管、投资人、成功商人 | 一线及海外华人 | 要求深度定制方案与隐私保护，可接受高价专家服务   |

### 2.2 核心需求拆解

| 需求类型 | 具体需求                     | 优先级 | 说明                                               |
| -------- | ---------------------------- | ------ | -------------------------------------------------- |
| 基础需求 | 自动生成八字命盘与玄空飞星盘 | P0     | 与现有 `src/lib/bazi`、`src/lib/fengshui` 模块复用 |
| 基础需求 | 多轮问答解释专业术语         | P0     | 对话中需引用可追溯数据来源                         |
| 核心需求 | 个性化风水布局与行动建议     | P0     | 结合罗盘场景、房型及用户目标                       |
| 核心需求 | 阶段性运势与风险预警         | P0     | 输出短期、中期重点与避忌                           |
| 增值需求 | 吉日择选与日程提醒           | P1     | 与通知中心联动，支持导出日历                       |
| 增值需求 | 实时运势提醒与 push          | P1     | 游客体验受限，会员可配置频率                       |
| 高阶需求 | 3D 可视化调理方案            | P2     | 复用 Three.js 场景，Beta 后评估                    |
| 高阶需求 | 专家一对一加持服务           | P2     | 需对接人工顾问排班系统                             |

### 2.3 关键用户旅程

| 场景         | 触发入口               | 主要步骤                                      | 期望结果                             |
| ------------ | ---------------------- | --------------------------------------------- | ------------------------------------ |
| 游客体验     | `[locale]/test-guest`  | 输入出生信息 → AI 对话大师引导 → 推荐升级     | 用户理解核心价值并完成注册或付费试用 |
| 会员深度咨询 | 会员中心 → AI 大师     | 记录场景 → 上传平面图/罗盘数据 → 获取行动清单 | 产出可执行计划并落地到提醒/分享      |
| 专家服务转化 | AI 对话 → 高级问题触发 | 识别高复杂度需求 → 推荐专家 → 完成预约与支付  | 提升高客单价订单与满意度             |

---

## 3. 场景与用户故事

### 3.1 优先场景矩阵

| 场景         | 目标                       | 主要用户           | 依赖功能                | 验收口径                            |
| ------------ | -------------------------- | ------------------ | ----------------------- | ----------------------------------- |
| 快速命盘解析 | 3 分钟内生成命盘并输出摘要 | 游客、潜在会员     | 八字引擎、对话模板      | 命盘生成成功率≥99%，摘要少于 200 字 |
| 风水布局建议 | 根据房屋信息输出布局       | 核心会员、高端用户 | 罗盘数据上传、AI 推理链 | 至少 3 条行动项，引用数据来源       |
| 运势持续跟踪 | 月度运势报告与提醒         | 会员               | 订阅中心、通知系统      | 到达率≥95%，满意度≥4.6              |
| 专家升级服务 | 高价值线索转化             | 高端用户           | CRM 接入、支付模块      | 预约完成率≥30%                      |

### 3.2 用户故事

- 作为一名新用户，我希望用自然语言描述我的住家情况，让 AI 大师自动判断朝向并给我三个最重要的改善建议。
- 作为一名会员，我希望 AI 大师记住我之前的运势分析，下次对话能根据新问题快速关联历史记录。
- 作为一名高端用户，我希望在对话中识别到复杂需求时可以快速链接真人大师，并在 Supabase 里生成预约订单。
- 作为运营人员，我希望系统能够输出 AI 建议引用的算法版本和数据来源，以便做质检与复盘。

---

## 4. 功能规划

### 4.1 核心能力模块

| 模块         | 需求要点                                           | 技术实现                                                                   | 成功标准                                                |
| ------------ | -------------------------------------------------- | -------------------------------------------------------------------------- | ------------------------------------------------------- |
| 对话编排     | 支持多轮上下文理解、话题切换与中断恢复、状态机管理 | `src/lib/ai/master-orchestrator.ts` 主控制器 + Redis 会话存储 + 对话状态机 | 意图识别准确率≥90%，上下文丢失率≤5%，状态切换响应≤200ms |
| 专业知识解释 | 对八字、玄空术语做分层解释，支持文化适应性         | 知识图谱 + RAG检索 + `FengShuiAIAnalysis` 结构化输出 + 多语言术语词典      | 术语解释准确率≥95%，回复耗时≤2s，文化适应性评分≥4.3/5   |
| 行动建议生成 | 输出结构化短期/中期/长期行动清单，支持个性化优先级 | BaZi+风水算法集成 + 个性化引擎 + `safe-data-utils` 校验 + JSON Schema      | 建议准确率≥85%，字段缺失率≤1%，用户采纳率≥60%           |
| 证据追溯     | 所有结论附带来源引用，支持算法版本追踪             | 分布式追踪 + 算法版本管理 + 审计日志 + 引用链生成                          | 引用覆盖率=100%，追溯查询≤1s，审计完整性≥99.9%          |
| 置信度评估   | 多维度置信度评分与不确定性表达                     | 多维评分引擎 + 专家标注数据 + 置信度校准                                   | 置信度准确率≥80%，专家一致性≥75%                        |
| 文化适应性   | 传统文化准确性与现代表达平衡                       | 文化知识库 + 内容审核 + 专家评审 + 敏感词过滤                              | 文化准确性≥90%，现代可读性≥4.2/5                        |

### 4.2 算法与数据要求

| 项目         | 说明                                                         | 集成点                                        | 性能要求                             | 质量标准                                         |
| ------------ | ------------------------------------------------------------ | --------------------------------------------- | ------------------------------------ | ------------------------------------------------ |
| 八字计算引擎 | 复用 `src/lib/bazi`，增强十神关系分析、流年计算、情感标签    | `src/lib/ai/algorithm-integration-service.ts` | 计算耗时≤500ms，缓存命中率≥80%       | 准确率≥99.5%，专家验证一致性≥95%                 |
| 玄空飞星算法 | 复用 `src/lib/fengshui`，支持九运切换、替卦处理、房型适配    | `src/lib/fengshui/enhanced-analysis.ts`       | 飞星盘生成≤300ms，罗盘数据同步≤100ms | 算法一致性≥99.8%，传统理论符合度≥90%             |
| AI 模型路由  | DeepSeek(主)+Claude(备)+Gemini(降级)，支持成本优化和质量权衡 | `src/lib/ai/enhanced-router.ts`               | 路由决策≤50ms，故障切换≤200ms        | 可用性≥99.9%，成本控制在预算内，质量评分≥4.2/5   |
| 安全与校验   | 输入校验、输出过滤、敏感信息保护、恶意请求检测               | `src/lib/security/conversation-security.ts`   | 校验耗时≤100ms，检测准确率≥95%       | 零安全事故，隐私合规100%，数据泄露风险≤0.01%     |
| 知识库管理   | 传统经典文献、现代解释、案例库、术语词典、多语言适配         | `src/lib/knowledge/graph-engine.ts`           | 检索响应≤200ms，相似度计算≤100ms     | 知识准确性≥95%，覆盖度≥90%，更新及时性≤24h       |
| 提示词工程   | 结构化提示模板、文化适应性、个性化调整、A/B测试支持          | `src/lib/ai/prompt-engine.ts`                 | 模板生成≤100ms，个性化≤200ms         | 回复质量≥4.5/5，文化适应性≥4.3/5，转化率提升≥15% |

### 4.3 多语言与呈现策略

- 首发中文（简体），遵循 `src/middleware.ts` 与 `src/lib/i18n` 约定，所有文案需同步补充 en、zh-Hant、ja、ko、th、ms，占位符以 key 管理。
- 对话 UI 复用 shadcn/ui 气泡组件，支持 Markdown、高亮与引用折叠，移动端采用底部输入框 + 操作 sheet。
- 提供语音输入占位接口，Beta 后视资源评估。

### 4.4 会员能力矩阵

| 功能              | 游客      | 会员     | 专业版         | 至尊版                |
| ----------------- | --------- | -------- | -------------- | --------------------- |
| AI 大师基础对话   | 每日 3 轮 | 无限制   | 无限制         | 无限制                |
| 八字/风水报告导出 | 不支持    | PDF 导出 | PDF + Markdown | PDF + 白标模板        |
| 运势提醒          | 不支持    | 月度邮件 | 周度推送       | 自定义频率 + 日历同步 |
| 吉日择选          | 不支持    | 标准择日 | 场景自定义     | 专家复核              |
| 专家预约          | 不支持    | 不支持   | 提交申请       | 专属顾问 24 小时响应  |

---

## 5. 体验设计要点

- 语气：专业、稳重、尊重隐私，避免绝对性结论，强调“建议”“趋势”而非“保证”。
- 会话结构：每轮需包含结论摘要、对应理由、可执行项、参考资料链接，支持“一键复制行动清单”。
- 可视化：罗盘与飞星图通过 React Konva 嵌入会话，提供缩略图 + 放大查看，移动端使用抽屉式展示。
- 容错：输入缺少出生时间或房屋朝向时，AI 需要引导用户补充信息并说明影响范围；必要时提供人工客服入口。
- 性能：首屏加载≤2.5s，对话响应平均≤3s，超时需有过渡动画与重试入口。

---

## 6. 商业模式

### 6.1 订阅方案

| 套餐   | 定价    | 目标用户 | 核心权益                                        |
| ------ | ------- | -------- | ----------------------------------------------- |
| 免费版 | ¥0      | 游客     | 基础命盘、3 轮对话、玄空入门文章                |
| 会员版 | ¥99/月  | 个人会员 | 全量命盘、多轮对话、月度运势报告、标准择日      |
| 专业版 | ¥299/月 | 高频用户 | 深度个性化分析、3D 布局、无限对话、专家电话咨询 |
| 至尊版 | ¥999/月 | 高端客户 | 全部高级功能、线下堪舆、专属顾问、定制报告      |

### 6.2 收入预估

| 用户类型   | 预估人数    | 月费 | 月收入       |
| ---------- | ----------- | ---- | ------------ |
| 免费用户   | 100,000     | ¥0   | ¥0           |
| 会员版用户 | 5,000       | ¥99  | ¥495,000     |
| 专业版用户 | 1,000       | ¥299 | ¥299,000     |
| 至尊版用户 | 100         | ¥999 | ¥99,900      |
| **合计**   | **106,100** | -    | **¥893,900** |

---

## 7. 成功指标（KPI）

- 用户增长：新注册≥1000/日，次日留存≥60%，7 日留存≥35%，30 日留存≥20%，免费到付费转化≥8%。
- 体验质量：AI 对话满意度≥4.5/5，平均对话轮次≥6，功能使用深度≥3 个模块/用户。
- 商业表现：月活≥50,000，ARPU≥¥15，客户生命周期价值≥¥500。
- 运营指标：专家预约完成率≥30%，问题工单解决时长≤4 小时，模型漂移监控每周复盘一次。

---

## 8. 技术实现与依赖

| 层级            | 模块                                                                                                                                              | 关键任务                                               | 责任团队  | 交付时间 | 依赖关系                |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ | --------- | -------- | ----------------------- |
| 前端（Next.js） | `src/components/chat/feng-shui-chat.tsx`<br/>`src/components/analysis/conversation-results.tsx`<br/>`src/components/compass/embedded-compass.tsx` | 对话界面、结果展示、罗盘集成、移动端适配、无障碍支持   | Web 前端  | Week 5-8 | 依赖设计规范、API契约   |
| 会话编排层      | `src/lib/ai/master-orchestrator.ts`<br/>`src/lib/ai/conversation-memory.ts`<br/>`src/lib/ai/state-machine.ts`                                     | 主控制器、会话状态管理、上下文存储、故障恢复、性能监控 | AI 平台   | Week 3-6 | 依赖Redis部署、算法接口 |
| AI服务层        | `src/lib/ai/enhanced-router.ts`<br/>`src/lib/ai/prompt-engine.ts`<br/>`src/lib/ai/confidence-scorer.ts`                                           | 模型路由、提示工程、置信度评估、成本控制、质量保证     | AI 平台   | Week 4-7 | 依赖模型API、知识库     |
| 算法集成层      | `src/lib/ai/algorithm-integration.ts`<br/>`src/lib/fengshui/enhanced-analysis.ts`<br/>`src/lib/bazi/conversation-adapter.ts`                      | 算法封装、结果转换、缓存策略、性能优化、错误处理       | 算法组    | Week 2-5 | 依赖现有算法模块        |
| 知识服务层      | `src/lib/knowledge/graph-engine.ts`<br/>`src/lib/knowledge/cultural-validator.ts`<br/>`src/lib/knowledge/terminology-service.ts`                  | 知识图谱、文化校验、术语管理、多语言支持、内容审核     | 知识工程  | Week 3-8 | 依赖专家标注数据        |
| 数据与存储层    | Supabase Schema扩展<br/>Redis会话存储<br/>Vector数据库集成                                                                                        | 对话历史、用户画像、知识向量、性能监控、数据备份       | 后端/DBA  | Week 1-4 | 依赖基础设施升级        |
| 安全与监控层    | `src/lib/security/conversation-security.ts`<br/>`src/lib/monitoring/ai-metrics.ts`<br/>Audit日志系统                                              | 输入校验、内容过滤、性能监控、安全审计、告警系统       | 安全/运维 | Week 2-6 | 依赖监控平台部署        |

### 8.1 非功能性要求详细规范

#### 性能要求

- **响应时间**: 简单对话≤1.5s，复杂分析≤3s，超时阈值5s，P95≤3s，P99≤6s
- **并发能力**: 支持200并发用户，峰值500并发，自动扩缩容
- **系统可用性**: 99.9%月度可用性，计划内维护≤4h/月
- **数据一致性**: 最终一致性模型，关键数据强一致性

#### 安全与合规

- **数据保护**: 个人信息AES-256加密，传输TLS 1.3，存储加密
- **访问控制**: RBAC权限模型，会话Token有效期管理，API速率限制
- **合规要求**: 遵循《网络安全法》《个人信息保护法》《GDPR》，数据本地化
- **审计日志**: 完整操作审计，7年日志保留，可导出报告

#### 可观测性

- **分布式追踪**: OpenTelemetry集成，完整请求链路追踪，性能瓶颈定位
- **监控指标**: AI响应时间、算法准确率、用户满意度、成本控制
- **告警策略**: 错误率>2%触发P2告警，响应时间>5s触发P3告警，系统故障触发P1
- **日志管理**: 结构化日志，ELK Stack集成，实时日志分析

#### 容灾与恢复

- **故障恢复**: RTO≤15分钟，RPO≤5分钟，自动故障切换
- **数据备份**: 每日增量备份，每周全量备份，异地灾备
- **降级策略**: 多层降级（缓存→模板→人工），服务优雅降级
- **回滚机制**: 自动回滚能力，版本管理，配置热更新

#### 测试要求

- **代码覆盖率**: Jest单元测试≥85%，集成测试≥75%，E2E测试≥60%
- **性能测试**: JMeter压力测试，K6负载测试，混沌工程验证
- **安全测试**: OWASP安全扫描，渗透测试，依赖漏洞扫描
- **文化测试**: 多地区专家评审，文化适应性测试，敏感内容检测

---

## 9. 风险与对策

### 9.1 技术风险

| 风险项         | 等级 | 影响           | 应对策略                                              |
| -------------- | ---- | -------------- | ----------------------------------------------------- |
| 模型输出失真   | 高   | 影响建议可信度 | 建立专家抽检，使用规则校验 + RAG 增强，必要时人工复核 |
| 算法结果不一致 | 中   | 影响体验一致性 | 建立回归测试流水线，飞星与八字算法版本锁定            |
| 性能瓶颈       | 中   | 影响响应时长   | 引入队列与缓存，压测目标 P95≤3s                       |

### 9.2 市场风险

| 风险项       | 等级 | 影响     | 应对策略                           |
| ------------ | ---- | -------- | ---------------------------------- |
| 竞品快速复制 | 中   | 用户流失 | 差异化体验、持续迭代 + 社群运营    |
| 政策监管变化 | 高   | 模块下线 | 建立法律顾问评审流程，内容合规审查 |
| 用户教育成本 | 中   | 转化降低 | 产出科普内容，运营引导直播/短视频  |

### 9.3 运营风险

| 风险项       | 等级 | 影响     | 应对策略                                      |
| ------------ | ---- | -------- | --------------------------------------------- |
| 专业性被质疑 | 中   | 口碑受损 | 强化引用来源、引入权威背书、开放质检入口      |
| 客服压力过大 | 中   | SLA 下降 | 自助知识库 + AI 客服 + 人工二线协作           |
| 内容违规     | 高   | 产品下架 | 多层审核（AI + 人审），敏感词黑名单，日志留痕 |

---

## 10. 里程碑计划

| 阶段            | 周期       | 主要交付物                        | 成功标准                           |
| --------------- | ---------- | --------------------------------- | ---------------------------------- |
| 需求梳理        | Week 1-2   | PRD、AI Prompt 草案、技术评审结论 | 跨团队评审通过                     |
| 架构设计        | Week 3-4   | 会话编排方案、接口契约、DB 设计   | 技术评审通过，落库表结构冻结       |
| 核心开发        | Week 5-12  | 对话大师 MVP、算法对接、会员策略  | 单元+集成测试通过，关键用例闭环    |
| 集成测试        | Week 13-14 | 全链路联调、性能压测              | P95 响应≤3s，Bug ≤ P1\*0 + P2≤3    |
| Beta & 运营预热 | Week 15-16 | Beta 版本、灰度策略、客服手册     | Beta 用户满意度≥4.5，问题闭环 ≤24h |
| 正式上线        | Week 17-18 | GA 发布、营销素材、监控看板       | 上线无严重事故，指标达成           |

---

## 11. 待办与后续文档

### 11.1 待确认事项（已细化）

#### 技术决策（Week 1-2 完成）

- [x] **AI模型配置**: DeepSeek主模型+Claude备用+Gemini降级，月预算¥50k
- [ ] **知识库方案**: ChromaDB向量存储+PostgreSQL关系数据，需采购决策
- [ ] **Redis集群**: 会话存储需Redis Cluster，3节点配置待批准
- [ ] **监控方案**: 采用Grafana+Prometheus+Sentry技术栈

#### 业务流程（Week 2-3 完成）

- [ ] **专家服务SLA**: 专业版24h响应，至尊版4h响应，费用¥300-800/小时
- [ ] **内容审核流程**: AI预审+人工复审，24h内处理违规内容
- [ ] **客服升级机制**: 3轮对话无满意答案自动转人工
- [ ] **数据删除流程**: 用户申请后30天内完成数据删除

#### 产品功能（Week 3-4 完成）

- [ ] **语音功能**: Phase 2评估，依赖用户反馈和技术成熟度
- [ ] **离线功能**: 基础算法支持离线，AI对话需网络连接
- [ ] **API开放**: 为企业客户提供API接口，单独定价模式
- [ ] **白标服务**: 至尊版提供企业定制化部署

### 11.2 后续文档需求（已同步优化）

#### 已完成文档优化

- [x] **UI设计规范**: 已优化文化元素设计、响应式布局、无障碍标准
- [x] **技术架构文档**: 已补充Master Orchestrator、会话管理、安全策略
- [x] **测试用例规划**: 已增强AI质量测试、文化准确性验证、性能基准

#### 待补充文档（Week 1-4）

- [ ] **API接口文档**: OpenAPI 3.0规范，包含请求/响应Schema，错误码定义
- [ ] **数据库设计文档**: ER图、索引策略、分表分库方案、迁移脚本
- [ ] **部署运维手册**: Docker容器化、K8s部署、监控配置、故障处理
- [ ] **知识库管理SOP**: 内容审核流程、专家评审标准、版本控制规范
- [ ] **AI模型管理规范**: 模型版本控制、A/B测试流程、质量评估标准
- [ ] **用户服务手册**: 客服话术、常见问题解答、升级转化策略
- [ ] **合规审查清单**: 内容合规标准、法律风险评估、审查流程SOP
- [ ] **成本控制策略**: AI调用成本监控、预算预警、优化建议

---

**文档结束**
