# Phase 2 - TypeScript é”™è¯¯ä¿®å¤è¿›åº¦æŠ¥å‘Š

**æ—¥æœŸ**: 2025-01-24  
**ä»»åŠ¡**: ä¿®å¤ TypeScript ç±»å‹é”™è¯¯  
**çŠ¶æ€**: ğŸ”„ éƒ¨åˆ†å®Œæˆï¼ˆåˆå§‹æ¸…ç†ï¼‰

---

## ğŸ“Š ä¿®å¤æˆæœ

### é”™è¯¯æ•°é‡å˜åŒ–

```
åˆå§‹çŠ¶æ€: 224 ä¸ª TypeScript é”™è¯¯
    â†“
ä¿®å¤ Actions å¯¼å…¥: ~150 ä¸ªé”™è¯¯ (-74, -33%)
    â†“
å‰©ä½™é”™è¯¯: ä¸»è¦æ˜¯ db ç±»å‹é—®é¢˜
```

### ä¿®å¤ç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| ä¿®å¤çš„æ–‡ä»¶ | 8 ä¸ª |
| ä¿®å¤çš„é”™è¯¯ç±»å‹ | 4 ç±» |
| å‡å°‘çš„é”™è¯¯ | ~74 ä¸ª |
| ä»£ç è¡Œå˜æ›´ | ~50 è¡Œ |

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. getDb() è°ƒç”¨é”™è¯¯ï¼ˆæœ€å¤šï¼‰

**é—®é¢˜**: ä»£ç ä¸­è°ƒç”¨ `getDb()` ä½†å¯¼å…¥çš„æ˜¯ `db`

**å½±å“æ–‡ä»¶**:
- `src/actions/chat/create-chat-session.ts`
- `src/actions/chat/end-chat-session.ts`
- `src/actions/chat/get-chat-session-status.ts`
- `src/actions/chat/renew-chat-session.ts`
- `src/actions/qiflow/claim-ab-test-reward.ts`
- `src/actions/qiflow/purchase-report-with-credits.ts`
- `src/actions/qiflow/generate-monthly-fortune.ts` (4 å¤„)

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¿®å¤å‰
import { getDb } from '@/db';
const db = await getDb();

// ä¿®å¤å
import { db } from '@/db';
// ç›´æ¥ä½¿ç”¨ db
```

**ä¿®å¤æ•°é‡**: ~10 å¤„

### 2. getSession() å¯¼å…¥é”™è¯¯

**é—®é¢˜**: å¯¼å…¥äº† `auth` ä½†è°ƒç”¨ `getSession()`

**å½±å“æ–‡ä»¶**:
- `src/actions/qiflow/claim-ab-test-reward.ts`
- `src/actions/qiflow/purchase-report-with-credits.ts`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¿®å¤å‰
import { auth } from '@/lib/auth';
const session = await getSession();

// ä¿®å¤å
import { getSession } from '@/lib/auth/session';
const session = await getSession();
```

**ä¿®å¤æ•°é‡**: 2 å¤„

### 3. Schema å¯¼å…¥é”™è¯¯

**é—®é¢˜**: å¯¼å…¥ `users` ä½†ä»£ç ä½¿ç”¨ `user`

**å½±å“æ–‡ä»¶**:
- `src/actions/qiflow/claim-ab-test-reward.ts`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¿®å¤å‰
import { creditTransaction, users } from '@/db/schema';
// ä½¿ç”¨ user

// ä¿®å¤å
import { creditTransaction, user } from '@/db/schema';
```

**ä¿®å¤æ•°é‡**: 1 å¤„

### 4. ç¼ºå¤± sql å¯¼å…¥

**é—®é¢˜**: ä½¿ç”¨ `sql` æ¨¡æ¿ä½†æœªå¯¼å…¥

**å½±å“æ–‡ä»¶**:
- `src/actions/qiflow/claim-ab-test-reward.ts`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¿®å¤å‰
import { eq } from 'drizzle-orm';

// ä¿®å¤å
import { eq, sql } from 'drizzle-orm';
```

**ä¿®å¤æ•°é‡**: 1 å¤„

### 5. é‡å¤ç±»å‹å¯¼å‡º

**é—®é¢˜**: ç±»å‹å·²åœ¨å®šä¹‰æ—¶å¯¼å‡ºï¼Œåˆåœ¨æ–‡ä»¶æœ«å°¾é‡å¤å¯¼å‡º

**å½±å“æ–‡ä»¶**:
- `src/actions/qiflow/generate-monthly-fortune.ts`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¿®å¤å‰
export interface GenerateMonthlyFortuneInput { ... }
export interface GenerateMonthlyFortuneResult { ... }
// ...
export type { GenerateMonthlyFortuneInput, GenerateMonthlyFortuneResult }; // âŒ é‡å¤

// ä¿®å¤å
export interface GenerateMonthlyFortuneInput { ... }
export interface GenerateMonthlyFortuneResult { ... }
// åˆ é™¤é‡å¤çš„å¯¼å‡ºè¯­å¥
```

**ä¿®å¤æ•°é‡**: 1 å¤„

### 6. JSX è¯­æ³•é”™è¯¯

**é—®é¢˜**: `<` ç¬¦å·åœ¨ JSX ä¸­è¢«è§£æä¸ºæ ‡ç­¾å¼€å§‹

**å½±å“æ–‡ä»¶**:
- `src/components/report/charts/HeatmapChart.tsx`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä¿®å¤å‰
<span>è¡°ä½ï¼ˆ<25ï¼‰</span> // âŒ è¯­æ³•é”™è¯¯

// ä¿®å¤å
<span>è¡°ä½ï¼ˆ{'<'}25ï¼‰</span> // âœ… æ­£ç¡®
```

**ä¿®å¤æ•°é‡**: 1 å¤„

---

## â³ å‰©ä½™é—®é¢˜

### ä¸»è¦é—®é¢˜ç±»åˆ«

1. **db ç±»å‹é—®é¢˜**ï¼ˆ~50 ä¸ªé”™è¯¯ï¼‰
   - `db` å¯¼å…¥è¿”å›çš„æ˜¯åŒ…è£…å¯¹è±¡è€Œä¸æ˜¯æ•°æ®åº“å®ä¾‹
   - éœ€è¦ä¿®å¤ `src/db/index.ts` çš„å¯¼å‡ºæ–¹å¼
   - æˆ–è€…ç»Ÿä¸€ä½¿ç”¨ `getDb()` å‡½æ•°å¹¶ç­‰å¾…

2. **Next.js ç”Ÿæˆçš„ç±»å‹é”™è¯¯**ï¼ˆ~30 ä¸ªé”™è¯¯ï¼‰
   - `.next/types/` ä¸‹çš„è‡ªåŠ¨ç”Ÿæˆæ–‡ä»¶
   - PageProps ç±»å‹ä¸åŒ¹é…
   - API RouteContext ç±»å‹ä¸åŒ¹é…
   - é€šå¸¸æ— éœ€æ‰‹åŠ¨ä¿®å¤ï¼Œé‡æ–°æ„å»ºå³å¯

3. **Schema å¯¼å…¥é”™è¯¯**ï¼ˆ~10 ä¸ªé”™è¯¯ï¼‰
   - `users` vs `user`
   - `auditLog` vs `auditLogs`
   - `analysis` ä¸å­˜åœ¨

4. **å…¶ä»–æ¨¡å—é”™è¯¯**ï¼ˆ~60 ä¸ªé”™è¯¯ï¼‰
   - ç¼ºå°‘çš„ä¾èµ–åŒ…å¯¼å‡º
   - ç±»å‹å®šä¹‰ä¸åŒ¹é…
   - å±æ€§è®¿é—®é”™è¯¯

---

## ğŸ“‹ è¯¦ç»†é”™è¯¯åˆ†ç±»

### æŒ‰æ–‡ä»¶åˆ†ç±»

| æ–‡ä»¶/ç›®å½• | é”™è¯¯æ•° | ä¸»è¦é—®é¢˜ |
|-----------|--------|----------|
| `.next/types/` | ~30 | è‡ªåŠ¨ç”Ÿæˆç±»å‹é”™è¯¯ |
| `src/actions/` | ~5 | db ç±»å‹é—®é¢˜ï¼ˆå·²ä¿®å¤å¯¼å…¥ï¼‰ |
| `src/app/api/` | ~30 | db ç±»å‹ã€Schema å¯¼å…¥ |
| `src/lib/` | ~40 | å„ç§ç±»å‹é—®é¢˜ |
| `src/components/` | ~20 | ç±»å‹å®šä¹‰ä¸åŒ¹é… |
| `src/cron/` | ~10 | db å’Œ Schema é—®é¢˜ |
| **æ€»è®¡** | **~150** | - |

### æŒ‰é”™è¯¯ç±»å‹åˆ†ç±»

| é”™è¯¯ç±»å‹ | æ•°é‡ | ä¼˜å…ˆçº§ |
|----------|------|--------|
| db ç±»å‹é—®é¢˜ | ~50 | ğŸ”´ é«˜ |
| Next.js ç”Ÿæˆé”™è¯¯ | ~30 | ğŸŸ¡ ä½ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰ |
| Schema å¯¼å…¥é”™è¯¯ | ~15 | ğŸ”´ é«˜ |
| éšå¼ any ç±»å‹ | ~20 | ğŸŸ  ä¸­ |
| å±æ€§ä¸å­˜åœ¨ | ~20 | ğŸŸ  ä¸­ |
| å…¶ä»– | ~15 | ğŸŸ¢ ä½ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³ä¼˜å…ˆçº§

1. **ä¿®å¤ db å¯¼å‡ºé—®é¢˜**ï¼ˆæœ€é‡è¦ï¼‰
   ```bash
   # æ£€æŸ¥ src/db/index.ts
   # ç¡®ä¿æ­£ç¡®å¯¼å‡ºæ•°æ®åº“å®ä¾‹
   ```

2. **æ‰¹é‡ä¿®å¤ Schema å¯¼å…¥**
   - `users` â†’ `user`
   - `auditLog` â†’ `auditLogs`
   - åˆ é™¤ `analysis` å¯¼å…¥

3. **æ¸…ç† Next.js æ„å»º**
   ```bash
   rm -rf .next
   npm run build
   ```

### ä¸­æœŸä¼˜å…ˆçº§

4. **ä¿®å¤éšå¼ any ç±»å‹**
   - æ·»åŠ æ˜ç¡®çš„ç±»å‹æ³¨è§£
   - ä½¿ç”¨ TypeScript strict æ¨¡å¼

5. **ä¿®å¤å±æ€§è®¿é—®é”™è¯¯**
   - æ£€æŸ¥ç±»å‹å®šä¹‰
   - æ·»åŠ å¯é€‰é“¾æ“ä½œç¬¦

---

## ğŸ“ ä¿®å¤å»ºè®®

### æ¨èä¿®å¤é¡ºåº

1. **Week 1 Day 1**: db å¯¼å‡ºé—®é¢˜ï¼ˆæ ¸å¿ƒï¼‰
2. **Week 1 Day 2**: Schema å¯¼å…¥æ‰¹é‡ä¿®å¤
3. **Week 1 Day 3**: éšå¼ any ç±»å‹ä¿®å¤
4. **Week 2**: å‰©ä½™é”™è¯¯é€ä¸ªä¿®å¤

### ä¿®å¤ç­–ç•¥

**æ‰¹é‡ä¿®å¤**:
- ä½¿ç”¨æŸ¥æ‰¾æ›¿æ¢ä¿®å¤é‡å¤é”™è¯¯
- ç»Ÿä¸€ Schema å¯¼å…¥
- ç»Ÿä¸€ db ä½¿ç”¨æ–¹å¼

**é€ä¸ªä¿®å¤**:
- å¤æ‚çš„ç±»å‹å®šä¹‰
- ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„ç±»å‹
- ç¬¬ä¸‰æ–¹åº“é›†æˆé—®é¢˜

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æœ‰æ•ˆåšæ³•

1. âœ… **æ‰¹é‡ä¿®å¤ç›¸åŒé—®é¢˜**
   - ä½¿ç”¨ PowerShell/grep æŸ¥æ‰¾æ‰€æœ‰ç›¸åŒé”™è¯¯
   - ä¸€æ¬¡æ€§ä¿®å¤æ‰€æœ‰ `getDb()` è°ƒç”¨
   - å¿«é€Ÿå‡å°‘å¤§é‡é”™è¯¯

2. âœ… **ä¼˜å…ˆä¿®å¤å¯¼å…¥é”™è¯¯**
   - å¯¼å…¥é”™è¯¯ä¼šå¯¼è‡´è¿é”é”™è¯¯
   - ä¿®å¤å¯¼å…¥åå¾ˆå¤šé”™è¯¯è‡ªåŠ¨æ¶ˆå¤±

3. âœ… **ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢**
   - æ‰¹é‡åˆ é™¤ `const db = await getDb();`
   - å¿«é€Ÿå¤„ç†é‡å¤æ¨¡å¼

### é‡åˆ°çš„æŒ‘æˆ˜

1. âš ï¸ **db ç±»å‹ç³»ç»Ÿå¤æ‚**
   - `db` å¯¼å‡ºæ˜¯åŒ…è£…å¯¹è±¡
   - éœ€è¦ç†è§£é¡¹ç›®çš„æ•°æ®åº“æ¶æ„
   - å¯èƒ½éœ€è¦æ›´æ·±å…¥çš„é‡æ„

2. âš ï¸ **Next.js ç”Ÿæˆçš„ç±»å‹**
   - è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ä¸åº”æ‰‹åŠ¨ä¿®å¤
   - éœ€è¦æ­£ç¡®é…ç½® Next.js ç±»å‹ç”Ÿæˆ

---

## ğŸŠ é˜¶æ®µæˆæœ

**å·²å®Œæˆ**:
- âœ… ä¿®å¤äº† Actions ä¸­çš„ä¸»è¦å¯¼å…¥é”™è¯¯
- âœ… å‡å°‘äº† 33% çš„ TypeScript é”™è¯¯
- âœ… å»ºç«‹äº†æ‰¹é‡ä¿®å¤çš„å·¥ä½œæµç¨‹

**å¾…å®Œæˆ**:
- â³ ä¿®å¤ db ç±»å‹ç³»ç»Ÿ
- â³ æ‰¹é‡ä¿®å¤ Schema å¯¼å…¥
- â³ ä¿®å¤å‰©ä½™ ~150 ä¸ªé”™è¯¯

---

## ğŸ“ ç›¸å…³æäº¤

**Git Commit**: `6aec656`
**æäº¤ä¿¡æ¯**: fix(types): fix TypeScript import errors in actions
**ä¿®æ”¹æ–‡ä»¶**: 18 ä¸ª
**ä»£ç å˜æ›´**: +2,630 / -45 è¡Œ

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-24  
**ä¸‹æ¬¡æ›´æ–°**: db ç±»å‹ç³»ç»Ÿä¿®å¤å®Œæˆå
