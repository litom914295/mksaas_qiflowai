# QiFlowè¿ç§»åº”æ€¥å“åº”é¢„æ¡ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-02  
**æœ‰æ•ˆæœŸ**: é•¿æœŸæœ‰æ•ˆ  
**é€‚ç”¨èŒƒå›´**: QiFlowè¿ç§»é¡¹ç›®å›æ»šä¸åº”æ€¥å¤„ç†

---

## ğŸš¨ åº”æ€¥å“åº”æµç¨‹

### å¿«é€Ÿå†³ç­–æ ‘

```
å‘ç°é—®é¢˜
    â†“
è¯„ä¼°ä¸¥é‡ç¨‹åº¦ (P0-P3)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   P0    â”‚   P1    â”‚   P2    â”‚   P3    â”‚
â”‚ ç´§æ€¥    â”‚ é«˜ä¼˜    â”‚ ä¸­ä¼˜    â”‚ ä½ä¼˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“         â†“         â†“         â†“
ç«‹å³å›æ»š  å°è¯•ä¿®å¤  è®¡åˆ’ä¿®å¤  è®°å½•é—®é¢˜
  15åˆ†é’Ÿ    2å°æ—¶     1å¤©      ä¸‹æ¬¡è¿­ä»£
```

---

## ğŸ“Š é—®é¢˜ä¸¥é‡ç¨‹åº¦åˆ†çº§

| çº§åˆ« | åç§° | å®šä¹‰ | å“åº”æ—¶é—´ | å¤„ç†ç­–ç•¥ |
|-----|------|------|---------|---------|
| **P0** | ç´§æ€¥ | æœåŠ¡å®Œå…¨ä¸å¯ç”¨ã€æ•°æ®ä¸¢å¤± | 15åˆ†é’Ÿ | ç«‹å³å›æ»š |
| **P1** | é«˜ä¼˜ | æ ¸å¿ƒåŠŸèƒ½æ•…éšœã€ä¸¥é‡æ€§èƒ½é—®é¢˜ | 2å°æ—¶ | å¿«é€Ÿä¿®å¤æˆ–å›æ»š |
| **P2** | ä¸­ä¼˜ | éƒ¨åˆ†åŠŸèƒ½å—å½±å“ | 1å¤© | è®¡åˆ’ä¿®å¤ |
| **P3** | ä½ä¼˜ | è½»å¾®é—®é¢˜ã€UIç‘•ç–µ | ä¸‹æ¬¡è¿­ä»£ | è®°å½•å¾…å¤„ç† |

---

## ğŸ”´ P0/P1åº”æ€¥å›æ»šSOP

### æ­¥éª¤1: è¯„ä¼°ä¸é€šçŸ¥ (5åˆ†é’Ÿ)

```bash
# 1.1 ç¡®è®¤é—®é¢˜ä¸¥é‡ç¨‹åº¦
- æ£€æŸ¥é”™è¯¯æ—¥å¿—
- æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡
- è¯„ä¼°å½±å“èŒƒå›´

# 1.2 é€šçŸ¥ç›¸å…³æ–¹
- å‘é€ç´§æ€¥é€šçŸ¥åˆ°å›¢é˜Ÿé¢‘é“
- é€šçŸ¥DBAå’ŒDevOps
- å‡†å¤‡ç”¨æˆ·å…¬å‘Š
```

### æ­¥éª¤2: åˆ›å»ºå¤‡ä»½ (5åˆ†é’Ÿ)

```bash
# 2.1 æ•°æ®åº“å¤‡ä»½
pg_dump $DATABASE_URL > emergency_backup_$(date +%Y%m%d_%H%M%S).sql

# 2.2 ä»£ç å¤‡ä»½
git branch emergency-backup-$(date +%Y%m%d-%H%M%S)
```

### æ­¥éª¤3: æ‰§è¡Œå›æ»š (10åˆ†é’Ÿ)

#### 3.1 æ•°æ®åº“å›æ»š

```bash
# æ‰§è¡ŒSQLå›æ»šè„šæœ¬
psql $DATABASE_URL -f artifacts/C11/rollback-0004.sql

# éªŒè¯å›æ»šæˆåŠŸ
psql $DATABASE_URL -c "\dt" | grep -E "bazi|fengshui"
# é¢„æœŸ: æ— ç»“æœï¼ˆè¡¨å·²åˆ é™¤ï¼‰
```

#### 3.2 ä»£ç å›æ»š

```bash
# æ–¹æ³•A: Git revertï¼ˆæ¨èï¼‰
git revert 69c5577 --no-edit
git push origin chore/migrate-qiflow-into-mksaas

# æ–¹æ³•B: Git resetï¼ˆç´§æ€¥æƒ…å†µï¼‰
git reset --hard <commit-before-migration>
git push --force origin chore/migrate-qiflow-into-mksaas
```

#### 3.3 ä¾èµ–å›æ»š

```bash
# æ¢å¤package.json
git checkout <commit-before-migration> -- package.json

# é‡æ–°å®‰è£…ä¾èµ–
npm install

# æ¸…ç†ç¼“å­˜
rm -rf .next node_modules/.cache
```

### æ­¥éª¤4: éªŒè¯å›æ»š (5åˆ†é’Ÿ)

```bash
# 4.1 ç¼–è¯‘æ£€æŸ¥
npm run build

# 4.2 å¯åŠ¨æœåŠ¡
npm run dev

# 4.3 å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/health
```

### æ­¥éª¤5: æ¢å¤æœåŠ¡ (5åˆ†é’Ÿ)

```bash
# 5.1 éƒ¨ç½²åˆ°ç”Ÿäº§
npm run deploy

# 5.2 éªŒè¯ç”Ÿäº§ç¯å¢ƒ
curl https://production-url.com/api/health

# 5.3 é€šçŸ¥æœåŠ¡æ¢å¤
# å‘é€å…¬å‘Š: æœåŠ¡å·²æ¢å¤æ­£å¸¸
```

---

## ğŸ“‹ å›æ»šæ£€æŸ¥æ¸…å•

### å›æ»šå‰

- [ ] å·²è¯„ä¼°é—®é¢˜ä¸¥é‡ç¨‹åº¦ï¼ˆP0/P1/P2/P3ï¼‰
- [ ] å·²é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜
- [ ] å·²åˆ›å»ºæ•°æ®åº“å¤‡ä»½
- [ ] å·²åˆ›å»ºGitå¤‡ä»½åˆ†æ”¯
- [ ] å·²å‡†å¤‡ç”¨æˆ·é€šçŸ¥å…¬å‘Š
- [ ] å·²ç¡®è®¤å›æ»šè„šæœ¬å¯ç”¨

### å›æ»šä¸­

- [ ] æ•°æ®åº“å›æ»šSQLæ‰§è¡ŒæˆåŠŸ
- [ ] Gitä»£ç å›æ»šå®Œæˆ
- [ ] ä¾èµ–ç‰ˆæœ¬å·²å›é€€
- [ ] .envé…ç½®å·²æ£€æŸ¥
- [ ] ç¼–è¯‘é€šè¿‡æ— é”™è¯¯
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡

### å›æ»šå

- [ ] ç”Ÿäº§ç¯å¢ƒå·²éƒ¨ç½²
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
- [ ] ç”¨æˆ·å·²é€šçŸ¥
- [ ] å›æ»šæ“ä½œå·²è®°å½•
- [ ] é—®é¢˜åŸå› å·²åˆ†æ

---

## ğŸ”§ å¸¸è§é—®é¢˜åº”æ€¥å¤„ç†

### é—®é¢˜1: æ•°æ®åº“å›æ»šå¤±è´¥

**ç—‡çŠ¶**: SQLè„šæœ¬æ‰§è¡ŒæŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥é”™è¯¯è¯¦æƒ…
psql $DATABASE_URL

# 2. æ‰‹åŠ¨åˆ é™¤è¡¨
DROP TABLE IF EXISTS bazi_calculations CASCADE;
DROP TABLE IF EXISTS fengshui_analysis CASCADE;
DROP TABLE IF EXISTS pdf_audit CASCADE;
DROP TABLE IF EXISTS copyright_audit CASCADE;

# 3. éªŒè¯åˆ é™¤æˆåŠŸ
\dt

# 4. é€€å‡º
\q
```

---

### é—®é¢˜2: Gitå›æ»šå†²çª

**ç—‡çŠ¶**: git revertå‡ºç°merge conflict

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æŸ¥çœ‹å†²çªæ–‡ä»¶
git status

# 2. é€‰æ‹©ä¿ç•™è¿ç§»å‰çš„ç‰ˆæœ¬
git checkout --theirs <file>

# 3. æˆ–æ‰‹åŠ¨ç¼–è¾‘è§£å†³å†²çª
code <conflicted-file>

# 4. æ ‡è®°ä¸ºå·²è§£å†³
git add <file>

# 5. å®Œæˆrevert
git revert --continue

# 6. æˆ–æ”¾å¼ƒrevertä½¿ç”¨reset
git revert --abort
git reset --hard <commit-before-migration>
```

---

### é—®é¢˜3: ä¾èµ–å®‰è£…å¤±è´¥

**ç—‡çŠ¶**: npm installæŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ¸…ç†ç¼“å­˜
rm -rf node_modules package-lock.json

# 2. ä½¿ç”¨æ­£ç¡®çš„åŒ…ç®¡ç†å™¨
npm install

# 3. å¦‚æœä»å¤±è´¥ï¼Œé”å®šç‰ˆæœ¬
npm install --legacy-peer-deps

# 4. æˆ–ä½¿ç”¨ä¹‹å‰çš„lockæ–‡ä»¶
git checkout <commit-before-migration> -- package-lock.json
npm ci
```

---

### é—®é¢˜4: ç¼–è¯‘é”™è¯¯

**ç—‡çŠ¶**: npm run buildå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥TypeScripté”™è¯¯
npx tsc --noEmit

# 2. åˆ é™¤QiFlowç›¸å…³å¯¼å…¥
# ç¼–è¾‘å‡ºé”™æ–‡ä»¶ï¼Œæ³¨é‡Šæ‰QiFlowå¯¼å…¥

# 3. æ¸…ç†æ„å»ºç¼“å­˜
rm -rf .next

# 4. é‡æ–°æ„å»º
npm run build
```

---

### é—®é¢˜5: ç”Ÿäº§ç¯å¢ƒæ•°æ®ä¸ä¸€è‡´

**ç—‡çŠ¶**: ä»£ç å·²å›æ»šä½†æ•°æ®åº“æœªåŒæ­¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. åœæ­¢è®¿é—®QiFlowåŠŸèƒ½
# åœ¨ä¸­é—´ä»¶æˆ–è·¯ç”±å±‚ç¦ç”¨

# 2. æ¸…ç†orphanæ•°æ®
psql $DATABASE_URL <<EOF
-- åˆ é™¤QiFlowç›¸å…³creditè®°å½•ï¼ˆå¯é€‰ï¼‰
DELETE FROM credit_transaction 
WHERE type IN ('bazi-calculation', 'xuankong-analysis', 'compass-reading');
EOF

# 3. åŒæ­¥å›æ»šæ•°æ®åº“
psql $DATABASE_URL -f artifacts/C11/rollback-0004.sql

# 4. éªŒè¯ä¸€è‡´æ€§
npm run verify:credits
```

---

## ğŸ“ ç´§æ€¥è”ç³»äºº

### æ ¸å¿ƒå›¢é˜Ÿ

| è§’è‰² | å§“å | è”ç³»æ–¹å¼ | å¤‡æ³¨ |
|-----|------|---------|------|
| é¡¹ç›®è´Ÿè´£äºº | [Name] | [Phone/Email] | æœ€ç»ˆå†³ç­– |
| DBA | [Name] | [Phone/Email] | æ•°æ®åº“æ“ä½œ |
| DevOps | [Name] | [Phone/Email] | éƒ¨ç½²å›æ»š |
| åç«¯å·¥ç¨‹å¸ˆ | [Name] | [Phone/Email] | ä»£ç å›æ»š |
| å‰ç«¯å·¥ç¨‹å¸ˆ | [Name] | [Phone/Email] | UIé—®é¢˜ |

### å¤–éƒ¨æ”¯æŒ

| æœåŠ¡ | è”ç³»æ–¹å¼ | ç”¨é€” |
|-----|---------|------|
| Supabase Support | support@supabase.io | æ•°æ®åº“é—®é¢˜ |
| Vercel Support | support@vercel.com | éƒ¨ç½²é—®é¢˜ |
| GitHub Support | support@github.com | Gité—®é¢˜ |

---

## ğŸ“ äº‹åæ€»ç»“æ¨¡æ¿

### å›æ»šæŠ¥å‘Š

```markdown
## QiFlowå›æ»šæŠ¥å‘Š

**æ—¥æœŸ**: YYYY-MM-DD  
**æ—¶é—´**: HH:MM - HH:MM  
**æ‰§è¡Œäºº**: [Name]  
**é—®é¢˜çº§åˆ«**: P0/P1/P2/P3

### é—®é¢˜æè¿°
[è¯¦ç»†æè¿°é‡åˆ°çš„é—®é¢˜]

### å½±å“èŒƒå›´
- å—å½±å“ç”¨æˆ·æ•°: XX
- æœåŠ¡ä¸å¯ç”¨æ—¶é•¿: XXåˆ†é’Ÿ
- æ•°æ®å½±å“: æœ‰/æ— 

### å›æ»šæ­¥éª¤
1. [æ­¥éª¤1]
2. [æ­¥éª¤2]
3. [æ­¥éª¤3]

### éªŒè¯ç»“æœ
- [ ] æ•°æ®åº“å›æ»šæˆåŠŸ
- [ ] ä»£ç å›æ»šæˆåŠŸ
- [ ] æœåŠ¡æ¢å¤æ­£å¸¸
- [ ] ç”¨æˆ·å·²é€šçŸ¥

### æ ¹æœ¬åŸå› 
[åˆ†æé—®é¢˜çš„æ ¹æœ¬åŸå› ]

### æ”¹è¿›æªæ–½
1. [æ”¹è¿›æªæ–½1]
2. [æ”¹è¿›æªæ–½2]
3. [æ”¹è¿›æªæ–½3]

### ç»éªŒæ•™è®­
[æ€»ç»“ç»éªŒæ•™è®­]
```

---

## ğŸ›¡ï¸ é¢„é˜²æªæ–½

### ä¸Šçº¿å‰æ£€æŸ¥

- [ ] å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] E2Eæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] å®‰å…¨å®¡è®¡é€šè¿‡
- [ ] åœ¨stagingç¯å¢ƒå……åˆ†æµ‹è¯•
- [ ] å‡†å¤‡å¥½å›æ»šè„šæœ¬
- [ ] æ•°æ®åº“å·²å¤‡ä»½
- [ ] åˆ¶å®šå›æ»šå†³ç­–æ ‡å‡†

### ç°åº¦å‘å¸ƒç­–ç•¥

1. **é˜¶æ®µ1**: å†…éƒ¨ç”¨æˆ·ï¼ˆ1-2å¤©ï¼‰
2. **é˜¶æ®µ2**: 5%ç”¨æˆ·ï¼ˆ1-2å¤©ï¼‰
3. **é˜¶æ®µ3**: 25%ç”¨æˆ·ï¼ˆ1-2å¤©ï¼‰
4. **é˜¶æ®µ4**: 50%ç”¨æˆ·ï¼ˆ1-2å¤©ï¼‰
5. **é˜¶æ®µ5**: 100%ç”¨æˆ·

### ç›‘æ§å‘Šè­¦

- é”™è¯¯ç‡è¶…è¿‡1%
- å“åº”æ—¶é—´è¶…è¿‡2ç§’
- æ•°æ®åº“è¿æ¥å¤±è´¥
- å†…å­˜ä½¿ç”¨è¶…è¿‡80%
- CPUä½¿ç”¨è¶…è¿‡80%

---

## ğŸ“Š å›æ»šå†³ç­–çŸ©é˜µ

| åœºæ™¯ | æ•°æ®ä¸¢å¤± | æœåŠ¡å¯ç”¨ | é”™è¯¯ç‡ | å†³ç­– | æ‰§è¡Œ |
|-----|---------|---------|-------|------|------|
| å®Œå…¨å®•æœº | æ˜¯ | å¦ | 100% | **ç«‹å³å›æ»š** | P0æµç¨‹ |
| æ ¸å¿ƒåŠŸèƒ½æ•…éšœ | å¦ | éƒ¨åˆ† | >20% | **å›æ»š** | P1æµç¨‹ |
| æ€§èƒ½ä¸¥é‡ä¸‹é™ | å¦ | æ˜¯ | <20% | **å°è¯•ä¿®å¤** | P1æµç¨‹ |
| éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸ | å¦ | æ˜¯ | <10% | **ç›‘æ§+ä¿®å¤** | P2æµç¨‹ |
| UI/UXé—®é¢˜ | å¦ | æ˜¯ | <5% | **è®°å½•é—®é¢˜** | P3æµç¨‹ |

---

## æ€»ç»“

### å…³é”®è¦ç‚¹

1. âœ… **å¿«é€Ÿå†³ç­–** - P0/P1é—®é¢˜ç«‹å³å›æ»š
2. âœ… **å¤‡ä»½ä¼˜å…ˆ** - ä»»ä½•æ“ä½œå‰å…ˆå¤‡ä»½
3. âœ… **åˆ†æ­¥éªŒè¯** - å›æ»šåé€æ­¥éªŒè¯
4. âœ… **è®°å½•å®Œæ•´** - è¯¦ç»†è®°å½•æ‰€æœ‰æ“ä½œ
5. âœ… **äº‹åå¤ç›˜** - åˆ†æåŸå› ï¼Œæ”¹è¿›æµç¨‹

### å›æ»šå‡†å¤‡åº¦: âœ… 100%

- âœ… æ•°æ®åº“å›æ»šè„šæœ¬å°±ç»ª
- âœ… Gitå›æ»šæŒ‡å—å®Œæ•´
- âœ… åº”æ€¥è”ç³»äººæ˜ç¡®
- âœ… å†³ç­–æµç¨‹æ¸…æ™°
- âœ… éªŒè¯æ­¥éª¤è¯¦ç»†

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-10-02  
**ç»´æŠ¤äºº**: AI Agent  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

