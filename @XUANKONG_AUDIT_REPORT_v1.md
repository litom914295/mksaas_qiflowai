# çŽ„ç©ºé£žæ˜Ÿç³»ç»Ÿæ·±åº¦å®¡è®¡æŠ¥å‘Š v1.0

**ç”Ÿæˆæ—¶é—´**: 2025-11-12  
**å®¡è®¡èŒƒå›´**: `src/lib/qiflow/xuankong/`  
**ä»£ç è§„æ¨¡**: 51 æ–‡ä»¶ï¼Œ632 KB

---

## æ‰§è¡Œæ‘˜è¦

### æ¸…ç†æˆæžœ
âœ… **å·²åˆ é™¤å†—ä½™ç³»ç»Ÿ**: `src/lib/qiflow/fengshui/` (105KB, 9æ–‡ä»¶)
- å®Œå…¨å¼ƒç”¨ï¼Œæ— ä»£ç å¼•ç”¨
- é¿å…åŽç»­ç»´æŠ¤æ··æ·†

### ä¾èµ–çŽ°çŠ¶
âœ… **å†œåŽ†/å…«å­—åº•åº§å·²å®Œå¤‡**
- `lunar-javascript` v1.7.5 (MIT è®¸å¯è¯) - å†œåŽ†è½¬æ¢ã€èŠ‚æ°”ã€å…«å­—
- `@aharris02/bazi-calculator-by-alvamind` v1.0.16 (MIT) - ä¸“ä¸šå…«å­—è®¡ç®—
- **æ— éœ€è¿ç§»æˆ–å¼•å…¥æ–°åº“**

âŒ **çŽ„ç©ºé£žæ˜Ÿå®Œå…¨è‡ªç ”**
- npm ç”Ÿæ€æ— å¯ç”¨å¼€æºåº“
- ç»´æŠ¤æˆæœ¬é›†ä¸­åœ¨çŽ„ç©ºé£žæ˜Ÿæ¨¡å—

---

## ä¸€ã€ä»£ç ç»“æž„åˆ†æž

### 1.1 æ¨¡å—ç»„ç»‡ï¼ˆ51 æ–‡ä»¶ï¼‰

#### æ ¸å¿ƒç®—æ³•å±‚ï¼ˆ18 æ–‡ä»¶ï¼‰
```
â”œâ”€â”€ luoshu.ts                    // æ´›ä¹¦ä¹å®«ã€é¡ºé€†é£žç®—æ³• â­
â”œâ”€â”€ yun.ts                       // ä¸‰å…ƒä¹è¿è®¡ç®—
â”œâ”€â”€ mountain.ts                  // äºŒåå››å±±å‘æ˜ å°„
â”œâ”€â”€ location.ts                  // æ–¹ä½åˆ†æžä¸Žå…¼å‘åˆ¤æ–­
â”œâ”€â”€ plate.ts                     // é£žæ˜Ÿç›˜åŸºç¡€ç»“æž„
â”œâ”€â”€ stack.ts                     // å¤šå±‚é£žæ˜Ÿå åŠ 
â”œâ”€â”€ layering.ts                  // å¹´æœˆæ—¥æ—¶åˆ†å±‚
â”œâ”€â”€ positions.ts                 // æ–‡æ˜Œä½ã€è´¢ä½è®¡ç®—
â”œâ”€â”€ geju.ts                      // æ ¼å±€åˆ¤æ–­ï¼ˆæ—ºå±±æ—ºæ°´ç­‰ï¼‰â­
â”œâ”€â”€ tigua.ts                     // æ›¿å¦è§„åˆ™
â”œâ”€â”€ enhanced-tigua.ts            // æ™ºèƒ½æ›¿å¦åˆ¤æ–­
â”œâ”€â”€ lingzheng.ts                 // é›¶æ­£ç†è®º
â”œâ”€â”€ chengmenjue.ts               // åŸŽé—¨è¯€
â”œâ”€â”€ liunian-analysis.ts          // æµå¹´åˆ†æž â­
â”œâ”€â”€ enhanced-aixing.ts           // å¢žå¼ºçˆ±æ˜Ÿåˆ†æž
â”œâ”€â”€ evaluate.ts                  // å®«ä½è¯„åˆ†
â”œâ”€â”€ star-interpretations.ts      // é£žæ˜Ÿè§£è¯»
â”œâ”€â”€ explanation.ts               // æ ¼å±€è§£é‡Š
```

#### ç»¼åˆå¼•æ“Žå±‚ï¼ˆ6 æ–‡ä»¶ï¼‰
```
â”œâ”€â”€ index.ts                     // ä¸»å…¥å£ API
â”œâ”€â”€ comprehensive-engine.ts      // ç»¼åˆåˆ†æžå¼•æ“Ž â­â­â­
â”œâ”€â”€ personalized-analysis.ts     // ä¸ªæ€§åŒ–åˆ†æž
â”œâ”€â”€ smart-recommendations.ts     // æ™ºèƒ½æŽ¨è
â”œâ”€â”€ diagnostic-system.ts         // è¯Šæ–­é¢„è­¦
â”œâ”€â”€ remedy-generator.ts          // åŒ–è§£æ–¹æ¡ˆç”Ÿæˆ
```

#### æ”¯æŒå·¥å…·å±‚ï¼ˆ10 æ–‡ä»¶ï¼‰
```
â”œâ”€â”€ types.ts                     // æ ¸å¿ƒç±»åž‹å®šä¹‰ â­
â”œâ”€â”€ converters.ts                // æ•°æ®æ ¼å¼è½¬æ¢
â”œâ”€â”€ adapters/v6-adapter.ts       // ç‰ˆæœ¬é€‚é…
â”œâ”€â”€ plate-generator.ts           // ç®€åŒ–ç›˜ç”Ÿæˆå™¨ âš ï¸
â”œâ”€â”€ diagnostic-engine.ts         // è¯Šæ–­å¼•æ“Ž
â”œâ”€â”€ remedy-engine.ts             // åŒ–è§£å¼•æ“Ž
â”œâ”€â”€ performance-monitor.ts       // æ€§èƒ½ç›‘æŽ§
â”œâ”€â”€ palace-profiles.ts           // å®«ä½æ¡£æ¡ˆ
â”œâ”€â”€ key-positions.ts             // å…³é”®ä½ç½®
â”œâ”€â”€ layout-suggestions.ts        // å¸ƒå±€å»ºè®®
```

#### æµ‹è¯•æ–‡ä»¶ï¼ˆ9 æ–‡ä»¶ï¼‰
```
â”œâ”€â”€ __tests__/
â”‚   â”œâ”€â”€ luoshu-algorithm-validation.test.ts  â­â­
â”‚   â”œâ”€â”€ comprehensive-engine.test.ts
â”‚   â”œâ”€â”€ enhanced-flying-star.test.ts
â”‚   â”œâ”€â”€ flying-star.test.ts
â”‚   â”œâ”€â”€ liunian-analysis.test.ts
â”‚   â”œâ”€â”€ personalized-analysis.test.ts
â”‚   â”œâ”€â”€ smart-recommendations.test.ts
â”‚   â”œâ”€â”€ authoritative-snapshots.test.ts
â”‚   â””â”€â”€ perf.test.ts                         â­
```

### 1.2 æ½œåœ¨é—®é¢˜è¯†åˆ«

#### âš ï¸ é‡å¤/å†—ä½™æ¨¡å—
1. **plate-generator.ts** (210è¡Œ)
   - ä¸Žä¸»ç³»ç»Ÿ `luoshu.ts` + `index.ts` åŠŸèƒ½é‡å 
   - ç®€åŒ–ç‰ˆç›˜ç”Ÿæˆå™¨ï¼Œç®—æ³•ä¸å®Œæ•´
   - **å»ºè®®**: å½’å¹¶æˆ–æ ‡è®°å¼ƒç”¨

2. **diagnostic-engine.ts** vs **diagnostic-system.ts**
   - åŠŸèƒ½è¾¹ç•Œä¸æ¸…æ™°
   - **å»ºè®®**: åˆå¹¶ä¸ºå•ä¸€æ¨¡å—

3. **remedy-engine.ts** vs **remedy-generator.ts**
   - ç±»ä¼¼åŠŸèƒ½ï¼Œä¸åŒæŽ¥å£
   - **å»ºè®®**: ç»Ÿä¸€åŒ–è§£æ–¹æ¡ˆç”Ÿæˆé€»è¾‘

---

## äºŒã€ç®—æ³•æ­£ç¡®æ€§å®¡è®¡

### 2.1 æ ¸å¿ƒç®—æ³•éªŒè¯ï¼ˆluoshu.tsï¼‰

#### âœ… å·²éªŒè¯æ­£ç¡®
```typescript
// é¡ºé£žå‡½æ•° - æµ‹è¯•é€šè¿‡
shunFei(1, 1) === 2
shunFei(9, 1) === 1  // å¾ªçŽ¯æ­£ç¡®
shunFei(1, 9) === 1  // ä¹æ­¥å›žåŽŸç‚¹ âœ…

// é€†é£žå‡½æ•° - æµ‹è¯•é€šè¿‡  
niFei(2, 1) === 1
niFei(1, 1) === 9
niFei(9, 9) === 9    // ä¹æ­¥å›žåŽŸç‚¹ âœ…

// æ€§è´¨æµ‹è¯•é€šè¿‡
é¡ºé£žä¸Žé€†é£žäº’ä¸ºé€†è¿ç®— âœ…
```

#### âš ï¸ éœ€å®Œå–„éƒ¨åˆ†
1. **æ›¿å¦å¤„ç†ä¸å®Œæ•´** (luoshu.ts:154, 206)
   ```typescript
   // å½“å‰å®žçŽ°ï¼šç®€åŒ–å ä½
   if (isJian) {
     shanStar = shanStar; // æš‚æ—¶ä¿æŒåŽŸæ · âš ï¸
   }
   ```
   **é—®é¢˜**: å…¼å‘å’Œæ›¿å¦é€»è¾‘æœªå®žçŽ°
   **å½±å“**: ç‰¹æ®Šåå‘çš„æŽ’ç›˜å‡†ç¡®æ€§

2. **å…ƒé¾™é¡ºé€†åˆ¤æ–­** (luoshu.ts:162-164)
   ```typescript
   const isShun =
     (baguaYinYang === 'é˜³' && zuoYuanLong === 'å¤©') ||
     (baguaYinYang === 'é˜´' && zuoYuanLong === 'äºº');
   ```
   **å¾…éªŒè¯**: åœ°å…ƒé¾™çš„å¤„ç†æ˜¯å¦å®Œæ•´

### 2.2 æ ¼å±€åˆ¤æ–­å®¡è®¡ï¼ˆgeju.tsï¼‰

#### âœ… å·²å®žçŽ°æ ¼å±€ï¼ˆ12ç§ï¼‰
```
âœ… æ—ºå±±æ—ºæ°´
âœ… ä¸Šå±±ä¸‹æ°´  
âœ… åŒæ˜Ÿä¼šå‘
âœ… åŒæ˜Ÿä¼šå
âœ… å…¨å±€åˆå
âœ… å¯¹å®«åˆå
âœ… è¿žç ä¸‰èˆ¬
âœ… çˆ¶æ¯ä¸‰èˆ¬
âœ… å±±æ˜Ÿä¼åŸ
âœ… å‘æ˜Ÿä¼åŸ
âœ… å•å®«ä¼åŸ
âœ… å•å®«ååŸ
```

#### âŒ ç¼ºå¤±é«˜çº§æ ¼å±€ï¼ˆ3ç§ï¼‰
```
âŒ ä¸ƒæ˜Ÿæ‰“åŠ«     - ä»…å ä½ï¼Œæœªå®žçŽ°
âŒ é›¶æ­£é¢ å€’     - ä»…å ä½ï¼Œæœªå®žçŽ°  
âŒ åŸŽé—¨è¯€å®Œæ•´ç‰ˆ - éƒ¨åˆ†å®žçŽ°
```

**ä¼˜å…ˆçº§**: é«˜ - å½±å“ä¸“ä¸šåº¦å’Œå‡†ç¡®æ€§

---

## ä¸‰ã€ç±»åž‹ç³»ç»Ÿå®¡è®¡

### 3.1 ç±»åž‹å®šä¹‰è´¨é‡ï¼ˆtypes.tsï¼‰

#### âœ… ä¼˜ç§€å®žè·µ
```typescript
// ä½¿ç”¨ literal union types
export type Yun = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;
export type FlyingStar = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;
export type PalaceIndex = 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9;

// ä½¿ç”¨ as const
export const DEFAULT_TOLERANCE_DEG = 0.5 as const;
```

#### âš ï¸ éœ€æ”¹è¿›
1. **ç±»åž‹æ–­è¨€è¿‡å¤š** - æœç´¢å‘çŽ° 50+ å¤„ `as FlyingStar`
2. **ç¼ºå°‘ JSDoc** - éƒ¨åˆ†å¤æ‚ç±»åž‹ç¼ºå°‘æ³¨é‡Š
3. **æŽ¥å£ vs ç±»åž‹** - æ··ç”¨ interface å’Œ type

**å»ºè®®**: 
- å‡å°‘ç±»åž‹æ–­è¨€ï¼Œå¢žå¼ºç±»åž‹æŽ¨å¯¼
- ä¸ºå¯¼å‡ºç±»åž‹æ·»åŠ  JSDoc
- ç»Ÿä¸€ä½¿ç”¨ typeï¼ˆé™¤éžéœ€è¦ declaration mergingï¼‰

---

## å››ã€æµ‹è¯•è¦†ç›–åˆ†æž

### 4.1 çŽ°æœ‰æµ‹è¯•ï¼ˆ9 æ–‡ä»¶ï¼‰

#### âœ… ç®—æ³•éªŒè¯æµ‹è¯•
- `luoshu-algorithm-validation.test.ts` - **ä¼˜ç§€** â­â­
  - é¡ºé£ž/é€†é£žæ­£ç¡®æ€§
  - æ€§è´¨ä¸å˜é‡ï¼ˆäº’é€†ã€å¾ªçŽ¯ï¼‰
  - äºŒåå››å±±æ˜ å°„
  - å…ƒé¾™å±žæ€§

#### âš ï¸ è¦†ç›–ä¸è¶³
- **æ›¿å¦é€»è¾‘** - æ— ä¸“é¡¹æµ‹è¯•
- **å…¼å‘å¤„ç†** - æ— ä¸“é¡¹æµ‹è¯•
- **è¾¹ç•Œæ¡ä»¶** - ç¼ºå°‘æžç«¯å€¼æµ‹è¯•
- **æ€§èƒ½åŸºçº¿** - perf.test.ts å­˜åœ¨ä½†æœªå®Œæ•´

### 4.2 å»ºè®®æ–°å¢žæµ‹è¯•

```typescript
// 1. æ›¿å¦ä¸“é¡¹æµ‹è¯•
describe('æ›¿å¦å¤„ç†', () => {
  test('æ­£æ›¿è§„åˆ™éªŒè¯');
  test('æ—æ›¿è§„åˆ™éªŒè¯');
  test('æ›¿å¦åŽæ ¼å±€å˜åŒ–');
});

// 2. å…¼å‘è¾¹ç•Œæµ‹è¯•
describe('å…¼å‘åˆ¤æ–­', () => {
  test('å®¹å·®èŒƒå›´è¾¹ç•Œ');
  test('ç©ºäº¡çº¿åˆ¤æ–­');
  test('å…¼å‘æƒé‡è®¡ç®—');
});

// 3. æ€§è´¨ä¸å˜é‡æµ‹è¯•
describe('ç®—æ³•ä¸å˜é‡', () => {
  test('é¡ºé£žä¹æ­¥å›žåŽŸç‚¹', () => {
    for (let star = 1; star <= 9; star++) {
      expect(shunFei(star, 9)).toBe(star);
    }
  });
});
```

---

## äº”ã€æ€§èƒ½è¯„ä¼°

### 5.1 çŽ°çŠ¶
- **åŸºç¡€é£žæ˜Ÿè®¡ç®—**: æœªåŸºå‡†æµ‹è¯•
- **ç»¼åˆåˆ†æž**: æœªåŸºå‡†æµ‹è¯•
- **ç¼“å­˜ç­–ç•¥**: éƒ¨åˆ†å®žçŽ°ï¼ˆEnhancedBaziCalculator æœ‰ç¼“å­˜ï¼‰

### 5.2 ç›®æ ‡åŸºçº¿
```
åŸºç¡€é£žæ˜Ÿè®¡ç®—: < 10ms
ç»¼åˆåˆ†æž:     < 100ms
å†…å­˜å ç”¨:     < 50MB
æ— å†…å­˜æ³„æ¼
```

---

## å…­ã€å®¡è®¡å‘çŽ°ä¼˜å…ˆçº§

### P0 - é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å¤„ç†ï¼‰
1. âœ… **åˆ é™¤å†—ä½™ fengshui/ ç›®å½•** - å·²å®Œæˆ
2. ðŸ”´ **è¡¥å…¨æ›¿å¦å®žçŽ°** (luoshu.ts:154, 206)
3. ðŸ”´ **å®Œå–„å…¼å‘å¤„ç†** (location.ts + luoshu.ts)
4. ðŸ”´ **å®žçŽ°ç¼ºå¤±é«˜çº§æ ¼å±€** (ä¸ƒæ˜Ÿæ‰“åŠ«ã€é›¶æ­£é¢ å€’)

### P1 - ä¸­ä¼˜å…ˆçº§ï¼ˆä¸¤å‘¨å†…ï¼‰
5. ðŸŸ¡ **å½’å¹¶é‡å¤æ¨¡å—** (plate-generator, diagnostic-*, remedy-*)
6. ðŸŸ¡ **å¢žå¼ºæµ‹è¯•è¦†ç›–** (æ›¿å¦ã€å…¼å‘ä¸“é¡¹æµ‹è¯•)
7. ðŸŸ¡ **å‡å°‘ç±»åž‹æ–­è¨€** (types.ts + å…¨å±€æœç´¢)

### P2 - ä½Žä¼˜å…ˆçº§ï¼ˆä¸€ä¸ªæœˆå†…ï¼‰
8. ðŸŸ¢ **æ€§èƒ½åŸºå‡†æµ‹è¯•** (perf.test.ts å®Œå–„)
9. ðŸŸ¢ **API æ–‡æ¡£è¡¥å…¨** (JSDoc + README)
10. ðŸŸ¢ **ä»£ç æ³¨é‡Šå¢žå¼º** (å¤æ‚ç®—æ³•éƒ¨åˆ†)

---

## ä¸ƒã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’

### ç¬¬ä¸€å‘¨ï¼šå‡†å¤‡ä¸Žæ¸…ç†
- [x] åˆ é™¤ fengshui/ ç›®å½•
- [ ] æž„å»ºæµ‹è¯•æ•°æ®é›†ï¼ˆè¾¹ç•Œã€å…¸åž‹ç›˜ï¼‰
- [ ] æ ‡æ³¨é‡å¤æ¨¡å—å¹¶åˆ¶å®šå½’å¹¶è®¡åˆ’

### ç¬¬äºŒå‘¨ï¼šæ›¿å¦ä¸Žå…¼å‘
- [ ] æ¢³ç†æ›¿å¦è§„åˆ™æ–‡æ¡£
- [ ] å®žçŽ°å®Œæ•´æ›¿å¦é€»è¾‘
- [ ] å®Œå–„å…¼å‘åˆ¤æ–­ä¸Žæƒé‡
- [ ] æ–°å¢žæ›¿å¦/å…¼å‘æµ‹è¯•å¥—ä»¶

### ç¬¬ä¸‰å‘¨ï¼šé«˜çº§æ ¼å±€
- [ ] å®žçŽ°ä¸ƒæ˜Ÿæ‰“åŠ«
- [ ] å®žçŽ°é›¶æ­£é¢ å€’å®Œæ•´ç‰ˆ
- [ ] å®Œå–„åŸŽé—¨è¯€
- [ ] ç»Ÿä¸€æ ¼å±€åˆ¤æ–­æŽ¥å£

### ç¬¬å››å‘¨ï¼šè´¨é‡æå‡
- [ ] å‡å°‘ç±»åž‹æ–­è¨€ 50% ä»¥ä¸Š
- [ ] å¢žåŠ  JSDoc è¦†ç›–è‡³ 80%
- [ ] å½’å¹¶é‡å¤æ¨¡å—
- [ ] æµ‹è¯•è¦†ç›–çŽ‡æå‡è‡³ 85%+

### ç¬¬äº”å‘¨ï¼šæ€§èƒ½ä¸Žå‘å¸ƒ
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•å¹¶ä¼˜åŒ–
- [ ] å®Œæ•´ API æ–‡æ¡£
- [ ] åˆè§„æ–‡æ¡£ä¸Žå…è´£å£°æ˜Ž
- [ ] å‘å¸ƒç­–ç•¥ä¸Žå›žæ»šé¢„æ¡ˆ

---

## å…«ã€é£Žé™©ä¸Žä¾èµ–

### é£Žé™©
1. **æ›¿å¦è§„åˆ™å¤æ‚** - å¯èƒ½éœ€è¦æŸ¥é˜…ä¼ ç»Ÿæ–‡çŒ®
2. **æµ‹è¯•æ•°æ®èŽ·å–** - éœ€æƒå¨ç›˜ä¾‹éªŒè¯
3. **æ€§èƒ½ç›®æ ‡** - ç»¼åˆåˆ†æž <100ms å¯èƒ½éœ€è¦ä¼˜åŒ–

### ä¾èµ–
- æ— å¤–éƒ¨çŽ„ç©ºé£Žæ°´åº“å¯ä¾èµ–
- éœ€ä¸“å®¶å®¡é˜…æ›¿å¦è§„åˆ™å®žçŽ°
- lunar-javascript ç‰ˆæœ¬ç¨³å®š

---

## é™„å½•ï¼šå…³é”®æ–‡ä»¶æ¸…å•

### å¿…è¯»æ–‡ä»¶
1. `luoshu.ts` - æ ¸å¿ƒç®—æ³•
2. `types.ts` - ç±»åž‹ç³»ç»Ÿ
3. `comprehensive-engine.ts` - ä¸»å¼•æ“Ž
4. `geju.ts` - æ ¼å±€åˆ¤æ–­
5. `luoshu-algorithm-validation.test.ts` - æµ‹è¯•åŸºå‡†

### å¾…é‡æž„æ–‡ä»¶
1. `plate-generator.ts` - åŠŸèƒ½é‡å 
2. `diagnostic-engine.ts` + `diagnostic-system.ts` - åˆå¹¶
3. `remedy-engine.ts` + `remedy-generator.ts` - ç»Ÿä¸€

---

**å®¡è®¡äººå‘˜**: AI Assistant  
**å®¡æ ¸æ—¥æœŸ**: 2025-11-12  
**ä¸‹æ¬¡å®¡è®¡**: å®Œæˆ P0 ä»»åŠ¡åŽ
