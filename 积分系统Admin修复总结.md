# ç§¯åˆ†ç³»ç»ŸAdminä¿®å¤æ€»ç»“

## é—®é¢˜ç°è±¡

è¶…çº§ç®¡ç†å‘˜ï¼ˆadminï¼‰ä»å‰ç«¯ç™»å½•æµ‹è¯•å„é¡¹åŠŸèƒ½æ—¶ï¼Œé‡åˆ°ç§¯åˆ†é™åˆ¶ã€‚

## æ ¹æœ¬åŸå› 

ç§¯åˆ†ç®¡ç†ç³»ç»ŸæœªåŒºåˆ†ç”¨æˆ·è§’è‰²ï¼Œå¯¹æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬adminï¼‰ç»Ÿä¸€æ‰§è¡Œç§¯åˆ†æ£€æŸ¥å’Œæ‰£é™¤ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

åœ¨ `src/lib/credits/manager.ts` ä¸­æ·»åŠ äº†ä¸‰å¤„å…³é”®ä¿®æ”¹ï¼š

1. **æ·»åŠ è§’è‰²æ£€æŸ¥æ–¹æ³•** `isAdmin()`
   - æŸ¥è¯¢æ•°æ®åº“åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºadmin
   - è¿”å›å¸ƒå°”å€¼

2. **ä¿®æ”¹ç§¯åˆ†ä½™é¢è·å–** `getBalance()`
   - adminç”¨æˆ·è¿”å› `Number.MAX_SAFE_INTEGER`ï¼ˆæ— é™ç§¯åˆ†ï¼‰
   - æ™®é€šç”¨æˆ·æ­£å¸¸æŸ¥è¯¢æ•°æ®åº“

3. **ä¿®æ”¹ç§¯åˆ†æ‰£é™¤é€»è¾‘** `deduct()`
   - adminç”¨æˆ·è·³è¿‡ç§¯åˆ†æ‰£é™¤
   - æ™®é€šç”¨æˆ·æ­£å¸¸æ‰£é™¤ç§¯åˆ†

### æŠ€æœ¯ç»†èŠ‚

```typescript
// æ£€æŸ¥æ˜¯å¦ä¸ºadmin
async isAdmin(userId: string): Promise<boolean> {
  const users = await db
    .select({ role: user.role })
    .from(user)
    .where(eq(user.id, userId))
    .limit(1);
  return users[0]?.role === 'admin';
}

// è·å–ä½™é¢æ—¶æ£€æŸ¥
if (await this.isAdmin(userId)) {
  return Number.MAX_SAFE_INTEGER; // æ— é™ç§¯åˆ†
}

// æ‰£é™¤æ—¶æ£€æŸ¥
if (await this.isAdmin(userId)) {
  return true; // ä¸æ‰£é™¤ï¼Œç›´æ¥è¿”å›æˆåŠŸ
}
```

## å¦‚ä½•éªŒè¯

### æ–¹æ³•1: ä½¿ç”¨æ£€æŸ¥è„šæœ¬

```bash
# æŸ¥çœ‹æ‰€æœ‰adminç”¨æˆ·åŠå…¶ç§¯åˆ†çŠ¶æ€
npm run tsx scripts/check-admin-user.ts
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
=== æ£€æŸ¥Adminç”¨æˆ·ç§¯åˆ†çŠ¶æ€ ===

æ‰¾åˆ° 1 ä¸ªadminç”¨æˆ·:

ğŸ“‹ ç”¨æˆ·ä¿¡æ¯:
   ID: abc123
   é‚®ç®±: admin@example.com
   åç§°: Admin User
   è§’è‰²: admin
   å½“å‰ç§¯åˆ†: 100
   å®é™…ä½¿ç”¨: æ— é™ç§¯åˆ† (9007199254740991)
   âœ… Adminç”¨æˆ·ä¸å—ç§¯åˆ†é™åˆ¶
```

### æ–¹æ³•2: æ‰‹åŠ¨æµ‹è¯•

1. **ç™»å½•adminè´¦æˆ·**
   - è®¿é—®ï¼š`/admin/login`
   - ä½¿ç”¨adminé‚®ç®±å’Œå¯†ç ç™»å½•

2. **æµ‹è¯•åŠŸèƒ½**
   - æµ‹è¯•AIèŠå¤©ï¼ˆéœ€è¦5ç§¯åˆ†ï¼‰
   - æµ‹è¯•å…«å­—åˆ†æï¼ˆéœ€è¦10ç§¯åˆ†ï¼‰
   - æµ‹è¯•ç„ç©ºé£æ°´åˆ†æï¼ˆéœ€è¦20-120ç§¯åˆ†ï¼‰

3. **é¢„æœŸç»“æœ**
   - âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ä½¿ç”¨
   - âœ… ä¸å‡ºç°"ç§¯åˆ†ä¸è¶³"æç¤º
   - âœ… ç§¯åˆ†ä½™é¢ä¸å˜æˆ–æ˜¾ç¤ºæå¤§å€¼

## å½±å“èŒƒå›´

### å—å½±å“çš„åŠŸèƒ½
æ‰€æœ‰ä½¿ç”¨ç§¯åˆ†ç³»ç»Ÿçš„åŠŸèƒ½éƒ½ä¼šå—ç›Šï¼š

- AIèŠå¤©ï¼ˆaiChat - 5ç§¯åˆ†ï¼‰
- æ·±åº¦è§£è¯»ï¼ˆdeepInterpretation - 30ç§¯åˆ†ï¼‰
- å…«å­—åˆ†æï¼ˆbazi - 10ç§¯åˆ†ï¼‰
- ç„ç©ºé£æ°´ï¼ˆxuankong - 20ç§¯åˆ†ï¼‰
- PDFå¯¼å‡ºï¼ˆpdfExport - 5ç§¯åˆ†ï¼‰
- ç»Ÿä¸€å¼•æ“å„çº§åˆ«åˆ†æï¼ˆ30-120ç§¯åˆ†ï¼‰

### ä¸å—å½±å“çš„éƒ¨åˆ†
- æ™®é€šç”¨æˆ·çš„ç§¯åˆ†é™åˆ¶ä¿æŒä¸å˜
- ç§¯åˆ†å……å€¼ã€äº¤æ˜“è®°å½•ç­‰åŠŸèƒ½æ­£å¸¸è¿ä½œ
- ç§¯åˆ†ç»Ÿè®¡å’ŒæŠ¥è¡¨ä¸å—å½±å“

## å®‰å…¨æ€§

- âœ… ä»…å¯¹ `role = 'admin'` çš„ç”¨æˆ·ç”Ÿæ•ˆ
- âœ… æ™®é€šç”¨æˆ·ï¼ˆ`role = 'user'`ï¼‰ä»å—ç§¯åˆ†é™åˆ¶
- âœ… ä¸ä¼šç»•è¿‡å…¶ä»–æƒé™æ£€æŸ¥
- âœ… å®¡è®¡æ—¥å¿—æ­£å¸¸è®°å½•

## ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- `src/lib/credits/manager.ts` - æ ¸å¿ƒä¿®å¤

### æ–°å¢æ–‡ä»¶
- `scripts/check-admin-user.ts` - æ£€æŸ¥adminç”¨æˆ·è„šæœ¬
- `scripts/test-admin-credits.ts` - ç§¯åˆ†åŠŸèƒ½æµ‹è¯•è„šæœ¬
- `docs/fixes/admin-credits-fix.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- `ç§¯åˆ†ç³»ç»ŸAdminä¿®å¤æ€»ç»“.md` - æœ¬æ–‡æ¡£

### ç›¸å…³æ–‡ä»¶
- `src/lib/auth/session.ts` - æƒé™ç®¡ç†
- `src/db/schema/auth.ts` - ç”¨æˆ·è¡¨å®šä¹‰
- `src/types/auth.d.ts` - ç±»å‹å®šä¹‰

## ä½¿ç”¨è¯´æ˜

### æŸ¥çœ‹adminç”¨æˆ·
```bash
npm run tsx scripts/check-admin-user.ts
```

### æµ‹è¯•ç§¯åˆ†åŠŸèƒ½
```bash
# éœ€è¦å…ˆä¿®æ”¹è„šæœ¬ä¸­çš„ç”¨æˆ·ID
npm run tsx scripts/test-admin-credits.ts
```

### æ•°æ®åº“æŸ¥è¯¢
```sql
-- æŸ¥çœ‹æ‰€æœ‰adminç”¨æˆ·
SELECT id, email, name, role FROM "user" WHERE role = 'admin';

-- æŸ¥çœ‹adminç”¨æˆ·çš„ç§¯åˆ†
SELECT u.email, uc.currentCredits 
FROM "user" u
LEFT JOIN user_credit uc ON u.id = uc.userId
WHERE u.role = 'admin';
```

## æ³¨æ„äº‹é¡¹

1. **é‡å¯æœåŠ¡**
   - ä¿®æ”¹åéœ€è¦é‡å¯å¼€å‘æœåŠ¡å™¨
   - ç”Ÿäº§ç¯å¢ƒéœ€è¦é‡æ–°éƒ¨ç½²

2. **æ¸…é™¤ç¼“å­˜**
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œcookies
   - é‡æ–°ç™»å½•adminè´¦æˆ·

3. **éªŒè¯æ•°æ®åº“**
   - ç¡®ä¿adminç”¨æˆ·çš„ `role` å­—æ®µå€¼ä¸º `'admin'`
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥æ­£å¸¸

## åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–
- [ ] æ·»åŠ adminä½¿ç”¨åŠŸèƒ½çš„å®¡è®¡æ—¥å¿—
- [ ] åœ¨å‰ç«¯æ˜¾ç¤ºadminç”¨æˆ·çš„ç‰¹æ®Šæ ‡è¯†
- [ ] æ·»åŠ adminåŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡

### é•¿æœŸè§„åˆ’
- [ ] æ”¯æŒæ›´ç»†ç²’åº¦çš„è§’è‰²æƒé™
- [ ] ä¸ºä¸åŒç®¡ç†å‘˜è®¾ç½®ä¸åŒé…é¢
- [ ] æ·»åŠ å¯é…ç½®çš„ç§¯åˆ†è±å…ç­–ç•¥

## å¸¸è§é—®é¢˜

### Q1: Adminè¿˜æ˜¯æ˜¾ç¤ºç§¯åˆ†ä¸è¶³ï¼Ÿ
**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. æ•°æ®åº“ä¸­ç”¨æˆ·çš„ `role` å­—æ®µæ˜¯å¦ä¸º `'admin'`
2. æœåŠ¡å™¨æ˜¯å¦å·²é‡å¯
3. æµè§ˆå™¨ç¼“å­˜æ˜¯å¦å·²æ¸…é™¤
4. æ˜¯å¦é‡æ–°ç™»å½•

### Q2: å¦‚ä½•åˆ›å»ºadminç”¨æˆ·ï¼Ÿ
**A:** ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
npm run tsx scripts/fix-admin-password.ts
```

### Q3: æ™®é€šç”¨æˆ·ä¼šå—å½±å“å—ï¼Ÿ
**A:** ä¸ä¼šã€‚æ­¤ä¿®å¤ä»…é’ˆå¯¹ `role = 'admin'` çš„ç”¨æˆ·ï¼Œæ™®é€šç”¨æˆ·ç§¯åˆ†é™åˆ¶ä¿æŒä¸å˜ã€‚

### Q4: å¦‚ä½•ä¸´æ—¶ç¦ç”¨adminå…ç§¯åˆ†ï¼Ÿ
**A:** åœ¨ `src/lib/credits/manager.ts` ä¸­æ³¨é‡Šæ‰ç›¸å…³çš„è§’è‰²æ£€æŸ¥ä»£ç å³å¯ã€‚

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- æŠ€æœ¯æ–‡æ¡£ï¼š`docs/fixes/admin-credits-fix.md`
- æµ‹è¯•è„šæœ¬ï¼š`scripts/check-admin-user.ts`

---

**ä¿®å¤æ—¥æœŸ:** 2025-10-19  
**ç‰ˆæœ¬:** v1.0  
**çŠ¶æ€:** âœ… å·²å®Œæˆå¹¶æµ‹è¯•
