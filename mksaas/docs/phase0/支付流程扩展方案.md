# Phase 0: æ”¯ä»˜æµç¨‹æ‰©å±•æ–¹æ¡ˆ v1.0

## ğŸ¯ åŒè½¨æ”¯ä»˜ç­–ç•¥

### æ”¯ä»˜æ–¹å¼ä¼˜å…ˆçº§
```
1ï¸âƒ£ ç§¯åˆ†æ”¯ä»˜ (Credits)
   - ä¼˜å…ˆå±•ç¤º
   - å³æ—¶åˆ°è´¦ï¼Œæ— æ‰‹ç»­è´¹
   - ç”¨æˆ·ä½“éªŒæœ€ä½³

2ï¸âƒ£ Stripe æ”¯ä»˜ (Fallback)
   - ç§¯åˆ†ä¸è¶³æ—¶å¤‡é€‰
   - æ”¯æŒä¿¡ç”¨å¡/å€Ÿè®°å¡
   - 3.4% + $0.30 æ‰‹ç»­è´¹
```

---

## ğŸ’³ Stripe äº§å“é…ç½® (Phase 2)

### 1. åˆ›å»ºæ–° Price ID
**Stripe Dashboard æ“ä½œ**:
```bash
# ç²¾åæŠ¥å‘Šä¸€æ¬¡æ€§è´­ä¹°
stripe prices create \
  --product prod_QiflowEssentialReport \
  --currency usd \
  --unit-amount 499 \
  --nickname "Essential Report - One-time"

# è¾“å‡º: price_1QiflowEssentialReport123
```

**ç¯å¢ƒå˜é‡** (`.env.local`):
```bash
# Phase 2 æ–°å¢
NEXT_PUBLIC_STRIPE_PRICE_REPORT_ESSENTIAL=price_1QiflowEssentialReport123
NEXT_PUBLIC_STRIPE_PRICE_REPORT_BASIC=price_1QiflowBasicReport456

# Phase 6 æ–°å¢ (Chat ä¼šè¯)
NEXT_PUBLIC_STRIPE_PRICE_CHAT_SESSION=price_1QiflowChatSession789
```

### 2. äº§å“å…ƒæ•°æ®è®¾ç½®
**é‡è¦**: åœ¨ Stripe Dashboard ä¸ºæ¯ä¸ª Price æ·»åŠ  metadata:
```json
{
  "productType": "qiflow_report",
  "reportType": "essential",
  "creditsEquivalent": "120",
  "validityDays": "0"  // 0 = ç»ˆèº«æœ‰æ•ˆ
}
```

**ç”¨é€”**: Webhook å¤„ç†æ—¶è¯†åˆ«äº§å“ç±»å‹ã€‚

---

## ğŸ”„ ç°æœ‰æ”¯ä»˜æµç¨‹å¤ç”¨åˆ†æ

### 1. ç°æœ‰ Checkout åˆ›å»ºé€»è¾‘
**æ¨æµ‹ä½ç½®**: `src/lib/stripe/create-checkout.ts` æˆ– `src/actions/stripe/checkout.ts`

**å½“å‰åŠŸèƒ½**:
- åˆ›å»º Stripe Checkout Session
- ä¼ é€’ `userId`, `priceId`, `successUrl`, `cancelUrl`
- å¯èƒ½æ”¯æŒ `metadata` è‡ªå®šä¹‰å­—æ®µ

**Phase 4 æ‰©å±•**:
```typescript
// src/actions/qiflow/create-report-checkout.ts
'use server';

import { createStripeCheckout } from '@/lib/stripe/create-checkout';
import { auth } from '@/lib/auth';

export async function createReportCheckoutAction(input: {
  reportType: 'essential' | 'basic';
  birthInfo: BirthInfo;
}) {
  const session = await auth();
  if (!session?.user?.id) throw new Error('Unauthorized');

  const priceId = 
    input.reportType === 'essential'
      ? process.env.NEXT_PUBLIC_STRIPE_PRICE_REPORT_ESSENTIAL!
      : process.env.NEXT_PUBLIC_STRIPE_PRICE_REPORT_BASIC!;

  // åˆ›å»ºå¾…ç”Ÿæˆçš„æŠ¥å‘Šè®°å½• (status = 'pending')
  const report = await db.insert(qiflowReports).values({
    userId: session.user.id,
    reportType: input.reportType,
    status: 'pending',
    input: { birthInfo: input.birthInfo },
    creditsUsed: input.reportType === 'essential' ? 120 : 50,
    metadata: { purchaseMethod: 'stripe' },
  }).returning();

  // å¤ç”¨ç°æœ‰ Checkout åˆ›å»ºé€»è¾‘
  const checkoutUrl = await createStripeCheckout({
    userId: session.user.id,
    priceId,
    successUrl: `/reports/${report.id}?success=true`,
    cancelUrl: `/reports/buy?canceled=true`,
    metadata: {
      productType: 'qiflow_report',
      reportType: input.reportType,
      reportId: report.id,  // âš ï¸ å…³é”®: å…³è”æŠ¥å‘Šè®°å½•
      birthInfo: JSON.stringify(input.birthInfo),
    },
  });

  return { checkoutUrl, reportId: report.id };
}
```

---

### 2. ç°æœ‰ Webhook å¤„ç†é€»è¾‘
**æ–‡ä»¶ä½ç½®**: `src/app/api/webhooks/stripe/route.ts`

**ç°æœ‰æ¶æ„**:
```typescript
export async function POST(req: NextRequest) {
  const payload = await req.text();
  const signature = req.headers.get('stripe-signature') || '';
  
  await handleWebhookEvent(payload, signature);
  return NextResponse.json({ received: true });
}
```

**Phase 1 æ”¹é€ ç‚¹ (å¹‚ç­‰æ€§)**:
```typescript
// src/payment/webhook-handler.ts (æ¨æµ‹)
import { stripe } from '@/lib/stripe';
import { getDb } from '@/db';
import { stripeWebhookEvents } from '@/db/schema';

export async function handleWebhookEvent(
  payload: string,
  signature: string
) {
  const db = await getDb();
  
  // 1. éªŒè¯ç­¾å
  const event = stripe.webhooks.constructEvent(
    payload,
    signature,
    process.env.STRIPE_WEBHOOK_SECRET!
  );

  // 2. å¹‚ç­‰æ€§æ£€æŸ¥ (Phase 1 æ–°å¢)
  const existingEvent = await db.query.stripeWebhookEvents.findFirst({
    where: eq(stripeWebhookEvents.id, event.id),
  });

  if (existingEvent) {
    console.log(`[Webhook] Event ${event.id} already processed`);
    return; // å·²å¤„ç†ï¼Œè·³è¿‡
  }

  // 3. è®°å½•äº‹ä»¶
  await db.insert(stripeWebhookEvents).values({
    id: event.id,
    eventType: event.type,
    processedAt: new Date(),
    payload: event,
    success: true,
  });

  // 4. åˆ†å‘å¤„ç†
  switch (event.type) {
    case 'invoice.paid':
      await handleInvoicePaid(event);
      break;
    case 'customer.subscription.updated':
      await handleSubscriptionUpdated(event);
      break;
    // Phase 4 æ–°å¢: æŠ¥å‘Šè´­ä¹°
    case 'checkout.session.completed':
      await handleCheckoutCompleted(event);
      break;
  }
}
```

**Phase 4 æ–°å¢å¤„ç†å™¨**:
```typescript
// src/payment/handlers/checkout-completed.ts
async function handleCheckoutCompleted(event: Stripe.Event) {
  const session = event.data.object as Stripe.Checkout.Session;
  const metadata = session.metadata;

  // ä»…å¤„ç†æŠ¥å‘Šè´­ä¹°
  if (metadata?.productType !== 'qiflow_report') {
    return; // å…¶ä»–äº§å“ç”±ç°æœ‰é€»è¾‘å¤„ç†
  }

  const reportId = metadata.reportId;
  if (!reportId) {
    throw new Error('[Webhook] Missing reportId in metadata');
  }

  // è§¦å‘æŠ¥å‘Šç”Ÿæˆä»»åŠ¡ (å¼‚æ­¥)
  await triggerReportGeneration(reportId);
  
  console.log(`[Webhook] Report generation triggered: ${reportId}`);
}
```

---

## ğŸš€ æŠ¥å‘Šç”Ÿæˆè§¦å‘æµç¨‹

### æ–¹æ¡ˆ A: åŒæ­¥ç”Ÿæˆ (Phase 3 åˆæœŸ)
```typescript
// src/lib/qiflow/reports/trigger-generation.ts
export async function triggerReportGeneration(reportId: string) {
  const db = await getDb();
  
  // æ›´æ–°çŠ¶æ€ä¸º generating
  await db.update(qiflowReports)
    .set({ status: 'generating' })
    .where(eq(qiflowReports.id, reportId));

  try {
    // è°ƒç”¨ç²¾åæŠ¥å‘Šç”Ÿæˆå™¨
    const result = await generateEssentialReport(reportId);
    
    // ä¿å­˜ç»“æœ
    await db.update(qiflowReports)
      .set({
        status: 'completed',
        output: result,
        generatedAt: new Date(),
        metadata: {
          ...result.metadata,
          generationTimeMs: Date.now() - startTime,
        },
      })
      .where(eq(qiflowReports.id, reportId));
  } catch (error) {
    // è®°å½•å¤±è´¥
    await db.update(qiflowReports)
      .set({ status: 'failed' })
      .where(eq(qiflowReports.id, reportId));
    
    throw error;
  }
}
```

**ä¼˜ç‚¹**: å®ç°ç®€å•ï¼Œé€‚åˆ MVP
**ç¼ºç‚¹**: Webhook è¶…æ—¶é£é™© (Stripe è¦æ±‚ 5 ç§’å†…å“åº”)

---

### æ–¹æ¡ˆ B: å¼‚æ­¥é˜Ÿåˆ— (Phase 9 ä¼˜åŒ–)
```typescript
// ä½¿ç”¨ Vercel Queue æˆ– Inngest
import { inngest } from '@/lib/inngest';

export async function triggerReportGeneration(reportId: string) {
  await inngest.send({
    name: 'qiflow/report.generate',
    data: { reportId },
  });
}

// inngest/functions/generate-report.ts
export default inngest.createFunction(
  { id: 'generate-report', retries: 3 },
  { event: 'qiflow/report.generate' },
  async ({ event }) => {
    const { reportId } = event.data;
    return await generateEssentialReport(reportId);
  }
);
```

**ä¼˜ç‚¹**: è§£è€¦ Webhook, æ”¯æŒé‡è¯•
**ç¼ºç‚¹**: éœ€å¼•å…¥é˜Ÿåˆ—æœåŠ¡ (Inngest å…è´¹é¢åº¦ 50K events/æœˆ)

---

## ğŸ’° ç§¯åˆ†æ”¯ä»˜æµç¨‹ (Phase 4)

### 1. ç›´æ¥æ‰£è´¹ + åŒæ­¥ç”Ÿæˆ
```typescript
// src/actions/qiflow/purchase-report-with-credits.ts
'use server';

import { CreditsManager } from '@/lib/credits/manager';
import { generateEssentialReport } from '@/lib/qiflow/reports/essential-report';

export async function purchaseReportWithCreditsAction(input: {
  reportType: 'essential' | 'basic';
  birthInfo: BirthInfo;
}) {
  const session = await auth();
  if (!session?.user?.id) throw new Error('Unauthorized');

  const price = input.reportType === 'essential' ? 120 : 50;
  const creditsManager = new CreditsManager();

  // 1. æ£€æŸ¥ä½™é¢
  const balance = await creditsManager.getBalance(session.user.id);
  if (balance < price) {
    return {
      success: false,
      error: 'INSUFFICIENT_CREDITS',
      required: price,
      balance,
    };
  }

  // 2. åˆ›å»ºæŠ¥å‘Šè®°å½•
  const [report] = await db.insert(qiflowReports).values({
    userId: session.user.id,
    reportType: input.reportType,
    status: 'generating',
    input: { birthInfo: input.birthInfo },
    creditsUsed: price,
    metadata: { purchaseMethod: 'credits' },
  }).returning();

  try {
    // 3. æ‰£è´¹
    const deductSuccess = await creditsManager.deduct(session.user.id, price);
    if (!deductSuccess) throw new Error('Deduction failed');

    // 4. åŒæ­¥ç”ŸæˆæŠ¥å‘Š (20s)
    const result = await generateEssentialReport(report.id);

    // 5. æ›´æ–°å®ŒæˆçŠ¶æ€
    await db.update(qiflowReports)
      .set({
        status: 'completed',
        output: result,
        generatedAt: new Date(),
      })
      .where(eq(qiflowReports.id, report.id));

    return {
      success: true,
      reportId: report.id,
    };
  } catch (error) {
    // å¤±è´¥å›æ»šç§¯åˆ†
    await creditsManager.addCredits(session.user.id, price);
    await db.update(qiflowReports)
      .set({ status: 'failed' })
      .where(eq(qiflowReports.id, report.id));

    return {
      success: false,
      error: 'GENERATION_FAILED',
    };
  }
}
```

---

## ğŸ” å®‰å…¨æ€§è€ƒé‡ (Phase 1)

### 1. Webhook ç­¾åéªŒè¯
```typescript
// å·²ç”± stripe.webhooks.constructEvent() è‡ªåŠ¨å¤„ç†
// ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½®
if (!process.env.STRIPE_WEBHOOK_SECRET) {
  throw new Error('Missing STRIPE_WEBHOOK_SECRET');
}
```

### 2. å¹‚ç­‰æ€§ä¿è¯
- âœ… åŸºäº `event.id` å»é‡ (Stripe é‡å‘æ—¶ ID ä¸å˜)
- âœ… è®°å½•å¤„ç†ç»“æœåˆ° `stripeWebhookEvents` è¡¨

### 3. å…ƒæ•°æ®æ ¡éªŒ
```typescript
function validateReportMetadata(metadata: any) {
  if (metadata.productType !== 'qiflow_report') {
    throw new Error('Invalid productType');
  }
  if (!['essential', 'basic'].includes(metadata.reportType)) {
    throw new Error('Invalid reportType');
  }
  if (!metadata.reportId) {
    throw new Error('Missing reportId');
  }
}
```

---

## ğŸ“Š æ”¯ä»˜æµç¨‹ç›‘æ§ (Phase 9)

### å…³é”®æŒ‡æ ‡
```typescript
// src/lib/qiflow/analytics/payment-metrics.ts
export interface PaymentMetrics {
  // è½¬åŒ–ç‡
  checkoutStarted: number;
  checkoutCompleted: number;
  conversionRate: number;  // completed / started

  // æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ
  creditsPurchases: number;
  stripePurchases: number;

  // å¤±è´¥ç‡
  webhookFailed: number;
  generationFailed: number;
  refundRate: number;

  // å¹³å‡å€¼
  avgGenerationTimeMs: number;
  avgCostPerReportUSD: number;
}
```

### Datadog / Sentry åŸ‹ç‚¹
```typescript
// Webhook æˆåŠŸ
Sentry.captureEvent({
  message: 'Report purchased',
  level: 'info',
  tags: {
    reportType: 'essential',
    paymentMethod: 'stripe',
  },
  contexts: {
    report: { id: reportId, generationTime: 15000 },
  },
});

// Webhook å¤±è´¥
Sentry.captureException(error, {
  tags: { eventType: 'invoice.paid' },
  extra: { eventId: event.id },
});
```

---

## ğŸ¨ å‰ç«¯è´­ä¹°æµç¨‹ UX

### æµç¨‹å›¾
```
[æŠ¥å‘Šé¢„è§ˆé¡µ]
    â†“
[ç‚¹å‡»"è§£é”å®Œæ•´ç‰ˆ"]
    â†“
[æ”¯ä»˜æ–¹å¼é€‰æ‹©å¼¹çª—]
  - ğŸ’ ä½¿ç”¨ 120 ç§¯åˆ† (ä½™é¢: 150)
  - ğŸ’³ Stripe æ”¯ä»˜ $4.99
    â†“
[é€‰æ‹©ç§¯åˆ†æ”¯ä»˜]
    â†“
[ç”Ÿæˆä¸­åŠ¨ç”» (20s)]
  - è¿›åº¦æ¡: è®¡ç®—å…«å­— â†’ ç”Ÿæˆä¸»é¢˜ â†’ è´¨é‡å®¡æ ¸
  - é¢„è®¡å®Œæˆ: 15 ç§’
    â†“
[æŸ¥çœ‹æŠ¥å‘Š] âœ…

æˆ–

[é€‰æ‹© Stripe æ”¯ä»˜]
    â†“
[è·³è½¬ Stripe Checkout]
    â†“
[æ”¯ä»˜æˆåŠŸ â†’ Webhook è§¦å‘]
    â†“
[è½®è¯¢æŠ¥å‘ŠçŠ¶æ€ (å‰ç«¯)]
  GET /api/reports/{reportId}/status
  â†’ { status: 'generating' | 'completed' }
    â†“
[æŸ¥çœ‹æŠ¥å‘Š] âœ…
```

### å‰ç«¯è½®è¯¢é€»è¾‘
```typescript
// src/app/(dashboard)/reports/[id]/page.tsx
'use client';

export default function ReportPage({ params }: { params: { id: string } }) {
  const [report, setReport] = useState<Report | null>(null);

  useEffect(() => {
    const pollStatus = async () => {
      const res = await fetch(`/api/reports/${params.id}/status`);
      const data = await res.json();

      if (data.status === 'completed') {
        setReport(data.report);
        return; // åœæ­¢è½®è¯¢
      }

      if (data.status === 'failed') {
        toast.error('æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œç§¯åˆ†å·²é€€å›');
        return;
      }

      // ç»§ç»­è½®è¯¢ (æ¯ 3 ç§’)
      setTimeout(pollStatus, 3000);
    };

    pollStatus();
  }, [params.id]);

  if (!report) {
    return <ReportGeneratingAnimation />;
  }

  return <ReportViewer report={report} />;
}
```

---

## ğŸ”¥ Phase 0 æ€»ç»“

### æ”¯ä»˜æµç¨‹å¤ç”¨ç‡: **90%**
- âœ… Stripe Checkout åˆ›å»ºé€»è¾‘ **å®Œå…¨å¤ç”¨**
- âœ… Webhook åŸºç¡€æ¡†æ¶ **å¤ç”¨ + æ‰©å±•**
- âœ… ä»…éœ€æ–°å¢æŠ¥å‘Šä¸“å±å¤„ç†å™¨

### å…³é”®é£é™©ç¼“è§£:
1. **Webhook è¶…æ—¶**: é‡‡ç”¨æ–¹æ¡ˆ A (åŒæ­¥ç”Ÿæˆ) + 5 ç§’è¶…æ—¶å®ˆå«
2. **ç§¯åˆ†å›æ»š**: ç”Ÿæˆå¤±è´¥è‡ªåŠ¨é€€æ¬¾
3. **é‡å¤è´­ä¹°**: å‰ç«¯æ£€æŸ¥ + åç«¯å¹‚ç­‰æ€§åŒä¿é™©

---

## â¡ï¸ Phase 0 å®Œæˆï¼Œå‡†å¤‡è¿›å…¥ Phase 1
æ‰€æœ‰å®¡è®¡æ–‡æ¡£å·²å°±ç»ªï¼Œç°å¯å¼€å§‹å®æ–½å®‰å…¨åˆè§„ä¸‰ä»¶å¥—ï¼
