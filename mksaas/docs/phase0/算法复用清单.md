# Phase 0: 算法复用清单 v1.0

## ✅ 可直接复用的算法模块

### 1. 八字计算核心算法 (99.9% 准确率)
**文件位置**: `src/lib/bazi-pro/core/calculator/four-pillars.ts`

**可复用能力**:
- `FourPillarsCalculator.calculate(birthInfo)` - 完整四柱计算
  - 自动处理农历/阳历转换
  - 真太阳时自动校正
  - 精确到节气边界的干支计算
- **输入**: `BirthInfo` (日期、时间、经度、性别、是否农历)
- **输出**: `FourPillars` (年月日时四柱 + 日主 + 月令 + 真太阳时 + 农历)

**复用场景**:
- ✅ 精华报告生成 (Phase 3): 直接调用获取基础八字数据
- ✅ Chat 会话分析 (Phase 6): 快速解析用户生辰
- ✅ Pro 月度运势 (Phase 8): 批量计算流年流月

**性能指标**:
- 计算耗时: ~50ms (同步计算)
- 内存占用: <1KB
- **无 AI 成本**: 纯本地算法

---

### 2. 玄空飞星风水算法
**文件位置**: `src/lib/fengshui/flying-star.ts`

**可复用能力**:
- `FlyingStarCalculator.calculateYearStar(year)` - 年飞星九宫
- `FlyingStarCalculator.calculateMonthStar(year, month)` - 月飞星
- **九宫格数据**:
  - 每宫飞星星数 (1-9)
  - 星性吉凶 (auspicious/inauspicious/neutral)
  - 方位推荐 (auspiciousDirections, inauspiciousDirections)

**复用场景**:
- ✅ 精华报告生成 (Phase 3): 玄空分析章节
- ✅ Chat RAG 增强 (Phase 7): 飞星知识库索引
- ✅ Pro 月度运势 (Phase 8): 月度飞星变化预警

**性能指标**:
- 计算耗时: ~20ms
- **无 AI 成本**: 纯本地算法

---

### 3. AI Provider 统一接口
**文件位置**: `src/server/ai/providers.ts`

**可复用能力**:
- `resolveModel(provider, model)` - 动态选择 AI 模型
  - 支持 OpenAI, DeepSeek, Gemini
  - 统一的 Vercel AI SDK 接口
- `getDefaultProvider()` - 自动回退策略 (DeepSeek → OpenAI → Gemini)
- `isProviderAvailable()` - 实时检查 API Key 可用性

**复用场景**:
- ✅ 精华报告 StoryWeaver (Phase 3): 调用 `resolveModel('deepseek', 'deepseek-chat')`
- ✅ Chat 会话 (Phase 6): 复用同一套 provider 切换逻辑
- ✅ RAG 向量化 (Phase 7): 调用 OpenAI embeddings
- ✅ 质量审计 (Phase 3): 使用 Gemini 做二次校验

**性能指标**:
- Provider 切换: 0 延迟 (仅环境变量检查)
- **成本优化**: 自动使用最便宜可用模型 (DeepSeek 优先)

---

### 4. 积分管理系统
**文件位置**: `src/lib/credits/manager.ts`

**可复用能力**:
- `CreditsManager.getBalance(userId)` - 查询余额
- `CreditsManager.deduct(userId, amount)` - 扣费
- `CreditsManager.addCredits(userId, amount)` - 充值/奖励
- **管理员豁免**: 自动识别 `role='admin'` 跳过扣费

**现有计费口径** (需扩展):
```typescript
PRICES = {
  aiChat: 5,
  deepInterpretation: 30,
  bazi: 10,
  xuankong: 20,
  pdfExport: 5,
  // 🔴 需在 Phase 2 添加:
  // reportBasic: 50,       // 基础报告 (仅生辰解读)
  // reportEssential: 120,  // 精华报告 (3 主题精选)
  // chatSession15Min: 40,  // 15分钟 Chat 会话
}
```

**复用场景**:
- ✅ Phase 4 购买流程: 调用 `deduct()` 扣除报告积分
- ✅ Phase 6 Chat 会话: 开启会话时扣除 40 积分
- ✅ Phase 1 新手任务: 调用 `addCredits()` 发放奖励

**性能指标**:
- 查询余额: ~50ms (DB 单表查询)
- 扣费事务: ~100ms (含事务记录)

---

### 5. 新手任务系统
**文件位置**: `src/lib/newbie-missions.ts`

**现有任务** (5 个):
1. 完善个人资料 (20 积分)
2. 首次八字分析 (30 积分)
3. 绑定社交账号 (15 积分)
4. 邀请好友注册 (50 积分)
5. 分享分析结果 (15 积分)

**复用能力**:
- `getUserNewbieMissions(userId)` - 获取任务进度
- `claimMissionReward(userId, missionId)` - 领取奖励
- **自动检测**: 每次查询时自动调用 `checkProgress()` 更新进度

**Phase 5 A/B 测试扩展点**:
```typescript
// B 组变体 (保持注册奖励 70 不变)
const AB_GROUP_B_MISSIONS = [
  ...NEWBIE_MISSIONS, // 继承现有 5 个
  { id: 'try_essential_report', reward: 50 }, // 新增第 6 个
];
```

**复用场景**:
- ✅ Phase 5: 在 B 组增加第 6 个任务 "生成首份精华报告"
- ✅ 前端: 现有任务中心 UI 无需改动

---

### 6. 数据库 Schema 基础
**文件位置**: `src/db/schema.ts`

**现有表结构** (可直接复用):
- `user` - 用户表 (含 `credits`, `role`, `customerId`)
- `userCredit` - 积分余额表 (含 `currentCredits`, `lastRefreshAt`)
- `creditTransaction` - 积分交易表 (含 `type`, `amount`, `remainingAmount`, `paymentId`)
- `payment` - 支付记录表 (Stripe 集成)
- `baziCalculations` - 八字分析记录 (含 `input`, `result`, `creditsUsed`)
- `fengshuiAnalysis` - 风水分析记录
- `taskProgress` - 任务进度表 (新手任务使用)
- `shareRecords` - 分享记录表
- `referralRelationships` - 推荐关系表

**Phase 2 需新增表** (Delta):
```sql
-- Phase 2 新增
CREATE TABLE qiflow_reports (
  id uuid PRIMARY KEY,
  userId text REFERENCES user(id),
  reportType text,  -- 'basic'/'essential'
  status text,      -- 'pending'/'generating'/'completed'/'failed'
  input jsonb,
  output jsonb,
  creditsUsed int,
  generatedAt timestamp,
  expiresAt timestamp,
  metadata jsonb
);

CREATE TABLE chat_sessions (
  id uuid PRIMARY KEY,
  userId text REFERENCES user(id),
  startedAt timestamp,
  expiresAt timestamp,  -- +15 mins
  messageCount int,
  creditsUsed int,
  status text,  -- 'active'/'expired'/'completed'
  metadata jsonb
);

CREATE TABLE stripe_webhook_events (
  id text PRIMARY KEY,
  eventType text,
  processedAt timestamp,
  payload jsonb
);
```

---

## ⚠️ 需改造的模块

### 1. Stripe Webhook 处理
**文件位置**: `src/app/api/webhooks/stripe/route.ts`

**现状**: 已有基础 webhook 框架，调用 `handleWebhookEvent(payload, signature)`

**Phase 1 改造点**:
- ✅ 添加幂等性检查: 基于 `event.id` 去重
  ```typescript
  const existingEvent = await db.query.stripe_webhook_events.findFirst({
    where: eq(stripe_webhook_events.id, event.id)
  });
  if (existingEvent) return; // 已处理，跳过
  ```
- ✅ 记录所有 webhook 事件到 `stripe_webhook_events` 表

**Phase 4 改造点**:
- ✅ 处理报告购买场景的 `invoice.paid` 事件
  ```typescript
  case 'invoice.paid':
    const metadata = invoice.metadata;
    if (metadata.productType === 'qiflow_report') {
      await triggerReportGeneration(metadata.reportId);
    }
  ```

---

### 2. 前端购买流程 UI
**现有**: Stripe Checkout 集成

**Phase 4 扩展点**:
- 新增报告购买页面: `src/app/(dashboard)/reports/essential/buy/page.tsx`
- 复用现有 Stripe Checkout 流程:
  ```typescript
  const checkoutUrl = await createStripeCheckout({
    userId,
    priceId: 'price_qiflow_report_essential',
    metadata: {
      productType: 'qiflow_report',
      reportType: 'essential',
      birthInfo: JSON.stringify(userInput),
    }
  });
  ```

---

## 🔥 Phase 0 关键结论

### 算法复用率: **95%**
- 八字、玄空、AI Provider、积分系统 **无需改动**
- 仅需扩展 pricing 配置 + 新增报告生成逻辑

### 成本优化机会:
1. **本地算法优先**: 八字+玄空计算 0 成本
2. **AI 调用精简**:
   - StoryWeaver: 1 次 AI 调用 (~$0.02)
   - Synthesis: 1 次 AI 调用 (~$0.01)
   - Quality Audit: 条件触发 (~$0.005)
   - **总计**: ~$0.035/报告 (远低于 $0.50 目标)

### 性能预估:
- 基础计算 (本地): ~100ms
- AI 生成 (3 次串行): ~15s (P95 < 20s ✅)
- 总耗时: ~20s (含网络、DB)
