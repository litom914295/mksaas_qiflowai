# MKSaaS QiFlow AI - Warp Code Project Profile

**é¡¹ç›®åç§°**: MKSaaS QiFlow AI  
**é¡¹ç›®ç±»å‹**: Next.js å…¨æ ˆ SaaS åº”ç”¨ï¼ˆAI å‘½ç†åˆ†æå¹³å°ï¼‰  
**æŠ€æœ¯æ ˆ**: Next.js 15 + TypeScript + PostgreSQL + Prisma + Better Auth  
**é¡¹ç›®é˜¶æ®µ**: ç”Ÿäº§å°±ç»ª (100% å®Œæˆæ ¸å¿ƒåŠŸèƒ½ï¼ŒæŒç»­ä¼˜åŒ–ä¸­)  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-01-12

---

## é¡¹ç›®æ¦‚è¿°

MKSaaS QiFlow AI æ˜¯ä¸€ä¸ªåŸºäº AI çš„ä¸­å›½ä¼ ç»Ÿå‘½ç†åˆ†æ SaaS å¹³å°ï¼Œæä¾›ï¼š

### æ ¸å¿ƒåŠŸèƒ½
- **å…«å­—åˆ†æ**ï¼šåŸºäºç”Ÿè¾°å…«å­—çš„å‘½ç†åˆ†æï¼ˆåŸºç¡€/è¯¦ç»†/ä¸“ä¸šä¸‰ä¸ªå±‚çº§ï¼‰
- **ç„ç©ºé£æ°´**ï¼šé£æ˜Ÿé£æ°´å¸ƒå±€åˆ†æå’Œç½—ç›˜ç®—æ³•
- **AI æ™ºèƒ½å’¨è¯¢**ï¼šåŸºäºå‘½ç†çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿ
- **ç§¯åˆ†ç³»ç»Ÿ**ï¼šç»Ÿä¸€çš„ç§¯åˆ†æ‰£å‡å’Œå®šä»·ç®¡ç†
- **ç—…æ¯’å¼å¢é•¿**ï¼šæ¨èè£‚å˜ã€æ¯æ—¥ç­¾åˆ°ã€é‚€è¯·æ’è¡Œæ¦œ
- **å¤šæ”¯ä»˜é›†æˆ**ï¼šæ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ã€Stripe ç­‰

### é¡¹ç›®ç‰¹è‰²
- âœ… å®Œæ•´çš„é™çº§å¤„ç†æœºåˆ¶ï¼ˆä½ç½®ä¿¡åº¦è‡ªåŠ¨é™çº§å’Œæ‰‹åŠ¨è¾“å…¥ fallbackï¼‰
- âœ… ä¸‰è‰²ç½®ä¿¡åº¦ç³»ç»Ÿï¼ˆçº¢/é»„/ç»¿ç½®ä¿¡åº¦è”åŠ¨ UIï¼‰
- âœ… åˆè§„æ£€æŸ¥ï¼ˆå¹´é¾„éªŒè¯ã€å…è´£å£°æ˜ã€æ•æ„Ÿè¯è¿‡æ»¤ï¼‰
- âœ… å›½é™…åŒ–æ”¯æŒï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰
- âœ… å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ
- âœ… Docker å®¹å™¨åŒ–éƒ¨ç½²

---

## æŠ€æœ¯æ¶æ„

### å‰ç«¯æŠ€æœ¯æ ˆ
```typescript
{
  "framework": "Next.js 15.5+ (App Router)",
  "language": "TypeScript 5.8+",
  "ui": "React 19 + Shadcn UI + Radix UI",
  "styling": "Tailwind CSS 4.0+",
  "forms": "React Hook Form + Zod",
  "state": "Zustand + React Query",
  "charts": "Recharts",
  "animation": "Framer Motion",
  "i18n": "next-intl 4.0"
}
```

### åç«¯æŠ€æœ¯æ ˆ
```typescript
{
  "runtime": "Node.js 20+",
  "api": "Next.js API Routes",
  "database": "PostgreSQL 15+ + Prisma ORM 5.7+",
  "auth": "Better Auth 1.1+ (JWT)",
  "payment": "Stripe + Alipay + WeChat Pay",
  "storage": "Aliyun OSS / AWS S3",
  "monitoring": "Sentry + Prometheus + Grafana"
}
```

### AI é›†æˆ
```typescript
{
  "providers": ["OpenAI", "Anthropic", "Google Gemini", "DeepSeek", "OpenRouter"],
  "sdk": "Vercel AI SDK 5.0+",
  "features": ["å…«å­—åˆ†æ", "é£æ°´åˆ†æ", "AIå¯¹è¯", "å›¾ç‰‡ç”Ÿæˆ"]
}
```

---

## é¡¹ç›®ç»“æ„

```
mksaas_qiflowai/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/[locale]/              # Next.js App Routerï¼ˆå¤šè¯­è¨€è·¯ç”±ï¼‰
â”‚   â”‚   â”œâ”€â”€ (marketing)/           # è¥é”€é¡µé¢ï¼ˆé¦–é¡µã€å®šä»·ã€å…³äºï¼‰
â”‚   â”‚   â”œâ”€â”€ (protected)/           # è®¤è¯ä¿æŠ¤é¡µé¢ï¼ˆDashboardã€åˆ†æï¼‰
â”‚   â”‚   â”œâ”€â”€ analysis/              # åˆ†æåŠŸèƒ½é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ bazi/             # å…«å­—åˆ†æ
â”‚   â”‚   â”‚   â””â”€â”€ xuankong/         # ç„ç©ºé£æ°´
â”‚   â”‚   â””â”€â”€ api/                  # API Routes
â”‚   â”œâ”€â”€ components/                # React ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ qiflow/               # QiFlow ä¸“ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ confidence-indicator.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ manual-input-form.tsx
â”‚   â”‚   â”‚   â””â”€â”€ compliance/       # åˆè§„ç»„ä»¶
â”‚   â”‚   â””â”€â”€ ui/                   # shadcn/ui ç»„ä»¶
â”‚   â”œâ”€â”€ lib/                       # æ ¸å¿ƒåº“
â”‚   â”‚   â”œâ”€â”€ qiflow/               # QiFlow ç®—æ³•åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ bazi/            # å…«å­—ç®—æ³•
â”‚   â”‚   â”‚   â”œâ”€â”€ xuankong/        # ç„ç©ºé£æ°´ç®—æ³•
â”‚   â”‚   â”‚   â”œâ”€â”€ compass/         # ç½—ç›˜ç®—æ³•
â”‚   â”‚   â”‚   â””â”€â”€ degradation/     # é™çº§å¤„ç†
â”‚   â”‚   â”œâ”€â”€ ai/                   # AI æœåŠ¡å°è£…
â”‚   â”‚   â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ actions/                   # Server Actions
â”‚   â”‚   â””â”€â”€ qiflow/
â”‚   â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ qiflow-pricing.ts    # å®šä»·é…ç½®
â”‚   â”‚   â””â”€â”€ qiflow-thresholds.ts # é˜ˆå€¼é…ç½®
â”‚   â”œâ”€â”€ db/                        # æ•°æ®åº“ç›¸å…³
â”‚   â”‚   â””â”€â”€ schema.ts             # Drizzle Schema
â”‚   â”œâ”€â”€ credits/                   # ç§¯åˆ†ç³»ç»Ÿ
â”‚   â”œâ”€â”€ payment/                   # æ”¯ä»˜é›†æˆ
â”‚   â””â”€â”€ i18n/                      # å›½é™…åŒ–é…ç½®
â”œâ”€â”€ .taskmaster/                   # Task Master AI é…ç½®
â”‚   â”œâ”€â”€ tasks/                    # ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ docs/                     # PRD æ–‡æ¡£
â”‚   â””â”€â”€ config.json               # AI æ¨¡å‹é…ç½®
â”œâ”€â”€ .warp/                         # Warp Code é…ç½®
â”‚   â””â”€â”€ profiles/                 # é¡¹ç›® Profiles
â”œâ”€â”€ .claude/                       # Claude Code é…ç½®
â”œâ”€â”€ artifacts/                     # å¼€å‘äº§ç‰©
â”œâ”€â”€ docs/                          # é¡¹ç›®æ–‡æ¡£
â””â”€â”€ monitoring/                    # ç›‘æ§é…ç½®
```

---

## ä»£ç è§„èŒƒ

### TypeScript è§„èŒƒ

```typescript
// âœ… æ¨èï¼šä½¿ç”¨ type å®šä¹‰ Props
type UserProfileProps = {
  userId: string;
  name: string;
  credits: number;
  onUpdate?: (user: User) => void;
};

// âœ… æ¨èï¼šå‡½æ•°ç»„ä»¶ä½¿ç”¨ç®­å¤´å‡½æ•°
const UserProfile = ({ userId, name, credits }: UserProfileProps) => {
  return <div>...</div>;
};

// âœ… æ¨èï¼šçº¯å‡½æ•°ä½¿ç”¨ function å…³é”®å­—
function calculateCredits(usage: UsageRecord[]): number {
  return usage.reduce((sum, record) => sum + record.amount, 0);
}

// âŒ é¿å…ï¼šä½¿ç”¨ enum
enum Status { PENDING, DONE } // ä¸æ¨è

// âœ… ä½¿ç”¨ï¼šå­—ç¬¦ä¸²å­—é¢é‡è”åˆç±»å‹
type Status = 'pending' | 'done' | 'in-progress';

// âœ… æ¨èï¼šå¯¹è±¡é…ç½®ä½¿ç”¨ as const
const QIFLOW_PRICING = {
  aiChat: 5,
  bazi: 10,
  xuankong: 20,
} as const;
```

### å‘½åè§„èŒƒ

```typescript
// æ–‡ä»¶å‘½åï¼škebab-case
// âœ… user-profile.tsx, qiflow-pricing.ts

// ç»„ä»¶å‘½åï¼šPascalCase
// âœ… UserProfile, ConfidenceIndicator

// å‡½æ•°/å˜é‡ï¼šcamelCase
// âœ… calculateBazi, userCredits

// å¸¸é‡ï¼šUPPER_SNAKE_CASE
// âœ… MAX_CREDITS, DEFAULT_THRESHOLD

// å¸ƒå°”å˜é‡ï¼šä½¿ç”¨åŠ©åŠ¨è¯å‰ç¼€
// âœ… isLoading, hasError, canEdit
```

### æ–‡ä»¶ç»„ç»‡

```typescript
// ç»„ä»¶æ–‡ä»¶ç»“æ„
// src/components/qiflow/bazi-result.tsx

// 1. å¯¼å…¥
import { useState } from 'react';
import type { BaziResult } from '@/types';

// 2. ç±»å‹å®šä¹‰
type BaziResultProps = {
  result: BaziResult;
};

// 3. è¾…åŠ©å‡½æ•°
function formatPillar(pillar: string) {
  // ...
}

// 4. ä¸»ç»„ä»¶
export const BaziResult = ({ result }: BaziResultProps) => {
  // 5. Hooks
  const [expanded, setExpanded] = useState(false);
  
  // 6. æ´¾ç”ŸçŠ¶æ€
  const formattedPillars = result.pillars.map(formatPillar);
  
  // 7. äº‹ä»¶å¤„ç†
  const handleExpand = () => setExpanded(!expanded);
  
  // 8. JSX
  return (
    <div>...</div>
  );
};

// 9. å­ç»„ä»¶ï¼ˆå¦‚æœç®€å•ï¼‰
const PillarCard = ({ pillar }: { pillar: string }) => {
  return <div>{pillar}</div>;
};
```

---

## QiFlow æ ¸å¿ƒæ¦‚å¿µ

### 1. ç§¯åˆ†ç³»ç»Ÿ

```typescript
// src/config/qiflow-pricing.ts
export const QIFLOW_PRICING = {
  // AI å¯¹è¯
  aiChat: 5,                    // æ¯æ¬¡å¯¹è¯
  deepInterpretation: 30,       // æ·±åº¦è§£è¯»
  
  // å…«å­—åˆ†æ
  bazi: 10,                     // åŸºç¡€åˆ†æ
  baziDetailed: 30,             // è¯¦ç»†åˆ†æ
  baziPro: 50,                  // ä¸“ä¸šåˆ†æ
  
  // é£æ°´åˆ†æ
  xuankong: 20,                 // ç„ç©ºé£æ˜Ÿ
  compass: 15,                  // ç½—ç›˜å®šä½
  
  // å¯¼å‡ºåŠŸèƒ½
  pdfExport: 5,                 // PDF åŸºç¡€å¯¼å‡º
  pdfPremium: 10,               // PDF é«˜çº§å¯¼å‡º
} as const;
```

### 2. ç½®ä¿¡åº¦ç³»ç»Ÿ

```typescript
// src/config/qiflow-thresholds.ts
export const CONFIDENCE_THRESHOLDS = {
  REJECT: 0.4,      // ğŸ”´ çº¢è‰²ï¼šæ‹’ç­” + æ‰‹åŠ¨è¾“å…¥
  WARNING: 0.7,     // ğŸŸ¡ é»„è‰²ï¼šè­¦å‘Š + æ ¡å‡†å¼•å¯¼
  NORMAL: 0.7,      // ğŸŸ¢ ç»¿è‰²ï¼šæ­£å¸¸å¤„ç†
} as const;

// ä½¿ç”¨ç¤ºä¾‹
const handleConfidence = (confidence: number) => {
  if (confidence < CONFIDENCE_THRESHOLDS.REJECT) {
    // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥è¡¨å•
    return <ManualInputForm />;
  }
  if (confidence < CONFIDENCE_THRESHOLDS.WARNING) {
    // æ˜¾ç¤ºæ ¡å‡†å¼•å¯¼
    return <CalibrationGuide />;
  }
  // æ­£å¸¸å¤„ç†
  return <NormalFlow />;
};
```

### 3. é™çº§å¤„ç†

```typescript
// src/lib/qiflow/degradation/strategy.ts
export async function analyzeBaziWithDegradation(input: BaziInput) {
  try {
    // 1. å°è¯•ä½¿ç”¨ AI åˆ†æ
    const result = await analyzeBaziWithAI(input);
    
    if (result.confidence < CONFIDENCE_THRESHOLDS.REJECT) {
      // 2. ç½®ä¿¡åº¦è¿‡ä½ï¼Œé™çº§åˆ°æ‰‹åŠ¨è¾“å…¥
      return {
        status: 'degraded',
        message: 'è‡ªåŠ¨åˆ†æç½®ä¿¡åº¦ä¸è¶³ï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤',
        needManualInput: true,
      };
    }
    
    if (result.confidence < CONFIDENCE_THRESHOLDS.WARNING) {
      // 3. ç½®ä¿¡åº¦ä¸€èˆ¬ï¼Œæä¾›æ ¡å‡†å»ºè®®
      return {
        status: 'warning',
        result,
        calibrationSuggestion: getCalibrationSuggestion(input),
      };
    }
    
    // 4. ç½®ä¿¡åº¦è‰¯å¥½ï¼Œæ­£å¸¸è¿”å›
    return {
      status: 'success',
      result,
    };
    
  } catch (error) {
    // 5. é”™è¯¯å¤„ç†ï¼Œé™çº§åˆ°åŸºç¡€ç®—æ³•
    console.error('AIåˆ†æå¤±è´¥ï¼Œé™çº§åˆ°åŸºç¡€ç®—æ³•', error);
    return {
      status: 'fallback',
      result: await basicBaziCalculation(input),
    };
  }
}
```

---

## å¼€å‘å·¥ä½œæµ

### 1. æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .envï¼Œå¡«å…¥å¿…è¦çš„ API Keys

# æ•°æ®åº“è®¾ç½®
npm run db:generate    # ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npm run db:push        # æ¨é€ schema åˆ°æ•°æ®åº“
npm run db:studio      # æ‰“å¼€æ•°æ®åº“ç®¡ç†ç•Œé¢

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev            # http://localhost:3000/zh
```

### 2. ä»£ç è´¨é‡æ£€æŸ¥

```bash
# ç±»å‹æ£€æŸ¥
npm run type-check

# ä»£ç æ ¼å¼åŒ–ï¼ˆBiomeï¼‰
npm run lint           # æ£€æŸ¥
npm run lint:fix       # ä¿®å¤

# è¿è¡Œæµ‹è¯•
npm run test:unit      # å•å…ƒæµ‹è¯•
npm run test:e2e       # E2E æµ‹è¯•
```

### 3. æ•°æ®åº“æ“ä½œ

```bash
# ç”Ÿæˆè¿ç§»
npm run db:generate

# æ‰§è¡Œè¿ç§»
npm run db:migrate

# æ¨é€åˆ°æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
npm run db:push

# å¤‡ä»½æ•°æ®åº“
npm run backup:db

# æŸ¥çœ‹å¤‡ä»½åˆ—è¡¨
npm run backup:list

# åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
npm run seed:admin
```

### 4. i18n ç›¸å…³

```bash
# éªŒè¯ç¿»è¯‘å®Œæ•´æ€§
npm run validate:i18n

# åˆå¹¶ç¿»è¯‘æ–‡ä»¶
npm run merge:i18n

# åŒæ­¥åŸºç¡€ç¿»è¯‘
npm run sync:i18n-base
```

---

## Task Master AI é›†æˆ

### åˆå§‹åŒ–å’Œè®¾ç½®

```bash
# 1. åˆå§‹åŒ– Task Masterï¼ˆå¦‚æœå°šæœªåˆå§‹åŒ–ï¼‰
task-master init

# 2. é…ç½® AI æ¨¡å‹
task-master models --setup

# 3. ä» PRD ç”Ÿæˆä»»åŠ¡ï¼ˆå¦‚æœæœ‰æ–°çš„ PRDï¼‰
task-master parse-prd .taskmaster/docs/prd.txt --append

# 4. åˆ†æä»»åŠ¡å¤æ‚åº¦
task-master analyze-complexity --research

# 5. å±•å¼€å¤æ‚ä»»åŠ¡
task-master expand --all --research
```

### æ—¥å¸¸å¼€å‘æµç¨‹

```bash
# æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
task-master list

# è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡
task-master next

# æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
task-master show <task-id>

# å±•å¼€ä»»åŠ¡ä¸ºå­ä»»åŠ¡
task-master expand --id=<task-id> --research

# æ›´æ–°ä»»åŠ¡çŠ¶æ€
task-master set-status --id=<task-id> --status=in-progress
task-master set-status --id=<task-id> --status=done

# åœ¨å­ä»»åŠ¡ä¸­è®°å½•å®ç°ç¬”è®°
task-master update-subtask --id=<subtask-id> --prompt="å®ç°äº†XXXåŠŸèƒ½ï¼Œä½¿ç”¨äº†YYYæŠ€æœ¯"

# æ·»åŠ æ–°ä»»åŠ¡
task-master add-task --prompt="éœ€è¦ä¼˜åŒ–XXXæ€§èƒ½" --research

# éªŒè¯ä¾èµ–å…³ç³»
task-master validate-dependencies
```

### MCP å·¥å…·è°ƒç”¨

```typescript
// åœ¨ Warp Code ä¸­ï¼Œå¯ä»¥é€šè¿‡ MCP ç›´æ¥è°ƒç”¨ Task Master
// è¿™äº›å·¥å…·è‡ªåŠ¨è¿æ¥åˆ° .taskmaster/ é…ç½®

// è·å–ä»»åŠ¡åˆ—è¡¨
call_mcp_tool("get_tasks", {
  projectRoot: "D:\\test\\mksaas_qiflowai",
  status: "pending"
})

// è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡
call_mcp_tool("next_task", {
  projectRoot: "D:\\test\\mksaas_qiflowai"
})

// å±•å¼€ä»»åŠ¡
call_mcp_tool("expand_task", {
  id: "1.2",
  projectRoot: "D:\\test\\mksaas_qiflowai",
  research: true
})

// æ›´æ–°ä»»åŠ¡çŠ¶æ€
call_mcp_tool("set_task_status", {
  id: "1.2",
  status: "done",
  projectRoot: "D:\\test\\mksaas_qiflowai"
})
```

---

## å…³é”® API ç«¯ç‚¹

### è®¤è¯ç›¸å…³
- `POST /api/auth/sign-up` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/auth/sign-in` - ç”¨æˆ·ç™»å½•
- `POST /api/auth/sign-out` - ç”¨æˆ·ç™»å‡º
- `GET /api/auth/session` - è·å–ä¼šè¯

### QiFlow åˆ†æ
- `POST /api/qiflow/bazi/analyze` - å…«å­—åˆ†æ
- `POST /api/qiflow/xuankong/analyze` - ç„ç©ºé£æ°´åˆ†æ
- `POST /api/qiflow/compass/read` - ç½—ç›˜è¯»å–
- `POST /api/ai/chat` - AI å¯¹è¯

### ç§¯åˆ†ç³»ç»Ÿ
- `GET /api/credits/balance` - æŸ¥è¯¢ç§¯åˆ†ä½™é¢
- `POST /api/credits/purchase` - è´­ä¹°ç§¯åˆ†
- `GET /api/credits/history` - ç§¯åˆ†å†å²
- `POST /api/credits/deduct` - æ‰£é™¤ç§¯åˆ†

### æ¨èç³»ç»Ÿ
- `POST /api/referral/create` - åˆ›å»ºæ¨è
- `GET /api/referral/stats` - æ¨èç»Ÿè®¡
- `POST /api/referral/check-activation` - æ£€æŸ¥æ¿€æ´»çŠ¶æ€

### æ”¯ä»˜ç³»ç»Ÿ
- `POST /api/payment/create-checkout` - åˆ›å»ºæ”¯ä»˜ä¼šè¯
- `POST /api/payment/webhook` - æ”¯ä»˜å›è°ƒ
- `GET /api/payment/orders` - è®¢å•åˆ—è¡¨

---

## å¸¸è§å¼€å‘ä»»åŠ¡

### æ·»åŠ æ–°çš„åˆ†æåŠŸèƒ½

```typescript
// 1. å®šä¹‰ç±»å‹ (src/types/qiflow.ts)
export type MyAnalysisInput = {
  param1: string;
  param2: number;
};

export type MyAnalysisResult = {
  result: string;
  confidence: number;
};

// 2. å®ç°ç®—æ³• (src/lib/qiflow/my-feature/algorithm.ts)
export async function analyzeMyFeature(input: MyAnalysisInput): Promise<MyAnalysisResult> {
  // ç®—æ³•å®ç°
}

// 3. åˆ›å»º Server Action (src/actions/qiflow/my-feature.ts)
'use server';

import { checkCredits, deductCredits } from '@/credits';
import { analyzeMyFeature } from '@/lib/qiflow/my-feature';

export async function analyzeMyFeatureAction(input: MyAnalysisInput) {
  const user = await getCurrentUser();
  
  // æ£€æŸ¥ç§¯åˆ†
  const cost = QIFLOW_PRICING.myFeature;
  const hasEnough = await checkCredits(user.id, cost);
  if (!hasEnough) {
    return { error: 'ç§¯åˆ†ä¸è¶³' };
  }
  
  // æ‰§è¡Œåˆ†æ
  const result = await analyzeMyFeature(input);
  
  // æ‰£é™¤ç§¯åˆ†
  await deductCredits(user.id, cost, 'my_feature_analysis');
  
  return { success: true, result };
}

// 4. åˆ›å»º UI ç»„ä»¶ (src/components/qiflow/my-feature-form.tsx)
'use client';

import { useForm } from 'react-hook-form';
import { analyzeMyFeatureAction } from '@/actions/qiflow/my-feature';

export const MyFeatureForm = () => {
  const form = useForm<MyAnalysisInput>();
  
  const onSubmit = async (data: MyAnalysisInput) => {
    const result = await analyzeMyFeatureAction(data);
    // å¤„ç†ç»“æœ
  };
  
  return <form onSubmit={form.handleSubmit(onSubmit)}>...</form>;
};

// 5. åˆ›å»ºé¡µé¢ (src/app/[locale]/analysis/my-feature/page.tsx)
import { MyFeatureForm } from '@/components/qiflow/my-feature-form';

export default function MyFeaturePage() {
  return (
    <div>
      <h1>æˆ‘çš„æ–°åŠŸèƒ½</h1>
      <MyFeatureForm />
    </div>
  );
}

// 6. æ›´æ–°å®šä»·é…ç½® (src/config/qiflow-pricing.ts)
export const QIFLOW_PRICING = {
  // ...existing
  myFeature: 25, // æ–°å¢
} as const;
```

### ä¿®æ”¹ç°æœ‰å®šä»·

```typescript
// src/config/qiflow-pricing.ts
export const QIFLOW_PRICING = {
  aiChat: 5,           // åŸ 5
  bazi: 12,            // ä¿®æ”¹ï¼šåŸ 10
  xuankong: 20,
} as const;

// âš ï¸ æ³¨æ„ï¼šä¿®æ”¹å®šä»·åï¼Œéœ€è¦ï¼š
// 1. æ›´æ–°æ–‡æ¡£å’Œç”¨æˆ·ç•Œé¢æ˜¾ç¤º
// 2. é€šçŸ¥ç°æœ‰ç”¨æˆ·
// 3. è®°å½•å˜æ›´æ—¥å¿—
```

### æ·»åŠ æ–°çš„æ”¯ä»˜æ–¹å¼

```typescript
// 1. åœ¨ src/payment/providers/ åˆ›å»ºæ–°çš„ provider
// src/payment/providers/new-provider.ts
export class NewPaymentProvider {
  async createCheckout(amount: number, userId: string) {
    // å®ç°æ”¯ä»˜é€»è¾‘
  }
  
  async handleWebhook(payload: any) {
    // å¤„ç†å›è°ƒ
  }
}

// 2. æ³¨å†Œ provider (src/payment/index.ts)
import { NewPaymentProvider } from './providers/new-provider';

export const paymentProviders = {
  stripe: new StripeProvider(),
  alipay: new AlipayProvider(),
  wechat: new WechatProvider(),
  newProvider: new NewPaymentProvider(), // æ–°å¢
};

// 3. æ·»åŠ ç¯å¢ƒå˜é‡ (.env)
NEW_PROVIDER_API_KEY="your_key"
NEW_PROVIDER_SECRET="your_secret"

// 4. æ›´æ–° UI (src/components/payment/payment-methods.tsx)
const PAYMENT_METHODS = [
  { id: 'stripe', name: 'Stripe', icon: 'ğŸ’³' },
  { id: 'alipay', name: 'æ”¯ä»˜å®', icon: 'ğŸ”µ' },
  { id: 'wechat', name: 'å¾®ä¿¡æ”¯ä»˜', icon: 'ğŸ’¬' },
  { id: 'newProvider', name: 'æ–°æ”¯ä»˜', icon: 'ğŸ†•' }, // æ–°å¢
];
```

---

## è°ƒè¯•æŠ€å·§

### 1. æ—¥å¿—æŸ¥çœ‹

```bash
# å¼€å‘ç¯å¢ƒæ—¥å¿—
npm run dev
# æŸ¥çœ‹ç»ˆç«¯è¾“å‡º

# ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
# æŸ¥çœ‹ Sentry æˆ– æ—¥å¿—æ–‡ä»¶
tail -f logs/app.log
```

### 2. æ•°æ®åº“è°ƒè¯•

```bash
# æ‰“å¼€ Prisma Studio
npm run db:studio

# ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
psql $DATABASE_URL
```

### 3. API è°ƒè¯•

```typescript
// åœ¨ Server Action ä¸­æ·»åŠ æ—¥å¿—
export async function myAction(input: Input) {
  console.log('[DEBUG] Input:', input);
  
  const result = await someOperation();
  console.log('[DEBUG] Result:', result);
  
  return result;
}
```

### 4. å‰ç«¯è°ƒè¯•

```typescript
// ä½¿ç”¨ React DevTools
// å®‰è£…æµè§ˆå™¨æ‰©å±•ï¼šReact Developer Tools

// ä½¿ç”¨ console è°ƒè¯•
useEffect(() => {
  console.log('[DEBUG] State updated:', state);
}, [state]);

// ä½¿ç”¨æ–­ç‚¹
debugger; // ç¨‹åºä¼šåœ¨è¿™é‡Œæš‚åœ
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_users_credits ON users(credits);
CREATE INDEX idx_analyses_user_id ON analyses(user_id);
CREATE INDEX idx_transactions_user_id ON credit_transactions(user_id);

-- æŸ¥è¯¢ä¼˜åŒ–ï¼šä½¿ç”¨ select æŒ‡å®šå­—æ®µ
// âŒ ä¸æ¨è
const user = await db.user.findUnique({ where: { id } });

// âœ… æ¨è
const user = await db.user.findUnique({
  where: { id },
  select: { id: true, name: true, credits: true }
});
```

### 2. å‰ç«¯ä¼˜åŒ–

```typescript
// ä½¿ç”¨åŠ¨æ€å¯¼å…¥
const HeavyComponent = dynamic(() => import('./heavy-component'), {
  loading: () => <Skeleton />,
  ssr: false,
});

// ä½¿ç”¨ React.memo
const ExpensiveComponent = React.memo(({ data }) => {
  // ä»…åœ¨ data å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
  return <div>{data}</div>;
});

// ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ
const expensiveValue = useMemo(() => {
  return computeExpensiveValue(data);
}, [data]);
```

### 3. API ä¼˜åŒ–

```typescript
// ä½¿ç”¨ç¼“å­˜
import { cache } from 'react';

export const getUser = cache(async (userId: string) => {
  return await db.user.findUnique({ where: { id: userId } });
});

// ä½¿ç”¨å¹¶å‘è¯·æ±‚
const [user, credits, history] = await Promise.all([
  getUser(userId),
  getCredits(userId),
  getHistory(userId),
]);
```

---

## å®‰å…¨æœ€ä½³å®è·µ

### 1. è¾“å…¥éªŒè¯

```typescript
import { z } from 'zod';

// å®šä¹‰ Schema
const BaziInputSchema = z.object({
  birthDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  birthTime: z.string().optional(),
  location: z.string().min(2).max(100),
});

// éªŒè¯è¾“å…¥
export async function analyzeBaziAction(input: unknown) {
  const validated = BaziInputSchema.parse(input); // ä¼šæŠ›å‡ºé”™è¯¯
  // æˆ–è€…
  const result = BaziInputSchema.safeParse(input); // è¿”å› { success, data?, error? }
  
  if (!result.success) {
    return { error: result.error.message };
  }
  
  // ä½¿ç”¨ validated æ•°æ®
}
```

### 2. è®¤è¯æ£€æŸ¥

```typescript
// åœ¨ Server Action ä¸­
export async function protectedAction() {
  const user = await getCurrentUser();
  
  if (!user) {
    return { error: 'æœªç™»å½•' };
  }
  
  if (!user.emailVerified) {
    return { error: 'è¯·å…ˆéªŒè¯é‚®ç®±' };
  }
  
  // ç»§ç»­å¤„ç†
}
```

### 3. ç§¯åˆ†éªŒè¯

```typescript
export async function expensiveAction() {
  const user = await getCurrentUser();
  const cost = QIFLOW_PRICING.expensiveFeature;
  
  // æ£€æŸ¥ç§¯åˆ†
  const hasEnough = await checkCredits(user.id, cost);
  if (!hasEnough) {
    return { error: 'ç§¯åˆ†ä¸è¶³' };
  }
  
  // æ‰§è¡Œæ“ä½œ
  const result = await doExpensiveOperation();
  
  // æ‰£é™¤ç§¯åˆ†
  await deductCredits(user.id, cost, 'expensive_feature');
  
  return { success: true, result };
}
```

### 4. æ•æ„Ÿæ•°æ®å¤„ç†

```typescript
// âŒ ä¸è¦åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ•æ„Ÿä¿¡æ¯
console.log('User data:', user); // å¯èƒ½åŒ…å«å¯†ç ã€token ç­‰

// âœ… è„±æ•åè¾“å‡º
console.log('User:', { id: user.id, email: maskEmail(user.email) });

// âŒ ä¸è¦è¿”å›æ•æ„Ÿå­—æ®µç»™å‰ç«¯
return { user: dbUser }; // åŒ…å« password hash

// âœ… é€‰æ‹©æ€§è¿”å›
return { 
  user: { 
    id: dbUser.id, 
    name: dbUser.name, 
    email: dbUser.email 
  } 
};
```

---

## éƒ¨ç½²æŒ‡å—

### 1. Vercel éƒ¨ç½²

```bash
# å®‰è£… Vercel CLI
npm i -g vercel

# ç™»å½•
vercel login

# éƒ¨ç½²
vercel

# ç”Ÿäº§éƒ¨ç½²
vercel --prod
```

### 2. Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t mksaas-qiflowai .

# è¿è¡Œå®¹å™¨
docker run -p 3000:3000 \
  -e DATABASE_URL="postgresql://..." \
  -e ANTHROPIC_API_KEY="sk-ant-..." \
  mksaas-qiflowai

# ä½¿ç”¨ docker-compose
docker-compose up -d
```

### 3. ç¯å¢ƒå˜é‡æ£€æŸ¥æ¸…å•

```bash
# å¿…éœ€çš„ç¯å¢ƒå˜é‡
âœ… DATABASE_URL
âœ… ANTHROPIC_API_KEY (æˆ–å…¶ä»– AI provider)
âœ… NEXT_PUBLIC_BASE_URL

# å¯é€‰çš„ç¯å¢ƒå˜é‡
â—»ï¸ STRIPE_SECRET_KEY (å¦‚æœå¯ç”¨ Stripe)
â—»ï¸ ALIPAY_APP_ID (å¦‚æœå¯ç”¨æ”¯ä»˜å®)
â—»ï¸ WECHAT_APP_ID (å¦‚æœå¯ç”¨å¾®ä¿¡æ”¯ä»˜)
â—»ï¸ SENTRY_DSN (å¦‚æœå¯ç”¨é”™è¯¯è¿½è¸ª)
â—»ï¸ NEXT_PUBLIC_GA_ID (å¦‚æœå¯ç”¨ Google Analytics)
```

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DATABASE_URL

# æµ‹è¯•è¿æ¥
npm run db:studio

# é‡æ–°ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
npm run db:generate
```

#### 2. ä¾èµ–å®‰è£…å¤±è´¥
```bash
# æ¸…ç†ç¼“å­˜
rm -rf node_modules package-lock.json
npm install

# æˆ–ä½¿ç”¨ pnpm
pnpm install
```

#### 3. ç±»å‹é”™è¯¯
```bash
# è¿è¡Œç±»å‹æ£€æŸ¥
npm run type-check

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
npx tsc --noEmit --pretty
```

#### 4. æ„å»ºå¤±è´¥
```bash
# æ¸…ç† .next ç¼“å­˜
rm -rf .next
npm run build

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
NEXT_TELEMETRY_DEBUG=1 npm run build
```

---

## é‡è¦æ–‡ä»¶é€ŸæŸ¥

### é…ç½®æ–‡ä»¶
- `package.json` - ä¾èµ–å’Œè„šæœ¬
- `tsconfig.json` - TypeScript é…ç½®
- `next.config.ts` - Next.js é…ç½®
- `.env` - ç¯å¢ƒå˜é‡
- `tailwind.config.js` - Tailwind é…ç½®

### æ–‡æ¡£æ–‡ä»¶
- `README.md` - é¡¹ç›®æ¦‚è¿°
- `QUICK_START.md` - å¿«é€Ÿå¼€å§‹
- `@PRD_*.md` - äº§å“éœ€æ±‚æ–‡æ¡£
- `@TECH_GUIDE_*.md` - æŠ€æœ¯è®¾è®¡æ–‡æ¡£
- `@TASK_PLAN_*.md` - ä»»åŠ¡è®¡åˆ’

### æ ¸å¿ƒä»£ç æ–‡ä»¶
- `src/lib/qiflow/` - QiFlow æ ¸å¿ƒç®—æ³•
- `src/actions/qiflow/` - Server Actions
- `src/components/qiflow/` - QiFlow UI ç»„ä»¶
- `src/config/qiflow-pricing.ts` - å®šä»·é…ç½®
- `src/config/qiflow-thresholds.ts` - é˜ˆå€¼é…ç½®
- `src/credits/` - ç§¯åˆ†ç³»ç»Ÿ
- `src/payment/` - æ”¯ä»˜ç³»ç»Ÿ

---

## Warp Code ä½¿ç”¨æŠ€å·§

### 1. ç†è§£é¡¹ç›®ä¸Šä¸‹æ–‡

å½“ä½ é—®"è¿™ä¸ªé¡¹ç›®æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"æ—¶ï¼Œæˆ‘ä¼šåŸºäºæ­¤ Profile ç»™å‡ºå‡†ç¡®å›ç­”ã€‚

### 2. ä»£ç ç”Ÿæˆ

```
ä½ : "å¸®æˆ‘æ·»åŠ ä¸€ä¸ªæ–°çš„é£æ°´åˆ†æåŠŸèƒ½ï¼Œå«åš'å…«å®…é£æ°´'"

æˆ‘: ä¼šåŸºäºç°æœ‰çš„ä»£ç ç»“æ„å’Œè§„èŒƒï¼Œç”Ÿæˆï¼š
- ç±»å‹å®šä¹‰ (src/types/qiflow.ts)
- ç®—æ³•å®ç° (src/lib/qiflow/bazhai/)
- Server Action (src/actions/qiflow/bazhai.ts)
- UI ç»„ä»¶ (src/components/qiflow/bazhai-form.tsx)
- é¡µé¢ (src/app/[locale]/analysis/bazhai/page.tsx)
- æ›´æ–°å®šä»·é…ç½®
```

### 3. ä»£ç å®¡æŸ¥

```
ä½ : "å®¡æŸ¥è¿™æ®µä»£ç ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰é—®é¢˜"

æˆ‘: ä¼šåŸºäºé¡¹ç›®è§„èŒƒæ£€æŸ¥ï¼š
- TypeScript ç±»å‹æ˜¯å¦æ­£ç¡®
- æ˜¯å¦éµå¾ªå‘½åè§„èŒƒ
- æ˜¯å¦æœ‰å®‰å…¨é—®é¢˜
- æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜
- æ˜¯å¦ç¼ºå°‘é”™è¯¯å¤„ç†
```

### 4. è°ƒè¯•ååŠ©

```
ä½ : "è¿™ä¸ª API è°ƒç”¨æ€»æ˜¯è¿”å› 401"

æˆ‘: ä¼šæ£€æŸ¥ï¼š
- è®¤è¯é€»è¾‘
- Session ç®¡ç†
- API Route é…ç½®
- ç¯å¢ƒå˜é‡é…ç½®
å¹¶æä¾›ä¿®å¤å»ºè®®
```

### 5. ä»»åŠ¡ç®¡ç†é›†æˆ

```
ä½ : "ä» Task Master è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡å¹¶å¼€å§‹å®ç°"

æˆ‘: ä¼šï¼š
1. è°ƒç”¨ MCP å·¥å…·è·å–ä»»åŠ¡
2. åˆ†æä»»åŠ¡éœ€æ±‚
3. ç”Ÿæˆå®ç°ä»£ç 
4. æ›´æ–°ä»»åŠ¡çŠ¶æ€
5. è®°å½•å®ç°ç¬”è®°
```

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£é“¾æ¥
- ğŸ“– [Next.js å®˜æ–¹æ–‡æ¡£](https://nextjs.org/docs)
- ğŸ“– [Prisma å®˜æ–¹æ–‡æ¡£](https://www.prisma.io/docs)
- ğŸ“– [Better Auth æ–‡æ¡£](https://www.better-auth.com/docs)
- ğŸ“– [Shadcn UI æ–‡æ¡£](https://ui.shadcn.com)
- ğŸ“– [Task Master AI æ–‡æ¡£](https://task-master.ai/docs)

### é¡¹ç›®ä»“åº“
- ğŸ”— [GitHub ä»“åº“](https://github.com/litom914295/mksaas_qiflowai)
- ğŸ› [é—®é¢˜è¿½è¸ª](https://github.com/litom914295/mksaas_qiflowai/issues)

### è”ç³»æ–¹å¼
- ğŸ’¬ é¡¹ç›®è®¨è®ºï¼šGitHub Discussions
- ğŸ› Bug æŠ¥å‘Šï¼šGitHub Issues
- ğŸ“§ æŠ€æœ¯æ”¯æŒï¼šé€šè¿‡ GitHub Issues

---

**Profile ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-01-12  
**ç»´æŠ¤è€…**: MKSaaS QiFlow AI Team

---

## ä½¿ç”¨æ­¤ Profile çš„ç¤ºä¾‹å¯¹è¯

### ç¤ºä¾‹ 1: äº†è§£é¡¹ç›®
```
ä½ : "è¿™ä¸ªé¡¹ç›®çš„ä¸»è¦æŠ€æœ¯æ ˆæ˜¯ä»€ä¹ˆï¼Ÿ"
æˆ‘: "è¿™æ˜¯ä¸€ä¸ªåŸºäº Next.js 15 çš„å…¨æ ˆ SaaS åº”ç”¨ï¼Œä½¿ç”¨ TypeScriptã€PostgreSQLã€Prisma ORM å’Œ Better Authã€‚å‰ç«¯ä½¿ç”¨ React 19 + Shadcn UI + Tailwind CSSï¼Œæ”¯æŒå›½é™…åŒ–ï¼ˆä¸­æ–‡/è‹±æ–‡ï¼‰ã€‚é¡¹ç›®å®ç°äº† AI å‘½ç†åˆ†æåŠŸèƒ½ï¼ŒåŒ…æ‹¬å…«å­—åˆ†æã€ç„ç©ºé£æ°´ã€AI å¯¹è¯ç­‰ã€‚"
```

### ç¤ºä¾‹ 2: ä»£ç ç”Ÿæˆ
```
ä½ : "å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªæ–°çš„ Server Actionï¼Œç”¨äºæŸ¥è¯¢ç”¨æˆ·çš„ç§¯åˆ†ä½™é¢"
æˆ‘: [åŸºäºé¡¹ç›®è§„èŒƒç”Ÿæˆç¬¦åˆæ ¼å¼çš„ä»£ç ï¼ŒåŒ…å«ç±»å‹å®šä¹‰ã€è¾“å…¥éªŒè¯ã€é”™è¯¯å¤„ç†ç­‰]
```

### ç¤ºä¾‹ 3: ä»»åŠ¡ç®¡ç†
```
ä½ : "æ˜¾ç¤º Task Master ä¸­å¾…å®Œæˆçš„ä»»åŠ¡"
æˆ‘: [è°ƒç”¨ MCP å·¥å…·è·å–ä»»åŠ¡åˆ—è¡¨ï¼Œå¹¶æ ¼å¼åŒ–å±•ç¤º]
```

### ç¤ºä¾‹ 4: æ•…éšœæ’æŸ¥
```
ä½ : "ä¸ºä»€ä¹ˆæˆ‘çš„ API è°ƒç”¨è¿”å› 500 é”™è¯¯ï¼Ÿ"
æˆ‘: [åŸºäºé¡¹ç›®æ¶æ„å’Œå¸¸è§é—®é¢˜ï¼Œæä¾›ç³»ç»Ÿçš„æ’æŸ¥æ­¥éª¤å’Œå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ]
```
