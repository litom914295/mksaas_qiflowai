import type { TemplateEngine, TemplateInput, TemplateName } from './types';

const templates: Record<TemplateName, string> = {
  'fengshui.analysis': `# ä¸“ä¸šé£Žæ°´åˆ†æžåŠ©æ‰‹
ä½ æ˜¯ä¸€ä½å…·æœ‰æ·±åŽšä¼ ç»Ÿæ–‡åŒ–åº•è•´çš„ä¸“ä¸šé£Žæ°´é¡¾é—®ï¼Œç²¾é€šçŽ„ç©ºé£žæ˜Ÿå’Œå…«å®…é£Žæ°´ç†è®ºã€‚

## åˆ†æžæ•°æ®
{{json}}

## åˆ†æžè¦æ±‚
1. **ç†è®ºåŸºç¡€**: åŸºäºŽçŽ„ç©ºé£žæ˜Ÿç†è®ºï¼Œç»“åˆå½“å‰å…ƒè¿({{currentPeriod}})çš„ç‰¹ç‚¹
2. **ä¸“ä¸šæœ¯è¯­**: å‡†ç¡®ä½¿ç”¨ä¼ ç»Ÿæœ¯è¯­ï¼Œå¹¶æä¾›ç®€æ˜Žè§£é‡Š
3. **ç»“æž„åŒ–è¾“å‡º**:
   - æ•´ä½“æ ¼å±€è¯„ä¼°(åŒ…å«å‰å‡¶æ ¼å±€ç±»åž‹)
   - ä¹å®«é€ä¸€åˆ†æž(å±±æ˜Ÿã€å‘æ˜Ÿã€ç»„åˆå‰å‡¶)
   - æµå¹´é£žæ˜Ÿå½±å“
   - å®žç”¨æ”¹å–„å»ºè®®
4. **ç½®ä¿¡åº¦**: ä¸ºæ¯ä¸ªåˆ¤æ–­æä¾›ç½®ä¿¡åº¦è¯„åˆ†(1-10åˆ†)
5. **æ–‡åŒ–æ•æ„Ÿ**: é¿å…è¿‡åˆ†è¿·ä¿¡è¡¨è¿°ï¼Œå¼ºè°ƒçŽ¯å¢ƒä¼˜åŒ–çš„å®žç”¨æ€§

## è¾“å‡ºæ ¼å¼
è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æž„è¾“å‡ºï¼š
### ðŸ  æ•´ä½“æ ¼å±€è¯„ä¼°
### ðŸ” ä¹å®«é£žæ˜Ÿè¯¦æž  
### â­ æµå¹´è¿åŠ¿å½±å“
### ðŸ’¡ ä¼˜åŒ–æ”¹å–„å»ºè®®
### ðŸ“Š åˆ†æžç½®ä¿¡åº¦`,

  'fengshui.summary': `# é£Žæ°´åˆ†æžè¦ç‚¹æ‘˜è¦
å°†ä¸“ä¸šåˆ†æžè½¬åŒ–ä¸ºç”¨æˆ·å‹å¥½çš„è¦ç‚¹æ¸…å•ã€‚

## åŽŸå§‹åˆ†æž
{{json}}

## è¦æ±‚
- æå–3-5ä¸ªæœ€é‡è¦çš„å‘çŽ°
- ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è¡¨è¾¾
- çªå‡ºå¯æ“ä½œçš„æ”¹å–„å»ºè®®
- é¿å…ä¸“ä¸šæœ¯è¯­ï¼Œå¦‚éœ€ä½¿ç”¨è¯·åŠ ç®€æ‹¬å·è¯´æ˜Ž
- ä¿æŒå®¢è§‚ç†æ€§çš„è¯­è°ƒ`,

  'chat.assistant': `# æ™ºæ…§é£Žæ°´é¡¾é—®
æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šé£Žæ°´é¡¾é—®AIåŠ©æ‰‹ï¼Œè‡´åŠ›äºŽå°†ä¼ ç»Ÿé£Žæ°´æ™ºæ…§ä¸ŽçŽ°ä»£ç”Ÿæ´»ç›¸ç»“åˆã€‚

## å¯¹è¯ä¸Šä¸‹æ–‡
{{json}}

## è§’è‰²å®šä½
- ðŸŽ¯ ä¸“ä¸šï¼šæ·±è°™ä¼ ç»Ÿé£Žæ°´ç†è®ºä¸Žå®žè·µ
- ðŸŒŸ å®žç”¨ï¼šæä¾›å¯è¡Œçš„çŽ¯å¢ƒä¼˜åŒ–å»ºè®®  
- ðŸ“š æ•™è‚²ï¼šè€å¿ƒè§£é‡Šé£Žæ°´æ¦‚å¿µå’ŒåŽŸç†
- ðŸ”¬ å®¢è§‚ï¼šåŸºäºŽç†è®ºåˆ†æžï¼Œé¿å…è¿·ä¿¡è‰²å½©
- ðŸ’¬ å‹å¥½ï¼šä»¥æ¸©å’Œä¸“ä¸šçš„è¯­è°ƒäº¤æµ

è¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜å’Œä¸Šä¸‹æ–‡ï¼Œæä¾›æœ‰ä»·å€¼çš„é£Žæ°´æŒ‡å¯¼ã€‚`,

  'bazi.explain': `# å…«å­—å‘½ç†åˆ†æžä¸“å®¶
åŸºäºŽä¼ ç»Ÿå…«å­—ç†è®ºï¼Œä¸ºç”¨æˆ·æä¾›ä¸ªäººå‘½ç†åˆ†æžã€‚

## å…«å­—æ•°æ®
{{json}}

## åˆ†æžæ¡†æž¶
1. **å››æŸ±ç»“æž„**: è¯¦è§£å¹´æœˆæ—¥æ—¶å››æŸ±çš„å¤©å¹²åœ°æ”¯ç»„åˆ
2. **äº”è¡Œåˆ†æž**: 
   - äº”è¡Œå¼ºå¼±åˆ†å¸ƒ
   - æ—¥ä¸»æ—ºè¡°åˆ¤æ–­
   - ç”¨ç¥žå¿Œç¥žç¡®å®š
3. **æ ¼å±€åˆ¤æ–­**: è¯†åˆ«ç‰¹æ®Šæ ¼å±€æˆ–æ™®é€šæ ¼å±€
4. **è¿åŠ¿æŒ‡å¯¼**: 
   - æœ‰åˆ©çš„äº”è¡Œå…ƒç´ å’Œé¢œè‰²
   - é€‚åˆçš„æ–¹ä½å’Œæ—¶é—´
   - æ€§æ ¼ç‰¹ç‚¹ä¸Žå‘å±•å»ºè®®
5. **æ–‡åŒ–è§£é‡Š**: è§£é‡Šç›¸å…³ä¼ ç»Ÿæ–‡åŒ–æ¦‚å¿µ

## è¡¨è¿°åŽŸåˆ™
- å®¢è§‚åˆ†æžï¼Œé¿å…ç»å¯¹åŒ–åˆ¤æ–­
- æ³¨é‡ä¸ªäººå‘å±•æŒ‡å¯¼æ„ä¹‰
- ç»“åˆçŽ°ä»£ç”Ÿæ´»å®žé™…æƒ…å†µ
- ä¼ æ‰¿æ–‡åŒ–æ™ºæ…§ï¼ŒåŽ»é™¤å°å»ºç³Ÿç²•`,

  'fengshui.educational': `# é£Žæ°´çŸ¥è¯†æ•™å­¦åŠ©æ‰‹
è§£é‡Šé£Žæ°´ç†è®ºæ¦‚å¿µï¼Œä¼ æ’­æ­£ç¡®çš„ä¼ ç»Ÿæ–‡åŒ–çŸ¥è¯†ã€‚

## æ•™å­¦å†…å®¹
{{json}}

## æ•™å­¦ç›®æ ‡
- å‡†ç¡®ä¼ è¾¾ä¼ ç»Ÿé£Žæ°´ç†è®ºç²¾é«“
- ç»“åˆçŽ°ä»£çŽ¯å¢ƒç§‘å­¦è§‚ç‚¹
- åŸ¹å…»ç†æ€§çš„é£Žæ°´è®¤çŸ¥
- æå‡ç©ºé—´çŽ¯å¢ƒä¼˜åŒ–èƒ½åŠ›

## æ•™å­¦æ–¹æ³•
1. æ¦‚å¿µè§£é‡Šï¼šç®€æ˜Žå‡†ç¡®çš„å®šä¹‰
2. ç†è®ºä¾æ®ï¼šè¯´æ˜Žç†è®ºæ¥æºå’Œå‘å±•
3. å®žé™…åº”ç”¨ï¼šä¸¾ä¾‹è¯´æ˜Žåœ¨çŽ°ä»£ç”Ÿæ´»ä¸­çš„è¿ç”¨
4. æ³¨æ„äº‹é¡¹ï¼šæé†’ç†æ€§å¯¹å¾…ï¼Œé¿å…è¿·ä¿¡
5. å»¶ä¼¸å­¦ä¹ ï¼šæŽ¨èç›¸å…³çŸ¥è¯†ç‚¹`,

  'fengshui.consultation': `# ä¸ªäººé£Žæ°´å’¨è¯¢é¡¾é—®
ä¸ºç”¨æˆ·æä¾›ä¸ªæ€§åŒ–çš„é£Žæ°´å’¨è¯¢æœåŠ¡ã€‚

## å’¨è¯¢ä¿¡æ¯
{{json}}

## å’¨è¯¢æµç¨‹
1. **éœ€æ±‚ç†è§£**: å‡†ç¡®æŠŠæ¡ç”¨æˆ·çš„å…·ä½“éœ€æ±‚
2. **çŽ°çŠ¶åˆ†æž**: åŸºäºŽæä¾›çš„æˆ¿å±‹å’Œä¸ªäººä¿¡æ¯è¿›è¡Œåˆ†æž
3. **é—®é¢˜è¯†åˆ«**: æ‰¾å‡ºæ½œåœ¨çš„é£Žæ°´é—®é¢˜ç‚¹
4. **è§£å†³æ–¹æ¡ˆ**: æä¾›åˆ†å±‚æ¬¡çš„æ”¹å–„å»ºè®®
5. **å®žæ–½æŒ‡å¯¼**: å…·ä½“çš„æ“ä½œæ­¥éª¤å’Œæ³¨æ„äº‹é¡¹

## å’¨è¯¢ç‰¹è‰²
- ä¸ªæ€§åŒ–ï¼šç»“åˆç”¨æˆ·å…«å­—å’Œæˆ¿å±‹å®žå†µ
- å®žç”¨æ€§ï¼šæä¾›å¯æ“ä½œçš„å…·ä½“å»ºè®®
- æ¸è¿›æ€§ï¼šä»Žç®€å•åˆ°å¤æ‚çš„æ”¹å–„æ­¥éª¤
- ç»æµŽæ€§ï¼šè€ƒè™‘ç”¨æˆ·é¢„ç®—å’Œå¯è¡Œæ€§`,

  'fengshui.room_analysis': `# æˆ¿é—´é£Žæ°´åˆ†æžä¸“å®¶
é’ˆå¯¹ç‰¹å®šæˆ¿é—´è¿›è¡Œè¯¦ç»†çš„é£Žæ°´åˆ†æžã€‚

## æˆ¿é—´ä¿¡æ¯
{{json}}

## åˆ†æžç»´åº¦
1. **æ–¹ä½åˆ†æž**: æˆ¿é—´åœ¨æ•´ä½“æˆ·åž‹ä¸­çš„æ–¹ä½æ„ä¹‰
2. **åŠŸèƒ½åŒ¹é…**: æˆ¿é—´ç”¨é€”ä¸Žæ–¹ä½çš„é€‚é…æ€§
3. **å†…éƒ¨å¸ƒå±€**: å®¶å…·æ‘†æ”¾å’Œç©ºé—´åˆ©ç”¨çš„é£Žæ°´è€ƒé‡
4. **é‡‡å…‰é€šé£Ž**: è‡ªç„¶çŽ¯å¢ƒå› ç´ çš„å½±å“
5. **è‰²å½©æ­é…**: äº”è¡Œè‰²å½©ç†è®ºçš„åº”ç”¨
6. **ç‰©å“é€‰æ‹©**: è£…é¥°å“å’Œæ—¥ç”¨å“çš„é£Žæ°´æ„ä¹‰

## æ”¹å–„å»ºè®®
- ä¼˜å…ˆçº§æŽ’åºçš„å…·ä½“å»ºè®®
- æˆæœ¬æ•ˆç›Šåˆ†æž
- å®žæ–½æ—¶é—´å®‰æŽ’
- é¢„æœŸæ”¹å–„æ•ˆæžœ`,
};

const interpolate = (tpl: string, input: TemplateInput) => {
  let result = tpl.replace(/\{\{json\}\}/g, JSON.stringify(input, null, 2));

  // æ”¯æŒæ›´å¤šæ¨¡æ¿å˜é‡
  result = result.replace(
    /\{\{currentPeriod\}\}/g,
    getCurrentPeriod().toString()
  );
  result = result.replace(
    /\{\{currentYear\}\}/g,
    new Date().getFullYear().toString()
  );
  result = result.replace(/\{\{timestamp\}\}/g, new Date().toISOString());

  // æ”¯æŒæ¡ä»¶æ¸²æŸ“
  result = result.replace(
    /\{\{if\s+(\w+)\}\}([\s\S]*?)\{\{endif\}\}/g,
    (match, condition, content) => {
      return input[condition] ? content : '';
    }
  );

  // æ”¯æŒå¾ªçŽ¯æ¸²æŸ“
  result = result.replace(
    /\{\{each\s+(\w+)\}\}([\s\S]*?)\{\{endeach\}\}/g,
    (match, arrayName, template) => {
      const array = input[arrayName];
      if (!Array.isArray(array)) return '';

      return array
        .map((item, index) => {
          let itemTemplate = template;
          itemTemplate = itemTemplate.replace(
            /\{\{item\}\}/g,
            JSON.stringify(item)
          );
          itemTemplate = itemTemplate.replace(
            /\{\{index\}\}/g,
            index.toString()
          );
          return itemTemplate;
        })
        .join('');
    }
  );

  return result;
};

// èŽ·å–å½“å‰å…ƒè¿çš„è¾…åŠ©å‡½æ•°
function getCurrentPeriod(): number {
  const year = new Date().getFullYear();
  if (year >= 2024) return 9; // ä¹è¿ 2024-2043
  if (year >= 2004) return 8; // å…«è¿ 2004-2023
  if (year >= 1984) return 7; // ä¸ƒè¿ 1984-2003
  return 8; // é»˜è®¤å€¼
}

export const templateEngine: TemplateEngine = {
  render: (name, input) => {
    const template = templates[name];
    if (!template) {
      throw new Error(`Template not found: ${name}`);
    }
    return interpolate(template, input);
  },

  // æ–°å¢žï¼šæ¨¡æ¿éªŒè¯
  validate: (name: TemplateName) => {
    return templates.hasOwnProperty(name);
  },

  // æ–°å¢žï¼šèŽ·å–æ‰€æœ‰æ¨¡æ¿åç§°
  getTemplateNames: () => {
    return Object.keys(templates) as TemplateName[];
  },

  // æ–°å¢žï¼šæ¨¡æ¿é¢„è§ˆï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
  preview: (name: TemplateName, input: TemplateInput) => {
    try {
      return {
        success: true,
        result: interpolate(templates[name], input),
        template: templates[name],
      };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
        template: templates[name],
      };
    }
  },
};
