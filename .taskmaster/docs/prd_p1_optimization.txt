# 用户旅程 P1 优化项目 PRD

## 项目概述
**项目名称**: 用户旅程 P1 优化
**版本**: v5.1.1
**目标**: 将用户旅程评分从 8.0 提升至 9.0+
**工期**: 2-4周
**优先级**: P1 (高优先级)

## 项目背景
Growth P0 病毒增长系统已完整实现（评分8.0/10），现需进行体验优化以提升转化率和用户参与度。

## 核心目标与指标

### 目标1: 首页"即时体验"优化
- 转化率提升: +15%
- 即时体验使用率: +25%
- 页面停留时间: +30秒

### 目标2: 创建邀请专页
- 邀请操作数提升: +50%
- 邀请专页访问量: >1000/周
- 邀请码复制率: +40%

### 目标3: 分享图片生成
- 分享意愿率提升: +80%
- 图片生成成功率: >95%
- 分享转化率: +60%

### 目标4: 定价页面优化
- 付费转化率提升: +20%
- 定价页停留时间: +45秒
- 购买完成率: +15%

### 目标5: Dashboard 优化
- 用户参与度提升: +30%
- 签到率: >60%
- Dashboard访问频率: +40%

## 需求列表

### 需求1: 数据库Schema变更
**优先级**: P0 (前置依赖)
**工期**: 1天
**描述**:
- 创建 instant_previews 表（即时体验记录）
- 扩展 referrals 表（添加 progress、activated_at、reward_tier 字段）
- 创建 leaderboard 表（邀请排行榜快照）
- 创建 posters 表（分享海报记录）
- 扩展 check_ins 表（每日签到）
- 扩展 users 表（添加 member_tier、total_invites、successful_invites 字段）

**验收标准**:
- Prisma migration 成功执行
- 所有索引创建成功
- 数据完整性约束正确

### 需求2: 即时体验API开发
**优先级**: P0
**工期**: 2天
**描述**:
- 实现 POST /api/instant-preview 端点
- 集成轻量级八字计算（日柱、五行）
- AI生成今日运势（带缓存）
- IP级别速率限制（每日5次）
- 记录到数据库（异步）

**技术要点**:
- 使用 Zod 验证输入
- Redis 缓存运势（按日柱+日期）
- 响应时间 < 2秒

**验收标准**:
- API响应正常
- 速率限制生效
- 生成的日柱、五行准确
- 缓存策略正确

### 需求3: 即时体验前端组件
**优先级**: P0
**工期**: 2天
**依赖**: 需求2
**描述**:
- 更新 InstantTrySection 组件
- 创建 InstantResultEnhanced 组件
- 五行雷达图可视化
- 今日运势展示（宜忌）
- CTA强化（"立即解锁"）

**技术要点**:
- 使用 Recharts 绘制雷达图
- React Hook Form + Zod 验证
- 错误处理和速率限制提示

**验收标准**:
- 组件渲染正确
- 表单验证生效
- 速率限制提示友好
- 雷达图显示正常

### 需求4: 邀请数据API开发
**优先级**: P0
**工期**: 2天
**描述**:
- 实现 GET /api/invite/stats 端点
- 返回用户邀请统计
- 返回邀请记录（带进度）
- 返回排行榜（本月top10）
- 返回用户排名

**技术要点**:
- 避免N+1查询
- Redis缓存排行榜（1小时）
- 脱敏处理用户姓名

**验收标准**:
- 数据准确
- 响应时间 < 500ms
- 排行榜缓存生效

### 需求5: 邀请专页前端开发
**优先级**: P1
**工期**: 3天
**依赖**: 需求4
**描述**:
- 创建 /invite 页面
- 实现6个核心组件:
  - InvitePageHeader（头部）
  - InviteProgress（进度）
  - ShareOptions（分享）
  - InviteHistory（记录）
  - Leaderboard（排行榜）
  - IncentiveExplain（说明）

**技术要点**:
- React Query 数据获取
- 复制到剪贴板功能
- 分页加载

**验收标准**:
- 页面加载 < 1.5秒
- 邀请码复制功能正常
- 排行榜实时更新
- 移动端适配良好

### 需求6: 海报生成后端开发
**优先级**: P1
**工期**: 3天
**描述**:
- 实现 POST /api/share/generate-poster 端点
- 使用 BullMQ 队列异步生成
- Canvas绘制海报（node-canvas）
- 二维码生成（qrcode）
- 上传到OSS
- 保存记录到数据库

**技术要点**:
- 注册中文字体（思源黑体）
- 海报尺寸 750x1334
- 缓存24小时内已生成的海报
- Worker并发5

**验收标准**:
- 生成成功率 > 95%
- 生成时间 < 3秒
- 二维码可扫描
- 图片清晰度满足要求

### 需求7: 海报生成前端集成
**优先级**: P1
**工期**: 2天
**依赖**: 需求6
**描述**:
- 创建 PosterGenerator 组件
- 实现生成按钮（带加载状态）
- 预览Modal
- 下载和分享功能

**技术要点**:
- 轮询job状态（最多5秒）
- 显示生成进度
- 长按保存（移动端）

**验收标准**:
- 按钮交互流畅
- 预览显示正常
- 下载功能正常
- 移动端体验良好

### 需求8: 定价页面优化
**优先级**: P1
**工期**: 2天
**描述**:
- 创建 PricingPageHeader（头部+信任徽章）
- 扩展 PricingTable（套餐对比）
- 创建 UseCaseSection（使用场景）
- 创建 PricingCalculator（积分计算器）
- 创建 TestimonialSection（用户评价）
- 创建 PromoBanner（限时优惠）

**技术要点**:
- 动态计算推荐套餐
- 倒计时组件
- 价格凸显

**验收标准**:
- 页面加载 < 2秒
- 计算器功能正常
- 移动端适配良好
- 套餐对比清晰

### 需求9: Dashboard数据API开发
**优先级**: P1
**工期**: 2天
**描述**:
- 实现 GET /api/dashboard/overview 端点
- 返回用户基本信息
- 返回签到状态（今日+连续天数+近7天）
- 返回邀请统计
- 返回最近分析记录（top5）
- 返回积分变动记录（top10）

**技术要点**:
- 聚合查询
- 缓存用户数据（5分钟）

**验收标准**:
- 数据准确
- 响应时间 < 500ms

### 需求10: Dashboard前端优化
**优先级**: P1
**工期**: 3天
**依赖**: 需求9
**描述**:
- 创建 WelcomeSection（欢迎区域）
- 创建 DailyCheckInCard（每日签到）
- 创建 QuickActions（快速操作）
- 创建 RecentAnalysis（最近分析）
- 创建 InviteSection（邀请卡片）
- 创建 CreditsActivity（积分动态）
- 创建 Recommendations（推荐内容）

**技术要点**:
- 签到功能实现
- 时间问候（早上好/下午好/晚上好）
- 里程碑进度条

**验收标准**:
- 页面加载 < 1.5秒
- 签到功能正常
- 所有数据实时更新
- 移动端适配良好

### 需求11: 速率限制与安全
**优先级**: P0
**工期**: 1天
**描述**:
- 实现通用速率限制模块
- 即时体验：IP级别，每日5次
- 海报生成：用户级别，每日10次
- 邀请操作：用户级别，每日5次

**技术要点**:
- Redis INCR + EXPIRE
- 中间件形式
- 返回剩余次数和重置时间

**验收标准**:
- 限流生效
- 错误提示友好
- 不影响正常用户

### 需求12: 性能优化
**优先级**: P1
**工期**: 2天
**描述**:
- 前端代码分割（动态导入重组件）
- Redis缓存热点数据（排行榜、运势）
- 图片CDN配置
- 数据库查询优化（索引、避免N+1）

**技术要点**:
- next/dynamic 动态导入
- Redis缓存策略（TTL设置）
- Prisma include优化

**验收标准**:
- Lighthouse评分 > 85
- 首屏加载 < 2秒
- API P95响应 < 500ms

### 需求13: 测试与验收
**优先级**: P1
**工期**: 2天
**描述**:
- 单元测试（关键业务逻辑）
- 集成测试（API端点）
- E2E测试（关键用户流程）
- 性能测试（压力测试）

**验收标准**:
- 测试覆盖率 > 70%
- 所有关键流程通过
- 无阻塞性bug

### 需求14: 文档与部署
**优先级**: P1
**工期**: 1天
**描述**:
- API文档更新
- 组件文档（Storybook）
- 部署流程文档
- 上线Checklist

**验收标准**:
- 文档完整
- 部署成功
- 监控正常

## 技术栈

### 前端
- Next.js 14 (App Router)
- TypeScript 5.3+
- React 18
- shadcn/ui + Radix UI
- Tailwind CSS 3.4+
- Recharts 2.10+
- React Hook Form + Zod
- Zustand + React Query

### 后端
- Node.js 20+
- Next.js API Routes
- PostgreSQL 15+ (Prisma ORM 5.7+)
- Redis 7+
- BullMQ (异步队列)
- Aliyun OSS (文件存储)
- NextAuth.js 5+ (鉴权)

### DevOps
- Vercel (部署)
- Sentry (错误追踪)
- Vercel Analytics (性能监控)
- GitHub Actions (CI/CD)

## 风险与依赖

### 技术风险
- Canvas兼容性问题（使用node-canvas服务端生成规避）
- 图片生成性能（使用队列异步处理）
- 移动端适配（Mobile First设计）

### 业务风险
- 用户接受度（A/B测试）
- 转化率不达预期（灰度发布）

### 资源依赖
- 设计师（UI设计）
- 前端工程师（2人）
- 后端工程师（1人）
- 测试工程师（1人）

## 里程碑

### Week 1
- ✅ 数据库Schema变更
- ✅ 即时体验API+前端
- ✅ 速率限制与安全

### Week 2
- ✅ 邀请数据API+前端
- ✅ 海报生成后端+前端

### Week 3
- ✅ 定价页面优化
- ✅ Dashboard优化

### Week 4
- ✅ 性能优化
- ✅ 测试与验收
- ✅ 文档与部署

## 验收标准（总体）

### 功能验收
- 所有新功能正常工作
- 无阻塞性bug
- 关键流程通畅

### 性能验收
- Lighthouse评分 > 85
- 首屏加载 < 2秒
- API响应 < 500ms

### 业务指标验收
- 首页转化率 +15%
- 邀请操作数 +50%
- 分享意愿率 +80%
- 付费转化率 +20%
- 用户参与度 +30%

## 参考文档
- [@PRD_USER_JOURNEY_P1_OPTIMIZATION_v5.1.1.md](/@PRD_USER_JOURNEY_P1_OPTIMIZATION_v5.1.1.md)
- [@TECH_GUIDE_USER_JOURNEY_P1_OPTIMIZATION_v5.1.1.md](/@TECH_GUIDE_USER_JOURNEY_P1_OPTIMIZATION_v5.1.1.md)
- [用户旅程评审报告 v5.1.1](/@USER_JOURNEY_ANALYSIS_CORRECTED_v5.1.1.md)

---

**文档版本**: v5.1.1
**创建日期**: 2025-10-12
**负责人**: 产品团队 + 技术团队
